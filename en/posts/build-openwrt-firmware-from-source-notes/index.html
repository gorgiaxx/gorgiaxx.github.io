<!DOCTYPE html>
<html lang="en"><meta charset="utf-8"><meta name="generator" content="Hugo 0.154.5"><meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<meta name="color-scheme" content="light dark">
<meta name="supported-color-schemes" content="light dark"><meta name="description" content="Preface
"><title>Building OpenWrt Firmware from Source&nbsp;&ndash;&nbsp;Gorgias&#39; Blog</title><link rel="stylesheet" href="/css/core.min.363cdd0e3e6340dd0e88b1f21887fb7e53e3129ed31d7f3cf62686d06069621ece79dc5ffb48a77ebba54468e667212f.css" integrity="sha384-NjzdDj5jQN0OiLHyGIf7flPjEp7THX889iaG0GBpYh7Oedxf&#43;0infrulRGjmZyEv"><meta name="twitter:card" content="summary" />
<meta name="twitter:title" content="Building OpenWrt Firmware from Source" /><body><section id="header">
    <div class="header wrap"><span class="header left-side"><a class="site home" href="/en/"><span class="site name">Gorgias' Blog</span></a></span>
        <span class="header right-side"><div class="nav wrap"><nav class="nav"><a class="nav item" href="/en/categories/">Categories</a><a class="nav item" href="/en/tags/">Tags</a><a class="nav item" href="/en/about/">About</a><a class="nav item" href="/en/links/">Links</a><a class="nav item" href="/zh/posts/build-openwrt-firmware-from-source-notes/" title="‰∏≠Êñá">
            <span class="lang-icon">üåê</span>‰∏≠Êñá</a></nav></div></span></div></section><section id="content"><div class="article-container"><section class="article header">
    <h1 class="article title">Building OpenWrt Firmware from Source</h1><p class="article date">Friday, February 24, 2017<span class="langs"><span class="lang">
                    <a href="/zh/posts/build-openwrt-firmware-from-source-notes/" title="‰∏≠Êñá">
                        <span class="lang-icon">üåê</span>‰∏≠Êñá</a>
                </span></span></p></section><article class="article markdown-body"><h2 id="preface">Preface</h2>
<p><img loading="lazy"  src="oye-0001.jpg"
        alt=""/></p>
<p>Recently the campus mobile broadband ISP started ‚Äúdoing things‚Äù: traffic hijacking and poisoned downloads‚Äîbasically joining the ranks of the usual suspects. This semester I also can‚Äôt do multi-dial anymore; the system detects it and blocks the connection for half an hour.</p>
<p>Last summer, a senior (George) gave me a router, OYE-0001. I‚Äôve used it for over half a year. Software-wise it‚Äôs quite stable, but the ports are too loose‚Äîif you bump it accidentally, it disconnects.</p>
<p><img loading="lazy"  src="845N.jpg"
        alt=""/></p>
<p>The modded TP-Link WR845N I flashed with Hackpascal‚Äôs firmware would crash periodically. Since I can‚Äôt multi-dial anymore, I decided to switch back to the original router and flash something more stable (official firmware). Also, I‚Äôm not living in the dorm now, so I don‚Äôt have strict traffic-control requirements.</p>
<p>But it looks like the vendor has abandoned the WR845N V4. I couldn‚Äôt find the firmware download anymore, and firmware for other versions won‚Äôt boot after flashing.</p>
<p>So I decided to try compiling it myself‚Äîhit quite a few potholes along the way.</p>
<p>Here are the steps I recorded.</p>
<h2 id="preparation">Preparation</h2>
<p>Start by reading the <a href="https://github.com/openwrt/openwrt"target="_blank" rel="noopener noreferrer">OpenWrt GitHub repo</a>.</p>
<p>Prepare a build environment with the following components:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">gcc, binutils, bzip2, flex, python, perl, make,
</span></span><span class="line"><span class="cl">find, grep, diff, unzip, gawk, getopt, subversion, libz-dev and libc headers
</span></span></code></pre></div><h3 id="system-environment">System environment</h3>
<ul>
<li>OS: Arch Linux</li>
<li>Kernel: x86_64 Linux 4.9.8-1-ARCH</li>
</ul>
<p>Use the trunk version directly:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">git clone https://github.com/openwrt/openwrt
</span></span></code></pre></div><p>Run <code>feeds</code> to fetch and install all predefined packages. For more details, see <a href="https://wiki.openwrt.org/doc/devel/feeds"target="_blank" rel="noopener noreferrer">OpenWrt Feeds</a>.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">./scripts/feeds update -a
</span></span><span class="line"><span class="cl">./scripts/feeds install -a
</span></span></code></pre></div><h2 id="build">Build</h2>
<p>Start the configuration menu:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">make menuconfig
</span></span></code></pre></div><p>Use arrow keys up/down to move in a column, left/right to switch columns. Press Space to select. <code>M</code> means build as a module, <code>*</code> means built into the firmware image.</p>
<p><img loading="lazy"  src="menuconfig.png"
        alt=""/></p>
<p>Because this is an 8-pin SPI flash, set <strong>Subtarget</strong> to <strong>Generic</strong>. See <a href="https://wiki.openwrt.org/doc/techref/flash.layout"target="_blank" rel="noopener noreferrer">The OpenWrt Flash Layout</a>.</p>
<p>Set <strong>Target Profile</strong> to <strong>TP-LINK TL-WR842N/ND</strong> because the hardware is similar (both are QCA953X).</p>
<p>Set <strong>Target Images</strong> to <code>squashfs</code>. See <a href="https://en.wikipedia.org/wiki/SquashFS"target="_blank" rel="noopener noreferrer">SquashFS</a>.</p>
<p>Keep other settings as default. Because storage is limited, don‚Äôt add extra components. Next, go to LuCI ‚Üí Collections and select the default one:</p>
<p><img loading="lazy"  src="./configuration.png"
        alt=""/></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">Modules ---&gt; Translations
</span></span></code></pre></div><p>Select Chinese and English.</p>
<p>Under <strong>Applications</strong>, choose the apps you need (you can refer to the apps bundled in PandoraBox firmware). Under <strong>Themes</strong>, choose the nicest one: <code>luci-theme-material</code>.</p>
<p><img loading="lazy"  src="./luci.png"
        alt=""/></p>
<p>Then save. The file name must be <code>.config</code>‚Äîdo not change it.</p>
<p><img loading="lazy"  src="./save.png"
        alt=""/></p>
<p>Now start building. My CPU has 2 cores / 4 threads, so I used <code>-j4</code>. Adding <code>V=99</code> shows verbose output:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">make -j4 <span class="nv">V</span><span class="o">=</span><span class="m">99</span>
</span></span></code></pre></div><p>The build process downloads packages from the internet. If your network can‚Äôt reach some mirrors, use a proxy.</p>
<p>If the build fails due to network issues, clean first and then build through <code>proxychains4</code>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">make clean
</span></span><span class="line"><span class="cl">pc4 make -j4 <span class="nv">V</span><span class="o">=</span><span class="m">99</span>
</span></span></code></pre></div><p>After compilation, firmware images and packages will be generated under <code>./bin/ar71xx/</code>. Find the correct image and flash it via Breed.</p>
<p><img loading="lazy"  src="./compile.png"
        alt=""/></p>
<p>Boot succeeded‚Äîand I found the signal was still full even in the bathroom.</p>
<p><img loading="lazy"  src="./ui.png"
        alt=""/></p>
<p>Firmware download:</p>
<p><a href="https://mega.nz/#!b94VCaJS!3u3TEam6ScpjXH9-oPVySjihKCgzLtbE6Z8KpYADhkc"target="_blank" rel="noopener noreferrer">Mega</a></p>
<h2 id="references">References</h2>
<p><a href="https://wiki.openwrt.org/"target="_blank" rel="noopener noreferrer">OpenWrt Wiki</a></p>
<p><a href="https://en.wikipedia.org"target="_blank" rel="noopener noreferrer">Wikipedia</a></p>
</article><section class="article labels"><a class="category" href=/en/categories/tinkering/>Tinkering</a><a class="category" href=/en/categories/iot/>IoT</a><a class="tag" href=/en/tags/openwrt/>openwrt</a><a class="tag" href=/en/tags/tp-link/>TP-Link</a></section>
</div>
<div class="article bottom"><section class="article navigation"><p><a class="link" href="/en/posts/burpsuite-extension-for-bruteforcing-a-platform/"><span class="iconfont icon-article"></span>Developing a Burp Suite Extension to Brute-Force a Platform</a></p><p><a class="link" href="/en/posts/qemu-first-impressions/"><span class="iconfont icon-article"></span>First Impressions of KVM/QEMU</a></p></section></div></section><section id="footer"><div class="footer-wrap">
    <p class="copyright">2015 - 2026 Gorgias' Blog. </p><p class="license">
        <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noopener noreferrer">
            <img alt="CC BY-NC-SA" loading="lazy" src="/images/by-nc.svg" style="vertical-align: middle; height: 1.2em; margin: 0 0.2em;" />
            CC BY-NC-SA 4.0
        </a>
        (Attribution-NonCommercial-ShareAlike).
    </p><p class="powerby"><span>Powered&nbsp;by&nbsp;</span><a href="https://gohugo.io" 
        target="_blank" rel="noopener noreferrer">Hugo</a><span>&nbsp;&amp;&nbsp;</span><a href="https://themes.gohugo.io/hugo-notepadium/" 
        target="_blank" rel="noopener noreferrer">Notepadium</a></p></div></section></body>

</html>