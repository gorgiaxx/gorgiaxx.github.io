<!DOCTYPE html>
<html lang="en"><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset="utf-8"><meta name="generator" content="Hugo 0.154.5"><meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<meta name="color-scheme" content="light dark">
<meta name="supported-color-schemes" content="light dark"><meta name="description" content="Preface
My laptop is a Lenovo Y410P with hybrid graphics: GT755M &#43; HD4600. In the past I never managed to get the NVIDIA proprietary driver working on Debian, nor on Arch Linux, so I had been using the Nouveau driver."><title>Arch Linux Dual-GPU: Installing the NVIDIA Proprietary Driver&nbsp;&ndash;&nbsp;Gorgias&#39; Blog</title><link rel="stylesheet" href="/css/core.min.363cdd0e3e6340dd0e88b1f21887fb7e53e3129ed31d7f3cf62686d06069621ece79dc5ffb48a77ebba54468e667212f.css" integrity="sha384-NjzdDj5jQN0OiLHyGIf7flPjEp7THX889iaG0GBpYh7Oedxf&#43;0infrulRGjmZyEv"><meta name="twitter:card" content="summary" />
<meta name="twitter:title" content="Arch Linux Dual-GPU: Installing the NVIDIA Proprietary Driver" /><body><section id="header">
    <div class="header wrap"><span class="header left-side"><a class="site home" href="/en/"><span class="site name">Gorgias' Blog</span></a></span>
        <span class="header right-side"><div class="nav wrap"><nav class="nav"><a class="nav item" href="/en/categories/">Categories</a><a class="nav item" href="/en/tags/">Tags</a><a class="nav item" href="/en/about/">About</a><a class="nav item" href="/en/links/">Links</a><a class="nav item" href="/zh/posts/arch-linux-dual-gpu-install-nvidia-proprietary-driver/" title="‰∏≠Êñá">
            <span class="lang-icon">üåê</span>‰∏≠Êñá</a></nav></div></span></div></section><section id="content"><div class="article-container"><section class="article header">
    <h1 class="article title">Arch Linux Dual-GPU: Installing the NVIDIA Proprietary Driver</h1><p class="article date">Tuesday, January 17, 2017<span class="langs"><span class="lang">
                    <a href="/zh/posts/arch-linux-dual-gpu-install-nvidia-proprietary-driver/" title="‰∏≠Êñá">
                        <span class="lang-icon">üåê</span>‰∏≠Êñá</a>
                </span></span></p></section><article class="article markdown-body"><h2 id="preface">Preface</h2>
<p>My laptop is a Lenovo Y410P with hybrid graphics: GT755M + HD4600. In the past I never managed to get the NVIDIA proprietary driver working on Debian, nor on Arch Linux, so I had been using the Nouveau driver.</p>
<p>This time I needed to run a wordlist with hashcat, but hashcat does not support Nouveau, so I had to use the proprietary driver.</p>
<p>Previously I installed it ‚Äúby luck‚Äù without really understanding what was going on, and I couldn‚Äôt find a clear solution online. This time I spent some effort to figure it out and wrote these notes in the hope it helps anyone who needs it.</p>
<h2 id="why-the-installation-usually-fails">Why the installation usually fails</h2>
<p>During installation, you will often be asked whether to generate <code>xorg.conf</code>. This step is critical: if you agree to generate it, you may end up with a black screen after reboot and fail to enter the desktop.</p>
<p>Depending on the situation, you may see one or more of the following errors:</p>
<ul>
<li>Error: couldn&rsquo;t get an RGB, Double-buffered visual</li>
<li>ERROR: ld.so: object &rsquo;libdlfaker.so&rsquo; from LD_PRELOAD cannot be preloaded: ignored</li>
<li>SDDM service fails to start</li>
<li><code>/var/log/Xorg.0.log</code> shows <code>(EE) No devices detected. (EE) no screens found</code></li>
<li><code>/var/log/Xorg.0.log</code> shows <code>Cannot establish any listening sockets - Make sure an X server isn't already running</code></li>
</ul>
<p>The first two errors are usually caused by an incorrect installation order, which leads to file conflicts and missing files.</p>
<p><strong>Do NOT use the official binary installer from NVIDIA‚Äôs website!!!</strong></p>
<p>When Xorg cannot start, the problem is often caused by a bad <code>xorg.conf</code>. In some cases Xorg fails to start which then causes SDDM to fail; in other cases Xorg starts successfully but you still get a black screen.</p>
<p><code>xorg.conf</code> is the configuration file for the Linux X Window System. It mainly stores configuration for devices such as mouse, keyboard, monitor, and graphics cards. It is composed of multiple <code>Section ... EndSection</code> blocks, and each block looks like this:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">    Section <span class="s2">&#34;SectionName&#34;</span>
</span></span><span class="line"><span class="cl">           OptionName     <span class="s2">&#34;OptionValue&#34;</span>
</span></span><span class="line"><span class="cl">           OptionName     <span class="s2">&#34;OptionValue&#34;</span>
</span></span><span class="line"><span class="cl">           ‚Ä¶
</span></span><span class="line"><span class="cl">    EndSection
</span></span></code></pre></div><p>Xorg configuration is not exactly friendly‚Äîjust looking at it can make you dizzy‚Äîso I won‚Äôt try to hand-write it from scratch.</p>
<p>In most Arch Linux setups, you first install the integrated GPU driver and then the discrete GPU driver, e.g. <a href="https://www.archlinux.org/packages/?name=xf86-video-intel"target="_blank" rel="noopener noreferrer">xf86-video-intel</a>. You might also run this command to generate a config under <code>/etc/X11/</code>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">Xorg -configure
</span></span></code></pre></div><p>When using only the integrated GPU, you usually don‚Äôt need <code>xorg.conf</code> (unless you need to fine-tune something). But when using the discrete GPU, you must have proper Xorg configuration; otherwise you will run into various errors and Xorg won‚Äôt start, or it starts but behaves incorrectly.</p>
<p>For hybrid graphics switching, the solution used here is Bumblebee. I‚Äôve also heard of some ‚Äúone extra space broke everything‚Äù stories. People say <code>nvidia-prime</code> is better, but it requires more <code>xorg.conf</code> work, so I‚Äôll skip it here.</p>
<h2 id="installation">Installation</h2>
<p>To start from a working desktop without the discrete driver, follow the Arch Wiki guide <a href="https://wiki.archlinux.org/index.php/Bumblebee#Installing_Bumblebee_with_Intel.2FNVIDIA"target="_blank" rel="noopener noreferrer">Installing Bumblebee with Intel/NVIDIA</a> first. <strong>Make sure you can enter the desktop normally before you proceed with the steps below.</strong></p>
<p>Install the following packages:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo pacman -S bumblebee bbswitch
</span></span></code></pre></div><p>Add your user to the <code>bumblebee</code> group:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo gpasswd -a gorgias bumblebee
</span></span></code></pre></div><p>Enable the <code>bumblebeed.service</code>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo systemctl <span class="nb">enable</span> bumblebeed.service
</span></span></code></pre></div><p>Pay attention to the order here: install the NVIDIA driver first. Otherwise it may conflict with some libraries and lead to a black screen on boot, or (because of missing 32-bit libraries) prevent VMware from using the GPU.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo pacman -S bumblebee nvidia opencl-nvidia lib32-nvidia-utils lib32-opencl-nvidia mesa lib32-mesa-libgl xf86-video-intel
</span></span></code></pre></div><p>Configure Bumblebee:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo vi /etc/bumblebee/bumblebee.conf
</span></span><span class="line"><span class="cl">-----------------------------------------
</span></span><span class="line"><span class="cl"><span class="c1"># Do not set this to auto; explicitly use nvidia</span>
</span></span><span class="line"><span class="cl"><span class="nv">Driver</span><span class="o">=</span>nvidia
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Use bbswitch for power management</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>driver-nvidia<span class="o">]</span>
</span></span><span class="line"><span class="cl"><span class="nv">PMMethod</span><span class="o">=</span>bbswitch
</span></span></code></pre></div><p>Reboot. If you can enter the desktop, verify that the discrete GPU can be used.</p>
<p>Install test tools:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo pacman -S glxspheres32 glxspheres64
</span></span></code></pre></div><p>Run:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">glxspheres32
</span></span><span class="line"><span class="cl">glxspheres64
</span></span><span class="line"><span class="cl">optirun glxspheres32
</span></span><span class="line"><span class="cl">optirun glxspheres64
</span></span></code></pre></div><p>Perfect:</p>
<p><img loading="lazy"  src="./glx.png"
        alt="glx"/></p>
<h2 id="adding-an-unrecognized-resolution">Adding an unrecognized resolution</h2>
<p>On my laptop, when using the VGA port under Linux, the highest resolution cannot be detected correctly. Following online tutorials and using <code>cvt</code> also didn‚Äôt produce usable modelines. After a lot of frustration, I bought a cheap DVI-to-HDMI cable last year and that finally solved it.</p>
<p>But then, at the end of 2016, the laptop‚Äôs HDMI port broke, so I had to keep tinkering.</p>
<p>First, to fix the issue where <code>cvt</code> cannot generate usable modelines: for non-CRT monitors you need the <code>-r</code> option. See <a href="http://www.uruk.org/projects/cvt/"target="_blank" rel="noopener noreferrer">CVT Timings Program</a>:</p>
<blockquote>
<p>Reduced Blanking - Timings for LCD flat panels and other monitors that do not require long blanking intervals as a retrace period. CRTs require this because the electron beam takes time to horizontally resteer to the other side of the monitor.</p>
</blockquote>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">usage: cvt <span class="o">[</span>-v<span class="p">|</span>--verbose<span class="o">]</span> <span class="o">[</span>-r<span class="p">|</span>--reduced<span class="o">]</span> X Y <span class="o">[</span>refresh<span class="o">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> -v<span class="p">|</span>--verbose : Warn about CVT standard adherance.
</span></span><span class="line"><span class="cl"> -r<span class="p">|</span>--reduced : Create a mode with reduced blanking <span class="o">(</span>default: normal blanking<span class="o">)</span>.
</span></span><span class="line"><span class="cl">           X : Desired horizontal resolution <span class="o">(</span>multiple of 8, required<span class="o">)</span>.
</span></span><span class="line"><span class="cl">           Y : Desired vertical resolution <span class="o">(</span>required<span class="o">)</span>.
</span></span><span class="line"><span class="cl">     refresh : Desired refresh rate <span class="o">(</span>default: 60.0Hz<span class="o">)</span>.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Calculates VESA CVT <span class="o">(</span>Coordinated Video Timing<span class="o">)</span> modelines <span class="k">for</span> use with X.
</span></span></code></pre></div><p>Finally, run the command below to get a usable modeline:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ cvt -r <span class="m">1920</span> <span class="m">1080</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Modeline <span class="s2">&#34;1920x1080R&#34;</span>  138.50  <span class="m">1920</span> <span class="m">1968</span> <span class="m">2000</span> <span class="m">2080</span>  <span class="m">1080</span> <span class="m">1083</span> <span class="m">1088</span> <span class="m">1111</span> +hsync -vsync
</span></span></code></pre></div><p>Here‚Äôs an <em>incorrect</em> workaround first: a script at <code>/etc/rc.d/afterx</code>. This is awkward because it can‚Äôt run too early or too late. I ended up placing the script path in <code>/usr/share/sddm/scripts/Xsetup</code>, but then the DPI on the login screen was wrong.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="cp">#!/bin/sh -e
</span></span></span><span class="line"><span class="cl"><span class="c1"># Fix VGA resolution</span>
</span></span><span class="line"><span class="cl">xrandr --newmode <span class="s2">&#34;1920x1080R&#34;</span>  138.50  <span class="m">1920</span> <span class="m">1968</span> <span class="m">2000</span> <span class="m">2080</span>  <span class="m">1080</span> <span class="m">1083</span> <span class="m">1088</span> <span class="m">1111</span> +hsync -vsync
</span></span><span class="line"><span class="cl">xrandr --addmode VGA1 <span class="s2">&#34;1920x1080R&#34;</span>
</span></span><span class="line"><span class="cl">xrandr --output VGA1 --mode <span class="s2">&#34;1920x1080R&#34;</span>
</span></span></code></pre></div><p>In fact, you can solve it cleanly via Xorg config. See <a href="https://wiki.archlinux.org/index.php/Xorg#Monitor_settings"target="_blank" rel="noopener noreferrer">Monitor Settings</a>. The meaning of each <code>Section</code> can also be found in the Arch Wiki.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">/etc/X11/xorg.conf.d/10-monitor.conf
</span></span><span class="line"><span class="cl">--------------------------------------
</span></span><span class="line"><span class="cl">Section <span class="s2">&#34;Monitor&#34;</span>
</span></span><span class="line"><span class="cl">    Identifier <span class="s2">&#34;VGA1&#34;</span>
</span></span><span class="line"><span class="cl">    Modeline <span class="s2">&#34;1920x1080R&#34;</span>  138.50  <span class="m">1920</span> <span class="m">1968</span> <span class="m">2000</span> <span class="m">2080</span>  <span class="m">1080</span> <span class="m">1083</span> <span class="m">1088</span> <span class="m">1111</span> +hsync -vsync
</span></span><span class="line"><span class="cl">    Option <span class="s2">&#34;PreferredMode&#34;</span> <span class="s2">&#34;1920x1080R&#34;</span>
</span></span><span class="line"><span class="cl">EndSection
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Section <span class="s2">&#34;Screen&#34;</span>
</span></span><span class="line"><span class="cl">    Identifier <span class="s2">&#34;Screen0&#34;</span>
</span></span><span class="line"><span class="cl">    Monitor <span class="s2">&#34;VGA1&#34;</span>
</span></span><span class="line"><span class="cl">    DefaultDepth <span class="m">24</span>
</span></span><span class="line"><span class="cl">    SubSection <span class="s2">&#34;Display&#34;</span>
</span></span><span class="line"><span class="cl">        Modes <span class="s2">&#34;1920x1080R&#34;</span>
</span></span><span class="line"><span class="cl">    EndSubSection
</span></span><span class="line"><span class="cl">EndSection
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Section <span class="s2">&#34;Device&#34;</span>
</span></span><span class="line"><span class="cl">    Identifier <span class="s2">&#34;Device0&#34;</span>
</span></span><span class="line"><span class="cl">    Driver <span class="s2">&#34;intel&#34;</span>
</span></span><span class="line"><span class="cl">EndSection
</span></span></code></pre></div><p>Notes on configuration:</p>
<ul>
<li>Set <code>Driver</code> to the integrated GPU driver (<code>intel</code>) here.</li>
<li>You can use <code>xrandr</code> to view <code>Identifier</code>s and check Monitor/Screen names:</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">xrandr
</span></span><span class="line"><span class="cl">xrandr --listmonitors
</span></span></code></pre></div><h2 id="references">References</h2>
<ul>
<li><a href="https://wiki.archlinux.org/"target="_blank" rel="noopener noreferrer">Arch Linux Wiki</a></li>
<li><a href="http://www.uruk.org/projects/cvt/"target="_blank" rel="noopener noreferrer">CVT Timings Program</a></li>
</ul>
</article><section class="article labels"><a class="category" href=/en/categories/tinkering/>tinkering</a><a class="tag" href=/en/tags/arch/>arch</a><a class="tag" href=/en/tags/bumblebee/>bumblebee</a><a class="tag" href=/en/tags/dual-gpu/>dual-gpu</a></section>
</div>
<div class="article bottom"><section class="article navigation"><p><a class="link" href="/en/posts/build-openwrt-firmware-from-source-notes/"><span class="iconfont icon-article"></span>Building OpenWrt Firmware from Source</a></p><p><a class="link" href="/en/posts/qemu-first-impressions/"><span class="iconfont icon-article"></span>First Impressions of KVM/QEMU</a></p></section></div></section><section id="footer"><div class="footer-wrap">
    <p class="copyright">2015 - 2026 Gorgias' Blog. </p><p class="license">
        <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noopener noreferrer">
            <img alt="CC BY-NC-SA" loading="lazy" src="/images/by-nc.svg" style="vertical-align: middle; height: 1.2em; margin: 0 0.2em;" />
            CC BY-NC-SA 4.0
        </a>
        (Attribution-NonCommercial-ShareAlike).
    </p><p class="powerby"><span>Powered&nbsp;by&nbsp;</span><a href="https://gohugo.io" 
        target="_blank" rel="noopener noreferrer">Hugo</a><span>&nbsp;&amp;&nbsp;</span><a href="https://themes.gohugo.io/hugo-notepadium/" 
        target="_blank" rel="noopener noreferrer">Notepadium</a></p></div></section></body>

</html>