<!DOCTYPE html>
<html lang="en"><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset="utf-8"><meta name="generator" content="Hugo 0.154.5"><meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<meta name="color-scheme" content="light dark">
<meta name="supported-color-schemes" content="light dark"><meta name="description" content="Preface
Back in 2021 at 360, I built a bench environment for the ID.4. I was close to getting results (I had internal ODIS access, and root on ICAS3), but then I got assigned to a business trip to build a demo car, and the follow-up plan got disrupted. During that period, both work and life threw a lot of unpleasant things at me, so I stopped the research."><title>VW ID.4 ICAS1 Vehicle Control Analysis&nbsp;&ndash;&nbsp;Gorgias&#39; Blog</title><link rel="stylesheet" href="/css/core.min.363cdd0e3e6340dd0e88b1f21887fb7e53e3129ed31d7f3cf62686d06069621ece79dc5ffb48a77ebba54468e667212f.css" integrity="sha384-NjzdDj5jQN0OiLHyGIf7flPjEp7THX889iaG0GBpYh7Oedxf&#43;0infrulRGjmZyEv"><meta name="twitter:card" content="summary" />
<meta name="twitter:title" content="VW ID.4 ICAS1 Vehicle Control Analysis" /><body><section id="header">
    <div class="header wrap"><span class="header left-side"><a class="site home" href="/en/"><span class="site name">Gorgias' Blog</span></a></span>
        <span class="header right-side"><div class="nav wrap"><nav class="nav"><a class="nav item" href="/en/categories/">Categories</a><a class="nav item" href="/en/tags/">Tags</a><a class="nav item" href="/en/about/">About</a><a class="nav item" href="/en/links/">Links</a></nav></div></span></div></section><section id="content"><div class="article-container"><section class="article header">
    <h1 class="article title">VW ID.4 ICAS1 Vehicle Control Analysis</h1><p class="article date">Thursday, December 26, 2024<span class="langs"><span class="lang">
                    <a href="/zh/posts/vw-id4-vehicle-control-analysis/" title="ä¸­æ–‡">
                        <span class="lang-icon">ğŸŒ</span>ä¸­æ–‡</a>
                </span></span></p></section><article class="article markdown-body"><h2 id="preface">Preface</h2>
<p>Back in 2021 at 360, I built a bench environment for the ID.4. I was close to getting results (I had internal ODIS access, and root on ICAS3), but then I got assigned to a business trip to build a demo car, and the follow-up plan got disrupted. During that period, both work and life threw a lot of unpleasant things at me, so I stopped the research.</p>
<p>You could call this a â€œregret projectâ€. This May, by coincidence, I picked up the vehicle-control logic of the ID.4â€™s ICAS1 again. Another â€œregret projectâ€ is CAN-Pick NGâ€”I wrote half of it and shelved it again. Not sure if I can finish it in 2025.</p>
<p>The ID.4 is based on Volkswagenâ€™s MEB platform. Its EE architecture has two domain controllers: ICAS1 and ICAS3. ICAS1 (J533) is related to body control.</p>
<p>The figure below shows the location of J533 at position 13. By mounting a drive-by-wire module here, you can monitor and control body functions.</p>
<p><img loading="lazy"  src="./icas1.png"
        alt="icas1"/></p>
<h2 id="in-vehicle-ecu-topology">In-Vehicle ECU Topology</h2>
<p>Classic CAN: 500k</p>
<p>CAN-FD: arbitration 500k, data 2M. If you want to analyze CAN-FD, ZLG devices are the best fit.</p>
<p>By analyzing the ELSA wiring diagrams and VW internal training materials, I found the bus naming to be messy. You have to re-organize it to get the correct CAN topology.</p>
<p>J533 has a total of 9 CAN buses and 4 LIN buses (LIN is not needed for now). Key ECUs are as follows:</p>
<ul>
<li>Running-Gear CAN (CAN-FD)
<ul>
<li>J104 - ABS</li>
<li>J500 - EPS, Electric Power Steering control unit</li>
<li>NX6 - Brake controller (Brake Booster)</li>
</ul>
</li>
<li>Powertrain CAN (CAN-FD)
<ul>
<li>J623 - Engine/Motor Control Module</li>
<li>J841/J944 - Electric drive unit</li>
<li>J234 - Airbag (do not fuzz here; itâ€™s dangerous)</li>
</ul>
</li>
<li>Driver Assistance CAN, CAN-FAS (CAN-FD)
<ul>
<li>J428 - Distance control unit</li>
<li>J446 - Parking radar control unit</li>
<li>J769/J770 - Lane change assist control units</li>
<li>J928 - Surround-view camera control unit</li>
</ul>
</li>
<li>Convenience CAN (Classic)
<ul>
<li>J527 - Steering Column Electronics Control Module (shift-by-wire module)</li>
<li>J605 - Tailgate control unit</li>
<li>J764 - Steering column lock</li>
<li>&hellip; other body controls</li>
</ul>
</li>
<li>CAN-EV (CAN-FD)
<ul>
<li>J979 - Heater and Air Conditioning Control Module</li>
</ul>
</li>
</ul>
<p><img loading="lazy"  src="./topicdiagram.png"
        alt="topicdiagram"/></p>
<h2 id="j533-connector-t40a-definition">J533 Connector T40a Definition</h2>
<p>The T40a connector and the table correspond as follows.</p>
<p><img loading="lazy"  src="./T40a_datasheet.png"
        alt="T40a_datasheet"/></p>
<p><img loading="lazy"  src="./T40a.png"
        alt="T40a"/></p>
<h2 id="bus-security-strategy">Bus Security Strategy</h2>
<h3 id="gateway-isolation">Gateway Isolation</h3>
<p>Multifunction steering wheel control signals are received on the Convenience CAN, but ECUs on the chassis CAN can also see them. However, multifunction steering wheel control signals originating from the chassis CAN will not be forwarded by J533 to the target ECU.</p>
<h2 id="crc-check">CRC Check</h2>
<p>By observing CAN bus changes, you can see the pattern for most messages: the first byte looks random, while the second byte increases in a regular way. The first byte is the CRC, and the second byte is the counter.</p>
<h3 id="crc-seeds">CRC Seeds</h3>
<p>Reference: <a href="https://github.com/commaai/opendbc"target="_blank" rel="noopener noreferrer">OpenDBC github</a><br>
<code>/opendbc/can/common.cc</code> <code>volkswagen_mqb_checksum</code></p>
<p>You can obtain checksum seeds for the VW MQB platform, but the ID.4 has many new CRC seeds. I reverse-engineered them and recorded them below.</p>
<p>Most control signals include both CRC and a counter. ECUs wonâ€™t validate CRC for some less critical functions (e.g., sunroof, windows, horn), but they will validate it for functions that affect driving, such as EPS, tailgate opening, and wipers.</p>
<table>
  <thead>
      <tr>
          <th>Signal</th>
          <th>CAN ID</th>
          <th>CRC Seed</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>AAA_01</td>
          <td>0x12DD5502</td>
          <td>0x62,0x14,0x7c,0xa1,0x49,0x95,0x43,0x04,0x78,0x46,0x74,0x19,0x39,0x17,0x9f,0x1c</td>
      </tr>
      <tr>
          <td>ACC_18</td>
          <td>0x14D</td>
          <td>0x1a,0x65,0x81,0x96,0xc0,0xdf,0x11,0x92,0xd3,0x61,0xc6,0x95,0x8c,0x29,0x21,0xb5</td>
      </tr>
      <tr>
          <td>Airbag_01</td>
          <td>0x040</td>
          <td>0x40,0x40,0x40,0x40,0x40,0x40,0x40,0x40,0x40,0x40,0x40,0x40,0x40,0x40,0x40,0x40</td>
      </tr>
      <tr>
          <td>Airbag_02</td>
          <td>0x520</td>
          <td>0x44,0x44,0x44,0x44,0x44,0x44,0x44,0x44,0x44,0x44,0x44,0x44,0x44,0x44,0x44,0x44</td>
      </tr>
      <tr>
          <td>APS_Master</td>
          <td>0x380</td>
          <td>0x13,0x13,0x13,0x13,0x13,0x13,0x13,0x13,0x13,0x13,0x13,0x13,0x13,0x13,0x13,0x13</td>
      </tr>
      <tr>
          <td>AWV_03</td>
          <td>0x0DB</td>
          <td>0x09,0xfa,0xca,0x8e,0x62,0xd5,0xd1,0xf0,0x31,0xa0,0xaf,0xda,0x4d,0x1a,0x0a,0x97</td>
      </tr>
      <tr>
          <td>BEM_06</td>
          <td>0x48B</td>
          <td>0x54,0xaf,0x8a,0xfb,0x0d,0x87,0x6a,0x0f,0x47,0x78,0x31,0x4f,0x35,0x28,0x82,0x6d</td>
      </tr>
      <tr>
          <td>Blinkmodi_02</td>
          <td>0x366</td>
          <td>0xa9,0xbd,0xfb,0x3c,0x95,0x0f,0x75,0x3a,0x4f,0x19,0x59,0x6d,0xb2,0xe9,0xd1,0x97</td>
      </tr>
      <tr>
          <td>EA_01</td>
          <td>0x1A4</td>
          <td>0x69,0xbb,0x54,0xe6,0x4e,0x46,0x8d,0x7b,0xea,0x87,0xe9,0xb3,0x63,0xce,0xf8,0xbf</td>
      </tr>
      <tr>
          <td>EA_02</td>
          <td>0x1F0</td>
          <td>0x2f,0x3c,0x22,0x60,0x18,0xeb,0x63,0x76,0xc5,0x91,0x0f,0x27,0x34,0x04,0x7f,0x02</td>
      </tr>
      <tr>
          <td>ELV_01</td>
          <td>0x656</td>
          <td>0xab,0x2f,0xd3,0x39,0x6f,0x37,0xfa,0x59,0xa4,0x70,0xce,0x11,0x54,0x82,0x62,0x56</td>
      </tr>
      <tr>
          <td>EM1_01</td>
          <td>0x0C0</td>
          <td>0x2f,0x44,0x72,0xd3,0x07,0xf2,0x39,0x09,0x8d,0x6f,0x57,0x20,0x37,0xf9,0x9b,0xfa</td>
      </tr>
      <tr>
          <td>EML_02</td>
          <td>0x1A555541</td>
          <td>0x3e,0xb4,0x25,0xc1,0x31,0x1f,0xf1,0xd7,0xb1,0xbe,0xcc,0xe0,0x0f,0x46,0x51,0xb2</td>
      </tr>
      <tr>
          <td>EML_06</td>
          <td>0x20A</td>
          <td>0x9d,0xe8,0x36,0xa1,0xca,0x3b,0x1d,0x33,0xe0,0xd5,0xbb,0x5f,0xae,0x3c,0x31,0x9f</td>
      </tr>
      <tr>
          <td>ESC_50</td>
          <td>0x102</td>
          <td>0xd7,0x12,0x85,0x7e,0x0b,0x34,0xfa,0x16,0x7a,0x25,0x2d,0x8f,0x04,0x8e,0x5d,0x35</td>
      </tr>
      <tr>
          <td>ESC_51</td>
          <td>0x0FC</td>
          <td>0x77,0x5c,0xa0,0x89,0x4b,0x7c,0xbb,0xd6,0x1f,0x6c,0x4f,0xf6,0x20,0x2b,0x43,0xdd</td>
      </tr>
      <tr>
          <td>ESP_10</td>
          <td>0x116</td>
          <td>0xac,0xac,0xac,0xac,0xac,0xac,0xac,0xac,0xac,0xac,0xac,0xac,0xac,0xac,0xac,0xac</td>
      </tr>
      <tr>
          <td>ESP_20</td>
          <td>0x65D</td>
          <td>0xac,0xb3,0xab,0xeb,0x7a,0xe1,0x3b,0xf7,0x73,0xba,0x7c,0x9e,0x06,0x5f,0x02,0xd9</td>
      </tr>
      <tr>
          <td>ESP_21</td>
          <td>0x0FD</td>
          <td>0xb4,0xef,0xf8,0x49,0x1e,0xe5,0xc2,0xc0,0x97,0x19,0x3c,0xc9,0xf1,0x98,0xd6,0x61</td>
      </tr>
      <tr>
          <td>ESP_24</td>
          <td>0x31B</td>
          <td>0x67,0x8a,0xae,0x22,0x4d,0xd0,0x51,0x80,0x5c,0xb9,0xce,0x1e,0xdf,0x02,0x2d,0xd4</td>
      </tr>
      <tr>
          <td>Getriebe_11</td>
          <td>0x0AD</td>
          <td>0x3f,0x69,0x39,0xdc,0x94,0xf9,0x14,0x64,0xd8,0x6a,0x34,0xce,0xa2,0x55,0xb5,0x2c</td>
      </tr>
      <tr>
          <td>GRA_ACC_01</td>
          <td>0x12B</td>
          <td>0x6a,0x38,0xb4,0x27,0x22,0xef,0xe1,0xbb,0xf8,0x80,0x84,0x49,0xc7,0x9e,0x1e,0x2b</td>
      </tr>
      <tr>
          <td>HCA_01</td>
          <td>0x126</td>
          <td>0xda,0xda,0xda,0xda,0xda,0xda,0xda,0xda,0xda,0xda,0xda,0xda,0xda,0xda,0xda,0xda</td>
      </tr>
      <tr>
          <td>HVL_01</td>
          <td>0x12DD553D</td>
          <td>0x1d,0x82,0x7b,0x79,0xa5,0xee,0x3a,0xb9,0xb7,0xf9,0xe4,0x67,0x7f,0x97,0x11,0xad</td>
      </tr>
      <tr>
          <td>IPA_01</td>
          <td>0x138</td>
          <td>0x77,0x4e,0x14,0x87,0xf2,0xf8,0xb2,0x61,0xf6,0xa4,0x52,0x94,0xd4,0x81,0x2a,0xb1</td>
      </tr>
      <tr>
          <td>IPA_02</td>
          <td>0x16A9545F</td>
          <td>0xc6,0x7f,0x85,0xb6,0xe6,0xae,0xf8,0x26,0xb0,0x8c,0x19,0x10,0x5b,0x33,0x64,0x6c</td>
      </tr>
      <tr>
          <td>Klemmen_Status_01</td>
          <td>0x3C0</td>
          <td>0xc3,0xc3,0xc3,0xc3,0xc3,0xc3,0xc3,0xc3,0xc3,0xc3,0xc3,0xc3,0xc3,0xc3,0xc3,0xc3</td>
      </tr>
      <tr>
          <td>LH_EPS_02</td>
          <td>0x11D</td>
          <td>0x1c,0x1c,0x1c,0x1c,0x1c,0x1c,0x1c,0x1c,0x1c,0x1c,0x1c,0x1c,0x1c,0x1c,0x1c,0x1c</td>
      </tr>
      <tr>
          <td>LH_EPS_03</td>
          <td>0x09F</td>
          <td>0xf5,0xf5,0xf5,0xf5,0xf5,0xf5,0xf5,0xf5,0xf5,0xf5,0xf5,0xf5,0xf5,0xf5,0xf5,0xf5</td>
      </tr>
      <tr>
          <td>Licht_Anf_01</td>
          <td>0x3D5</td>
          <td>0xc5,0x39,0xc7,0xf9,0x92,0xd8,0x24,0xce,0xf1,0xb5,0x7a,0xc4,0xbc,0x60,0xe3,0xd1</td>
      </tr>
      <tr>
          <td>LWI_01</td>
          <td>0x086</td>
          <td>0x86,0x86,0x86,0x86,0x86,0x86,0x86,0x86,0x86,0x86,0x86,0x86,0x86,0x86,0x86,0x86</td>
      </tr>
      <tr>
          <td>Motor_14</td>
          <td>0x3BE</td>
          <td>0x1f,0x28,0xc6,0x85,0xe6,0xf8,0xb0,0x19,0x5b,0x64,0x35,0x21,0xe4,0xf7,0x9c,0x24</td>
      </tr>
      <tr>
          <td>Motor_51</td>
          <td>0x10B</td>
          <td>0x77,0x5c,0xa0,0x89,0x4b,0x7c,0xbb,0xd6,0x1f,0x6c,0x4f,0xf6,0x20,0x2b,0x43,0xdd</td>
      </tr>
      <tr>
          <td>Motor_54</td>
          <td>0x14C</td>
          <td>0x16,0x35,0x59,0x15,0x9a,0x2a,0x97,0xb8,0x0e,0x4e,0x30,0xcc,0xb3,0x07,0x01,0xad</td>
      </tr>
      <tr>
          <td>Motor_Code_01</td>
          <td>0x641</td>
          <td>0x47,0x47,0x47,0x47,0x47,0x47,0x47,0x47,0x47,0x47,0x47,0x47,0x47,0x47,0x47,0x47</td>
      </tr>
      <tr>
          <td>Parken_01</td>
          <td>0x206</td>
          <td>0x09,0xfa,0xca,0x8e,0x62,0xd5,0xd1,0xf0,0x31,0xa0,0xaf,0xda,0x4d,0x1a,0x0a,0x97</td>
      </tr>
      <tr>
          <td>PLA_04</td>
          <td>0x407</td>
          <td>0xef,0x60,0x04,0xa8,0x0c,0x1c,0xda,0x07,0x36,0xd7,0x28,0x92,0xa9,0x88,0x2c,0x4a</td>
      </tr>
      <tr>
          <td>QFK_01</td>
          <td>0x13D</td>
          <td>0x20,0xca,0x68,0xd5,0x1b,0x31,0xe2,0xda,0x08,0x0a,0xd4,0xde,0x9c,0xe4,0x35,0x5b</td>
      </tr>
      <tr>
          <td>RCTA_01</td>
          <td>0x2B7</td>
          <td>0x5e,0xc7,0x04,0x11,0x4d,0x27,0x0d,0x31,0x91,0xb8,0x62,0x76,0x64,0x09,0xeb,0xec</td>
      </tr>
      <tr>
          <td>SAL_01</td>
          <td>0x12DD54C9</td>
          <td>0xde,0xa9,0x83,0x0b,0x0c,0x64,0x79,0x44,0x0f,0xf6,0xc6,0xc7,0x05,0x45,0xb7,0x59</td>
      </tr>
      <tr>
          <td>SAM_01</td>
          <td>0x205</td>
          <td>0x19,0x36,0xd4,0x1e,0x80,0x22,0xf4,0xb8,0xad,0x41,0x0b,0x3f,0x87,0x42,0x25,0x40</td>
      </tr>
      <tr>
          <td>SMLS_01</td>
          <td>0x3D4</td>
          <td>0xc3,0x79,0xbf,0xdb,0xe9,0x11,0x46,0x86,0x69,0xb6,0x9b,0x29,0x15,0x9c,0x45,0x0d</td>
      </tr>
      <tr>
          <td>TA_01</td>
          <td>0x26B</td>
          <td>0xce,0xcc,0xbd,0x69,0xa1,0x3c,0x18,0x76,0x0f,0x04,0xf2,0x3a,0x93,0x24,0x19,0x51</td>
      </tr>
      <tr>
          <td>TSG_FT_02</td>
          <td>0x3E5</td>
          <td>0xc4,0x6a,0x69,0x30,0xcf,0x61,0x58,0x51,0x1b,0x86,0x99,0xd3,0xf6,0x1d,0x9a,0x37</td>
      </tr>
      <tr>
          <td>VMM_01</td>
          <td>0x105</td>
          <td>0xde,0x0e,0xa7,0x1d,0xc3,0x83,0xbd,0x82,0x8c,0xa2,0x0c,0x7b,0x4d,0x3c,0x58,0x79</td>
      </tr>
      <tr>
          <td>VMM_02</td>
          <td>0x139</td>
          <td>0xed,0x03,0x1c,0x13,0xc6,0x23,0x78,0x7a,0x8b,0x40,0x14,0x51,0xbf,0x68,0x32,0xba</td>
      </tr>
  </tbody>
</table>
<h3 id="crc-algorithm">CRC Algorithm</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">MEB_Kennungsfolge</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># LWI_01 Steering Angle</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x86</span><span class="p">:</span> <span class="p">[</span><span class="mh">0x86</span><span class="p">,</span> <span class="mh">0x86</span><span class="p">,</span> <span class="mh">0x86</span><span class="p">,</span> <span class="mh">0x86</span><span class="p">,</span> <span class="mh">0x86</span><span class="p">,</span> <span class="mh">0x86</span><span class="p">,</span> <span class="mh">0x86</span><span class="p">,</span> <span class="mh">0x86</span><span class="p">,</span> <span class="mh">0x86</span><span class="p">,</span> <span class="mh">0x86</span><span class="p">,</span> <span class="mh">0x86</span><span class="p">,</span> <span class="mh">0x86</span><span class="p">,</span> <span class="mh">0x86</span><span class="p">,</span> <span class="mh">0x86</span><span class="p">,</span> <span class="mh">0x86</span><span class="p">,</span> <span class="mh">0x86</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># LH_EPS_03 Electric Power Steering</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x9F</span><span class="p">:</span> <span class="p">[</span><span class="mh">0xF5</span><span class="p">,</span> <span class="mh">0xF5</span><span class="p">,</span> <span class="mh">0xF5</span><span class="p">,</span> <span class="mh">0xF5</span><span class="p">,</span> <span class="mh">0xF5</span><span class="p">,</span> <span class="mh">0xF5</span><span class="p">,</span> <span class="mh">0xF5</span><span class="p">,</span> <span class="mh">0xF5</span><span class="p">,</span> <span class="mh">0xF5</span><span class="p">,</span> <span class="mh">0xF5</span><span class="p">,</span> <span class="mh">0xF5</span><span class="p">,</span> <span class="mh">0xF5</span><span class="p">,</span> <span class="mh">0xF5</span><span class="p">,</span> <span class="mh">0xF5</span><span class="p">,</span> <span class="mh">0xF5</span><span class="p">,</span> <span class="mh">0xF5</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># HCA_01 Heading Control Assist</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x126</span><span class="p">:</span> <span class="p">[</span><span class="mh">0xDA</span><span class="p">,</span> <span class="mh">0xDA</span><span class="p">,</span> <span class="mh">0xDA</span><span class="p">,</span> <span class="mh">0xDA</span><span class="p">,</span> <span class="mh">0xDA</span><span class="p">,</span> <span class="mh">0xDA</span><span class="p">,</span> <span class="mh">0xDA</span><span class="p">,</span> <span class="mh">0xDA</span><span class="p">,</span> <span class="mh">0xDA</span><span class="p">,</span> <span class="mh">0xDA</span><span class="p">,</span> <span class="mh">0xDA</span><span class="p">,</span> <span class="mh">0xDA</span><span class="p">,</span> <span class="mh">0xDA</span><span class="p">,</span> <span class="mh">0xDA</span><span class="p">,</span> <span class="mh">0xDA</span><span class="p">,</span> <span class="mh">0xDA</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># GRA_ACC_01 Steering wheel controls for ACC</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x12B</span><span class="p">:</span> <span class="p">[</span><span class="mh">0x6A</span><span class="p">,</span> <span class="mh">0x38</span><span class="p">,</span> <span class="mh">0xB4</span><span class="p">,</span> <span class="mh">0x27</span><span class="p">,</span> <span class="mh">0x22</span><span class="p">,</span> <span class="mh">0xEF</span><span class="p">,</span> <span class="mh">0xE1</span><span class="p">,</span> <span class="mh">0xBB</span><span class="p">,</span> <span class="mh">0xF8</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mh">0x84</span><span class="p">,</span> <span class="mh">0x49</span><span class="p">,</span> <span class="mh">0xC7</span><span class="p">,</span> <span class="mh">0x9E</span><span class="p">,</span> <span class="mh">0x1E</span><span class="p">,</span> <span class="mh">0x2B</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">gen_crc_lookup_table_8</span><span class="p">(</span><span class="n">poly</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">crc_lut</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">256</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">256</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">crc</span> <span class="o">=</span> <span class="n">i</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">crc</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">crc</span> <span class="o">=</span> <span class="p">(</span><span class="n">crc</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">^</span> <span class="n">poly</span>
</span></span><span class="line"><span class="cl">            <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">crc</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">        <span class="n">crc_lut</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">crc</span> <span class="o">&amp;</span> <span class="mh">0xFF</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">crc_lut</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">volkswagen_mqb_checksum</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">global</span> <span class="n">crc8_lut_8h2f</span>
</span></span><span class="line"><span class="cl">    <span class="n">crc</span> <span class="o">=</span> <span class="mh">0xFF</span>  <span class="c1"># CRC8 8H2F/AUTOSAR</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)):</span>
</span></span><span class="line"><span class="cl">        <span class="n">crc</span> <span class="o">=</span> <span class="n">crc</span> <span class="o">^</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># print(hex(crc), hex(i))</span>
</span></span><span class="line"><span class="cl">        <span class="n">crc</span> <span class="o">=</span> <span class="n">crc8_lut_8h2f</span><span class="p">[</span><span class="n">crc</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">counter</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x0F</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">address</span> <span class="ow">in</span> <span class="n">MEB_Kennungsfolge</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">crc</span> <span class="o">^=</span> <span class="n">MEB_Kennungsfolge</span><span class="p">[</span><span class="n">address</span><span class="p">][</span><span class="n">counter</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># æ— éœ€æ ¡éªŒ</span>
</span></span><span class="line"><span class="cl">        <span class="n">crc</span> <span class="o">^=</span> <span class="p">[</span><span class="mh">0x00</span><span class="p">]</span> <span class="o">*</span> <span class="mi">16</span>  <span class="c1"># é»˜è®¤æƒ…å†µä¸‹ï¼Œè¿”å›å…¨ 0</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">crc</span> <span class="o">=</span> <span class="n">crc8_lut_8h2f</span><span class="p">[</span><span class="n">crc</span><span class="p">]</span>  <span class="c1"># æ ‡å‡† CRC8 8H2F/AUTOSAR æœ€åä¸€ä¸ª XOR</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">crc</span> <span class="o">^</span> <span class="mh">0xFF</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl"><span class="n">can_id</span> <span class="o">=</span> <span class="mh">0x126</span>
</span></span><span class="line"><span class="cl"><span class="n">data</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="nb">bytes</span><span class="p">(</span><span class="mi">8</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">crc8_lut_8h2f</span> <span class="o">=</span> <span class="n">gen_crc_lookup_table_8</span><span class="p">(</span><span class="mh">0x2f</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">crc</span> <span class="o">=</span> <span class="n">volkswagen_mqb_checksum</span><span class="p">(</span><span class="n">can_id</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">crc</span>
</span></span></code></pre></div><h2 id="can-signals">CAN Signals</h2>
<ul>
<li>The Convenience CAN carries the following signal traffic. It can be used for state reading, and most body functions can essentially be controlled through this CAN bus, including HVAC, front/rear lights, horn, wipers, windows, door locks, and various vehicle status information.</li>
</ul>
<pre tabindex="0"><code>0x12B	GRA_ACC_01	è‡ªé€‚åº”å·¡èˆªï¼ŒGRAç³»ç»Ÿï¼ŒACCï¼Œ
0x1F0	EA_02	åº”æ€¥è¾…åŠ©
0x205	SAM_01	å¼€å…³å’Œæ‰§è¡Œæ¨¡å—
0x2B7	RCTA_01	Rear Cross Traffic Alertï¼Œåæ–¹äº¤é€šè­¦ç¤º
0x31B	ESP_24	
0x366	Blinkmodi_02	é—ªçƒæ¨¡å¼
0x397	LDW_02	è½¦é“åç¦»è­¦ç¤ºç³»ç»Ÿ
0x3BE	Motor_14	ç”µæœºæ§åˆ¶
0x3C0	Klemmen_Status_01	ç«¯å­çŠ¶æ€
0x3CE	TSG_HFS_01	ååº§é—¨çª—åŠŸèƒ½ç³»ç»Ÿ
0x3CF	TSG_HBFS_01	åé—¨çª—æˆ·åŠŸèƒ½ç³»ç»Ÿ
0x3D0	TSG_FT_01	å‰é—¨åŠŸèƒ½ç³»ç»Ÿ
0x3D4	SMLS_01	è½¬å‘æŸ±å¼€å…³æ¨¡å—
0x3D5	Licht_Anf_01	ç¯å…‰è¦æ±‚
0x3D6	Licht_hinten_01	åéƒ¨ç¯å…‰çŠ¶æ€
0x3DC	Gateway_73	è¿™äº›ä¿¡æ¯æ¶‰åŠè½¦è¾†çš„å„ç§ä¿¡å·å’ŒçŠ¶æ€ï¼ŒåŒ…æ‹¬ç³»ç»Ÿæç¤ºã€å®‰å…¨æç¤ºã€æ•…éšœè¯Šæ–­ã€ä¿¡å·æ›´æ–°å’Œæ—§ä¿¡å·çš„æ›¿æ¢
0x48B	BEM_06	ä½ç”µå‹èƒ½æºç®¡ç†
0x520	Airbag_02	æ°”å›Š2
0x551	WFS_01	è½¦é’¥åŒ™é˜²ç›—
0x582	HDSG_01	åå¤‡ç®±ç®¡ç†çŠ¶æ€
0x583	ZV_02	ä¸­å¤®é—¨é”ç³»ç»Ÿ
0x585	Systeminfo_01	è¯Šæ–­å’Œç”Ÿäº§æ¨¡å¼è®¾ç½®
0x592	Kessy_04	æ™ºèƒ½é’¥åŒ™ç³»ç»Ÿï¼ˆKessyï¼‰ä»¥åŠè¿œç¨‹åœè½¦åŠŸèƒ½çš„çŠ¶æ€å’Œæ§åˆ¶
0x5A0	RLS_01	å…‰ä¼ æ„Ÿå™¨å’Œé›¨é‡ä¼ æ„Ÿå™¨
0x5A7	TM_01	Telematics
0x5F0	Dimmung_01	è°ƒå…‰
0x5F4	Innenlicht_11	è½¦å†…ç¯å…‰
0x641	Motor_Code_01	ç”µæœºè®¾ç 
0x643	Einheiten_01	å•ä½è®¾ç½®
0x656	ELV_01	ç”µå­è½¬å‘æŸ±é”
0x658	Licht_vorne_01	å‰ç¯çŠ¶æ€
0x65D	ESP_20	
0x668	Klima_12	ç©ºè°ƒç³»ç»Ÿ
0x670	Motor_18	
0x6AE	Spiegel_01	åè§†é•œ
0x6AF	Rear_View_01	åè§†æ‘„åƒå¤´
0x6B2	Diagnose_01	
0x6B4	VIN_01	
0x12DD54C9	SAL_01	ç…§æ˜æ¨¡å—
</code></pre><h2 id="other-signals">Other Signals</h2>
<p>The DBC has been analyzed, but it is not published for now.</p>
<pre tabindex="0"><code>0x184
1. é”è½¦
  1. ç¬¬äºŒå­—èŠ‚ åè§†é•œå¼€ 0x20 å¼€
  2. ç¬¬ä¸‰å­—èŠ‚ åè§†é•œå…³ 0x40 å…³
2. è½¦çª—
  1. ç¬¬å…­å­—èŠ‚ è½¦çª—  04 å·¦å‰ä¸‹ï¼Œ02 å·¦å‰ä¸Šï¼Œ40 å·¦åä¸‹ï¼Œ08å³å‰ä¸Šï¼Œ10å³å‰ä¸‹
  2. ç¬¬ä¸ƒå­—èŠ‚ï¼Œ01å³åä¸‹
0x185
1. è½¦çª—æ§åˆ¶ï¼Œ10 20 up 40 80 down
  1. ç¬¬ä¸€å­—èŠ‚ å‰æ’
  2. ç¬¬äºŒå­—èŠ‚ åæ’
0x598
1. å¤©çª—æ§åˆ¶
  1. ç¬¬ä¸‰å­—èŠ‚ 0x20 æ—  0x21 tap 0x22 æ»‘åŠ¨ 0x25 é•¿æŒ‰
  2. ç¬¬ä¸ƒå­—èŠ‚ï¼š04 å…³ä¸€ä¸‹ï¼Œ08 ä¸€ç›´å…³ï¼Œ0C å¼€ä¸€ä¸‹ï¼Œ10 ä¸€ç›´å¼€ï¼Œ 14ï¼Œ1cå…¶ä»–
</code></pre><h2 id="steering-control">Steering Control</h2>
<p>The gear must be in D/B or R. The following five signals can be used to control the steering wheel:</p>
<ul>
<li>LWI_01        Lenkwinkelsensor</li>
<li>LH_EPS_03     Lenkhilfe Electric Power Steering</li>
<li>HCA_01        Heading Control Assist</li>
<li>GRA_ACC_01    Geschwindigkeitsregelanlage &amp; Adaptive Cruise Control</li>
<li>PLA_05        Park Lane Assist</li>
</ul>
<p>Notes:</p>
<ul>
<li>By combining signals 0x86, 0x9f, 0x126, 0x12b, and 0x302 and sending them on CAN-FAS, you can achieve parking steering-wheel actuation.</li>
<li>By combining signals 0x86, 0x9f, and 0x302 and sending them on the Gear-Running CAN, you can actuate the steering wheel.</li>
<li>Among them, both 0x9f (LH_EPS_03) and 0x302 (PLA_05) can directly control the steering wheel.</li>
<li>0x302 has no CRC check, so controlling the steering wheel via 0x302 is easier than via 0x9f.</li>
</ul>
<h3 id="demo">DEMO</h3>
<pre tabindex="0"><code>def create_pla_control(sendestatus, positive, degree):
    data = bytearray(bytes(24))
    data[1] = 0x40
    # PLA_QFK_Spuerb
    data[2] = 0xFA
    # PLA_QFK_KruemmSoll
    data = set_value(data, degree, 32, 15)
    # PLA_QFK_KruemmSoll_VZ
    if positive:
        data = set_value(data, 1, 47, 1)
    else:
        data = set_value(data, 0, 47, 1)
    
    # PLA_05_Sendestatus
    if sendestatus:
        data = set_value(data, 1, 74, 1)
    else:
        data = set_value(data, 0, 74, 1)
    return data

hca_01_counter = 0
degree = 0
for i in range(20):
    # data = create_steering_control(10 * i, 1)
    # meb_can_send(0x126, 0.1, data)
    degree += 0x10
    data = create_pla_control(1, 1, degree)
    can_send(0x302, 0.1, data)
</code></pre><h3 id="rpi-can-hat">RPi CAN HAT</h3>
<p>This steering control demo only makes the steering wheel move. To implement true remote driving, you need knowledge of dynamics and you must design a control algorithm.</p>
<pre tabindex="0"><code>import os
import can
import time

can0 = can.interface.Bus(channel = &#39;can0&#39;, bustype = &#39;socketcan&#39;, fd=True, bitrate=500000)

# msg = can.Message(is_extended_id=False, arbitration_id=0x123, data=[0, 1, 2, 3, 4, 5, 6, 7])
# can0.send(msg)

MEB_Kennungsfolge = {
    # LWI_01 Steering Angle
    0x86: [0x86, 0x86, 0x86, 0x86, 0x86, 0x86, 0x86, 0x86, 0x86, 0x86, 0x86, 0x86, 0x86, 0x86, 0x86, 0x86],
    # LH_EPS_03 Electric Power Steering
    0x9F: [0xF5, 0xF5, 0xF5, 0xF5, 0xF5, 0xF5, 0xF5, 0xF5, 0xF5, 0xF5, 0xF5, 0xF5, 0xF5, 0xF5, 0xF5, 0xF5],
    # HCA_01 Heading Control Assist
    0x126: [0xDA, 0xDA, 0xDA, 0xDA, 0xDA, 0xDA, 0xDA, 0xDA, 0xDA, 0xDA, 0xDA, 0xDA, 0xDA, 0xDA, 0xDA, 0xDA],
    # GRA_ACC_01 Steering wheel controls for ACC
    0x12B: [0x6A, 0x38, 0xB4, 0x27, 0x22, 0xEF, 0xE1, 0xBB, 0xF8, 0x80, 0x84, 0x49, 0xC7, 0x9E, 0x1E, 0x2B]
}

def volkswagen_mqb_checksum(address, data):
    global crc8_lut_8h2f
    crc = 0xFF  # CRC8 8H2F/AUTOSAR

    for i in range(1, len(data)):
        crc = crc ^ data[i]
        # print(hex(crc), hex(i))
        crc = crc8_lut_8h2f[crc]

    counter = data[1] &amp; 0x0F
    if address in MEB_Kennungsfolge:
        crc ^= MEB_Kennungsfolge[address][counter]
    else:
        print(&#34;Attempt to CRC check undefined Volkswagen message 0x%02X&#34; % address)
        crc ^= [0x00] * 16  # é»˜è®¤æƒ…å†µä¸‹ï¼Œè¿”å›å…¨ 0

    crc = crc8_lut_8h2f[crc]  # æ ‡å‡† CRC8 8H2F/AUTOSAR æœ€åä¸€ä¸ª XOR
    return crc ^ 0xFF

def gen_crc_lookup_table_8(poly):
    crc_lut = [0] * 256
    for i in range(256):
        crc = i
        for j in range(8):
            if crc &amp; 0x80:
                crc = (crc &lt;&lt; 1) ^ poly
            else:
                crc &lt;&lt;= 1
        crc_lut[i] = crc &amp; 0xFF
    return crc_lut

def meb_can_send(can_id, interval, data):
    global hca_01_counter
    data[1] = data[1] | hca_01_counter
    crc = volkswagen_mqb_checksum(can_id, data)
    data[0] = crc
    hca_01_counter += 1
    for j in data:
        print(hex(j), end=&#34;, &#34;)
    time.sleep(interval)
    msg = can.Message(is_extended_id=False, arbitration_id=can_id, data=data, is_fd=True)
    can0.send(msg)
    
def can_send(can_id, interval, data):
    time.sleep(interval)
    msg = can.Message(is_extended_id=False, arbitration_id=can_id, data=data, is_fd=True)
    can0.send(msg)

crc8_lut_8h2f = gen_crc_lookup_table_8(0x2f)

def set_value(data, value, start_pos, value_length):
    end_pos = start_pos + value_length
    for bit_index in range(start_pos, end_pos):
        byte_index = bit_index // 8
        bit_offset = bit_index % 8
        bit_value = (value &gt;&gt; (bit_index - start_pos)) &amp; 1
        # print(&#34;\n&#34;)
        # print(&#34;index&#34;, bit_index, start_pos, end_pos, &#34;byte_index:&#34;, byte_index, &#34;bit_offset:&#34;, bit_offset, &#34;v:&#34;, bit_value)
        if bit_value:
            data[byte_index] |= 1 &lt;&lt; bit_offset
        else:
            data[byte_index] &amp;= ~(1 &lt;&lt; bit_offset)
    # for i in data:
    #     print(bin(i), end=&#34;,&#34;)
    return data

def set_bit(b, bit, bit_index):
    if bit_index &lt; 0 or bit_index &gt; 7:
        raise ValueError(&#34;bit_index must be between 0 and 7&#34;)
    mask = 1 &lt;&lt; bit_index
    flipped_byte = b ^ mask
    return flipped_byte

def create_steering_control(apply_steer, lkas_enabled):
    data = bytearray(bytes(8))
    if lkas_enabled:
        # HCA_01_Sendestatus
        data = set_value(data, 5, 30, 1)
        # HCA_01_Status_HCA
        data = set_value(data, 1, 32, 4)
    else:
        # HCA_01_Sendestatus
        data = set_value(data, 3, 30, 1)
        # HCA_01_Status_HCA
        data = set_value(data, 0, 32, 4)
    # HCA_01_LM_Offset
    print(&#34;create_steering_control&#34;, apply_steer)
    data = set_value(data, abs(apply_steer), 16, 9)
    # HCA_01_LM_OffSign
    v = 1 if apply_steer &lt; 0 else 0
    data = set_value(data, v, 31, 1)
    # HCA_01_Vib_Freq
    data = set_value(data, 3, 12, 4)
    # HCA_01_Vib_Amp
    data = set_value(data, 10, 36, 4)
    return data

def create_pla_control(sendestatus, positive, degree):
    data = bytearray(bytes(24))
    data[1] = 0x40
    # PLA_QFK_Spuerb
    data[2] = 0xFA
    # PLA_QFK_KruemmSoll
    data = set_value(data, degree, 32, 15)
    # PLA_QFK_KruemmSoll_VZ
    if positive:
        data = set_value(data, 1, 47, 1)
    else:
        data = set_value(data, 0, 47, 1)
    
    # PLA_05_Sendestatus
    if sendestatus:
        data = set_value(data, 1, 74, 1)
    else:
        data = set_value(data, 0, 74, 1)
    return data

hca_01_counter = 0
degree = 0
for i in range(20):
    # data = create_steering_control(10 * i, 1)
    # meb_can_send(0x126, 0.1, data)
    degree += 0x10
    data = create_pla_control(1, 1, degree)
    can_send(0x302, 0.1, data)
</code></pre><h2 id="notes">Notes</h2>
<ol>
<li>Before leaving the vehicle, make sure the CAN bus remains powered on; otherwise it may drain a lot of battery.</li>
<li>Do not fuzz the Powertrain and Running Gear CAN buses. It can directly cause personal injury, and it may also trigger ECU abnormal behavior and introduce hidden risks (e.g., turn signals failing, mirrors not unfolding).</li>
</ol>
</article><section class="article labels"><a class="category" href=/en/categories/automotive-security/>Automotive Security</a><a class="tag" href=/en/tags/id%2e4/>ID.4</a><a class="tag" href=/en/tags/icas1/>ICAS1</a><a class="tag" href=/en/tags/can-bus/>CAN-Bus</a></section>
</div>
<div class="article bottom"><section class="article navigation"><p><a class="link" href="/en/posts/igs-arcade-re-1/"><span class="iconfont icon-article"></span>IGS Arcade Reverse Engineering Series (1) - E2000 Platform Analysis</a></p><p><a class="link" href="/en/posts/qnx7-password-hash-analysis-and-hashcat-module/"><span class="iconfont icon-article"></span>QNX 7 Password Hash Analysis and Writing a Hashcat Module</a></p></section></div></section><section id="footer"><div class="footer-wrap">
    <p class="copyright">2015 - 2026 Gorgias' Blog. </p><p class="license">
        <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noopener noreferrer">
            <img alt="CC BY-NC-SA" loading="lazy" src="/images/by-nc.svg" style="vertical-align: middle; height: 1.2em; margin: 0 0.2em;" />
            CC BY-NC-SA 4.0
        </a>
        (Attribution-NonCommercial-ShareAlike).
    </p><p class="powerby"><span>Powered&nbsp;by&nbsp;</span><a href="https://gohugo.io" 
        target="_blank" rel="noopener noreferrer">Hugo</a><span>&nbsp;&amp;&nbsp;</span><a href="https://themes.gohugo.io/hugo-notepadium/" 
        target="_blank" rel="noopener noreferrer">Notepadium</a></p></div></section></body>

</html>