<!DOCTYPE html>
<html lang="en"><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset="utf-8"><meta name="generator" content="Hugo 0.147.8"><meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<meta name="color-scheme" content="light dark">
<meta name="supported-color-schemes" content="light dark"><meta name="description" content="前言
SD卡(Secure Digital Memory Card)是一种存储介质，基于NAND闪存技术，作为MMC(Multimedia Card)的替代。一般用于多媒体播放器，相机，手机，随后也大量用于IoT设备和汽车电子。根据SD卡尺寸，可以分为SD、miniSD、microSD。"><title>固件提取系列 - SD卡解锁&nbsp;&ndash;&nbsp;Gorgias&#39; Blog</title><link rel="stylesheet" href="/css/core.min.63f706677e61b4ee62b8daf083358d3bbf8ac8ab03c7d171af3180fab3a3ebb83efb79fb98674f13dde6db11de2bf694.css" integrity="sha384-Y/cGZ35htO5iuNrwgzWNO7&#43;KyKsDx9FxrzGA&#43;rOj67g&#43;&#43;3n7mGdPE93m2xHeK/aU"><meta name="twitter:card" content="summary" />
<meta name="twitter:title" content="固件提取系列 - SD卡解锁" /><body><section id="header">
    <div class="header wrap"><span class="header left-side"><a class="site home" href="/"><span class="site name">Gorgias' Blog</span></a></span>
        <span class="header right-side"><div class="nav wrap"><nav class="nav"><a class="nav item" href="/categories/">Categories</a><a class="nav item" href="/tags/">Tags</a><a class="nav item" href="/about">About</a><a class="nav item" href="/links">Links</a></nav></div></span></div></section><section id="content"><div class="article-container"><section class="article header">
    <h1 class="article title">固件提取系列 - SD卡解锁</h1><p class="article date">Thursday, October 18, 2018</p></section><article class="article markdown-body"><h2 id="前言">前言</h2>
<p>SD卡(Secure Digital Memory Card)是一种存储介质，基于NAND闪存技术，作为MMC(Multimedia Card)的替代。一般用于多媒体播放器，相机，手机，随后也大量用于IoT设备和汽车电子。根据SD卡尺寸，可以分为SD、miniSD、microSD。</p>
<p><img loading="lazy"  src="./sd_size.png"
        alt="sd_size"/></p>
<p>SD卡的速度等级标准当前在用的有两种，一种是普通速度标记，另一种是UHS速度标记，不同速度标准对应的总线模式也不同。现在SD协会又出了新的速度等级标准：Video Speed Class，使用UHS总线。SD卡的容量也有标准，从SDSC到SDUC。</p>
<p><img loading="lazy"  src="./Micro-SD-speeds.png"
        alt="Micro-SD-speeds"/>
<img loading="lazy"  src="./bus_speed_img.jpg"
        alt="bus_speed_img"/></p>
<p>SD卡的参数可以在SD卡的贴纸或者丝印上看到。</p>
<p><img loading="lazy"  src="./sd_sticker.png"
        alt="sd_sticker"/></p>
<p>而microSD卡原名是TF卡(Trans-flash Card)，SD插槽兼容MMC卡，也可以通过飞线方式将eMMC接到SD插槽。</p>
<p><img loading="lazy"  src="./sd_emmc.png"
        alt="sd_emmc"/></p>
<p>本文基于SD物理层简化规范第六版，主要研究解锁机制。</p>
<p>SDIO(Secure Digital Input Output)是由SD物理层规范修改而来，属于SD规范的扩展，除了支持SDIO规范的储存卡，还支持SDIO外围设备，例如WiFi模块、GPS模块、CMOS传感器模块等。</p>
<h2 id="io-informations">I/O informations</h2>
<p>下面是MMC卡和SD卡引脚的对比</p>
<p><img loading="lazy"  src="./pin_compare.gif"
        alt="pin_compare"/></p>
<p>在不同的总线协议和传输模式下，这些引脚都负责不同的功能，本文主要研究SD模式的规范。在Type一栏，有如下定义：</p>
<ul>
<li>S - Power Supply</li>
<li>I - Input</li>
<li>O - Output using Pull Push Drivers</li>
<li>PP - I/O using Pull Push Drivers</li>
</ul>
<table>
  <thead>
      <tr>
          <th>Pin #</th>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>1</td>
          <td>CD/DAT3</td>
          <td>I/O/PP</td>
          <td>Card Detect/Data Line [Bit3]</td>
      </tr>
      <tr>
          <td>2</td>
          <td>CMD</td>
          <td>I/O/PP</td>
          <td>Command/Response</td>
      </tr>
      <tr>
          <td>3</td>
          <td>VSS1</td>
          <td>S</td>
          <td>Supply voltage ground</td>
      </tr>
      <tr>
          <td>4</td>
          <td>VDD</td>
          <td>S</td>
          <td>Supply voltage</td>
      </tr>
      <tr>
          <td>5</td>
          <td>CLK</td>
          <td>I</td>
          <td>Clock</td>
      </tr>
      <tr>
          <td>6</td>
          <td>VSS2</td>
          <td>S</td>
          <td>Supply voltage ground</td>
      </tr>
      <tr>
          <td>7</td>
          <td>DAT0</td>
          <td>I/O/PP</td>
          <td>Data Line [Bit0]</td>
      </tr>
      <tr>
          <td>8</td>
          <td>DAT1</td>
          <td>I/O/PP</td>
          <td>Data Line [Bit1]</td>
      </tr>
      <tr>
          <td>9</td>
          <td>DAT2</td>
          <td>I/O/PP</td>
          <td>Data Line [Bit2]</td>
      </tr>
  </tbody>
</table>
<p>下面是我们要研究的SD卡，SDSC，刚好最大2GB，上面印着M2B9 2GB Made in Japan，网上不能搜索到这些信息。</p>
<p><img loading="lazy"  src="./SD_card_internal.jpg"
        alt="SD_card_internal"/></p>
<p>再看SD主控芯片，56X31B002 AC00145R，无法搜索到。
但是下面的存储芯片印有镁光Logo，在<a href="https://www.micron.com/decoder"target="_blank" rel="noopener noreferrer">FBGA &amp; Component Marking Decoder</a>网站可以查询FPGA Code。是SLC NAND Flash，VBGA100封装，但是官网信息不太准确，只有16GB的版本。</p>
<p><img loading="lazy"  src="./SD_card_internal2.jpg"
        alt="SD_card_internal2"/></p>
<h2 id="registers">Registers</h2>
<p>OCR,CID,CSD,SCR携带了卡的特定信息，RCA和DSR储存着实际的配置参数，SSR和CSR则携带状态信息。
因为规范制定者有强迫症，所以寄存器都是三位缩写，如果三位不能准确表达意思，就把R去掉。</p>
<table>
  <thead>
      <tr>
          <th>Name</th>
          <th>length(bit)</th>
          <th>Description</th>
          <th>Optional</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>CID</td>
          <td>128</td>
          <td>Card Identification Data，包括厂商ID、OEM ID、产品名、产品编号、生产日期以及校验和</td>
          <td>必选</td>
      </tr>
      <tr>
          <td>RCA</td>
          <td>16</td>
          <td>Relative Card Address，用于寻址，默认0x0000，SPI模式下不可用</td>
          <td>必选</td>
      </tr>
      <tr>
          <td>DSR</td>
          <td>16</td>
          <td>Driver Stage Register，用于改善总线性能</td>
          <td>可选</td>
      </tr>
      <tr>
          <td>CSD</td>
          <td>128</td>
          <td>Card Special Data，较为复杂，包含关于卡各种操作的条件信息：错误类型、最大数据访问时间、速率、DSR可用状态等</td>
          <td>必选</td>
      </tr>
      <tr>
          <td>SCR</td>
          <td>64</td>
          <td>SD Configuration Register，包含了SD卡支持的特性，规范版本</td>
          <td>必选</td>
      </tr>
      <tr>
          <td>OCR</td>
          <td>32</td>
          <td>Operation Condition Register，携带了当前电源信息</td>
          <td>必选</td>
      </tr>
      <tr>
          <td>SSR</td>
          <td>512</td>
          <td>SD Status Register，包含当前SD卡特性和应用特性的状态信息，如总线数据宽度、安全模式、SD卡类型、速度等</td>
          <td>必选</td>
      </tr>
      <tr>
          <td>CSR</td>
          <td>32</td>
          <td>Card Status Register，包含了当前卡执行命令的状态信息，体现在响应中，如上锁状态，错误信息等</td>
          <td>必选</td>
      </tr>
  </tbody>
</table>
<h2 id="architecture">Architecture</h2>
<p>卡内带有上电检测电路，与主控接口和存储区接口相连，每个引脚和卡主控相连，主控通过存储接口对存储区进行操作。</p>
<p><img loading="lazy"  src="./architecture.png"
        alt="architecture"/></p>
<h3 id="sdio">SDIO</h3>
<p>而在SDIO规范中，定义了两种类型的SDIO卡：低速卡与高速卡，定义了SDIO卡的三种模式：</p>
<ul>
<li>SPI bus mode</li>
<li>One-bit SD bus mode - 指令和数据分离的传输模式</li>
<li>Four-bit SD bus mode - 高速卡支持，指令单独占用一个通道，使用另外4通道传输数据，SD卡的默认模式</li>
</ul>
<h2 id="sd-bus-protocol">SD Bus Protocol</h2>
<p>SD总线通信主要由CMD(Command Token, 操作命令)、DAT(Data, 数据)组成。CMD和DAT由不同的通道并行传输，CMD和Response走同一条通道，CMD来自Host(上位机)，Response(响应)来自SD卡，Response只针对特定的CMD出现。</p>
<p><img loading="lazy"  src="./sd_protocal.png"
        alt="sd_protocal"/></p>
<p>SD规定以块为单位进行读写操作，紧随着CMD后出现。每个数据块结尾带有CRC校验位。由终止操作由终止指令完成。</p>
<p><img loading="lazy"  src="./sd_protocal_r.png"
        alt="sd_protocal_r"/></p>
<p>写过程会附带一个busy信号。</p>
<p><img loading="lazy"  src="./sd_protocal_w.png"
        alt="sd_protocal_w"/></p>
<h3 id="cmd-format">CMD Format</h3>
<p>Command Token的长度是48-bit，起始位是0，传输位是1，表示来自Host的数据。Content携带了命令，地址信息以及参数。结尾带有7位的CRC(Cyclic Redundancy Check)，结束位是0。因为这个特性，Response的首个字节比CMD的首个字节小0x40。</p>
<p><img loading="lazy"  src="./cmd_format.png"
        alt="cmd_format"/></p>
<p>Response Token有四种场景，根据场景的不同采用不同的长度，分别是48-bit(R1,R3,R6)，136-bit(R2)。传输位是0，表示来自SD卡的数据。</p>
<p><img loading="lazy"  src="./response_format.png"
        alt="response_format"/></p>
<h3 id="data-packet-format">Data Packet Format</h3>
<p>通常模式下，数据通过DAT[0-3]引脚传输。和CMD一样，起始位0，结束位1，带有CRC校验。总线宽度默认1-bit。</p>
<p><img loading="lazy"  src="./data_packet_format.png"
        alt="data_packet_format"/></p>
<h3 id="crc7">CRC7</h3>
<p>SD卡使用CRC7/MMC算法作为CMD的校验，公式如下
<img loading="lazy"  src="./crc7_calc.png"
        alt="crc7_calc"/>
将多项式转化为二进制G(x)</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">10001001
</span></span></code></pre></div><p>在数据帧M(x)后补上长度位divisor-1，就是7，使用模2除法，数据帧除以10001001得到CRC</p>
<p><img loading="lazy"  src="./crc7.png"
        alt="crc7"/></p>
<h3 id="crc16">CRC16</h3>
<p>SD卡使用CRC-16/CCITT-XMODEM算法作为Data的校验。宽总线模式下每行独立计算CRC，公式如下</p>
<p><img loading="lazy"  src="./crc16_calc.png"
        alt="crc16_calc"/></p>
<p>将多项式转化为二进制G(x)，第16位超出长度，忽略。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">0001000000100001
</span></span></code></pre></div><p><img loading="lazy"  src="./crc16.png"
        alt="crc16"/></p>
<h2 id="response-type">Response Type</h2>
<p>SD卡总共有五种类型的响应，SDIO支持附加的响应类型R4，R5。除R3以外，响应包的结尾都有CRC校验。</p>
<ul>
<li>R1 正常响应命令，可携带busy信号(R1b)</li>
<li>R2 CID,CSD响应</li>
<li>R3 OCR响应</li>
<li>R6 RCA响应</li>
<li>R7 卡接口条件响应</li>
</ul>
<h3 id="不同响应对应的格式">不同响应对应的格式</h3>
<p>R1的参数部分是32位，对应了卡的状态，由于版本迭代问题，规范里没有明确说是CSR，CSR寄存器也是后面定义的。R2直接返回CID或CSD的数据。R3返回OCR的数据。</p>
<p><img loading="lazy"  src="./response_r1.png"
        alt="response_r1"/>
<img loading="lazy"  src="./response_r2.png"
        alt="response_r2"/>
<img loading="lazy"  src="./response_r3.png"
        alt="response_r3"/>
<img loading="lazy"  src="./response_r6.png"
        alt="response_r6"/>
<img loading="lazy"  src="./response_r7.png"
        alt="response_r7"/></p>
<h2 id="function-mode">Function mode</h2>
<p>SD卡的操作模式有两种种，默认是inactive：</p>
<ul>
<li>card indentification mode 卡认证模式</li>
<li>data transfer mode 数据传输模式</li>
</ul>
<p>UHS-II下和SD模式下，卡认证模式不同。</p>
<h2 id="command">Command</h2>
<p>Command主要有两种类型————广播和寻址，具体细分有如下四种:</p>
<ul>
<li>broadcast commands (bc), no response</li>
<li>broadcast commands with response (bcr) (Note: No open drain on SD card)</li>
<li>addressed (point-to-point) commands (ac), no data transfer on DAT lines</li>
<li>addressed (point-to-point) data transfer commands (adtc), data transfer on DAT lines</li>
</ul>
<p>CMD5，CMD52-54是SDIO特有的模式</p>
<p>最高有效位(Most Significant Bit, MSB)在前，最低有效位(Least Significant Bit, LSB)在后。</p>
<p><img loading="lazy"  src="./command_format.png"
        alt="command_format"/></p>
<p>有如下分类：</p>
<table>
  <thead>
      <tr>
          <th>Class #</th>
          <th>Name</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>0</td>
          <td>Basic Commands</td>
      </tr>
      <tr>
          <td>1</td>
          <td>Command and Queue Function Commands</td>
      </tr>
      <tr>
          <td>2</td>
          <td>Block Oriented Read Commands</td>
      </tr>
      <tr>
          <td>3</td>
          <td>Reversed</td>
      </tr>
      <tr>
          <td>4</td>
          <td>Block Oriented Write Commands</td>
      </tr>
      <tr>
          <td>5</td>
          <td>Erase Commands</td>
      </tr>
      <tr>
          <td>6</td>
          <td>Block Oriented Write Protection Commands</td>
      </tr>
      <tr>
          <td>7</td>
          <td>Lock Card</td>
      </tr>
      <tr>
          <td>8</td>
          <td>Application Specific Commands</td>
      </tr>
      <tr>
          <td>9</td>
          <td>I/O Mode Commands</td>
      </tr>
      <tr>
          <td>10</td>
          <td>Switch Function Commands</td>
      </tr>
      <tr>
          <td>11</td>
          <td>Function Extension Commands</td>
      </tr>
  </tbody>
</table>
<p>Class 7 锁卡相关命令有三个，其中CMD16设定块长度，用来设置密码。CMD42进行上锁/解锁操作。上锁状态的卡可以响应Class 0的命令.</p>
<p><img loading="lazy"  src="./card_lock_class.png"
        alt="card_lock_class"/></p>
<p>在SDSC卡中，可通过SET_BLOCK_LEN来指定数据的块长度。而在SDHC和SDXC卡中，块长度固定为512bytes。</p>
<h2 id="application-specific-commands">Application-Specific Commands</h2>
<p>Application-Specific Commands是Commands的扩展，CMD55是触发ACMD的条件，ACMD41也就是CMD55接一个CMD41。</p>
<p>ACMD41是初始化命令，设定HCS(Host Capacity Support)，决定SD卡的类型，电源控制以及电平。ACMD6是设置总线宽度，决定使用1-bit还是4-bits的Data传输。只有未解锁和传输状态才能使用ACMD6。</p>
<h2 id="status-information">Status Information</h2>
<p>SD卡状态信息可以在R1类型的响应里看到，比如CMD13，SD卡有三种状态信息：</p>
<ul>
<li>SD Status</li>
<li>Card Status</li>
<li>Task Status</li>
</ul>
<p>下面是每一位的类型定义：</p>
<p>E - Error bit
S - Status bit
R - Detected and set for the actual command response
X - Detected and set during command execution. 上位机可以通过执行命令的响应获得状态信息</p>
<p>还有状态位的清除条件：</p>
<p>A - According to the card current status.
B - Always related to the previous command. 发送特定CMD来清除
C - Clear by read.</p>
<p>R1响应携带卡状态信息，长度32-bit，储存在CSR。下面是CSR每一位的定义，预留位已经省略。</p>
<table>
  <thead>
      <tr>
          <th>Bits</th>
          <th>Identifier</th>
          <th>Type</th>
          <th>Value</th>
          <th>Description</th>
          <th>Clear Condition</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>31</td>
          <td>OUT_OF_RANGE</td>
          <td>E R X</td>
          <td>&lsquo;0&rsquo;= no error<br/>&lsquo;1&rsquo;= error</td>
          <td>The command&rsquo;s argument was out of the allowed range for this card.</td>
          <td>C</td>
      </tr>
      <tr>
          <td>30</td>
          <td>ADDRESS_ERROR</td>
          <td>E R X</td>
          <td>&lsquo;0&rsquo;= no error<br/>&lsquo;1&rsquo;= error</td>
          <td>A misaligned address which did not match the block length was used in the command.</td>
          <td>C</td>
      </tr>
      <tr>
          <td>29</td>
          <td>BLOCK_LEN_ERROR</td>
          <td>E R X</td>
          <td>&lsquo;0&rsquo;= no error<br/>&lsquo;1&rsquo;= error</td>
          <td>The transferred block length is not allowed for this card, or the number of transferred bytes does not match the block length.</td>
          <td>C</td>
      </tr>
      <tr>
          <td>28</td>
          <td>ERASE_SEQ_ERROR</td>
          <td>E R</td>
          <td>&lsquo;0&rsquo;= no error<br/>&lsquo;1&rsquo;= error</td>
          <td>An error in the sequence of erasecommands occurred.</td>
          <td>C</td>
      </tr>
      <tr>
          <td>27</td>
          <td>ERASE_PARAM</td>
          <td>E R X</td>
          <td>&lsquo;0&rsquo;= no error<br/>&lsquo;1&rsquo;= error</td>
          <td>An invalid selection of write-blocksfor erase occurred.</td>
          <td>C</td>
      </tr>
      <tr>
          <td>26</td>
          <td>WP_VIOLATION</td>
          <td>E R X</td>
          <td>&lsquo;0&rsquo;= no protected<br/>&lsquo;1&rsquo;= protected</td>
          <td>Set when the host attempts to writeto a protected block or to the temporary or permanent write protected card.</td>
          <td>C</td>
      </tr>
      <tr>
          <td>25</td>
          <td>CARD_IS_LOCKED</td>
          <td>S X</td>
          <td>&lsquo;0&rsquo;= card unlocked<br/>&lsquo;1&rsquo;= card locked</td>
          <td>When set, signals that the card is locked by the host.</td>
          <td>A</td>
      </tr>
      <tr>
          <td>24</td>
          <td>LOCK_UNLOCK_FAILED</td>
          <td>E R X</td>
          <td>&lsquo;0&rsquo;= no error<br/>&lsquo;1&rsquo;= error</td>
          <td>Set when a sequence or passworderror has been detected in lock/unlock card command.</td>
          <td>C</td>
      </tr>
      <tr>
          <td>23</td>
          <td>COM_CRC_ERROR</td>
          <td>E R</td>
          <td>&lsquo;0&rsquo;= no error<br/>&lsquo;1&rsquo;= error</td>
          <td>The CRC check of the previous command failed.</td>
          <td>B</td>
      </tr>
      <tr>
          <td>22</td>
          <td>ILLEGAL_COMMAND</td>
          <td>E R</td>
          <td>&lsquo;0&rsquo;= no error<br/>&lsquo;1&rsquo;= error</td>
          <td>Command not legal for the cardstate</td>
          <td>B</td>
      </tr>
      <tr>
          <td>21</td>
          <td>CARD_ECC_FAILED</td>
          <td>E R X</td>
          <td>&lsquo;0&rsquo;= no error<br/>&lsquo;1&rsquo;= error</td>
          <td>Card internal ECC was applied butfailed to correct the data.</td>
          <td>C</td>
      </tr>
      <tr>
          <td>20</td>
          <td>CC_ERROR</td>
          <td>E R X</td>
          <td>&lsquo;0&rsquo;= no error<br/>&lsquo;1&rsquo;= error</td>
          <td>Internal card controller error.</td>
          <td>C</td>
      </tr>
      <tr>
          <td>19</td>
          <td>ERROR</td>
          <td>E R X</td>
          <td>&lsquo;0&rsquo;= no error<br/>&lsquo;1&rsquo;= error</td>
          <td>A general or an unknown error occurred during the operation.</td>
          <td>C</td>
      </tr>
      <tr>
          <td>16</td>
          <td>CSD_OVERWRITE</td>
          <td>E R X</td>
          <td>&lsquo;0&rsquo;= no error<br/>&lsquo;1&rsquo;= error</td>
          <td>Can be either one of the following errors: <br/>- The read only section of the CSD does not match the card content. <br/>- An attempt to reverse the copy (set as original) or permanent WP (unprotected) bits was made.</td>
          <td>C</td>
      </tr>
      <tr>
          <td>15</td>
          <td>WP_ERASE_SKIP</td>
          <td>E R X</td>
          <td>&lsquo;0&rsquo;= no protected<br/>&lsquo;1&rsquo;= protected</td>
          <td>Set when only partial address space was erased due to existing write protected blocks or the temporary or permanent write protected card was erased.</td>
          <td>C</td>
      </tr>
      <tr>
          <td>14</td>
          <td>CARD_ECC_DISABLED</td>
          <td>S X</td>
          <td>&lsquo;0&rsquo;= enabled<br/>&lsquo;1&rsquo;= disabled</td>
          <td>The command has been executed without using the internal ECC.</td>
          <td>A</td>
      </tr>
      <tr>
          <td>13</td>
          <td>ERASE_RESET</td>
          <td>S R</td>
          <td>&lsquo;0&rsquo;= cleared<br/>&lsquo;1&rsquo;= set</td>
          <td>An erase sequence was cleared before executing because an out of erase sequence command was received.</td>
          <td>C</td>
      </tr>
      <tr>
          <td>12:9</td>
          <td>CURRENT_STATE</td>
          <td>S X</td>
          <td>0 = idle<br/>1 = ready<br/>2 = ident<br/>3 = stby<br/>4 = tran<br/>5 = data<br/>6 = rcv<br/>7 = prg<br/>8 = dis<br/>9-14 = reserved<br/>15 = reserved for<br/>I/O mode</td>
          <td>The state of the card when receiving the command. If the command execution causes a state change, it will be visible to the host in the response to the next command.<br/> The four bits are interpreted as a binary coded number between 0 and 15.</td>
          <td>B</td>
      </tr>
      <tr>
          <td>8</td>
          <td>READY_FOR_DATA</td>
          <td>S X</td>
          <td>&lsquo;0&rsquo;= not ready<br/>&lsquo;1&rsquo;= ready</td>
          <td>Corresponds to buffer empty signaling on the bus.</td>
          <td>A</td>
      </tr>
      <tr>
          <td>6</td>
          <td>FX_EVENT</td>
          <td>S X</td>
          <td>&lsquo;0&rsquo;= No event<br/>&lsquo;1&rsquo;= Event invoked</td>
          <td>Extension Functions may set this bit to get host to deal with events.</td>
          <td>A</td>
      </tr>
      <tr>
          <td>5</td>
          <td>APP_CMD</td>
          <td>S R</td>
          <td>&lsquo;0&rsquo;= enabled<br/>&lsquo;1&rsquo;= disabled</td>
          <td>The card will expect ACMD, or an indication that the command has been interpreted as ACMD.</td>
          <td>C</td>
      </tr>
      <tr>
          <td>3</td>
          <td>AKE_SEQ_ERROR(SD Memory Card app. spec.)</td>
          <td>E R</td>
          <td>&lsquo;0&rsquo;= no error<br/>&lsquo;1&rsquo;= error</td>
          <td>Error in the sequence of the authentication process.</td>
          <td>C</td>
      </tr>
  </tbody>
</table>
<p>12:9是4位长度，转成10进制，对应着卡的操作阶段
<img loading="lazy"  src="./state_mode.png"
        alt="state_mode"/></p>
<h2 id="sd-protocol-sniff">SD Protocol Sniff</h2>
<p>等长布线(wiring length maching)是PCB设计领域的术语，一般用于高速IO，比如DDR。飞线尽量使用等长线，控制时钟线与其他信号线之间的距离，这也是SD卡厂商对于PCB设计的要求。</p>
<p><img loading="lazy"  src="./wiring.jpg"
        alt="wiring"/></p>
<p>实际上SD高速模式下也就20MHz，是否使用等长线对数据的影响不大。最关键的还是逻辑分析仪的采样率，一开始使用100MHz采样率的逻辑分析仪经常乱码，后来换成500MHz采样率的LA5016就能正常使用。</p>
<p><img loading="lazy"  src="./LA5016.jpg"
        alt="LA5016"/></p>
<p>选择采样率和时间，另外选择电平。选择SDIO以及时钟上升沿(rising edge)触发。这样就能得到准确的逻辑电平。如下图，当上升沿对应的数据为0。</p>
<p><img loading="lazy"  src="./rising_edge.png"
        alt="rising_edge"/></p>
<h2 id="sd-unlock">SD Unlock</h2>
<p>解锁的会话只在一次上电中生效，下一次上电时SD卡会自动回到上锁状态。解锁过程首先使用CMD7选择卡，如果设置了FEP，那么需要解锁COP。然后使用CMD16设置所需块长度，8-bit解锁操作 + 8-bit密码长度 + 实际密码的长度，最后发送CMD42解锁。</p>
<p><img loading="lazy"  src="./unlock_operations.png"
        alt="unlock_operations"/></p>
<h3 id="cmd-42">CMD 42</h3>
<p>CMD42用于解锁设备，有V1.0和V2.0两个版本。解锁方式也有两种，一种是使用强制擦除密码(Force Erase Password, FEP)，另一种是使用密码解锁。只有COP(Card Ownership Protection)特性的SD卡，才带有非易失性的FEP寄存器。COP特性是SD规范6.0中新加的，市面上几乎很少有COP特性的SD卡。
根据CMD的格式，01代表CMD请求，101010代表42，推断出01101010是CMD42的第一个字节，也就是6A。
CMD42的参数前4个bit应该是0，CSR的对应状态位bit-25应该由1变为0，bit-24为0。</p>
<p><img loading="lazy"  src="./unlock_parameters.png"
        alt="unlock_parameters"/></p>
<p>通过逻辑分析仪解析上位机和SD卡之间的通信数据，得到了下面的报文，Command Index,Arguments,CRC7都符合前面的定义。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">6A 00 00 00 00 51
</span></span></code></pre></div><p>最后一个字节51可以通过CRC7校验</p>
<p>本文研究的目标设备较老，不支持COP，解锁上锁位的0代表解锁操作，1代表上锁。最后使用CMD42，因此CMD42的操作参数是00000000，也就是CMD42[00h]</p>
<p>CMD42的Data部分，第一个字节描述了具体的操作，前三位预留，一般置0，第四位表示COP特性，在解锁过程中，后面四位都应该是0。第二个字节表示Password Length区间为8-bit，单位是byte。因此password最大长度是128-bytes，因此密码长度最大16字节，从第三位开始都是密码数据，最后带上16位的CRC。</p>
<p><img loading="lazy"  src="./password.png"
        alt="password"/></p>
<p>CMD7的地址随机</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">47 4B 47 00 00 6F
</span></span><span class="line"><span class="cl">[47:41] 01000111  start bit + Command index
</span></span><span class="line"><span class="cl">[40:32] 01001011  RCA 4B
</span></span><span class="line"><span class="cl">[31:24] 01000111  RCA 47
</span></span><span class="line"><span class="cl">[23:16] 00000000  stuff bits
</span></span><span class="line"><span class="cl">[15:8]  00000000
</span></span><span class="line"><span class="cl">[7:0]   01101111  CRC7 + end bit
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">07 02 00 07 00 79
</span></span></code></pre></div><p>CMD16命令如下, 倒数第二行便是参数SET_BLOCKLEN，设置块长度，必须是偶数长度。响应类型是R1，0b00010010的十进制为18，也就是2字节的参数加上16-bytes密码</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">50 00 00 00 12 2F
</span></span><span class="line"><span class="cl">[47:41] 01010000  start bit + Command index
</span></span><span class="line"><span class="cl">[40:32] 00000000
</span></span><span class="line"><span class="cl">[31:24] 00000000
</span></span><span class="line"><span class="cl">[23:16] 00000000
</span></span><span class="line"><span class="cl">[15:8]  00010010  SET_BLOCKLEN
</span></span><span class="line"><span class="cl">[7:0]   00101111  CRC7 + end bit
</span></span></code></pre></div><p>CMD16的响应</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">10 02 00 09 00 07
</span></span><span class="line"><span class="cl">[47:41] 00010000  start bit + Command index
</span></span><span class="line"><span class="cl">[40:32] 00000010  Card Status
</span></span><span class="line"><span class="cl">[31:24] 00000000  Card Status
</span></span><span class="line"><span class="cl">[23:16] 00001001  Card Status
</span></span><span class="line"><span class="cl">[15:8]  00000000  Card Status
</span></span><span class="line"><span class="cl">[7:0]   00000111  CRC7 + end bit
</span></span></code></pre></div><p>CMD42响应的第一个字节为00101010也就是2A。响应类型是R1。</p>
<p>在逻辑分析仪抓取到了CMD42的响应</p>
<p>将Parameter字段转换成二进制，根据CSR定义，下面返回的状态是未解锁，ready,tran模式</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">2a <span class="m">02</span> <span class="m">00</span> <span class="m">09</span> <span class="m">00</span> 6f
</span></span><span class="line"><span class="cl"><span class="o">[</span>47:41<span class="o">]</span> <span class="m">00010000</span>  start bit + Command index
</span></span><span class="line"><span class="cl"><span class="o">[</span>40:32<span class="o">]</span> <span class="m">00000010</span>  Card Status Locked
</span></span><span class="line"><span class="cl"><span class="o">[</span>31:24<span class="o">]</span> <span class="m">00000000</span>  Card Status
</span></span><span class="line"><span class="cl"><span class="o">[</span>23:16<span class="o">]</span> <span class="m">00001001</span>  Card Status
</span></span><span class="line"><span class="cl"><span class="o">[</span>15:8<span class="o">]</span>  <span class="m">00000000</span>  Card Status
</span></span><span class="line"><span class="cl"><span class="o">[</span>7:0<span class="o">]</span>   <span class="m">00000111</span>  CRC7 + end bit
</span></span></code></pre></div><p>当CMD42的Data发送完成，再发送CMD13，根据CSR定义，下面返回的状态是已解锁，ready,tran模式，APP_CMD关闭</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">0D <span class="m">00</span> <span class="m">00</span> <span class="m">09</span> <span class="m">00</span> <span class="m">07</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>47:41<span class="o">]</span> <span class="m">00010000</span>  start bit + Command index
</span></span><span class="line"><span class="cl"><span class="o">[</span>40:32<span class="o">]</span> <span class="m">00000000</span>  Card Status Unlocked
</span></span><span class="line"><span class="cl"><span class="o">[</span>31:24<span class="o">]</span> <span class="m">00000000</span>  Card Status
</span></span><span class="line"><span class="cl"><span class="o">[</span>23:16<span class="o">]</span> <span class="m">00001001</span>  Card Status
</span></span><span class="line"><span class="cl"><span class="o">[</span>15:8<span class="o">]</span>  <span class="m">00000000</span>  Card Status
</span></span><span class="line"><span class="cl"><span class="o">[</span>7:0<span class="o">]</span>   <span class="m">01101111</span>  CRC7 + end bit
</span></span></code></pre></div><h3 id="analyze-data">Analyze Data</h3>
<p>在KingstVIS找到Data0的信道，在CMD42后面对齐上升沿截取区间，导出时钟信道和Data0信道为TXT。</p>
<p><img loading="lazy"  src="./exporting_data.png"
        alt="exporting_data"/></p>
<p>最后导出的数据实际上还是csv。在KingstVIS里选择CSV导出则为倒序，所以才选择TXT格式。这里字符编码是ANSI，在Linux下会乱码，所以把Title删除。</p>
<p><img loading="lazy"  src="./csv_data_exported.png"
        alt="csv_data_exported"/></p>
<p>通过下面的脚本，可以将Data0数据打印成可读数据。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="ch">#!/usr/bin/env python3</span>
</span></span><span class="line"><span class="cl"><span class="c1"># -*- coding: utf-8 -*-</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">csv</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">sys</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">getopt</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">binascii</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">parse_csv</span><span class="p">(</span><span class="n">csv_file</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">csv_file</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">reader</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">reader</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">last_ch0_v</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">            <span class="n">bits</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">reader</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">current_ch0_v</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">(</span><span class="n">current_ch0_v</span> <span class="o">^</span> <span class="n">last_ch0_v</span><span class="p">)</span> <span class="ow">and</span> <span class="n">last_ch0_v</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">bits</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">2</span><span class="p">])))</span>
</span></span><span class="line"><span class="cl">                <span class="n">last_ch0_v</span> <span class="o">=</span> <span class="n">current_ch0_v</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">bits</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">crc16_calc</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">crc</span> <span class="o">=</span> <span class="mh">0x0000</span>
</span></span><span class="line"><span class="cl">    <span class="n">poly</span> <span class="o">=</span> <span class="mh">0x1021</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">cur_byte</span> <span class="o">=</span> <span class="mh">0xFF</span> <span class="o">&amp;</span> <span class="n">b</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">8</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">bit</span> <span class="o">=</span> <span class="p">((</span><span class="n">cur_byte</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="mi">7</span><span class="o">-</span><span class="n">i</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">c15</span> <span class="o">=</span> <span class="p">((</span><span class="n">crc</span> <span class="o">&gt;&gt;</span> <span class="mi">15</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">crc</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">c15</span> <span class="o">^</span> <span class="n">bit</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="n">crc</span> <span class="o">^=</span> <span class="n">poly</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">crc</span> <span class="o">&amp;</span> <span class="mh">0xFFFF</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">usage</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">options</span><span class="p">,</span> <span class="n">args</span> <span class="o">=</span> <span class="n">getopt</span><span class="o">.</span><span class="n">getopt</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="s2">&#34;f:o&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">csv_file</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
</span></span><span class="line"><span class="cl">        <span class="n">output_file</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">opt</span><span class="p">,</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">options</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">opt</span> <span class="o">==</span> <span class="s1">&#39;-f&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">csv_file</span> <span class="o">=</span> <span class="n">arg</span>
</span></span><span class="line"><span class="cl">            <span class="k">elif</span> <span class="n">opt</span> <span class="o">==</span> <span class="s1">&#39;-o&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">output_file</span> <span class="o">=</span> <span class="n">arg</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">bits</span> <span class="o">=</span> <span class="n">parse_csv</span><span class="p">(</span><span class="n">csv_file</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">remainder</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">bits</span><span class="p">)</span> <span class="o">%</span> <span class="mi">8</span>
</span></span><span class="line"><span class="cl">        <span class="n">bits</span> <span class="o">=</span> <span class="n">bits</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">bits</span><span class="p">)</span> <span class="o">-</span> <span class="n">remainder</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">keys_list</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">        <span class="n">crc_data</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">        <span class="n">keys_len</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># 去掉Data的第一位标志位</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">bits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;0&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">bits</span> <span class="o">=</span> <span class="n">bits</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">bits</span><span class="p">),</span> <span class="mi">8</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="n">byte</span> <span class="o">=</span> <span class="n">bits</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">bits</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">bits</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">bits</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> \
</span></span><span class="line"><span class="cl">                    <span class="n">bits</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">4</span><span class="p">]</span> <span class="o">+</span> <span class="n">bits</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">5</span><span class="p">]</span> <span class="o">+</span> <span class="n">bits</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">6</span><span class="p">]</span> <span class="o">+</span> <span class="n">bits</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">7</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">                <span class="n">n</span> <span class="o">=</span> <span class="n">i</span><span class="o">/</span><span class="mi">8</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">byte</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                        <span class="n">keys_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">byte</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                    <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;CMD42 data block parameters error.&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                        <span class="n">exit</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                <span class="k">elif</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">keys_len</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">byte</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="n">keys_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">keys_len</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;Keys length: &#34;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">keys_len</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&#34;-bytes&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">elif</span> <span class="n">n</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">n</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="n">keys_len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                    <span class="n">keys_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">byte</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                <span class="k">elif</span> <span class="p">(</span><span class="n">keys_len</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">n</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="n">keys_len</span> <span class="o">+</span> <span class="mi">3</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                    <span class="n">crc_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">byte</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="p">(</span><span class="n">crc_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mi">16</span><span class="o">*</span><span class="mi">16</span> <span class="o">+</span> <span class="n">crc_data</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">==</span> <span class="n">crc16_calc</span><span class="p">(</span><span class="n">keys_list</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                        <span class="n">x</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="n">keys_list</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="n">keys_len</span><span class="o">+</span><span class="mi">2</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">                        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;Key:&#34;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">binascii</span><span class="o">.</span><span class="n">b2a_hex</span><span class="p">(</span><span class="n">x</span><span class="p">))[</span><span class="mi">2</span><span class="p">:(</span><span class="n">keys_len</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">                        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;CRC:&#34;</span><span class="p">,</span> <span class="nb">hex</span><span class="p">(</span><span class="n">crc16_calc</span><span class="p">(</span><span class="n">keys_list</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">                        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">Analyse compeleted!&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;CRC error!&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="n">exit</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;Data Error&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">usage</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">usage</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;Usage:python kinstvis_sdio_parser.py -f test.csv&#34;</span><span class="p">)</span>
</span></span></code></pre></div><p>去掉第一位起始位，解析CMD42 Data结构，再进行CRC校验，校验成功。</p>
<p><img loading="lazy"  src="./parse_key.png"
        alt="parse_key"/></p>
<p>密码如下</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">5ffca19ffcdb5899a82c4e265f99c76b
</span></span></code></pre></div><h2 id="mmc-utils">MMC Utils</h2>
<p>下一步是写SD解锁工具，镁光的官方文档提供了添加上锁解锁功能的Demo，通过修改mmc-utils可以实现解锁。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">git clone git://git.kernel.org/pub/scm/linux/kernel/git/cjb/mmc-utils.git
</span></span></code></pre></div><p>mmc-utils/mmc.h</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#define MMC_SET_BLOCKLEN        16 </span><span class="cm">/* ac [31:0] block len R1 */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define MMC_LOCK_UNLOCK         42 </span><span class="cm">/* adtc R1b */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define MMC_CMD42_UNLOCK        0x0 </span><span class="cm">/* UNLOCK */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define MMC_CMD42_SET_PWD       0x1 </span><span class="cm">/* SET_PWD */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define MMC_CMD42_CLR_PWD       0x2 </span><span class="cm">/* CLR_PWD */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define MMC_CMD42_LOCK          0x4 </span><span class="cm">/* LOCK */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define MMC_CMD42_SET_LOCK      0x5 </span><span class="cm">/* SET_PWD &amp; LOCK */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define MMC_CMD42_ERASE         0x8 </span><span class="cm">/* ERASE */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define MAX_PWD_LENGTH          32 </span><span class="cm">/* max PWDS_LEN: old+new */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define MMC_BLOCK_SIZE          512 </span><span class="cm">/* data blk size for cmd42 */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define MMC_R1_ERROR            (1 &lt;&lt; 19) </span><span class="cm">/* R1 bit19 */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define MMC_R1_LOCK_ULOCK_FAIL  (1 &lt;&lt; 24) </span><span class="cm">/* R1 bit24 */</span><span class="cp">
</span></span></span></code></pre></div><p>mmc-utils/mmc.c</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="p">{</span><span class="n">do_lock_unlock</span><span class="p">,</span> <span class="o">-</span><span class="mi">3</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s">&#34;cmd42&#34;</span><span class="p">,</span> <span class="s">&#34;&lt;password&gt; &lt;s|c|l|u|e&gt; &lt;device&gt;</span><span class="se">\n</span><span class="s">&#34;</span>
</span></span><span class="line"><span class="cl">                <span class="s">&#34;s</span><span class="se">\t</span><span class="s">set password</span><span class="se">\n</span><span class="s">&#34;</span>
</span></span><span class="line"><span class="cl">                <span class="s">&#34;c</span><span class="se">\t</span><span class="s">clear password</span><span class="se">\n</span><span class="s">&#34;</span>
</span></span><span class="line"><span class="cl">                <span class="s">&#34;l</span><span class="se">\t</span><span class="s">lock</span><span class="se">\n</span><span class="s">&#34;</span>
</span></span><span class="line"><span class="cl">                <span class="s">&#34;sl</span><span class="se">\t</span><span class="s">set password and lock</span><span class="se">\n</span><span class="s">&#34;</span>
</span></span><span class="line"><span class="cl">                <span class="s">&#34;u</span><span class="se">\t</span><span class="s">unlock</span><span class="se">\n</span><span class="s">&#34;</span>
</span></span><span class="line"><span class="cl">                <span class="s">&#34;e</span><span class="se">\t</span><span class="s">force erase</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nb">NULL</span><span class="p">},</span>
</span></span></code></pre></div><p>mmc-utils/mmc_cmds.h</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="c1">//lock/unlock feature implementation
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">int</span> <span class="nf">do_lock_unlock</span><span class="p">(</span><span class="kt">int</span> <span class="n">nargs</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">char</span> <span class="o">*</span><span class="n">device</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">__u8</span> <span class="n">data_block</span><span class="p">[</span><span class="n">MMC_BLOCK_SIZE</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="n">__u8</span> <span class="n">data_block_onebyte</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">block_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">mmc_ioc_cmd</span> <span class="n">idata</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">cmd42_para</span><span class="p">;</span>               <span class="c1">//parameter of cmd42
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">char</span> <span class="n">pwd</span><span class="p">[</span><span class="n">MAX_PWD_LENGTH</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span> <span class="c1">//password
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int</span> <span class="n">pwd_len</span><span class="p">;</span>                  <span class="c1">//password length
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">__u32</span> <span class="n">r1_response</span><span class="p">;</span>            <span class="c1">//R1 response token
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">nargs</span> <span class="o">!=</span> <span class="mi">4</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&#34;Usage: mmc cmd42 &lt;password&gt; &lt;s|c|l|u|e&gt; &lt;device&gt; </span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nf">strcpy</span><span class="p">(</span><span class="n">pwd</span><span class="p">,</span> <span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">    <span class="n">pwd_len</span> <span class="o">=</span> <span class="nf">strlen</span><span class="p">(</span><span class="n">pwd</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nf">strcmp</span><span class="p">(</span><span class="s">&#34;s&#34;</span><span class="p">,</span> <span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">cmd42_para</span> <span class="o">=</span> <span class="n">MMC_CMD42_SET_PWD</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Set password: password=%s ...</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">pwd</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nf">strcmp</span><span class="p">(</span><span class="s">&#34;c&#34;</span><span class="p">,</span> <span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">cmd42_para</span> <span class="o">=</span> <span class="n">MMC_CMD42_CLR_PWD</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Clear password: password=%s ...</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">pwd</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nf">strcmp</span><span class="p">(</span><span class="s">&#34;l&#34;</span><span class="p">,</span> <span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">cmd42_para</span> <span class="o">=</span> <span class="n">MMC_CMD42_LOCK</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Lock the card: password=%s ...</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">pwd</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nf">strcmp</span><span class="p">(</span><span class="s">&#34;sl&#34;</span><span class="p">,</span> <span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">cmd42_para</span> <span class="o">=</span> <span class="n">MMC_CMD42_SET_LOCK</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Set password and lock the card: password - %s ...</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">pwd</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nf">strcmp</span><span class="p">(</span><span class="s">&#34;u&#34;</span><span class="p">,</span> <span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">cmd42_para</span> <span class="o">=</span> <span class="n">MMC_CMD42_UNLOCK</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Unlock the card: password=%s ...</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">pwd</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nf">strcmp</span><span class="p">(</span><span class="s">&#34;e&#34;</span><span class="p">,</span> <span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">cmd42_para</span> <span class="o">=</span> <span class="n">MMC_CMD42_ERASE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Force erase ... (Warning: all card data will be erased together with PWD!)</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Invalid parameter:</span><span class="se">\n</span><span class="s">&#34;</span>
</span></span><span class="line"><span class="cl">               <span class="s">&#34;s</span><span class="se">\t</span><span class="s">set password</span><span class="se">\n</span><span class="s">&#34;</span>
</span></span><span class="line"><span class="cl">               <span class="s">&#34;c</span><span class="se">\t</span><span class="s">clear password</span><span class="se">\n</span><span class="s">&#34;</span>
</span></span><span class="line"><span class="cl">               <span class="s">&#34;l</span><span class="se">\t</span><span class="s">lock</span><span class="se">\n</span><span class="s">&#34;</span>
</span></span><span class="line"><span class="cl">               <span class="s">&#34;sl</span><span class="se">\t</span><span class="s">set password and lock</span><span class="se">\n</span><span class="s">&#34;</span>
</span></span><span class="line"><span class="cl">               <span class="s">&#34;u</span><span class="se">\t</span><span class="s">unlock</span><span class="se">\n</span><span class="s">&#34;</span>
</span></span><span class="line"><span class="cl">               <span class="s">&#34;e</span><span class="se">\t</span><span class="s">force erase</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">device</span> <span class="o">=</span> <span class="n">argv</span><span class="p">[</span><span class="n">nargs</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="n">fd</span> <span class="o">=</span> <span class="nf">open</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">O_RDWR</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">fd</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">perror</span><span class="p">(</span><span class="s">&#34;open&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">cmd42_para</span> <span class="o">==</span> <span class="n">MMC_CMD42_ERASE</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">block_size</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="c1">//set blk size to 2-byte for Force Erase @DDR50 compability
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">else</span> <span class="n">block_size</span> <span class="o">=</span> <span class="n">MMC_BLOCK_SIZE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">ret</span> <span class="o">=</span> <span class="nf">set_block_len</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">block_size</span><span class="p">);</span> <span class="c1">//set data block size prior to cmd42
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Set to data block length = %d byte(s).</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">block_size</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">cmd42_para</span> <span class="o">==</span> <span class="n">MMC_CMD42_ERASE</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">data_block_onebyte</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cmd42_para</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">data_block</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cmd42_para</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">data_block</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">pwd_len</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nf">memcpy</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">data_block</span> <span class="o">+</span> <span class="mi">2</span><span class="p">),</span> <span class="n">pwd</span><span class="p">,</span> <span class="n">pwd_len</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nf">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">idata</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">idata</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="n">idata</span><span class="p">.</span><span class="n">write_flag</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">idata</span><span class="p">.</span><span class="n">opcode</span> <span class="o">=</span> <span class="n">MMC_LOCK_UNLOCK</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">idata</span><span class="p">.</span><span class="n">arg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="c1">//set all 0 for cmd42 arg
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">idata</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">MMC_RSP_R1</span> <span class="o">|</span> <span class="n">MMC_CMD_AC</span> <span class="o">|</span> <span class="n">MMC_CMD_ADTC</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">idata</span><span class="p">.</span><span class="n">blksz</span> <span class="o">=</span> <span class="n">block_size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">idata</span><span class="p">.</span><span class="n">blocks</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">cmd42_para</span> <span class="o">==</span> <span class="n">MMC_CMD42_ERASE</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nf">mmc_ioc_cmd_set_data</span><span class="p">(</span><span class="n">idata</span><span class="p">,</span> <span class="n">data_block_onebyte</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span>
</span></span><span class="line"><span class="cl">        <span class="nf">mmc_ioc_cmd_set_data</span><span class="p">(</span><span class="n">idata</span><span class="p">,</span> <span class="n">data_block</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">ret</span> <span class="o">=</span> <span class="nf">ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">MMC_IOC_CMD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">idata</span><span class="p">);</span> <span class="c1">//Issue CMD42
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">r1_response</span> <span class="o">=</span> <span class="n">idata</span><span class="p">.</span><span class="n">response</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;cmd42 response: 0x%08x</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">r1_response</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">r1_response</span> <span class="o">&amp;</span> <span class="n">MMC_R1_ERROR</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span> <span class="c1">//check CMD42 error
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;cmd42 error! Error code: 0x%08x</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">r1_response</span> <span class="o">&amp;</span> <span class="n">MMC_R1_ERROR</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">r1_response</span> <span class="o">&amp;</span> <span class="n">MMC_R1_LOCK_ULOCK_FAIL</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//check lock/unlock error
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Card lock/unlock fail! Error code: 0x%08x</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">r1_response</span> <span class="o">&amp;</span> <span class="n">MMC_R1_LOCK_ULOCK_FAIL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nf">close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//change data block length
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">int</span> <span class="nf">set_block_len</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">blk_len</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">mmc_ioc_cmd</span> <span class="n">idata</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">idata</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">idata</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="n">idata</span><span class="p">.</span><span class="n">opcode</span> <span class="o">=</span> <span class="n">MMC_SET_BLOCKLEN</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">idata</span><span class="p">.</span><span class="n">arg</span> <span class="o">=</span> <span class="n">blk_len</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">idata</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">MMC_RSP_R1</span> <span class="o">|</span> <span class="n">MMC_CMD_AC</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">ret</span> <span class="o">=</span> <span class="nf">ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">MMC_IOC_CMD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">idata</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>实际上是通过ioctl控制的，编译之后，可以上锁，但是再也无法解锁成功，只能换一种方式。</p>
<p><a href="https://github.com/torvalds/linux/blob/master/include/uapi/linux/mmc/ioctl.h"target="_blank" rel="noopener noreferrer">https://github.com/torvalds/linux/blob/master/include/uapi/linux/mmc/ioctl.h</a></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo ./mmc scr <span class="nb">read</span> /sys/bus/mmc/devices/mmc0:aaaa/
</span></span><span class="line"><span class="cl">type: <span class="s1">&#39;SD&#39;</span>
</span></span><span class="line"><span class="cl">version: SD 3.0x
</span></span><span class="line"><span class="cl">bus widths: 4bit, 1bit,
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">sudo ./mmc cmd42 <span class="m">123456</span> s /sys/bus/mmc/devices/mmc0:aaaa/
</span></span><span class="line"><span class="cl">Set password: <span class="nv">password</span><span class="o">=</span><span class="m">123456</span> ...
</span></span></code></pre></div><h2 id="modify-the-kernel-module">Modify the kernel module</h2>
<p>因为第三方工具无法实现，现在只能修改内核模块了。本人的操作系统是Arch Linux，MMC驱动属于内核模块，所以不需要重新编译整个内核。而不是像Ubuntu直接builtin。</p>
<p>Arch Linux的内核模块目录如下，我的电脑是HP 840G3，SD卡使用PCI通道，主要会涉及下面三个驱动。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">/lib/modules/$(uname -r)/kernel/drivers/mmc/core/mmc_core.ko.xz
</span></span><span class="line"><span class="cl">/lib/modules/$(uname -r)/kernel/drivers/mmc/core/mmc_block.ko.xz
</span></span><span class="line"><span class="cl">/lib/modules/$(uname -r)/kernel/drivers/mmc/host/rtsx_pci_sdmmc.ko.xz
</span></span><span class="line"><span class="cl">/lib/modules/$(uname -r)/kernel/drivers/misc/cardreader/rtsx_pci.ko.xz
</span></span></code></pre></div><p>如果重新下载官方源码编译内核模块，会出现奇怪的错误。首先是vermagic匹配问题，内核版本，处理器特性不匹配则不允许挂载。因为Linux 3.7后加入了模块签名机制，可以通过modinfo查看系统自带的内核模块，没有签名会导致无法挂载。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ modinfo mmc_core
</span></span><span class="line"><span class="cl">filename:       /lib/modules/4.18.10-arch1-1-ARCH/kernel/drivers/mmc/core/mmc_core.ko.xz
</span></span><span class="line"><span class="cl">license:        GPL
</span></span><span class="line"><span class="cl">srcversion:     72D2DBEB18AB4B898BE5331
</span></span><span class="line"><span class="cl">depends:
</span></span><span class="line"><span class="cl">retpoline:      Y
</span></span><span class="line"><span class="cl">intree:         Y
</span></span><span class="line"><span class="cl">name:           mmc_core
</span></span><span class="line"><span class="cl">vermagic:       4.18.10-arch1-1-ARCH SMP preempt mod_unload modversions
</span></span><span class="line"><span class="cl">sig_id:         PKCS#7
</span></span><span class="line"><span class="cl">signer:
</span></span><span class="line"><span class="cl">sig_key:
</span></span><span class="line"><span class="cl">sig_hashalgo:   md4
</span></span><span class="line"><span class="cl">signature:      30:82:02:A5:06:09:2A:86:48:86:F7:0D:01:07:02:A0:82:02:96:30
</span></span><span class="line"><span class="cl">                以下省略
</span></span><span class="line"><span class="cl">parm:           use_spi_crc:bool
</span></span></code></pre></div><p>我们可以在/usr/lib/modules/$(uname -r)/build/目录进行编译，无需另外配置。只需要把MMC的core代码拷贝到目标目录下。就可以直接make，然后重新挂载MMC内核模块驱动。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">cp ./core/* /usr/lib/modules/<span class="k">$(</span>uname -r<span class="k">)</span>/build/drivers/mmc/core/
</span></span><span class="line"><span class="cl">make modules <span class="nv">SUBDIRS</span><span class="o">=</span>drivers/mmc/core
</span></span><span class="line"><span class="cl">  Building modules, stage 2.
</span></span><span class="line"><span class="cl">  MODPOST <span class="m">7</span> modules
</span></span><span class="line"><span class="cl">rmmod rtsx_pci_sdmmc <span class="o">&amp;&amp;</span> rmmod mmc_core
</span></span><span class="line"><span class="cl">insmod /usr/lib/modules/<span class="k">$(</span>uname -r<span class="k">)</span>/build/drivers/mmc/core/mmc_core.ko
</span></span><span class="line"><span class="cl">insmod /lib/modules/<span class="k">$(</span>uname -r<span class="k">)</span>/kernel/drivers/mmc/host/rtsx_pci_sdmmc.ko.xz
</span></span></code></pre></div><h3 id="add-unlock-function">Add Unlock Function</h3>
<p>在mmc_ops.h加入unlock_mmc声明</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">unlock_mmc</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="n">u8</span><span class="o">*</span> <span class="n">key_buf</span><span class="p">,</span><span class="kt">int</span> <span class="n">key_len</span><span class="p">);</span>
</span></span></code></pre></div><p>随后编写具体实现，首先设定块长度，随后发送CMD42 ADTC命令。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">unlock_mmc</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="n">u8</span><span class="o">*</span> <span class="n">key_buf</span><span class="p">,</span><span class="kt">int</span> <span class="n">key_len</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">block_size</span> <span class="o">=</span> <span class="n">key_len</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">mmc_request</span> <span class="n">mrq</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">mmc_command</span> <span class="n">cmd_sbl</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">mmc_command</span> <span class="n">cmd</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">mmc_data</span> <span class="n">data</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">scatterlist</span> <span class="n">sg</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">u8</span> <span class="o">*</span><span class="n">data_buf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/*------------CMD 16----------------*/</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 1 byteflag + 1 byte password length + 16 bytes password
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd_sbl</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_command</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">cmd_sbl</span><span class="p">.</span><span class="n">opcode</span> <span class="o">=</span> <span class="n">MMC_SET_BLOCKLEN</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">cmd_sbl</span><span class="p">.</span><span class="n">arg</span> <span class="o">=</span> <span class="n">block_size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">cmd_sbl</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">MMC_RSP_R1</span> <span class="o">|</span> <span class="n">MMC_CMD_AC</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">err</span> <span class="o">=</span> <span class="nf">mmc_wait_for_cmd</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd_sbl</span><span class="p">,</span> <span class="n">MMC_CMD_RETRIES</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">printk</span><span class="p">(</span><span class="s">&#34;%s failed block_size=%d </span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span><span class="n">__func__</span><span class="p">,</span><span class="n">block_size</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/*-----------CMD 42-----------------*/</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// CMD
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_command</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="n">cmd</span><span class="p">.</span><span class="n">opcode</span> <span class="o">=</span> <span class="n">MMC_LOCK_UNLOCK</span><span class="p">;</span> <span class="c1">// CMD 42
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">cmd</span><span class="p">.</span><span class="n">arg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>   <span class="c1">// set all 0 for cmd42 arg
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">cmd</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">MMC_RSP_R1</span> <span class="o">|</span> <span class="n">MMC_CMD_ADTC</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Data
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_data</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="n">data</span><span class="p">.</span><span class="n">timeout_ns</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="mi">1000</span><span class="o">*</span><span class="mi">1000</span><span class="o">*</span><span class="mi">1000</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">data</span><span class="p">.</span><span class="n">blksz</span> <span class="o">=</span> <span class="n">block_size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">data</span><span class="p">.</span><span class="n">blocks</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">data</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">MMC_DATA_WRITE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">data</span><span class="p">.</span><span class="n">sg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sg</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">data</span><span class="p">.</span><span class="n">sg_len</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">mmc_set_data_timeout</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="p">,</span> <span class="n">card</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mrq</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_request</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="n">mrq</span><span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">mrq</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Set Data for DMA
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">data_buf</span> <span class="o">=</span> <span class="nf">kzalloc</span><span class="p">(</span><span class="n">block_size</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data_buf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">printk</span><span class="p">(</span><span class="s">&#34;%s kzalloc failed</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span><span class="n">__func__</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nf">memset</span><span class="p">(</span><span class="n">data_buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">block_size</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">data_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">data_buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">key_len</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">memcpy</span><span class="p">(</span><span class="n">data_buf</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">key_buf</span><span class="p">,</span> <span class="n">key_len</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">sg_init_one</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sg</span><span class="p">,</span> <span class="n">data_buf</span><span class="p">,</span> <span class="n">block_size</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// request
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">mmc_wait_for_req</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mrq</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">err</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">.</span><span class="n">error</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nf">printk</span><span class="p">(</span><span class="s">&#34;%s: unlock cmd error %d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">cmd</span><span class="p">.</span><span class="n">error</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span>
</span></span><span class="line"><span class="cl">        <span class="n">err</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="n">error</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">printk</span><span class="p">(</span><span class="s">&#34;[SDLOCK] %s MMC_LOCK_UNLOCK </span><span class="se">\r\n</span><span class="s">&#34;</span><span class="p">,</span><span class="n">__func__</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nl">out</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="nf">kfree</span><span class="p">(</span><span class="n">data_buf</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">err</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>在sd.c的mmc_sd_setup_card之前，加入解锁功能。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">// 检查是否上锁
</span></span><span class="line"><span class="cl">u32 <span class="nv">status</span> <span class="o">=</span> 0<span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="nv">err</span> <span class="o">=</span> mmc_send_status<span class="o">(</span>card, <span class="p">&amp;</span>status<span class="o">)</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="o">(</span>err<span class="o">)</span>
</span></span><span class="line"><span class="cl">    goto free_card<span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="o">(</span>status <span class="p">&amp;</span> R1_CARD_IS_LOCKED<span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="o">{</span>
</span></span><span class="line"><span class="cl">    mmc_card_set_encrypted<span class="o">(</span>card<span class="o">)</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    mmc_card_set_locked<span class="o">(</span>card<span class="o">)</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">//方便调试
</span></span><span class="line"><span class="cl">bool <span class="nv">auto_unlock</span> <span class="o">=</span> true<span class="p">;</span>
</span></span><span class="line"><span class="cl">char unlock_pwd<span class="o">[</span>16<span class="o">]</span> <span class="o">=</span> <span class="o">{</span>0x5f,0xfc,0xa1,0x9f,0xfc,0xdb,0x58,0x99,0xa8,0x2c,0x4e,0x26,0x5f,0x99,0xc7,0x6b<span class="o">}</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="o">(</span>status <span class="p">&amp;</span> R1_CARD_IS_LOCKED<span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="o">(</span>auto_unlock<span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">{</span>
</span></span><span class="line"><span class="cl">        //unlock sd card
</span></span><span class="line"><span class="cl">        <span class="nv">err</span> <span class="o">=</span> unlock_mmc<span class="o">(</span>card, unlock_pwd, 16<span class="o">)</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="o">(</span>err<span class="o">)</span>
</span></span><span class="line"><span class="cl">        <span class="o">{</span>
</span></span><span class="line"><span class="cl">            printk<span class="o">(</span><span class="s2">&#34;[SDLOCK] %s unlock failed \n&#34;</span>,__func__<span class="o">)</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span>
</span></span><span class="line"><span class="cl">        <span class="o">{</span>
</span></span><span class="line"><span class="cl">            printk<span class="o">(</span><span class="s2">&#34;[SDLOCK] %s unlock success \n&#34;</span>,__func__<span class="o">)</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="k">if</span><span class="o">(</span>!mmc_card_locked<span class="o">(</span>card<span class="o">))</span>
</span></span><span class="line"><span class="cl">            <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="nv">auto_unlock</span> <span class="o">=</span> false<span class="p">;</span>
</span></span><span class="line"><span class="cl">                printk<span class="o">(</span><span class="s2">&#34;[SDLOCK] %s unlock success and sdcard status is unlocked.\n&#34;</span>,__func__<span class="o">)</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">else</span>
</span></span><span class="line"><span class="cl">            <span class="o">{</span>
</span></span><span class="line"><span class="cl">                printk<span class="o">(</span><span class="s2">&#34;[SDLOCK] %s unlock success but sdcard status is locked, abnormal status.\n&#34;</span>,__func__<span class="o">)</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        //Check <span class="k">if</span> card is locked
</span></span><span class="line"><span class="cl">        <span class="nv">err</span> <span class="o">=</span> mmc_send_status<span class="o">(</span>card, <span class="p">&amp;</span>status<span class="o">)</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span>err<span class="o">)</span>
</span></span><span class="line"><span class="cl">        <span class="o">{</span>
</span></span><span class="line"><span class="cl">            printk<span class="o">(</span><span class="s2">&#34;[SDLOCK] %s resume sd card exception /n&#34;</span>,__func__<span class="o">)</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            goto free_card<span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span>status <span class="p">&amp;</span> R1_CARD_IS_LOCKED<span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">{</span>
</span></span><span class="line"><span class="cl">        printk<span class="o">(</span>KERN_WARNING <span class="s2">&#34;[SDLOCK] sdcard is locked\n&#34;</span><span class="o">)</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        goto <span class="k">done</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span>
</span></span><span class="line"><span class="cl">    <span class="o">{</span>
</span></span><span class="line"><span class="cl">        printk<span class="o">(</span>KERN_WARNING <span class="s2">&#34;[SDLOCK] sdcard resume to unlocked\n&#34;</span><span class="o">)</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="k">else</span>
</span></span><span class="line"><span class="cl"><span class="o">{</span>
</span></span><span class="line"><span class="cl">    printk<span class="o">(</span>KERN_WARNING <span class="s2">&#34;[SDLOCK] sdcard is unlocked\n&#34;</span><span class="o">)</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>在card.h加入宏定义</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#define mmc_card_mmc(c)     ((c)-&gt;type == MMC_TYPE_MMC)
</span></span></span><span class="line"><span class="cl"><span class="cp">#define mmc_card_sd(c)      ((c)-&gt;type == MMC_TYPE_SD)
</span></span></span><span class="line"><span class="cl"><span class="cp">#define mmc_card_sdio(c)    ((c)-&gt;type == MMC_TYPE_SDIO)
</span></span></span><span class="line"><span class="cl"><span class="cp">#define mmc_card_locked(c)  ((c)-&gt;state &amp; MMC_STATE_LOCKED)
</span></span></span><span class="line"><span class="cl"><span class="cp">#define mmc_card_encrypt(c) ((c)-&gt;state &amp; MMC_STATE_ENCRYPT)
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#define MMC_STATE_PRESENT        (1&lt;&lt;0)       </span><span class="cm">/* present in sysfs */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define MMC_STATE_READONLY       (1&lt;&lt;1)       </span><span class="cm">/* card is read-only */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define MMC_STATE_BLOCKADDR      (1&lt;&lt;2)       </span><span class="cm">/* card uses block-addressing */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define MMC_CARD_SDXC            (1&lt;&lt;3)       </span><span class="cm">/* card is SDXC */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define MMC_CARD_REMOVED         (1&lt;&lt;4)       </span><span class="cm">/* card has been removed */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define MMC_STATE_DOING_BKOPS    (1&lt;&lt;5)       </span><span class="cm">/* card is doing BKOPS */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define MMC_STATE_LOCKED         (1&lt;&lt;12)      </span><span class="cm">/* card is currently locked */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define MMC_STATE_ENCRYPT        (1&lt;&lt;13)      </span><span class="cm">/* card is currently encrypt */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define MMC_STATE_ULTRAHIGHSPEED (1&lt;&lt;14)      </span><span class="cm">/* card is in ultra high speed mode */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#define MMC_STATE_SUSPENDED      (1&lt;&lt;6)       </span><span class="cm">/* card is suspended */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define MMC_STATE_CMDQ           (1&lt;&lt;7)       </span><span class="cm">/* card is in cmd queue mode */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#define MMC_LOCK_MODE_ERASE      (1&lt;&lt;3)
</span></span></span><span class="line"><span class="cl"><span class="cp">#define MMC_LOCK_MODE_LOCK       (1&lt;&lt;2)
</span></span></span><span class="line"><span class="cl"><span class="cp">#define MMC_LOCK_MODE_CLR_PWD    (1&lt;&lt;1)
</span></span></span><span class="line"><span class="cl"><span class="cp">#define MMC_LOCK_MODE_SET_PWD    (1&lt;&lt;0)
</span></span></span><span class="line"><span class="cl"><span class="cp">#define MMC_LOCK_MODE_UNLOCK     0
</span></span></span></code></pre></div><p>在core.c的mmc_wait_for_req_done插桩调试，随后通过dmesg查看记录</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="nf">printk</span><span class="p">(</span><span class="s">&#34;[mmc] CMD %d err number: %d&#34;</span><span class="p">,</span> <span class="n">mrq</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">opcode</span><span class="p">,</span> <span class="n">mrq</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">error</span><span class="p">);</span>
</span></span></code></pre></div><h2 id="uhs-i">UHS-I</h2>
<p>UHS-I(Ultra High Speed Phase I，超高速)是实现 SDHC 和 SDXC 卡高速数据传输的的总线接口。支持LVS，有七种操作模式。</p>
<ul>
<li>DS - Default Speed up to 25MHz 3.3V signaling</li>
<li>HS - High Speed up to 50MHz 3.3V signaling</li>
<li>SDR12 - SDR up to 25MHz 1.8V signaling</li>
<li>SDR25 - SDR up to 50MHz 1.8V signaling</li>
<li>SDR50 - SDR up to 100MHz 1.8V signaling</li>
<li>SDR104 - SDR up to 208MHz 1.8V signaling</li>
<li>DDR - DDR up to 50MHz 1.8V signaling</li>
</ul>
<p>首先用CMD0选择总线模式：SPI模式和SD模式。1.8V的信号模式只能进入SD模式。</p>
<p><img loading="lazy"  src="./uhs_command_sequence.png"
        alt="uhs_command_sequence"/></p>
<p>可以看到并没有解锁成功，在CMD42出现了-22的错误。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ dmesg -l 0,1,2,3,4,5,6,7
</span></span><span class="line"><span class="cl"><span class="o">[</span>62696.072102<span class="o">]</span> <span class="o">[</span>mmc<span class="o">]</span> CMD <span class="m">52</span> err number: -110
</span></span><span class="line"><span class="cl"><span class="o">[</span>62696.175620<span class="o">]</span> <span class="o">[</span>mmc<span class="o">]</span> CMD <span class="m">52</span> err number: -110
</span></span><span class="line"><span class="cl"><span class="o">[</span>62696.177592<span class="o">]</span> <span class="o">[</span>mmc<span class="o">]</span> CMD <span class="m">0</span> err number: <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>62696.181590<span class="o">]</span> <span class="o">[</span>mmc<span class="o">]</span> CMD <span class="m">8</span> err number: <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>62696.282033<span class="o">]</span> <span class="o">[</span>mmc<span class="o">]</span> CMD <span class="m">5</span> err number: -110
</span></span><span class="line"><span class="cl"><span class="o">[</span>62696.385534<span class="o">]</span> <span class="o">[</span>mmc<span class="o">]</span> CMD <span class="m">5</span> err number: -110
</span></span><span class="line"><span class="cl"><span class="o">[</span>62696.492060<span class="o">]</span> <span class="o">[</span>mmc<span class="o">]</span> CMD <span class="m">5</span> err number: -110
</span></span><span class="line"><span class="cl"><span class="o">[</span>62696.595641<span class="o">]</span> <span class="o">[</span>mmc<span class="o">]</span> CMD <span class="m">5</span> err number: -110
</span></span><span class="line"><span class="cl"><span class="o">[</span>62696.596514<span class="o">]</span> <span class="o">[</span>mmc<span class="o">]</span> CMD <span class="m">55</span> err number: <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>62696.597226<span class="o">]</span> <span class="o">[</span>mmc<span class="o">]</span> CMD <span class="m">41</span> err number: <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>62696.626822<span class="o">]</span> <span class="o">[</span>mmc<span class="o">]</span> CMD <span class="m">0</span> err number: <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>62696.630372<span class="o">]</span> <span class="o">[</span>mmc<span class="o">]</span> CMD <span class="m">8</span> err number: <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>62696.631051<span class="o">]</span> <span class="o">[</span>mmc<span class="o">]</span> CMD <span class="m">55</span> err number: <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>62696.631758<span class="o">]</span> <span class="o">[</span>mmc<span class="o">]</span> CMD <span class="m">41</span> err number: <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>62696.642862<span class="o">]</span> <span class="o">[</span>mmc<span class="o">]</span> CMD <span class="m">55</span> err number: <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>62696.643590<span class="o">]</span> <span class="o">[</span>mmc<span class="o">]</span> CMD <span class="m">41</span> err number: <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>62696.656036<span class="o">]</span> <span class="o">[</span>mmc<span class="o">]</span> CMD <span class="m">55</span> err number: <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>62696.656752<span class="o">]</span> <span class="o">[</span>mmc<span class="o">]</span> CMD <span class="m">41</span> err number: <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>62696.669827<span class="o">]</span> <span class="o">[</span>mmc<span class="o">]</span> CMD <span class="m">55</span> err number: <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>62696.670711<span class="o">]</span> <span class="o">[</span>mmc<span class="o">]</span> CMD <span class="m">41</span> err number: <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>62696.683086<span class="o">]</span> <span class="o">[</span>mmc<span class="o">]</span> CMD <span class="m">55</span> err number: <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>62696.683976<span class="o">]</span> <span class="o">[</span>mmc<span class="o">]</span> CMD <span class="m">41</span> err number: <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>62696.685084<span class="o">]</span> <span class="o">[</span>mmc<span class="o">]</span> CMD <span class="m">2</span> err number: <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>62696.685781<span class="o">]</span> <span class="o">[</span>mmc<span class="o">]</span> CMD <span class="m">3</span> err number: <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>62696.686493<span class="o">]</span> <span class="o">[</span>mmc<span class="o">]</span> CMD <span class="m">13</span> err number: <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>62696.687827<span class="o">]</span> <span class="o">[</span>mmc<span class="o">]</span> CMD <span class="m">9</span> err number: <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>62696.688551<span class="o">]</span> <span class="o">[</span>mmc<span class="o">]</span> CMD <span class="m">7</span> err number: <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>62696.689227<span class="o">]</span> <span class="o">[</span>mmc<span class="o">]</span> CMD <span class="m">16</span> err number: <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>62696.690033<span class="o">]</span> <span class="o">[</span>mmc<span class="o">]</span> CMD <span class="m">42</span> err number: -22
</span></span><span class="line"><span class="cl"><span class="o">[</span>62696.690041<span class="o">]</span> unlock_mmc: unlock cmd error -22
</span></span><span class="line"><span class="cl"><span class="o">[</span>62696.690045<span class="o">]</span> <span class="o">[</span>SDLOCK<span class="o">]</span> mmc_sd_init_card unlock failed
</span></span><span class="line"><span class="cl"><span class="o">[</span>62696.690749<span class="o">]</span> <span class="o">[</span>mmc<span class="o">]</span> CMD <span class="m">13</span> err number: <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>62696.690755<span class="o">]</span> <span class="o">[</span>SDLOCK<span class="o">]</span> sdcard is locked
</span></span><span class="line"><span class="cl"><span class="o">[</span>62696.690773<span class="o">]</span> mmc0: new SD card at address f317
</span></span><span class="line"><span class="cl"><span class="o">[</span>62696.691709<span class="o">]</span> mmcblk0: mmc0:f317 MF02B 1.88 GiB
</span></span></code></pre></div><p>Linux系统错误号-22即EINVAL。最后跟到了drivers/mmc/host/sdhci.c里</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">filename: drivers/mmc/core/core.c
</span></span><span class="line"><span class="cl">functions:
</span></span><span class="line"><span class="cl">mmc_wait_for_req -&gt; __mmc_start_request -&gt; host-&gt;ops-&gt;request
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">filename: drivers/mmc/host/rtsx_pci_sdmmc.c
</span></span><span class="line"><span class="cl">functions:
</span></span><span class="line"><span class="cl">sdmmc_request -&gt; schedule_work -&gt; sd_request -&gt; sd_send_cmd_get_rsp -&gt; sd_normal_rw -&gt; sd_write_data -&gt; rtsx_pci_write_ppbuf -&gt; rtsx_pci_send_cmd
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">filename: drivers/misc/cardreader/rtsx_pcr.c
</span></span><span class="line"><span class="cl">rtsx_pci_write_ppbuf
</span></span><span class="line"><span class="cl">rtsx_pci_add_cmd
</span></span><span class="line"><span class="cl">rtsx_pci_send_cmd
</span></span></code></pre></div><p>因为是笔记本电脑，所以相关命令在Realtek的SD读卡器驱动里，而在手机中是drivers/mfd/rtsx_pcr.c。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">rtsx_pci_send_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_pcr</span> <span class="o">*</span><span class="n">pcr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">timeout</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="p">...</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">pcr</span><span class="o">-&gt;</span><span class="n">trans_result</span> <span class="o">==</span> <span class="n">TRANS_RESULT_FAIL</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">...</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">cp ./drivers/misc/cardreader/* /usr/lib/modules/<span class="k">$(</span>uname -r<span class="k">)</span>/build/drivers/misc/cardreader/
</span></span><span class="line"><span class="cl">make modules <span class="nv">SUBDIRS</span><span class="o">=</span>drivers/misc/cardreader
</span></span></code></pre></div><p>通过打印rtsx_pci_add_cmd的参数，可以确定传入的key没有错误</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">sd_cmd_set_sd_cmd
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">[75754.016095] [rtsx] cmd_type:1, reg_addr:fda9, ptr:0x50, val:2108292944 SD_CMD0 16
</span></span><span class="line"><span class="cl">[75754.016100] [rtsx] cmd_type:1, reg_addr:fdaa, ptr:0x0, val:2108358400  SD_CMD1
</span></span><span class="line"><span class="cl">[75754.016104] [rtsx] cmd_type:1, reg_addr:fdab, ptr:0x0, val:2108423936  SD_CMD2
</span></span><span class="line"><span class="cl">[75754.016111] [rtsx] cmd_type:1, reg_addr:fdac, ptr:0x0, val:2108489472  SD_CMD3
</span></span><span class="line"><span class="cl">[75754.016115] [rtsx] cmd_type:1, reg_addr:fdad, ptr:0x12, val:2108555026 SD_CMD4 0x12
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">sd_send_cmd_get_rsp
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">[75754.016119] [rtsx] cmd_type:1, reg_addr:fda1, ptr:0x1, val:2107768577  WRITE_REG_CMD SD_CFG2
</span></span><span class="line"><span class="cl">[75754.016122] [rtsx] cmd_type:1, reg_addr:fd5b, ptr:0x1, val:2103116033  CARD_DATA_SOURCE
</span></span><span class="line"><span class="cl">[75754.016126] [rtsx] cmd_type:1, reg_addr:fdb3, ptr:0x88, val:2108948360  WRITE_REG_CMD SD_TRANSFER
</span></span><span class="line"><span class="cl">[75754.016130] [rtsx] cmd_type:2, reg_addr:fdb3, ptr:0x60, val:-1112317856 CHECK_REG_CMD SD_TRANSFER
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">[75754.016134] [rtsx] cmd_type:0, reg_addr:fda9, ptr:0x0, val:1034485760  sd_cmd_set_sd_cmd 0
</span></span><span class="line"><span class="cl">[75754.016138] [rtsx] cmd_type:0, reg_addr:fdaa, ptr:0x0, val:1034551296  SD_CMD1
</span></span><span class="line"><span class="cl">[75754.016142] [rtsx] cmd_type:0, reg_addr:fdab, ptr:0x0, val:1034616832  SD_CMD1
</span></span><span class="line"><span class="cl">[75754.016146] [rtsx] cmd_type:0, reg_addr:fdac, ptr:0x0, val:1034682368  SD_CMD2
</span></span><span class="line"><span class="cl">[75754.016150] [rtsx] cmd_type:0, reg_addr:fdad, ptr:0x0, val:1034747904  SD_CMD3
</span></span><span class="line"><span class="cl">[75754.016153] [rtsx] cmd_type:0, reg_addr:fda3, ptr:0x0, val:1034092544  SD_STAT1
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">sd_cmd_set_sd_cmd
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">[75754.016787] [SDLOCK] unlock_mmc MMC_SET_BLOCKLEN 18
</span></span><span class="line"><span class="cl">[75754.016820] [rtsx] cmd_type:1, reg_addr:fda9, ptr:0x6a, val:2108292970 SD_CMD0 42
</span></span><span class="line"><span class="cl">[75754.016823] [rtsx] cmd_type:1, reg_addr:fdaa, ptr:0x0, val:2108358400  SD_CMD1
</span></span><span class="line"><span class="cl">[75754.016826] [rtsx] cmd_type:1, reg_addr:fdab, ptr:0x0, val:2108423936  SD_CMD2
</span></span><span class="line"><span class="cl">[75754.016829] [rtsx] cmd_type:1, reg_addr:fdac, ptr:0x0, val:2108489472  SD_CMD3
</span></span><span class="line"><span class="cl">[75754.016831] [rtsx] cmd_type:1, reg_addr:fdad, ptr:0x0, val:2108555008  SD_CMD4
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">[75754.016834] [rtsx] cmd_type:1, reg_addr:fda1, ptr:0x1, val:2107768577  WRITE_REG_CMD SD_CFG2
</span></span><span class="line"><span class="cl">[75754.016837] [rtsx] cmd_type:1, reg_addr:fd5b, ptr:0x1, val:2103116033  CARD_DATA_SOURCE
</span></span><span class="line"><span class="cl">[75754.016839] [rtsx] cmd_type:1, reg_addr:fdb3, ptr:0x88, val:2108948360 WRITE_REG_CMD SD_TRANSFER
</span></span><span class="line"><span class="cl">[75754.016842] [rtsx] cmd_type:2, reg_addr:fdb3, ptr:0x60, val:-1112317856 CHECK_REG_CMD SD_TRANSFER
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">[75754.016845] [rtsx] cmd_type:0, reg_addr:fda9, ptr:0x0, val:1034485760  sd_cmd_set_sd_cmd 0
</span></span><span class="line"><span class="cl">[75754.016848] [rtsx] cmd_type:0, reg_addr:fdaa, ptr:0x0, val:1034551296  SD_CMD1
</span></span><span class="line"><span class="cl">[75754.016851] [rtsx] cmd_type:0, reg_addr:fdab, ptr:0x0, val:1034616832  SD_CMD2
</span></span><span class="line"><span class="cl">[75754.016854] [rtsx] cmd_type:0, reg_addr:fdac, ptr:0x0, val:1034682368  SD_CMD3
</span></span><span class="line"><span class="cl">[75754.016856] [rtsx] cmd_type:0, reg_addr:fdad, ptr:0x0, val:1034747904  SD_CMD4
</span></span><span class="line"><span class="cl">[75754.016862] [rtsx] cmd_type:0, reg_addr:fda3, ptr:0x0, val:1034092544  SD_STAT1
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">write data
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">[75754.017492] [rtsx] cmd_type:1, reg_addr:fa00, ptr:0x0, val:2046885632
</span></span><span class="line"><span class="cl">[75754.017496] [rtsx] cmd_type:1, reg_addr:fa01, ptr:0x10, val:2046951184
</span></span><span class="line"><span class="cl">[75754.017499] [rtsx] cmd_type:1, reg_addr:fa02, ptr:0x5f, val:2047016799
</span></span><span class="line"><span class="cl">[75754.017502] [rtsx] cmd_type:1, reg_addr:fa03, ptr:0xfc, val:2047082492
</span></span><span class="line"><span class="cl">[75754.017505] [rtsx] cmd_type:1, reg_addr:fa04, ptr:0xa1, val:2047147937
</span></span><span class="line"><span class="cl">[75754.017508] [rtsx] cmd_type:1, reg_addr:fa05, ptr:0x9f, val:2047213471
</span></span><span class="line"><span class="cl">[75754.017511] [rtsx] cmd_type:1, reg_addr:fa06, ptr:0xfc, val:2047279100
</span></span><span class="line"><span class="cl">[75754.017513] [rtsx] cmd_type:1, reg_addr:fa07, ptr:0xdb, val:2047344573
</span></span><span class="line"><span class="cl">[75754.017518] [rtsx] cmd_type:1, reg_addr:fa08, ptr:0x58, val:2047410008
</span></span><span class="line"><span class="cl">[75754.017521] [rtsx] cmd_type:1, reg_addr:fa09, ptr:0x99, val:2047475609
</span></span><span class="line"><span class="cl">[75754.017524] [rtsx] cmd_type:1, reg_addr:fa0a, ptr:0xa8, val:2047541160
</span></span><span class="line"><span class="cl">[75754.017526] [rtsx] cmd_type:1, reg_addr:fa0b, ptr:0x2c, val:2047606572
</span></span><span class="line"><span class="cl">[75754.017529] [rtsx] cmd_type:1, reg_addr:fa0c, ptr:0x4e, val:2047672142
</span></span><span class="line"><span class="cl">[75754.017531] [rtsx] cmd_type:1, reg_addr:fa0d, ptr:0x26, val:2047737638
</span></span><span class="line"><span class="cl">[75754.017534] [rtsx] cmd_type:1, reg_addr:fa0e, ptr:0x5f, val:2047803231
</span></span><span class="line"><span class="cl">[75754.017537] [rtsx] cmd_type:1, reg_addr:fa0f, ptr:0x99, val:2047868825
</span></span><span class="line"><span class="cl">[75754.017539] [rtsx] cmd_type:1, reg_addr:fa10, ptr:0xc7, val:2047934407
</span></span><span class="line"><span class="cl">[75754.017542] [rtsx] cmd_type:1, reg_addr:fa11, ptr:0x6b, val:2047999851
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">sd_cmd_set_block_len
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">[75754.017569] [rtsx] cmd_type:1, reg_addr:fdb1, ptr:0x1, val:2108817153  SD_BLOCK_CNT_L 1
</span></span><span class="line"><span class="cl">[75754.017572] [rtsx] cmd_type:1, reg_addr:fdb2, ptr:0x0, val:2108882688  SD_BLOCK_CNT_H
</span></span><span class="line"><span class="cl">[75754.017575] [rtsx] cmd_type:1, reg_addr:fdaf, ptr:0x12, val:2108686098 SD_BYTE_CNT_L  18
</span></span><span class="line"><span class="cl">[75754.017577] [rtsx] cmd_type:1, reg_addr:fdb0, ptr:0x0, val:2108751616  SD_BYTE_CNT_H
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">[75754.017580] [rtsx] cmd_type:1, reg_addr:fda1, ptr:0x0, val:2107768576  WRITE_REG_CMD SD_CFG2
</span></span><span class="line"><span class="cl">[75754.017583] [rtsx] cmd_type:1, reg_addr:fdb3, ptr:0x81, val:2108948353 WRITE_REG_CMD SD_TRANSFER
</span></span><span class="line"><span class="cl">[75754.017585] [rtsx] cmd_type:2, reg_addr:fdb3, ptr:0x40, val:-1112326080 CHECK_REG_CMD SD_TRANSFER
</span></span></code></pre></div><h2 id="unlocking-sd-card-by-raspberry-pi">Unlocking SD Card by Raspberry Pi</h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo dd <span class="nv">bs</span><span class="o">=</span>4M <span class="k">if</span><span class="o">=</span>/home/cygnus/IMG/2018-06-27-raspbian-stretch-lite/2018-06-27-raspbian-stretch-lite.img <span class="nv">of</span><span class="o">=</span>/dev/mmcblk0 <span class="nv">status</span><span class="o">=</span>progress <span class="nv">conv</span><span class="o">=</span>fsync
</span></span></code></pre></div><p>下载对应版本的树莓派源代码，并把工具链加入环境变量</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">git clone --depth<span class="o">=</span><span class="m">1</span> --branch rpi-4.14.y https://github.com/raspberrypi/linux
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">PATH</span><span class="o">=</span><span class="nv">$PATH</span>:/home/cygnus/git/rapi-tools/arm-bcm2708/gcc-linaro-arm-linux-gnueabihf-raspbian-x64/bin
</span></span></code></pre></div><p>使用BCM2709配置，并在MENU CONFIG里把SD卡驱动和MMC驱动变为内核模块形式。最后编译zImage，模块，设备树，然后更新SD卡里的文件。
kernel.img is used by RPi 1B, 1A, A+, B+, 2B (first version) Z, Z (with camera), ZW, CM1
kernel7.img is used by the RPi2B2, RPi3B, CM3 and CM3L.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="nv">KERNEL</span><span class="o">=</span>kernel7
</span></span><span class="line"><span class="cl">make <span class="nv">ARCH</span><span class="o">=</span>arm <span class="nv">CROSS_COMPILE</span><span class="o">=</span>arm-linux-gnueabihf- bcm2709_defconfig
</span></span><span class="line"><span class="cl">make <span class="nv">ARCH</span><span class="o">=</span>arm <span class="nv">CROSS_COMPILE</span><span class="o">=</span>arm-linux-gnueabihf- menuconfig
</span></span><span class="line"><span class="cl">make <span class="nv">ARCH</span><span class="o">=</span>arm <span class="nv">CROSS_COMPILE</span><span class="o">=</span>arm-linux-gnueabihf- -j16 zImage modules dtbs
</span></span><span class="line"><span class="cl">sudo make <span class="nv">ARCH</span><span class="o">=</span>arm <span class="nv">CROSS_COMPILE</span><span class="o">=</span>arm-linux-gnueabihf- <span class="nv">INSTALL_MOD_PATH</span><span class="o">=</span>/run/media/cygnus/rootfs modules_install
</span></span></code></pre></div><p>更新内核</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo cp /run/media/cygnus/boot/<span class="nv">$KERNEL</span>.img /run/media/cygnus/boot/<span class="nv">$KERNEL</span>-backup.img
</span></span><span class="line"><span class="cl">sudo cp arch/arm/boot/zImage /run/media/cygnus/boot/<span class="nv">$KERNEL</span>.img
</span></span></code></pre></div><p>更新设备树</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo cp arch/arm/boot/dts/*.dtb /run/media/cygnus/boot/
</span></span><span class="line"><span class="cl">sudo cp arch/arm/boot/dts/overlays/*.dtb* /run/media/cygnus/boot/overlays/
</span></span></code></pre></div><p>在boot config加入下面配置</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="nv">dtoverlay</span><span class="o">=</span>sdio,poll_once<span class="o">=</span>off
</span></span></code></pre></div><table>
  <thead>
      <tr>
          <th>Name</th>
          <th>SD Card</th>
          <th>Raspberry Pi Pin Num</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>VCC</td>
          <td>4</td>
          <td>17</td>
      </tr>
      <tr>
          <td>GND</td>
          <td>6</td>
          <td>20</td>
      </tr>
      <tr>
          <td>CLK/SCLK</td>
          <td>5</td>
          <td>15</td>
      </tr>
      <tr>
          <td>CMD/MOSI</td>
          <td>2</td>
          <td>16</td>
      </tr>
      <tr>
          <td>DAT0/MISO</td>
          <td>7</td>
          <td>18</td>
      </tr>
      <tr>
          <td>DAT1</td>
          <td>8</td>
          <td>22</td>
      </tr>
      <tr>
          <td>DAT2</td>
          <td>9</td>
          <td>37</td>
      </tr>
      <tr>
          <td>DAT3/CS</td>
          <td>1</td>
          <td>13</td>
      </tr>
  </tbody>
</table>
<h2 id="reference">Reference</h2>
<p><a href="https://www.sdcard.org/downloads/pls/index.html"target="_blank" rel="noopener noreferrer">SD Simplified Specifications</a></p>
<p><a href="https://en.wikipedia.org/wiki/Secure_Digital"target="_blank" rel="noopener noreferrer">Wiki - Secure_Digital</a></p>
<p><a href="https://www.sdcard.org/developers/overview/index.html"target="_blank" rel="noopener noreferrer">SD Standard Overview</a></p>
</article><section class="article labels"><a class="category" href=/categories/%E5%9B%BA%E4%BB%B6%E6%8F%90%E5%8F%96%E7%B3%BB%E5%88%97/>固件提取系列</a><a class="tag" href=/tags/sd%E5%8D%A1/>SD卡</a><a class="tag" href=/tags/sd%E8%A7%84%E8%8C%83/>SD规范</a><a class="tag" href=/tags/sdio/>SDIO</a></section>
</div>
<div class="article bottom"><section class="article navigation"><p><a class="link" href="/posts/tinyscheme%E8%AF%BB%E5%86%99%E6%96%87%E4%BB%B6/"><span class="iconfont icon-article"></span>TinyScheme读写文件</a></p><p><a class="link" href="/posts/%E5%8D%8E%E4%B8%BA-e5885l-4g%E8%B7%AF%E7%94%B1%E5%99%A8%E6%8A%98%E8%85%BE%E7%AC%94%E8%AE%B0/"><span class="iconfont icon-article"></span>华为 E5885L 4G路由器折腾笔记</a></p></section></div></section><section id="footer"><div class="footer-wrap">
    <p class="copyright">2015 - 2025 Gorgias' Blog. </p>
    <p class="powerby"><span>Powered&nbsp;by&nbsp;</span><a href="https://gohugo.io" 
        target="_blank" rel="noopener noreferrer">Hugo</a><span>&nbsp;&amp;&nbsp;</span><a href="https://themes.gohugo.io/hugo-notepadium/" 
        target="_blank" rel="noopener noreferrer">Notepadium</a></p></div></section></body>

</html>