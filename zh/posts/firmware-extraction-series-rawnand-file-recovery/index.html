<!DOCTYPE html>
<html lang="zh"><meta charset="utf-8"><meta name="generator" content="Hugo 0.154.5"><meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<meta name="color-scheme" content="light dark">
<meta name="supported-color-schemes" content="light dark"><meta name="description" content="å‰è¨€
æœ¬æ–‡è®°å½•äº†è¿˜åŸè½¦æœºå†…NAND Flashæ–‡ä»¶ç³»ç»Ÿçš„è¿‡ç¨‹ã€‚"><title>å›ºä»¶æå–ç³»åˆ— - RawNANDæ–‡ä»¶æ¢å¤&nbsp;&ndash;&nbsp;Gorgias&#39; Blog</title><link rel="stylesheet" href="/css/core.min.363cdd0e3e6340dd0e88b1f21887fb7e53e3129ed31d7f3cf62686d06069621ece79dc5ffb48a77ebba54468e667212f.css" integrity="sha384-NjzdDj5jQN0OiLHyGIf7flPjEp7THX889iaG0GBpYh7Oedxf&#43;0infrulRGjmZyEv"><meta name="twitter:card" content="summary" />
<meta name="twitter:title" content="å›ºä»¶æå–ç³»åˆ— - RawNANDæ–‡ä»¶æ¢å¤" /><body><section id="header">
    <div class="header wrap"><span class="header left-side"><a class="site home" href="/zh/"><span class="site name">Gorgias' Blog</span></a></span>
        <span class="header right-side"><div class="nav wrap"><nav class="nav"><a class="nav item" href="/zh/categories/">åˆ†ç±»</a><a class="nav item" href="/zh/tags/">æ ‡ç­¾</a><a class="nav item" href="/zh/about/">å…³äº</a><a class="nav item" href="/zh/links/">å‹é“¾</a><a class="nav item" href="/en/posts/firmware-extraction-series-rawnand-file-recovery/" title="English">
            <span class="lang-icon">ğŸŒ</span>English</a></nav></div></span></div></section><section id="content"><style>
     
    .toc-wrapper {
        position: fixed;
        bottom: 30px;
        right: 30px;
        z-index: 9999;
        display: flex;
        flex-direction: column-reverse;
        align-items: flex-end;
        gap: 10px;
    }

     
    .toc-button {
        background-color: #fff;
        color: #333;
        width: 50px;
        height: 50px;
        border-radius: 50%;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        border: 1px solid #ddd;
        transition: transform 0.2s, box-shadow 0.2s;
    }

    .toc-button:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2);
    }

    .toc-button svg {
        width: 24px;
        height: 24px;
        fill: currentColor;
    }

     
    .toc-content-box {
        background: #fff;
        border: 1px solid #eee;
        border-radius: 8px;
        padding: 15px;
        width: 250px;
        max-height: 60vh;
        overflow-y: auto;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        display: none;
         
        font-size: 0.9em;
        opacity: 0;
        transform: translateY(10px);
        transition: opacity 0.3s, transform 0.3s;
    }

    .toc-content-box.show {
        display: block;
        opacity: 1;
        transform: translateY(0);
    }

    .toc-header {
        font-weight: bold;
        border-bottom: 2px solid #f0f0f0;
        padding-bottom: 8px;
        margin-bottom: 8px;
        font-size: 1.1em;
    }

     
    #TableOfContents {
        text-align: left;
    }

    #TableOfContents ul,
    #TableOfContents ol {
        list-style: none;
        padding-left: 0;
        margin: 0;
    }

    #TableOfContents li {
        margin: 4px 0;
    }

    #TableOfContents ul ul,
    #TableOfContents ol ol {
        padding-left: 1em;
    }

    #TableOfContents a {
        text-decoration: none;
        color: #555;
        display: block;
        padding: 2px 0;
        transition: color 0.2s;
    }

    #TableOfContents a:hover {
        color: #007bff;
    }

     
    @media (prefers-color-scheme: dark) {
        .toc-button {
            background-color: #333;
            color: #ddd;
            border-color: #555;
        }

        .toc-content-box {
            background-color: #2a2a2a;
            border-color: #444;
            color: #ddd;
        }

        .toc-header {
            border-bottom-color: #444;
        }

        #TableOfContents a {
            color: #aaa;
        }

        #TableOfContents a:hover {
            color: #fff;
        }
    }
</style><div class="article-container"><section class="article header">
    <h1 class="article title">å›ºä»¶æå–ç³»åˆ— - RawNANDæ–‡ä»¶æ¢å¤</h1><p class="article date">2019-03-10<span class="langs"><span class="lang">
                    <a href="/en/posts/firmware-extraction-series-rawnand-file-recovery/" title="English">
                        <span class="lang-icon">ğŸŒ</span>English</a>
                </span></span></p></section><article class="article markdown-body"><h2 id="å‰è¨€">å‰è¨€</h2>
<p>æœ¬æ–‡è®°å½•äº†è¿˜åŸè½¦æœºå†…NAND Flashæ–‡ä»¶ç³»ç»Ÿçš„è¿‡ç¨‹ã€‚</p>
<h2 id="æ¢å¤è¿‡ç¨‹">æ¢å¤è¿‡ç¨‹</h2>
<p>è½¦æœºä¸­é«˜é€šCPUä½¿ç”¨MXIC B162711 NAND Flashå­˜å‚¨èŠ¯ç‰‡ï¼Œä¸€èˆ¬å¾ˆå°‘ç›´æ¥ç”¨NAND Flashçš„ï¼Œé™¤éåƒé«˜é€šè¿™æ ·å¯¹è‡ªå·±çš„ä¸»æ§ç‰¹åˆ«è‡ªä¿¡ã€‚
åœ¨è¿›è¡Œç¡¬ä»¶åˆ†ææ—¶ï¼Œå‘ç°æ­¤èŠ¯ç‰‡å¹¶æœªé‡‡å–é˜²æ‹†æªæ–½ï¼Œæ•…å°†å…¶æ”¾åœ¨ç„Šæ¥å°ï¼Œè¿›è¡Œæ‹†è§£ã€‚</p>
<p><img loading="lazy"  src="./tearoff.png"
        alt="tearoff"/></p>
<p>å…¶èŠ¯ç‰‡ä¿¡æ¯å¦‚ä¸‹ï¼Œæ˜¯ä¸€å—512MBçš„SLC NAND</p>
<p><img loading="lazy"  src="./features.png"
        alt="features"/></p>
<p>èŠ¯ç‰‡é‡‡ç”¨BGA63å°è£…ï¼Œå…¶å¼•è„šå®šä¹‰å¦‚ä¸‹</p>
<p><img loading="lazy"  src="./bga63.png"
        alt="bga63"/></p>
<p>ä»¥ä¸‹ä¸ºæå–è¿‡ç¨‹ï¼Œä½¿ç”¨çš„æ˜¯Promanç¼–ç¨‹å™¨</p>
<p><img loading="lazy"  src="./socket.png"
        alt="socket"/></p>
<p><img loading="lazy"  src="./reading.png"
        alt="reading"/></p>
<p>éšåæˆ‘å¯¹æ­¤èŠ¯ç‰‡çš„å›ºä»¶è¿›è¡Œäº†å¤šæ¬¡çš„è¯»å–ï¼Œå¹¶ç›¸äº’æ¯”å¯¹ï¼Œä¿ç•™å‡ºç°æ¬¡æ•°å¤šçš„å­—èŠ‚ï¼Œå°½é‡å‡å°ç¿»è½¬ä½çš„å½±å“ï¼Œä¿è¯å›ºä»¶çš„æ­£ç¡®æ€§ã€‚</p>
<p><img loading="lazy"  src="./bytes_diff.png"
        alt="bytes_diff"/></p>
<p>è½¦æœºä½¿ç”¨é«˜é€šCSR3703 SoCæ–¹æ¡ˆã€‚</p>
<p><img loading="lazy"  src="./CSR3703.png"
        alt="CSR3703"/></p>
<p>äº’è”ç½‘ä¸Šå¹¶æœªå…¬å¼€è¯¥èŠ¯ç‰‡çš„æ•°æ®æ‰‹å†Œï¼Œå°è¯•äº†_________ï¼Œæ— æ³•è·å–æ•°æ®æ‰‹å†Œï¼Œä»–ä»¬å¯¹æ•°æ®æ‰‹å†Œéå¸¸ä¿å¯†ã€‚</p>
<p>æ‰‹åŠ¨æ‹†è§£èŠ¯ç‰‡ï¼Œä¹Ÿæ— æ³•ä»BGAæ’åˆ—åˆ¤æ–­èŠ¯ç‰‡ç±»å‹ã€‚</p>
<p><img loading="lazy"  src="./CSR3703pin.png"
        alt="CSR3703pin"/></p>
<p>é€šè¿‡ç›²æµ‹ï¼Œç¡®å®šäº†SoCå†…å­˜æ˜ å°„è¡¨åœ¨NANDä¸»æ§ä¸­ï¼Œå› æ­¤å›ºä»¶è½¬å‚¨æ–‡ä»¶çš„é€»è¾‘å—é¡ºåºæ— æ³•ç¡®å®šã€‚</p>
<p><img loading="lazy"  src="./soc_block_diagram.png"
        alt="soc_block_diagram"/></p>
<p>å› æ­¤åªèƒ½å¯¹æå–çš„å›ºä»¶ç›²æµ‹ï¼Œé€šè¿‡åˆ†æNAND Dumpçš„äºŒè¿›åˆ¶æ•°æ®ï¼Œæš‚æ—¶æŠŠç³»ç»Ÿåº•å±‚éƒ¨åˆ†æ–‡ä»¶æå–å‡ºæ¥ï¼ŒåŒ…æ‹¬U-Bootã€‚</p>
<p><img loading="lazy"  src="./binwalk.png"
        alt="binwalk"/></p>
<p>å¯ä»¥å¯¹U-Booté€†å‘åˆ†æï¼Œä½†æ˜¯é‡è¦ä¿¡æ¯åœ¨ç³»ç»Ÿåˆ†åŒºå†…ã€‚</p>
<p>CSR Visor 128KB</p>
<p><img loading="lazy"  src="./dts1.png"
        alt="dts1"/></p>
<p>Device Treeï¼Œæ˜¾ç¤ºæ§åˆ¶å°ä¸ºttySiRF1ï¼Œæ³¢ç‰¹ç‡115200</p>
<p><img loading="lazy"  src="./dts2.png"
        alt="dts2"/></p>
<p>NANDä¸»æ§é…ç½®ä¿¡æ¯ã€‚</p>
<p><img loading="lazy"  src="./dts3.png"
        alt="dts3"/></p>
<p>ç”±äºä¸Šä¸€å°è½¦æœºçš„NANDè½¬å‚¨æ–‡ä»¶æ“¦é™¤å—è¿‡äºéšæœºï¼Œå› æ­¤ä»å¦ä¸€å°è½¦æœºæ‹†è§£äº†NAND Flashè¯»å–</p>
<p><img loading="lazy"  src="./reball1.png"
        alt="reball1"/>
<img loading="lazy"  src="./reball2.png"
        alt="reball2"/></p>
<p>ä¸ºäº†ç»§ç»­ä½¿ç”¨è½¦æœºï¼Œå¯¹èŠ¯ç‰‡é‡æ¤çƒï¼Œä½¿ç”¨å…‰å­¦ç„Šå°è¿›è¡Œå¯¹ä½ä¿®å¤ã€‚</p>
<p><img loading="lazy"  src="./reball3.png"
        alt="reball3"/></p>
<p>æŸ¥é˜…äº†ä¸€äº›èµ„æ–™ï¼ŒWLæ¨¡å¼å¯èƒ½æ˜¯æ··åˆæ¨¡å¼ï¼Œå‚è€ƒäº†ç°æœ‰å…¬å¼€çš„FTLä»£ç ï¼Œå¹¶æ²¡æœ‰æ‰¾åˆ°èƒ½åŒ¹é…çš„æ˜ å°„é€»è¾‘ï¼ŒçŒœæµ‹FTL Tableå¯èƒ½å­˜æ”¾åœ¨NAND Controllerçš„ROMå†…ã€‚</p>
<p><img loading="lazy"  src="./compact_flash_system.png"
        alt="compact_flash_system"/></p>
<p>é€šè¿‡åˆ†æU-Bootï¼Œç¡®å®šä½¿ç”¨äº†ä¸“æœ‰çš„NANDDiské©±åŠ¨ï¼Œä½¿ç”¨IOCtlæ¥è¯»å†™NANDï¼Œæ˜ å°„ç®—æ³•ä¸åœ¨æ­¤å¤„ã€‚</p>
<p><img loading="lazy"  src="./nand_driver.png"
        alt="nand_driver"/></p>
<p>å› æ­¤åªèƒ½å¾—åˆ°ç¢ç‰‡åŒ–çš„æ–‡ä»¶ï¼Œè€Œéæ–‡ä»¶ç³»ç»Ÿã€‚ä¸ºäº†æµ‹è¯•æ˜ å°„è¡¨æ˜¯å¦çœŸçš„å­˜æ”¾åœ¨SoCå†…ï¼Œæˆ‘å°†ä¸¤å°ç›¸åŒçš„è½¦æœºçš„NAND Flashè¿›è¡Œæ›¿æ¢å®éªŒï¼Œæ§åˆ¶å˜é‡ï¼Œå¹¶è¿›è¡Œå¤šæ¬¡æ¤çƒæ‹†ç„Šï¼Œä½¿ç”¨å…¶ä»–è½¦æœºçš„NAND Flashæ²¡æœ‰ä¸€æ¬¡èƒ½å¯åŠ¨ã€‚æœ€åï¼Œæˆ‘å°†è‡ªå¸¦çš„NAND Flashæ¤çƒåˆ†åˆ«è£…å›åŸå…ˆçš„è½¦æœºï¼Œèƒ½æˆåŠŸå¯åŠ¨ï¼Œè¯æ˜äº†SoCå†…å­˜åœ¨æ˜ å°„ã€‚</p>
<p><img loading="lazy"  src="./reball_again.png"
        alt="reball_again"/></p>
<p>ç»è¿‡å¤šæ¬¡å¯¹æ¯”ï¼Œå°†å®Œæ•´æ€§é«˜äº50%çš„RAMdiskæå–å‡ºæ¥ï¼Œå¯ä»¥æˆåŠŸè¯»å–åˆ°å‰åŠéƒ¨åˆ†çš„æ•°æ®ã€‚</p>
<p><img loading="lazy"  src="./binalk_again.png"
        alt="binalk_again"/></p>
<p><img loading="lazy"  src="./hex_workshop.png"
        alt="hex_workshop"/></p>
<p>ä½†æ˜¯å¯ä»¥ç¡®å®šä½¿ç”¨äº†Linux EXTæ–‡ä»¶ç³»ç»Ÿï¼Œæ ¹æ®MBRä¿¡æ¯æœ‰ä¸‰ä¸ªåˆ†åŒº</p>
<p><img loading="lazy"  src="./010editor.png"
        alt="010editor"/></p>
<p>Parititon1: 30MB</p>
<p>Partition2: 400MB</p>
<p>Partition3: 61.75MB</p>
<p>å…¶ä»–æ–‡ä»¶åªæ˜¯ä¸€äº›èµ„æºæ–‡ä»¶å’Œç¢ç‰‡åŒ–çš„ELFæ–‡ä»¶ï¼Œå› ä¸ºELFç¢ç‰‡åŒ–ï¼Œæ— æ³•æ­£å¸¸é€†å‘åˆ†æã€‚</p>
<p><img loading="lazy"  src="./files_1.png"
        alt="files_1"/></p>
<p>äºæ˜¯æˆ‘æ‰‹åŠ¨å°è¯•å¯»æ‰¾æ“¦é™¤å—é¡ºåºé€»è¾‘ï¼Œå°†æ¯ä¸ªæ“¦é™¤å—åˆ†ç¦»å‡ºæ¥ï¼Œåˆ†ææ¯ä¸ªå—çš„ç‰¹å¾ï¼Œç”±äºæœ€å‰é¢ä¸€éƒ¨åˆ†çš„OOBåŒºåŸŸå’Œåé¢ä¸ä¸€æ ·ï¼Œå½±å“äº†æˆ‘å½“æ—¶çš„åˆ¤æ–­ï¼Œåªæ‰¾å‡ºäº†é¡µçš„é¡ºåºï¼Œæ‰€ä»¥åªèƒ½è¿˜åŸå‡ºä½“ç§¯è¾ƒå°çš„zImageå’ŒRamdiskï¼Œæ•´ä½“é€»è¾‘æ— æ³•çŒœè§£ã€‚</p>
<p><img loading="lazy"  src="./files_2.png"
        alt="files_2"/></p>
<p>åœ¨NANDè½¬å‚¨æ–‡ä»¶ä¸­ä¹Ÿæ²¡æ‰¾åˆ°Map Tableï¼Œå› æ­¤æ— æ³•åœ¨çŸ­æ—¶é—´å†…è·å–æ–‡ä»¶ï¼Œéœ€è¦åˆ†ææ¸…æ¥šå—çš„è§„å¾‹ï¼Œæ‰èƒ½å¾—åˆ°æ˜ å°„é€»è¾‘ã€‚</p>
<p>æˆ‘æŠŠæœ€åå¦ä¸€å°è½¦æœºçš„NAND Flashæ‹†ä¸‹å¹¶è¿›è¡Œäº†è¯»å–ã€‚</p>
<p>å‘ç°ä¸¤ä¸ªè½¦æœºç³»ç»Ÿç‰ˆæœ¬ä¸ä¸€è‡´ï¼Œæ— æ³•ç»§ç»­åˆ†æã€‚</p>
<p>XXXXX_IHU_LOW_A7_LINUX_18.0F40</p>
<p>XXXXX_IHU_LOW_A7_LINUX_18.0F43</p>
<p>Kernelå’Œramdiskçš„ç¼–è¯‘æ—¶é—´é¡µä¸ä¸€è‡´ï¼Œå› æ­¤æ²¡æœ‰åŠæ³•é€šè¿‡ç›²æµ‹æ¥çŒœè§£æ˜ å°„ç®—æ³•</p>
<p><img loading="lazy"  src="./modification_time.png"
        alt="modification_time"/>
<img loading="lazy"  src="./modification_time2.png"
        alt="modification_time2"/></p>
<p>å› ä¸ºä½¿ç”¨äº†æ··åˆæ˜ å°„ï¼Œé€šè¿‡USB HID GetShellçš„æ–¹å¼è·å–äº†ç›¸åŒç‰ˆæœ¬çš„å›ºä»¶è¿›è¡Œåˆ†æï¼Œå¾—åˆ°äº†æ˜ å°„ç®—æ³•ã€‚</p>
<p><img loading="lazy"  src="./struct.png"
        alt="struct"/></p>
<p>è¿™æ˜¯ä¿®å¤NAND dumpçš„è„šæœ¬ï¼Œæˆ‘ä¹Ÿå¿˜äº†å½“æ—¶å†™äº†äº›å•¥ä¸œè¥¿</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="ch">#!/usr/bin/env python3</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">sys</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">binascii</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">struct</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;Usage: fuckftl.py ftl.bin raw.bin&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">bin2hex</span><span class="p">(</span><span class="nb">bin</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">x</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">binascii</span><span class="o">.</span><span class="n">b2a_hex</span><span class="p">(</span><span class="nb">bin</span><span class="p">),</span> <span class="s2">&#34;utf-8&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">x</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">hex2int</span><span class="p">(</span><span class="nb">hex</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">x</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="s1">&#39;0x&#39;</span> <span class="o">+</span> <span class="nb">hex</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">x</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">get_hex_tens_place</span><span class="p">(</span><span class="n">num</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">x</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">num</span> <span class="o">/</span> <span class="mh">0x10</span><span class="p">)</span> <span class="o">%</span> <span class="mh">0x10</span><span class="p">)</span> <span class="o">*</span> <span class="mh">0x10</span> <span class="o">+</span> <span class="nb">int</span><span class="p">((</span><span class="n">num</span> <span class="o">/</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="mh">0x10</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">x</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">get_le_int16</span><span class="p">(</span><span class="n">be</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s2">&#34;&lt;H&#34;</span><span class="p">,</span> <span class="n">be</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">proman_file_path</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">raw_file_path</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">nanddisk_path</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">readable_block_addr</span> <span class="o">=</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&#34;sp_.bin&#34;</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">sp</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">proman_file_path</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">proman_file</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">promanbin</span> <span class="o">=</span> <span class="n">proman_file</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="n">proman_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">raw_file_path</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">raw_file</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">promanbin</span><span class="p">),</span> <span class="mh">0x840</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                    <span class="n">pbuffer</span> <span class="o">=</span> <span class="n">promanbin</span><span class="p">[</span><span class="n">x</span><span class="p">:</span><span class="n">x</span><span class="o">+</span><span class="mh">0x840</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">                    <span class="n">page_a</span> <span class="o">=</span> <span class="n">pbuffer</span><span class="p">[:</span><span class="mh">0x400</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">                    <span class="n">page_b</span> <span class="o">=</span> <span class="n">pbuffer</span><span class="p">[</span><span class="mh">0x415</span><span class="p">:</span><span class="mh">0x800</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">                    <span class="n">page_c</span> <span class="o">=</span> <span class="n">pbuffer</span><span class="p">[</span><span class="mh">0x816</span><span class="p">:</span><span class="mh">0x82B</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                    <span class="n">sparea_b</span> <span class="o">=</span> <span class="n">pbuffer</span><span class="p">[</span><span class="mh">0x800</span><span class="p">:</span><span class="mh">0x816</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="n">sparea_b</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\xFF\x42\x00\x00</span><span class="s1">&#39;</span> <span class="ow">or</span> <span class="p">(</span><span class="n">sparea_b</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\xFF\x41\xFF\xFF</span><span class="s1">&#39;</span> <span class="ow">and</span> <span class="n">sparea_b</span><span class="p">[</span><span class="mi">6</span><span class="p">:</span><span class="mi">8</span><span class="p">]</span> <span class="o">==</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00\x00</span><span class="s1">&#39;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                        <span class="n">x_addr</span> <span class="o">=</span> <span class="n">get_le_int16</span><span class="p">(</span><span class="n">sparea_b</span><span class="p">[</span><span class="mi">4</span><span class="p">:</span><span class="mi">6</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">                        <span class="k">if</span> <span class="n">x_addr</span> <span class="ow">in</span> <span class="n">readable_block_addr</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                            <span class="n">cur_wl_version</span> <span class="o">=</span>  <span class="n">get_le_int16</span><span class="p">(</span><span class="n">sparea_b</span><span class="p">[</span><span class="mi">6</span><span class="p">:</span><span class="mi">8</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">                            <span class="k">if</span> <span class="n">readable_block_addr</span><span class="p">[</span><span class="n">x_addr</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">cur_wl_version</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                                <span class="n">readable_block_addr</span><span class="p">[</span><span class="n">x_addr</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span> <span class="o">/</span> <span class="mh">0x840</span> <span class="o">*</span> <span class="mh">0x800</span><span class="p">),</span> <span class="n">get_le_int16</span><span class="p">(</span><span class="n">sparea_b</span><span class="p">[</span><span class="mi">6</span><span class="p">:</span><span class="mi">8</span><span class="p">])]</span>
</span></span><span class="line"><span class="cl">                        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                            <span class="n">readable_block_addr</span><span class="p">[</span><span class="n">x_addr</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span> <span class="o">/</span> <span class="mh">0x840</span> <span class="o">*</span> <span class="mh">0x800</span><span class="p">),</span> <span class="n">get_le_int16</span><span class="p">(</span><span class="n">sparea_b</span><span class="p">[</span><span class="mi">6</span><span class="p">:</span><span class="mi">8</span><span class="p">])]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                    <span class="n">pbuffer</span> <span class="o">=</span> <span class="n">page_a</span> <span class="o">+</span> <span class="n">page_b</span> <span class="o">+</span> <span class="n">page_c</span>
</span></span><span class="line"><span class="cl">                    <span class="n">raw_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">pbuffer</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="n">sp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">sparea_b</span><span class="p">[:</span><span class="mi">10</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">            <span class="n">raw_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">sp</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">readable_block_addr_sorted</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">readable_block_addr</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">raw_file_path</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">raw_file</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">rawbin</span> <span class="o">=</span> <span class="n">raw_file</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">raw_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">cur_index</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl">    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">nanddisk_path</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">nand_file</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="p">)</span> <span class="ow">in</span> <span class="n">readable_block_addr_sorted</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">k</span><span class="o">&lt;</span><span class="mh">0xfff</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;fix block </span><span class="si">{:x}</span><span class="s2">, off </span><span class="si">{:x}</span><span class="s2">&#34;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
</span></span><span class="line"><span class="cl">                <span class="c1"># print(hex(k))</span>
</span></span><span class="line"><span class="cl">                <span class="n">skip</span> <span class="o">=</span> <span class="n">k</span><span class="o">-</span><span class="n">cur_index</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">(</span><span class="n">skip</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">nand_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">rawbin</span><span class="p">[</span><span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mh">0x20000</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">                <span class="n">cur_index</span> <span class="o">=</span> <span class="n">cur_index</span> <span class="o">+</span> <span class="n">skip</span>
</span></span><span class="line"><span class="cl">        <span class="n">nand_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span></span></code></pre></div><p>æœ€ç»ˆè¿˜åŸå‡ºå›ºä»¶ï¼Œç”±äºNANDä½ç¿»è½¬ç‰¹æ€§ï¼Œè¿˜éœ€è¦ä½¿ç”¨Hanming ECCä¿®å¤é”™è¯¯ã€‚å¦å¤–å› ä¸ºè¯¥ç³»ç»Ÿé‡å¯è¿‡å¤šæ¬¡ï¼Œéƒ¨åˆ†å†…å®¹ä¸ä¸€è‡´ï¼Œæ‰€ä»¥ä¸‹å›¾æ˜¾ç¤ºå­˜åœ¨å¤§é‡å·®å¼‚ã€‚</p>
<p><img loading="lazy"  src="./fixed_diff.png"
        alt="fixed_diff"/></p>
<p>æ–‡ä»¶å¤§å°ä¸ç±»å‹éƒ½æ²¡æœ‰é”™è¯¯</p>
<p><img loading="lazy"  src="./fdisk.png"
        alt="fdisk"/></p>
<p>è¿˜åŸå‡ºå›ºä»¶çš„å¤§å°ä¸å®é™…è¿è¡Œä¸­çš„ç³»ç»Ÿæ˜¾ç¤ºçš„496.6MiBåŒ¹é…</p>
<p><img loading="lazy"  src="./nand_info.png"
        alt="nand_info"/></p>
<p>æ‰“å¼€å…¶ä¸­çš„ç¬¬äºŒä¸ªåˆ†åŒºï¼Œå¯ä»¥çœ‹åˆ°æ­£å¸¸æ˜¾ç¤ºç›®å½•</p>
<p><img loading="lazy"  src="./fixed.png"
        alt="fixed"/></p>
<p>ä½†æ˜¯ç”±äºä½ç¿»è½¬ï¼Œæˆ‘ä¼°è®¡è‚¯å®šæœ‰ä¸€äº›æ–‡ä»¶æ˜¯æŸåçš„ï¼Œå› ä¸ºæ—¶é—´é™åˆ¶ï¼Œæ²¡æœ‰ç»§ç»­ç ”ç©¶ä¸‹å»ã€‚</p>
</article><section class="article labels"><a class="category" href=/zh/categories/%E5%9B%BA%E4%BB%B6%E6%8F%90%E5%8F%96%E7%B3%BB%E5%88%97/>å›ºä»¶æå–ç³»åˆ—</a><a class="tag" href=/zh/tags/nand/>NAND</a><a class="tag" href=/zh/tags/ftl/>FTL</a><a class="tag" href=/zh/tags/oob/>OOB</a><a class="tag" href=/zh/tags/flash/>Flash</a></section>
</div>

<div class="article bottom"><section class="article navigation"><p><a class="link" href="/zh/posts/firmware-extraction-series-sata-hdd-unlock/"><span class="iconfont icon-article"></span>å›ºä»¶æå–ç³»åˆ— - SATAç¡¬ç›˜è§£é”</a></p><p><a class="link" href="/zh/posts/visteon-firmware-repacking/"><span class="iconfont icon-article"></span>Visteonå›ºä»¶é‡æ‰“åŒ…</a></p></section></div></section><section id="footer"><div class="footer-wrap">
    <p class="copyright">2015 - 2026 Gorgias' Blog. </p><p class="license">
        <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noopener noreferrer">
            <img alt="CC BY-NC-SA" loading="lazy" src="/images/by-nc.svg" style="vertical-align: middle; height: 1.2em; margin: 0 0.2em;" />
            CC BY-NC-SA 4.0
        </a>
        (ç½²å-éå•†ä¸šæ€§ä½¿ç”¨-ç›¸åŒæ–¹å¼å…±äº«).
    </p><p class="powerby"><span>Powered&nbsp;by&nbsp;</span><a href="https://gohugo.io" 
        target="_blank" rel="noopener noreferrer">Hugo</a><span>&nbsp;&amp;&nbsp;</span><a href="https://themes.gohugo.io/hugo-notepadium/" 
        target="_blank" rel="noopener noreferrer">Notepadium</a></p></div></section></body>

</html>