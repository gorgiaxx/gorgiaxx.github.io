<!DOCTYPE html>
<html lang="zh"><meta charset="utf-8"><meta name="generator" content="Hugo 0.154.5"><meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<meta name="color-scheme" content="light dark">
<meta name="supported-color-schemes" content="light dark"><meta name="description" content="å‰è¨€
SDå¡(Secure Digital Memory Card)æ˜¯ä¸€ç§å­˜å‚¨ä»‹è´¨ï¼ŒåŸºäºNANDé—ªå­˜æŠ€æœ¯ï¼Œä½œä¸ºMMC(Multimedia Card)çš„æ›¿ä»£ã€‚ä¸€èˆ¬ç”¨äºå¤šåª’ä½“æ’­æ”¾å™¨ï¼Œç›¸æœºï¼Œæ‰‹æœºï¼Œéšåä¹Ÿå¤§é‡ç”¨äºIoTè®¾å¤‡å’Œæ±½è½¦ç”µå­ã€‚æ ¹æ®SDå¡å°ºå¯¸ï¼Œå¯ä»¥åˆ†ä¸ºSDã€miniSDã€microSDã€‚"><title>å›ºä»¶æå–ç³»åˆ— - SDå¡è§£é”&nbsp;&ndash;&nbsp;Gorgias&#39; Blog</title><link rel="stylesheet" href="/css/core.min.363cdd0e3e6340dd0e88b1f21887fb7e53e3129ed31d7f3cf62686d06069621ece79dc5ffb48a77ebba54468e667212f.css" integrity="sha384-NjzdDj5jQN0OiLHyGIf7flPjEp7THX889iaG0GBpYh7Oedxf&#43;0infrulRGjmZyEv"><meta name="twitter:card" content="summary" />
<meta name="twitter:title" content="å›ºä»¶æå–ç³»åˆ— - SDå¡è§£é”" /><body><section id="header">
    <div class="header wrap"><span class="header left-side"><a class="site home" href="/zh/"><span class="site name">Gorgias' Blog</span></a></span>
        <span class="header right-side"><div class="nav wrap"><nav class="nav"><a class="nav item" href="/zh/categories/">åˆ†ç±»</a><a class="nav item" href="/zh/tags/">æ ‡ç­¾</a><a class="nav item" href="/zh/about/">å…³äº</a><a class="nav item" href="/zh/links/">å‹é“¾</a></nav></div></span></div></section><section id="content"><div class="article-container"><section class="article header">
    <h1 class="article title">å›ºä»¶æå–ç³»åˆ— - SDå¡è§£é”</h1><p class="article date">Thursday, October 18, 2018<span class="langs"><span class="lang">
                    <a href="/en/posts/firmware-extraction-series-sd-card-unlock/" title="English">
                        <span class="lang-icon">ğŸŒ</span>English</a>
                </span></span></p></section><article class="article markdown-body"><h2 id="å‰è¨€">å‰è¨€</h2>
<p>SDå¡(Secure Digital Memory Card)æ˜¯ä¸€ç§å­˜å‚¨ä»‹è´¨ï¼ŒåŸºäºNANDé—ªå­˜æŠ€æœ¯ï¼Œä½œä¸ºMMC(Multimedia Card)çš„æ›¿ä»£ã€‚ä¸€èˆ¬ç”¨äºå¤šåª’ä½“æ’­æ”¾å™¨ï¼Œç›¸æœºï¼Œæ‰‹æœºï¼Œéšåä¹Ÿå¤§é‡ç”¨äºIoTè®¾å¤‡å’Œæ±½è½¦ç”µå­ã€‚æ ¹æ®SDå¡å°ºå¯¸ï¼Œå¯ä»¥åˆ†ä¸ºSDã€miniSDã€microSDã€‚</p>
<p><img loading="lazy"  src="./sd_size.png"
        alt="sd_size"/></p>
<p>SDå¡çš„é€Ÿåº¦ç­‰çº§æ ‡å‡†å½“å‰åœ¨ç”¨çš„æœ‰ä¸¤ç§ï¼Œä¸€ç§æ˜¯æ™®é€šé€Ÿåº¦æ ‡è®°ï¼Œå¦ä¸€ç§æ˜¯UHSé€Ÿåº¦æ ‡è®°ï¼Œä¸åŒé€Ÿåº¦æ ‡å‡†å¯¹åº”çš„æ€»çº¿æ¨¡å¼ä¹Ÿä¸åŒã€‚ç°åœ¨SDåä¼šåˆå‡ºäº†æ–°çš„é€Ÿåº¦ç­‰çº§æ ‡å‡†ï¼šVideo Speed Classï¼Œä½¿ç”¨UHSæ€»çº¿ã€‚SDå¡çš„å®¹é‡ä¹Ÿæœ‰æ ‡å‡†ï¼Œä»SDSCåˆ°SDUCã€‚</p>
<p><img loading="lazy"  src="./Micro-SD-speeds.png"
        alt="Micro-SD-speeds"/>
<img loading="lazy"  src="./bus_speed_img.jpg"
        alt="bus_speed_img"/></p>
<p>SDå¡çš„å‚æ•°å¯ä»¥åœ¨SDå¡çš„è´´çº¸æˆ–è€…ä¸å°ä¸Šçœ‹åˆ°ã€‚</p>
<p><img loading="lazy"  src="./sd_sticker.png"
        alt="sd_sticker"/></p>
<p>è€ŒmicroSDå¡åŸåæ˜¯TFå¡(Trans-flash Card)ï¼ŒSDæ’æ§½å…¼å®¹MMCå¡ï¼Œä¹Ÿå¯ä»¥é€šè¿‡é£çº¿æ–¹å¼å°†eMMCæ¥åˆ°SDæ’æ§½ã€‚</p>
<p><img loading="lazy"  src="./sd_emmc.png"
        alt="sd_emmc"/></p>
<p>æœ¬æ–‡åŸºäºSDç‰©ç†å±‚ç®€åŒ–è§„èŒƒç¬¬å…­ç‰ˆï¼Œä¸»è¦ç ”ç©¶è§£é”æœºåˆ¶ã€‚</p>
<p>SDIO(Secure Digital Input Output)æ˜¯ç”±SDç‰©ç†å±‚è§„èŒƒä¿®æ”¹è€Œæ¥ï¼Œå±äºSDè§„èŒƒçš„æ‰©å±•ï¼Œé™¤äº†æ”¯æŒSDIOè§„èŒƒçš„å‚¨å­˜å¡ï¼Œè¿˜æ”¯æŒSDIOå¤–å›´è®¾å¤‡ï¼Œä¾‹å¦‚WiFiæ¨¡å—ã€GPSæ¨¡å—ã€CMOSä¼ æ„Ÿå™¨æ¨¡å—ç­‰ã€‚</p>
<h2 id="io-informations">I/O informations</h2>
<p>ä¸‹é¢æ˜¯MMCå¡å’ŒSDå¡å¼•è„šçš„å¯¹æ¯”</p>
<p><img loading="lazy"  src="./pin_compare.gif"
        alt="pin_compare"/></p>
<p>åœ¨ä¸åŒçš„æ€»çº¿åè®®å’Œä¼ è¾“æ¨¡å¼ä¸‹ï¼Œè¿™äº›å¼•è„šéƒ½è´Ÿè´£ä¸åŒçš„åŠŸèƒ½ï¼Œæœ¬æ–‡ä¸»è¦ç ”ç©¶SDæ¨¡å¼çš„è§„èŒƒã€‚åœ¨Typeä¸€æ ï¼Œæœ‰å¦‚ä¸‹å®šä¹‰ï¼š</p>
<ul>
<li>S - Power Supply</li>
<li>I - Input</li>
<li>O - Output using Pull Push Drivers</li>
<li>PP - I/O using Pull Push Drivers</li>
</ul>
<table>
  <thead>
      <tr>
          <th>Pin #</th>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>1</td>
          <td>CD/DAT3</td>
          <td>I/O/PP</td>
          <td>Card Detect/Data Line [Bit3]</td>
      </tr>
      <tr>
          <td>2</td>
          <td>CMD</td>
          <td>I/O/PP</td>
          <td>Command/Response</td>
      </tr>
      <tr>
          <td>3</td>
          <td>VSS1</td>
          <td>S</td>
          <td>Supply voltage ground</td>
      </tr>
      <tr>
          <td>4</td>
          <td>VDD</td>
          <td>S</td>
          <td>Supply voltage</td>
      </tr>
      <tr>
          <td>5</td>
          <td>CLK</td>
          <td>I</td>
          <td>Clock</td>
      </tr>
      <tr>
          <td>6</td>
          <td>VSS2</td>
          <td>S</td>
          <td>Supply voltage ground</td>
      </tr>
      <tr>
          <td>7</td>
          <td>DAT0</td>
          <td>I/O/PP</td>
          <td>Data Line [Bit0]</td>
      </tr>
      <tr>
          <td>8</td>
          <td>DAT1</td>
          <td>I/O/PP</td>
          <td>Data Line [Bit1]</td>
      </tr>
      <tr>
          <td>9</td>
          <td>DAT2</td>
          <td>I/O/PP</td>
          <td>Data Line [Bit2]</td>
      </tr>
  </tbody>
</table>
<p>ä¸‹é¢æ˜¯æˆ‘ä»¬è¦ç ”ç©¶çš„SDå¡ï¼ŒSDSCï¼Œåˆšå¥½æœ€å¤§2GBï¼Œä¸Šé¢å°ç€M2B9 2GB Made in Japanï¼Œç½‘ä¸Šä¸èƒ½æœç´¢åˆ°è¿™äº›ä¿¡æ¯ã€‚</p>
<p><img loading="lazy"  src="./SD_card_internal.jpg"
        alt="SD_card_internal"/></p>
<p>å†çœ‹SDä¸»æ§èŠ¯ç‰‡ï¼Œ56X31B002 AC00145Rï¼Œæ— æ³•æœç´¢åˆ°ã€‚
ä½†æ˜¯ä¸‹é¢çš„å­˜å‚¨èŠ¯ç‰‡å°æœ‰é•å…‰Logoï¼Œåœ¨<a href="https://www.micron.com/decoder"target="_blank" rel="noopener noreferrer">FBGA &amp; Component Marking Decoder</a>ç½‘ç«™å¯ä»¥æŸ¥è¯¢FPGA Codeã€‚æ˜¯SLC NAND Flashï¼ŒVBGA100å°è£…ï¼Œä½†æ˜¯å®˜ç½‘ä¿¡æ¯ä¸å¤ªå‡†ç¡®ï¼Œåªæœ‰16GBçš„ç‰ˆæœ¬ã€‚</p>
<p><img loading="lazy"  src="./SD_card_internal2.jpg"
        alt="SD_card_internal2"/></p>
<h2 id="registers">Registers</h2>
<p>OCR,CID,CSD,SCRæºå¸¦äº†å¡çš„ç‰¹å®šä¿¡æ¯ï¼ŒRCAå’ŒDSRå‚¨å­˜ç€å®é™…çš„é…ç½®å‚æ•°ï¼ŒSSRå’ŒCSRåˆ™æºå¸¦çŠ¶æ€ä¿¡æ¯ã€‚
å› ä¸ºè§„èŒƒåˆ¶å®šè€…æœ‰å¼ºè¿«ç—‡ï¼Œæ‰€ä»¥å¯„å­˜å™¨éƒ½æ˜¯ä¸‰ä½ç¼©å†™ï¼Œå¦‚æœä¸‰ä½ä¸èƒ½å‡†ç¡®è¡¨è¾¾æ„æ€ï¼Œå°±æŠŠRå»æ‰ã€‚</p>
<table>
  <thead>
      <tr>
          <th>Name</th>
          <th>length(bit)</th>
          <th>Description</th>
          <th>Optional</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>CID</td>
          <td>128</td>
          <td>Card Identification Dataï¼ŒåŒ…æ‹¬å‚å•†IDã€OEM IDã€äº§å“åã€äº§å“ç¼–å·ã€ç”Ÿäº§æ—¥æœŸä»¥åŠæ ¡éªŒå’Œ</td>
          <td>å¿…é€‰</td>
      </tr>
      <tr>
          <td>RCA</td>
          <td>16</td>
          <td>Relative Card Addressï¼Œç”¨äºå¯»å€ï¼Œé»˜è®¤0x0000ï¼ŒSPIæ¨¡å¼ä¸‹ä¸å¯ç”¨</td>
          <td>å¿…é€‰</td>
      </tr>
      <tr>
          <td>DSR</td>
          <td>16</td>
          <td>Driver Stage Registerï¼Œç”¨äºæ”¹å–„æ€»çº¿æ€§èƒ½</td>
          <td>å¯é€‰</td>
      </tr>
      <tr>
          <td>CSD</td>
          <td>128</td>
          <td>Card Special Dataï¼Œè¾ƒä¸ºå¤æ‚ï¼ŒåŒ…å«å…³äºå¡å„ç§æ“ä½œçš„æ¡ä»¶ä¿¡æ¯ï¼šé”™è¯¯ç±»å‹ã€æœ€å¤§æ•°æ®è®¿é—®æ—¶é—´ã€é€Ÿç‡ã€DSRå¯ç”¨çŠ¶æ€ç­‰</td>
          <td>å¿…é€‰</td>
      </tr>
      <tr>
          <td>SCR</td>
          <td>64</td>
          <td>SD Configuration Registerï¼ŒåŒ…å«äº†SDå¡æ”¯æŒçš„ç‰¹æ€§ï¼Œè§„èŒƒç‰ˆæœ¬</td>
          <td>å¿…é€‰</td>
      </tr>
      <tr>
          <td>OCR</td>
          <td>32</td>
          <td>Operation Condition Registerï¼Œæºå¸¦äº†å½“å‰ç”µæºä¿¡æ¯</td>
          <td>å¿…é€‰</td>
      </tr>
      <tr>
          <td>SSR</td>
          <td>512</td>
          <td>SD Status Registerï¼ŒåŒ…å«å½“å‰SDå¡ç‰¹æ€§å’Œåº”ç”¨ç‰¹æ€§çš„çŠ¶æ€ä¿¡æ¯ï¼Œå¦‚æ€»çº¿æ•°æ®å®½åº¦ã€å®‰å…¨æ¨¡å¼ã€SDå¡ç±»å‹ã€é€Ÿåº¦ç­‰</td>
          <td>å¿…é€‰</td>
      </tr>
      <tr>
          <td>CSR</td>
          <td>32</td>
          <td>Card Status Registerï¼ŒåŒ…å«äº†å½“å‰å¡æ‰§è¡Œå‘½ä»¤çš„çŠ¶æ€ä¿¡æ¯ï¼Œä½“ç°åœ¨å“åº”ä¸­ï¼Œå¦‚ä¸Šé”çŠ¶æ€ï¼Œé”™è¯¯ä¿¡æ¯ç­‰</td>
          <td>å¿…é€‰</td>
      </tr>
  </tbody>
</table>
<h2 id="architecture">Architecture</h2>
<p>å¡å†…å¸¦æœ‰ä¸Šç”µæ£€æµ‹ç”µè·¯ï¼Œä¸ä¸»æ§æ¥å£å’Œå­˜å‚¨åŒºæ¥å£ç›¸è¿ï¼Œæ¯ä¸ªå¼•è„šå’Œå¡ä¸»æ§ç›¸è¿ï¼Œä¸»æ§é€šè¿‡å­˜å‚¨æ¥å£å¯¹å­˜å‚¨åŒºè¿›è¡Œæ“ä½œã€‚</p>
<p><img loading="lazy"  src="./architecture.png"
        alt="architecture"/></p>
<h3 id="sdio">SDIO</h3>
<p>è€Œåœ¨SDIOè§„èŒƒä¸­ï¼Œå®šä¹‰äº†ä¸¤ç§ç±»å‹çš„SDIOå¡ï¼šä½é€Ÿå¡ä¸é«˜é€Ÿå¡ï¼Œå®šä¹‰äº†SDIOå¡çš„ä¸‰ç§æ¨¡å¼ï¼š</p>
<ul>
<li>SPI bus mode</li>
<li>One-bit SD bus mode - æŒ‡ä»¤å’Œæ•°æ®åˆ†ç¦»çš„ä¼ è¾“æ¨¡å¼</li>
<li>Four-bit SD bus mode - é«˜é€Ÿå¡æ”¯æŒï¼ŒæŒ‡ä»¤å•ç‹¬å ç”¨ä¸€ä¸ªé€šé“ï¼Œä½¿ç”¨å¦å¤–4é€šé“ä¼ è¾“æ•°æ®ï¼ŒSDå¡çš„é»˜è®¤æ¨¡å¼</li>
</ul>
<h2 id="sd-bus-protocol">SD Bus Protocol</h2>
<p>SDæ€»çº¿é€šä¿¡ä¸»è¦ç”±CMD(Command Token, æ“ä½œå‘½ä»¤)ã€DAT(Data, æ•°æ®)ç»„æˆã€‚CMDå’ŒDATç”±ä¸åŒçš„é€šé“å¹¶è¡Œä¼ è¾“ï¼ŒCMDå’ŒResponseèµ°åŒä¸€æ¡é€šé“ï¼ŒCMDæ¥è‡ªHost(ä¸Šä½æœº)ï¼ŒResponse(å“åº”)æ¥è‡ªSDå¡ï¼ŒResponseåªé’ˆå¯¹ç‰¹å®šçš„CMDå‡ºç°ã€‚</p>
<p><img loading="lazy"  src="./sd_protocal.png"
        alt="sd_protocal"/></p>
<p>SDè§„å®šä»¥å—ä¸ºå•ä½è¿›è¡Œè¯»å†™æ“ä½œï¼Œç´§éšç€CMDåå‡ºç°ã€‚æ¯ä¸ªæ•°æ®å—ç»“å°¾å¸¦æœ‰CRCæ ¡éªŒä½ã€‚ç”±ç»ˆæ­¢æ“ä½œç”±ç»ˆæ­¢æŒ‡ä»¤å®Œæˆã€‚</p>
<p><img loading="lazy"  src="./sd_protocal_r.png"
        alt="sd_protocal_r"/></p>
<p>å†™è¿‡ç¨‹ä¼šé™„å¸¦ä¸€ä¸ªbusyä¿¡å·ã€‚</p>
<p><img loading="lazy"  src="./sd_protocal_w.png"
        alt="sd_protocal_w"/></p>
<h3 id="cmd-format">CMD Format</h3>
<p>Command Tokençš„é•¿åº¦æ˜¯48-bitï¼Œèµ·å§‹ä½æ˜¯0ï¼Œä¼ è¾“ä½æ˜¯1ï¼Œè¡¨ç¤ºæ¥è‡ªHostçš„æ•°æ®ã€‚Contentæºå¸¦äº†å‘½ä»¤ï¼Œåœ°å€ä¿¡æ¯ä»¥åŠå‚æ•°ã€‚ç»“å°¾å¸¦æœ‰7ä½çš„CRC(Cyclic Redundancy Check)ï¼Œç»“æŸä½æ˜¯0ã€‚å› ä¸ºè¿™ä¸ªç‰¹æ€§ï¼ŒResponseçš„é¦–ä¸ªå­—èŠ‚æ¯”CMDçš„é¦–ä¸ªå­—èŠ‚å°0x40ã€‚</p>
<p><img loading="lazy"  src="./cmd_format.png"
        alt="cmd_format"/></p>
<p>Response Tokenæœ‰å››ç§åœºæ™¯ï¼Œæ ¹æ®åœºæ™¯çš„ä¸åŒé‡‡ç”¨ä¸åŒçš„é•¿åº¦ï¼Œåˆ†åˆ«æ˜¯48-bit(R1,R3,R6)ï¼Œ136-bit(R2)ã€‚ä¼ è¾“ä½æ˜¯0ï¼Œè¡¨ç¤ºæ¥è‡ªSDå¡çš„æ•°æ®ã€‚</p>
<p><img loading="lazy"  src="./response_format.png"
        alt="response_format"/></p>
<h3 id="data-packet-format">Data Packet Format</h3>
<p>é€šå¸¸æ¨¡å¼ä¸‹ï¼Œæ•°æ®é€šè¿‡DAT[0-3]å¼•è„šä¼ è¾“ã€‚å’ŒCMDä¸€æ ·ï¼Œèµ·å§‹ä½0ï¼Œç»“æŸä½1ï¼Œå¸¦æœ‰CRCæ ¡éªŒã€‚æ€»çº¿å®½åº¦é»˜è®¤1-bitã€‚</p>
<p><img loading="lazy"  src="./data_packet_format.png"
        alt="data_packet_format"/></p>
<h3 id="crc7">CRC7</h3>
<p>SDå¡ä½¿ç”¨CRC7/MMCç®—æ³•ä½œä¸ºCMDçš„æ ¡éªŒï¼Œå…¬å¼å¦‚ä¸‹
<img loading="lazy"  src="./crc7_calc.png"
        alt="crc7_calc"/>
å°†å¤šé¡¹å¼è½¬åŒ–ä¸ºäºŒè¿›åˆ¶G(x)</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">10001001
</span></span></code></pre></div><p>åœ¨æ•°æ®å¸§M(x)åè¡¥ä¸Šé•¿åº¦ä½divisor-1ï¼Œå°±æ˜¯7ï¼Œä½¿ç”¨æ¨¡2é™¤æ³•ï¼Œæ•°æ®å¸§é™¤ä»¥10001001å¾—åˆ°CRC</p>
<p><img loading="lazy"  src="./crc7.png"
        alt="crc7"/></p>
<h3 id="crc16">CRC16</h3>
<p>SDå¡ä½¿ç”¨CRC-16/CCITT-XMODEMç®—æ³•ä½œä¸ºDataçš„æ ¡éªŒã€‚å®½æ€»çº¿æ¨¡å¼ä¸‹æ¯è¡Œç‹¬ç«‹è®¡ç®—CRCï¼Œå…¬å¼å¦‚ä¸‹</p>
<p><img loading="lazy"  src="./crc16_calc.png"
        alt="crc16_calc"/></p>
<p>å°†å¤šé¡¹å¼è½¬åŒ–ä¸ºäºŒè¿›åˆ¶G(x)ï¼Œç¬¬16ä½è¶…å‡ºé•¿åº¦ï¼Œå¿½ç•¥ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">0001000000100001
</span></span></code></pre></div><p><img loading="lazy"  src="./crc16.png"
        alt="crc16"/></p>
<h2 id="response-type">Response Type</h2>
<p>SDå¡æ€»å…±æœ‰äº”ç§ç±»å‹çš„å“åº”ï¼ŒSDIOæ”¯æŒé™„åŠ çš„å“åº”ç±»å‹R4ï¼ŒR5ã€‚é™¤R3ä»¥å¤–ï¼Œå“åº”åŒ…çš„ç»“å°¾éƒ½æœ‰CRCæ ¡éªŒã€‚</p>
<ul>
<li>R1 æ­£å¸¸å“åº”å‘½ä»¤ï¼Œå¯æºå¸¦busyä¿¡å·(R1b)</li>
<li>R2 CID,CSDå“åº”</li>
<li>R3 OCRå“åº”</li>
<li>R6 RCAå“åº”</li>
<li>R7 å¡æ¥å£æ¡ä»¶å“åº”</li>
</ul>
<h3 id="ä¸åŒå“åº”å¯¹åº”çš„æ ¼å¼">ä¸åŒå“åº”å¯¹åº”çš„æ ¼å¼</h3>
<p>R1çš„å‚æ•°éƒ¨åˆ†æ˜¯32ä½ï¼Œå¯¹åº”äº†å¡çš„çŠ¶æ€ï¼Œç”±äºç‰ˆæœ¬è¿­ä»£é—®é¢˜ï¼Œè§„èŒƒé‡Œæ²¡æœ‰æ˜ç¡®è¯´æ˜¯CSRï¼ŒCSRå¯„å­˜å™¨ä¹Ÿæ˜¯åé¢å®šä¹‰çš„ã€‚R2ç›´æ¥è¿”å›CIDæˆ–CSDçš„æ•°æ®ã€‚R3è¿”å›OCRçš„æ•°æ®ã€‚</p>
<p><img loading="lazy"  src="./response_r1.png"
        alt="response_r1"/>
<img loading="lazy"  src="./response_r2.png"
        alt="response_r2"/>
<img loading="lazy"  src="./response_r3.png"
        alt="response_r3"/>
<img loading="lazy"  src="./response_r6.png"
        alt="response_r6"/>
<img loading="lazy"  src="./response_r7.png"
        alt="response_r7"/></p>
<h2 id="function-mode">Function mode</h2>
<p>SDå¡çš„æ“ä½œæ¨¡å¼æœ‰ä¸¤ç§ç§ï¼Œé»˜è®¤æ˜¯inactiveï¼š</p>
<ul>
<li>card indentification mode å¡è®¤è¯æ¨¡å¼</li>
<li>data transfer mode æ•°æ®ä¼ è¾“æ¨¡å¼</li>
</ul>
<p>UHS-IIä¸‹å’ŒSDæ¨¡å¼ä¸‹ï¼Œå¡è®¤è¯æ¨¡å¼ä¸åŒã€‚</p>
<h2 id="command">Command</h2>
<p>Commandä¸»è¦æœ‰ä¸¤ç§ç±»å‹â€”â€”â€”â€”å¹¿æ’­å’Œå¯»å€ï¼Œå…·ä½“ç»†åˆ†æœ‰å¦‚ä¸‹å››ç§:</p>
<ul>
<li>broadcast commands (bc), no response</li>
<li>broadcast commands with response (bcr) (Note: No open drain on SD card)</li>
<li>addressed (point-to-point) commands (ac), no data transfer on DAT lines</li>
<li>addressed (point-to-point) data transfer commands (adtc), data transfer on DAT lines</li>
</ul>
<p>CMD5ï¼ŒCMD52-54æ˜¯SDIOç‰¹æœ‰çš„æ¨¡å¼</p>
<p>æœ€é«˜æœ‰æ•ˆä½(Most Significant Bit, MSB)åœ¨å‰ï¼Œæœ€ä½æœ‰æ•ˆä½(Least Significant Bit, LSB)åœ¨åã€‚</p>
<p><img loading="lazy"  src="./command_format.png"
        alt="command_format"/></p>
<p>æœ‰å¦‚ä¸‹åˆ†ç±»ï¼š</p>
<table>
  <thead>
      <tr>
          <th>Class #</th>
          <th>Name</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>0</td>
          <td>Basic Commands</td>
      </tr>
      <tr>
          <td>1</td>
          <td>Command and Queue Function Commands</td>
      </tr>
      <tr>
          <td>2</td>
          <td>Block Oriented Read Commands</td>
      </tr>
      <tr>
          <td>3</td>
          <td>Reversed</td>
      </tr>
      <tr>
          <td>4</td>
          <td>Block Oriented Write Commands</td>
      </tr>
      <tr>
          <td>5</td>
          <td>Erase Commands</td>
      </tr>
      <tr>
          <td>6</td>
          <td>Block Oriented Write Protection Commands</td>
      </tr>
      <tr>
          <td>7</td>
          <td>Lock Card</td>
      </tr>
      <tr>
          <td>8</td>
          <td>Application Specific Commands</td>
      </tr>
      <tr>
          <td>9</td>
          <td>I/O Mode Commands</td>
      </tr>
      <tr>
          <td>10</td>
          <td>Switch Function Commands</td>
      </tr>
      <tr>
          <td>11</td>
          <td>Function Extension Commands</td>
      </tr>
  </tbody>
</table>
<p>Class 7 é”å¡ç›¸å…³å‘½ä»¤æœ‰ä¸‰ä¸ªï¼Œå…¶ä¸­CMD16è®¾å®šå—é•¿åº¦ï¼Œç”¨æ¥è®¾ç½®å¯†ç ã€‚CMD42è¿›è¡Œä¸Šé”/è§£é”æ“ä½œã€‚ä¸Šé”çŠ¶æ€çš„å¡å¯ä»¥å“åº”Class 0çš„å‘½ä»¤.</p>
<p><img loading="lazy"  src="./card_lock_class.png"
        alt="card_lock_class"/></p>
<p>åœ¨SDSCå¡ä¸­ï¼Œå¯é€šè¿‡SET_BLOCK_LENæ¥æŒ‡å®šæ•°æ®çš„å—é•¿åº¦ã€‚è€Œåœ¨SDHCå’ŒSDXCå¡ä¸­ï¼Œå—é•¿åº¦å›ºå®šä¸º512bytesã€‚</p>
<h2 id="application-specific-commands">Application-Specific Commands</h2>
<p>Application-Specific Commandsæ˜¯Commandsçš„æ‰©å±•ï¼ŒCMD55æ˜¯è§¦å‘ACMDçš„æ¡ä»¶ï¼ŒACMD41ä¹Ÿå°±æ˜¯CMD55æ¥ä¸€ä¸ªCMD41ã€‚</p>
<p>ACMD41æ˜¯åˆå§‹åŒ–å‘½ä»¤ï¼Œè®¾å®šHCS(Host Capacity Support)ï¼Œå†³å®šSDå¡çš„ç±»å‹ï¼Œç”µæºæ§åˆ¶ä»¥åŠç”µå¹³ã€‚ACMD6æ˜¯è®¾ç½®æ€»çº¿å®½åº¦ï¼Œå†³å®šä½¿ç”¨1-bitè¿˜æ˜¯4-bitsçš„Dataä¼ è¾“ã€‚åªæœ‰æœªè§£é”å’Œä¼ è¾“çŠ¶æ€æ‰èƒ½ä½¿ç”¨ACMD6ã€‚</p>
<h2 id="status-information">Status Information</h2>
<p>SDå¡çŠ¶æ€ä¿¡æ¯å¯ä»¥åœ¨R1ç±»å‹çš„å“åº”é‡Œçœ‹åˆ°ï¼Œæ¯”å¦‚CMD13ï¼ŒSDå¡æœ‰ä¸‰ç§çŠ¶æ€ä¿¡æ¯ï¼š</p>
<ul>
<li>SD Status</li>
<li>Card Status</li>
<li>Task Status</li>
</ul>
<p>ä¸‹é¢æ˜¯æ¯ä¸€ä½çš„ç±»å‹å®šä¹‰ï¼š</p>
<p>E - Error bit
S - Status bit
R - Detected and set for the actual command response
X - Detected and set during command execution. ä¸Šä½æœºå¯ä»¥é€šè¿‡æ‰§è¡Œå‘½ä»¤çš„å“åº”è·å¾—çŠ¶æ€ä¿¡æ¯</p>
<p>è¿˜æœ‰çŠ¶æ€ä½çš„æ¸…é™¤æ¡ä»¶ï¼š</p>
<p>A - According to the card current status.
B - Always related to the previous command. å‘é€ç‰¹å®šCMDæ¥æ¸…é™¤
C - Clear by read.</p>
<p>R1å“åº”æºå¸¦å¡çŠ¶æ€ä¿¡æ¯ï¼Œé•¿åº¦32-bitï¼Œå‚¨å­˜åœ¨CSRã€‚ä¸‹é¢æ˜¯CSRæ¯ä¸€ä½çš„å®šä¹‰ï¼Œé¢„ç•™ä½å·²ç»çœç•¥ã€‚</p>
<table>
  <thead>
      <tr>
          <th>Bits</th>
          <th>Identifier</th>
          <th>Type</th>
          <th>Value</th>
          <th>Description</th>
          <th>Clear Condition</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>31</td>
          <td>OUT_OF_RANGE</td>
          <td>E R X</td>
          <td>&lsquo;0&rsquo;= no error<br/>&lsquo;1&rsquo;= error</td>
          <td>The command&rsquo;s argument was out of the allowed range for this card.</td>
          <td>C</td>
      </tr>
      <tr>
          <td>30</td>
          <td>ADDRESS_ERROR</td>
          <td>E R X</td>
          <td>&lsquo;0&rsquo;= no error<br/>&lsquo;1&rsquo;= error</td>
          <td>A misaligned address which did not match the block length was used in the command.</td>
          <td>C</td>
      </tr>
      <tr>
          <td>29</td>
          <td>BLOCK_LEN_ERROR</td>
          <td>E R X</td>
          <td>&lsquo;0&rsquo;= no error<br/>&lsquo;1&rsquo;= error</td>
          <td>The transferred block length is not allowed for this card, or the number of transferred bytes does not match the block length.</td>
          <td>C</td>
      </tr>
      <tr>
          <td>28</td>
          <td>ERASE_SEQ_ERROR</td>
          <td>E R</td>
          <td>&lsquo;0&rsquo;= no error<br/>&lsquo;1&rsquo;= error</td>
          <td>An error in the sequence of erasecommands occurred.</td>
          <td>C</td>
      </tr>
      <tr>
          <td>27</td>
          <td>ERASE_PARAM</td>
          <td>E R X</td>
          <td>&lsquo;0&rsquo;= no error<br/>&lsquo;1&rsquo;= error</td>
          <td>An invalid selection of write-blocksfor erase occurred.</td>
          <td>C</td>
      </tr>
      <tr>
          <td>26</td>
          <td>WP_VIOLATION</td>
          <td>E R X</td>
          <td>&lsquo;0&rsquo;= no protected<br/>&lsquo;1&rsquo;= protected</td>
          <td>Set when the host attempts to writeto a protected block or to the temporary or permanent write protected card.</td>
          <td>C</td>
      </tr>
      <tr>
          <td>25</td>
          <td>CARD_IS_LOCKED</td>
          <td>S X</td>
          <td>&lsquo;0&rsquo;= card unlocked<br/>&lsquo;1&rsquo;= card locked</td>
          <td>When set, signals that the card is locked by the host.</td>
          <td>A</td>
      </tr>
      <tr>
          <td>24</td>
          <td>LOCK_UNLOCK_FAILED</td>
          <td>E R X</td>
          <td>&lsquo;0&rsquo;= no error<br/>&lsquo;1&rsquo;= error</td>
          <td>Set when a sequence or passworderror has been detected in lock/unlock card command.</td>
          <td>C</td>
      </tr>
      <tr>
          <td>23</td>
          <td>COM_CRC_ERROR</td>
          <td>E R</td>
          <td>&lsquo;0&rsquo;= no error<br/>&lsquo;1&rsquo;= error</td>
          <td>The CRC check of the previous command failed.</td>
          <td>B</td>
      </tr>
      <tr>
          <td>22</td>
          <td>ILLEGAL_COMMAND</td>
          <td>E R</td>
          <td>&lsquo;0&rsquo;= no error<br/>&lsquo;1&rsquo;= error</td>
          <td>Command not legal for the cardstate</td>
          <td>B</td>
      </tr>
      <tr>
          <td>21</td>
          <td>CARD_ECC_FAILED</td>
          <td>E R X</td>
          <td>&lsquo;0&rsquo;= no error<br/>&lsquo;1&rsquo;= error</td>
          <td>Card internal ECC was applied butfailed to correct the data.</td>
          <td>C</td>
      </tr>
      <tr>
          <td>20</td>
          <td>CC_ERROR</td>
          <td>E R X</td>
          <td>&lsquo;0&rsquo;= no error<br/>&lsquo;1&rsquo;= error</td>
          <td>Internal card controller error.</td>
          <td>C</td>
      </tr>
      <tr>
          <td>19</td>
          <td>ERROR</td>
          <td>E R X</td>
          <td>&lsquo;0&rsquo;= no error<br/>&lsquo;1&rsquo;= error</td>
          <td>A general or an unknown error occurred during the operation.</td>
          <td>C</td>
      </tr>
      <tr>
          <td>16</td>
          <td>CSD_OVERWRITE</td>
          <td>E R X</td>
          <td>&lsquo;0&rsquo;= no error<br/>&lsquo;1&rsquo;= error</td>
          <td>Can be either one of the following errors: <br/>- The read only section of the CSD does not match the card content. <br/>- An attempt to reverse the copy (set as original) or permanent WP (unprotected) bits was made.</td>
          <td>C</td>
      </tr>
      <tr>
          <td>15</td>
          <td>WP_ERASE_SKIP</td>
          <td>E R X</td>
          <td>&lsquo;0&rsquo;= no protected<br/>&lsquo;1&rsquo;= protected</td>
          <td>Set when only partial address space was erased due to existing write protected blocks or the temporary or permanent write protected card was erased.</td>
          <td>C</td>
      </tr>
      <tr>
          <td>14</td>
          <td>CARD_ECC_DISABLED</td>
          <td>S X</td>
          <td>&lsquo;0&rsquo;= enabled<br/>&lsquo;1&rsquo;= disabled</td>
          <td>The command has been executed without using the internal ECC.</td>
          <td>A</td>
      </tr>
      <tr>
          <td>13</td>
          <td>ERASE_RESET</td>
          <td>S R</td>
          <td>&lsquo;0&rsquo;= cleared<br/>&lsquo;1&rsquo;= set</td>
          <td>An erase sequence was cleared before executing because an out of erase sequence command was received.</td>
          <td>C</td>
      </tr>
      <tr>
          <td>12:9</td>
          <td>CURRENT_STATE</td>
          <td>S X</td>
          <td>0 = idle<br/>1 = ready<br/>2 = ident<br/>3 = stby<br/>4 = tran<br/>5 = data<br/>6 = rcv<br/>7 = prg<br/>8 = dis<br/>9-14 = reserved<br/>15 = reserved for<br/>I/O mode</td>
          <td>The state of the card when receiving the command. If the command execution causes a state change, it will be visible to the host in the response to the next command.<br/> The four bits are interpreted as a binary coded number between 0 and 15.</td>
          <td>B</td>
      </tr>
      <tr>
          <td>8</td>
          <td>READY_FOR_DATA</td>
          <td>S X</td>
          <td>&lsquo;0&rsquo;= not ready<br/>&lsquo;1&rsquo;= ready</td>
          <td>Corresponds to buffer empty signaling on the bus.</td>
          <td>A</td>
      </tr>
      <tr>
          <td>6</td>
          <td>FX_EVENT</td>
          <td>S X</td>
          <td>&lsquo;0&rsquo;= No event<br/>&lsquo;1&rsquo;= Event invoked</td>
          <td>Extension Functions may set this bit to get host to deal with events.</td>
          <td>A</td>
      </tr>
      <tr>
          <td>5</td>
          <td>APP_CMD</td>
          <td>S R</td>
          <td>&lsquo;0&rsquo;= enabled<br/>&lsquo;1&rsquo;= disabled</td>
          <td>The card will expect ACMD, or an indication that the command has been interpreted as ACMD.</td>
          <td>C</td>
      </tr>
      <tr>
          <td>3</td>
          <td>AKE_SEQ_ERROR(SD Memory Card app. spec.)</td>
          <td>E R</td>
          <td>&lsquo;0&rsquo;= no error<br/>&lsquo;1&rsquo;= error</td>
          <td>Error in the sequence of the authentication process.</td>
          <td>C</td>
      </tr>
  </tbody>
</table>
<p>12:9æ˜¯4ä½é•¿åº¦ï¼Œè½¬æˆ10è¿›åˆ¶ï¼Œå¯¹åº”ç€å¡çš„æ“ä½œé˜¶æ®µ
<img loading="lazy"  src="./state_mode.png"
        alt="state_mode"/></p>
<h2 id="sd-protocol-sniff">SD Protocol Sniff</h2>
<p>ç­‰é•¿å¸ƒçº¿(wiring length maching)æ˜¯PCBè®¾è®¡é¢†åŸŸçš„æœ¯è¯­ï¼Œä¸€èˆ¬ç”¨äºé«˜é€ŸIOï¼Œæ¯”å¦‚DDRã€‚é£çº¿å°½é‡ä½¿ç”¨ç­‰é•¿çº¿ï¼Œæ§åˆ¶æ—¶é’Ÿçº¿ä¸å…¶ä»–ä¿¡å·çº¿ä¹‹é—´çš„è·ç¦»ï¼Œè¿™ä¹Ÿæ˜¯SDå¡å‚å•†å¯¹äºPCBè®¾è®¡çš„è¦æ±‚ã€‚</p>
<p><img loading="lazy"  src="./wiring.jpg"
        alt="wiring"/></p>
<p>å®é™…ä¸ŠSDé«˜é€Ÿæ¨¡å¼ä¸‹ä¹Ÿå°±20MHzï¼Œæ˜¯å¦ä½¿ç”¨ç­‰é•¿çº¿å¯¹æ•°æ®çš„å½±å“ä¸å¤§ã€‚æœ€å…³é”®çš„è¿˜æ˜¯é€»è¾‘åˆ†æä»ªçš„é‡‡æ ·ç‡ï¼Œä¸€å¼€å§‹ä½¿ç”¨100MHzé‡‡æ ·ç‡çš„é€»è¾‘åˆ†æä»ªç»å¸¸ä¹±ç ï¼Œåæ¥æ¢æˆ500MHzé‡‡æ ·ç‡çš„LA5016å°±èƒ½æ­£å¸¸ä½¿ç”¨ã€‚</p>
<p><img loading="lazy"  src="./LA5016.jpg"
        alt="LA5016"/></p>
<p>é€‰æ‹©é‡‡æ ·ç‡å’Œæ—¶é—´ï¼Œå¦å¤–é€‰æ‹©ç”µå¹³ã€‚é€‰æ‹©SDIOä»¥åŠæ—¶é’Ÿä¸Šå‡æ²¿(rising edge)è§¦å‘ã€‚è¿™æ ·å°±èƒ½å¾—åˆ°å‡†ç¡®çš„é€»è¾‘ç”µå¹³ã€‚å¦‚ä¸‹å›¾ï¼Œå½“ä¸Šå‡æ²¿å¯¹åº”çš„æ•°æ®ä¸º0ã€‚</p>
<p><img loading="lazy"  src="./rising_edge.png"
        alt="rising_edge"/></p>
<h2 id="sd-unlock">SD Unlock</h2>
<p>è§£é”çš„ä¼šè¯åªåœ¨ä¸€æ¬¡ä¸Šç”µä¸­ç”Ÿæ•ˆï¼Œä¸‹ä¸€æ¬¡ä¸Šç”µæ—¶SDå¡ä¼šè‡ªåŠ¨å›åˆ°ä¸Šé”çŠ¶æ€ã€‚è§£é”è¿‡ç¨‹é¦–å…ˆä½¿ç”¨CMD7é€‰æ‹©å¡ï¼Œå¦‚æœè®¾ç½®äº†FEPï¼Œé‚£ä¹ˆéœ€è¦è§£é”COPã€‚ç„¶åä½¿ç”¨CMD16è®¾ç½®æ‰€éœ€å—é•¿åº¦ï¼Œ8-bitè§£é”æ“ä½œ + 8-bitå¯†ç é•¿åº¦ + å®é™…å¯†ç çš„é•¿åº¦ï¼Œæœ€åå‘é€CMD42è§£é”ã€‚</p>
<p><img loading="lazy"  src="./unlock_operations.png"
        alt="unlock_operations"/></p>
<h3 id="cmd-42">CMD 42</h3>
<p>CMD42ç”¨äºè§£é”è®¾å¤‡ï¼Œæœ‰V1.0å’ŒV2.0ä¸¤ä¸ªç‰ˆæœ¬ã€‚è§£é”æ–¹å¼ä¹Ÿæœ‰ä¸¤ç§ï¼Œä¸€ç§æ˜¯ä½¿ç”¨å¼ºåˆ¶æ“¦é™¤å¯†ç (Force Erase Password, FEP)ï¼Œå¦ä¸€ç§æ˜¯ä½¿ç”¨å¯†ç è§£é”ã€‚åªæœ‰COP(Card Ownership Protection)ç‰¹æ€§çš„SDå¡ï¼Œæ‰å¸¦æœ‰éæ˜“å¤±æ€§çš„FEPå¯„å­˜å™¨ã€‚COPç‰¹æ€§æ˜¯SDè§„èŒƒ6.0ä¸­æ–°åŠ çš„ï¼Œå¸‚é¢ä¸Šå‡ ä¹å¾ˆå°‘æœ‰COPç‰¹æ€§çš„SDå¡ã€‚
æ ¹æ®CMDçš„æ ¼å¼ï¼Œ01ä»£è¡¨CMDè¯·æ±‚ï¼Œ101010ä»£è¡¨42ï¼Œæ¨æ–­å‡º01101010æ˜¯CMD42çš„ç¬¬ä¸€ä¸ªå­—èŠ‚ï¼Œä¹Ÿå°±æ˜¯6Aã€‚
CMD42çš„å‚æ•°å‰4ä¸ªbitåº”è¯¥æ˜¯0ï¼ŒCSRçš„å¯¹åº”çŠ¶æ€ä½bit-25åº”è¯¥ç”±1å˜ä¸º0ï¼Œbit-24ä¸º0ã€‚</p>
<p><img loading="lazy"  src="./unlock_parameters.png"
        alt="unlock_parameters"/></p>
<p>é€šè¿‡é€»è¾‘åˆ†æä»ªè§£æä¸Šä½æœºå’ŒSDå¡ä¹‹é—´çš„é€šä¿¡æ•°æ®ï¼Œå¾—åˆ°äº†ä¸‹é¢çš„æŠ¥æ–‡ï¼ŒCommand Index,Arguments,CRC7éƒ½ç¬¦åˆå‰é¢çš„å®šä¹‰ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">6A 00 00 00 00 51
</span></span></code></pre></div><p>æœ€åä¸€ä¸ªå­—èŠ‚51å¯ä»¥é€šè¿‡CRC7æ ¡éªŒ</p>
<p>æœ¬æ–‡ç ”ç©¶çš„ç›®æ ‡è®¾å¤‡è¾ƒè€ï¼Œä¸æ”¯æŒCOPï¼Œè§£é”ä¸Šé”ä½çš„0ä»£è¡¨è§£é”æ“ä½œï¼Œ1ä»£è¡¨ä¸Šé”ã€‚æœ€åä½¿ç”¨CMD42ï¼Œå› æ­¤CMD42çš„æ“ä½œå‚æ•°æ˜¯00000000ï¼Œä¹Ÿå°±æ˜¯CMD42[00h]</p>
<p>CMD42çš„Dataéƒ¨åˆ†ï¼Œç¬¬ä¸€ä¸ªå­—èŠ‚æè¿°äº†å…·ä½“çš„æ“ä½œï¼Œå‰ä¸‰ä½é¢„ç•™ï¼Œä¸€èˆ¬ç½®0ï¼Œç¬¬å››ä½è¡¨ç¤ºCOPç‰¹æ€§ï¼Œåœ¨è§£é”è¿‡ç¨‹ä¸­ï¼Œåé¢å››ä½éƒ½åº”è¯¥æ˜¯0ã€‚ç¬¬äºŒä¸ªå­—èŠ‚è¡¨ç¤ºPassword LengthåŒºé—´ä¸º8-bitï¼Œå•ä½æ˜¯byteã€‚å› æ­¤passwordæœ€å¤§é•¿åº¦æ˜¯128-bytesï¼Œå› æ­¤å¯†ç é•¿åº¦æœ€å¤§16å­—èŠ‚ï¼Œä»ç¬¬ä¸‰ä½å¼€å§‹éƒ½æ˜¯å¯†ç æ•°æ®ï¼Œæœ€åå¸¦ä¸Š16ä½çš„CRCã€‚</p>
<p><img loading="lazy"  src="./password.png"
        alt="password"/></p>
<p>CMD7çš„åœ°å€éšæœº</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">47 4B 47 00 00 6F
</span></span><span class="line"><span class="cl">[47:41] 01000111  start bit + Command index
</span></span><span class="line"><span class="cl">[40:32] 01001011  RCA 4B
</span></span><span class="line"><span class="cl">[31:24] 01000111  RCA 47
</span></span><span class="line"><span class="cl">[23:16] 00000000  stuff bits
</span></span><span class="line"><span class="cl">[15:8]  00000000
</span></span><span class="line"><span class="cl">[7:0]   01101111  CRC7 + end bit
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">07 02 00 07 00 79
</span></span></code></pre></div><p>CMD16å‘½ä»¤å¦‚ä¸‹, å€’æ•°ç¬¬äºŒè¡Œä¾¿æ˜¯å‚æ•°SET_BLOCKLENï¼Œè®¾ç½®å—é•¿åº¦ï¼Œå¿…é¡»æ˜¯å¶æ•°é•¿åº¦ã€‚å“åº”ç±»å‹æ˜¯R1ï¼Œ0b00010010çš„åè¿›åˆ¶ä¸º18ï¼Œä¹Ÿå°±æ˜¯2å­—èŠ‚çš„å‚æ•°åŠ ä¸Š16-byteså¯†ç </p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">50 00 00 00 12 2F
</span></span><span class="line"><span class="cl">[47:41] 01010000  start bit + Command index
</span></span><span class="line"><span class="cl">[40:32] 00000000
</span></span><span class="line"><span class="cl">[31:24] 00000000
</span></span><span class="line"><span class="cl">[23:16] 00000000
</span></span><span class="line"><span class="cl">[15:8]  00010010  SET_BLOCKLEN
</span></span><span class="line"><span class="cl">[7:0]   00101111  CRC7 + end bit
</span></span></code></pre></div><p>CMD16çš„å“åº”</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">10 02 00 09 00 07
</span></span><span class="line"><span class="cl">[47:41] 00010000  start bit + Command index
</span></span><span class="line"><span class="cl">[40:32] 00000010  Card Status
</span></span><span class="line"><span class="cl">[31:24] 00000000  Card Status
</span></span><span class="line"><span class="cl">[23:16] 00001001  Card Status
</span></span><span class="line"><span class="cl">[15:8]  00000000  Card Status
</span></span><span class="line"><span class="cl">[7:0]   00000111  CRC7 + end bit
</span></span></code></pre></div><p>CMD42å“åº”çš„ç¬¬ä¸€ä¸ªå­—èŠ‚ä¸º00101010ä¹Ÿå°±æ˜¯2Aã€‚å“åº”ç±»å‹æ˜¯R1ã€‚</p>
<p>åœ¨é€»è¾‘åˆ†æä»ªæŠ“å–åˆ°äº†CMD42çš„å“åº”</p>
<p>å°†Parameterå­—æ®µè½¬æ¢æˆäºŒè¿›åˆ¶ï¼Œæ ¹æ®CSRå®šä¹‰ï¼Œä¸‹é¢è¿”å›çš„çŠ¶æ€æ˜¯æœªè§£é”ï¼Œready,tranæ¨¡å¼</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">2a <span class="m">02</span> <span class="m">00</span> <span class="m">09</span> <span class="m">00</span> 6f
</span></span><span class="line"><span class="cl"><span class="o">[</span>47:41<span class="o">]</span> <span class="m">00010000</span>  start bit + Command index
</span></span><span class="line"><span class="cl"><span class="o">[</span>40:32<span class="o">]</span> <span class="m">00000010</span>  Card Status Locked
</span></span><span class="line"><span class="cl"><span class="o">[</span>31:24<span class="o">]</span> <span class="m">00000000</span>  Card Status
</span></span><span class="line"><span class="cl"><span class="o">[</span>23:16<span class="o">]</span> <span class="m">00001001</span>  Card Status
</span></span><span class="line"><span class="cl"><span class="o">[</span>15:8<span class="o">]</span>  <span class="m">00000000</span>  Card Status
</span></span><span class="line"><span class="cl"><span class="o">[</span>7:0<span class="o">]</span>   <span class="m">00000111</span>  CRC7 + end bit
</span></span></code></pre></div><p>å½“CMD42çš„Dataå‘é€å®Œæˆï¼Œå†å‘é€CMD13ï¼Œæ ¹æ®CSRå®šä¹‰ï¼Œä¸‹é¢è¿”å›çš„çŠ¶æ€æ˜¯å·²è§£é”ï¼Œready,tranæ¨¡å¼ï¼ŒAPP_CMDå…³é—­</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">0D <span class="m">00</span> <span class="m">00</span> <span class="m">09</span> <span class="m">00</span> <span class="m">07</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>47:41<span class="o">]</span> <span class="m">00010000</span>  start bit + Command index
</span></span><span class="line"><span class="cl"><span class="o">[</span>40:32<span class="o">]</span> <span class="m">00000000</span>  Card Status Unlocked
</span></span><span class="line"><span class="cl"><span class="o">[</span>31:24<span class="o">]</span> <span class="m">00000000</span>  Card Status
</span></span><span class="line"><span class="cl"><span class="o">[</span>23:16<span class="o">]</span> <span class="m">00001001</span>  Card Status
</span></span><span class="line"><span class="cl"><span class="o">[</span>15:8<span class="o">]</span>  <span class="m">00000000</span>  Card Status
</span></span><span class="line"><span class="cl"><span class="o">[</span>7:0<span class="o">]</span>   <span class="m">01101111</span>  CRC7 + end bit
</span></span></code></pre></div><h3 id="analyze-data">Analyze Data</h3>
<p>åœ¨KingstVISæ‰¾åˆ°Data0çš„ä¿¡é“ï¼Œåœ¨CMD42åé¢å¯¹é½ä¸Šå‡æ²¿æˆªå–åŒºé—´ï¼Œå¯¼å‡ºæ—¶é’Ÿä¿¡é“å’ŒData0ä¿¡é“ä¸ºTXTã€‚</p>
<p><img loading="lazy"  src="./exporting_data.png"
        alt="exporting_data"/></p>
<p>æœ€åå¯¼å‡ºçš„æ•°æ®å®é™…ä¸Šè¿˜æ˜¯csvã€‚åœ¨KingstVISé‡Œé€‰æ‹©CSVå¯¼å‡ºåˆ™ä¸ºå€’åºï¼Œæ‰€ä»¥æ‰é€‰æ‹©TXTæ ¼å¼ã€‚è¿™é‡Œå­—ç¬¦ç¼–ç æ˜¯ANSIï¼Œåœ¨Linuxä¸‹ä¼šä¹±ç ï¼Œæ‰€ä»¥æŠŠTitleåˆ é™¤ã€‚</p>
<p><img loading="lazy"  src="./csv_data_exported.png"
        alt="csv_data_exported"/></p>
<p>é€šè¿‡ä¸‹é¢çš„è„šæœ¬ï¼Œå¯ä»¥å°†Data0æ•°æ®æ‰“å°æˆå¯è¯»æ•°æ®ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="ch">#!/usr/bin/env python3</span>
</span></span><span class="line"><span class="cl"><span class="c1"># -*- coding: utf-8 -*-</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">csv</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">sys</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">getopt</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">binascii</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">parse_csv</span><span class="p">(</span><span class="n">csv_file</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">csv_file</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">reader</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">reader</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">last_ch0_v</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">            <span class="n">bits</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">reader</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">current_ch0_v</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">(</span><span class="n">current_ch0_v</span> <span class="o">^</span> <span class="n">last_ch0_v</span><span class="p">)</span> <span class="ow">and</span> <span class="n">last_ch0_v</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">bits</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">2</span><span class="p">])))</span>
</span></span><span class="line"><span class="cl">                <span class="n">last_ch0_v</span> <span class="o">=</span> <span class="n">current_ch0_v</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">bits</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">crc16_calc</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">crc</span> <span class="o">=</span> <span class="mh">0x0000</span>
</span></span><span class="line"><span class="cl">    <span class="n">poly</span> <span class="o">=</span> <span class="mh">0x1021</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">cur_byte</span> <span class="o">=</span> <span class="mh">0xFF</span> <span class="o">&amp;</span> <span class="n">b</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">8</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">bit</span> <span class="o">=</span> <span class="p">((</span><span class="n">cur_byte</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="mi">7</span><span class="o">-</span><span class="n">i</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">c15</span> <span class="o">=</span> <span class="p">((</span><span class="n">crc</span> <span class="o">&gt;&gt;</span> <span class="mi">15</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">crc</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">c15</span> <span class="o">^</span> <span class="n">bit</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="n">crc</span> <span class="o">^=</span> <span class="n">poly</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">crc</span> <span class="o">&amp;</span> <span class="mh">0xFFFF</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">usage</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">options</span><span class="p">,</span> <span class="n">args</span> <span class="o">=</span> <span class="n">getopt</span><span class="o">.</span><span class="n">getopt</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="s2">&#34;f:o&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">csv_file</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
</span></span><span class="line"><span class="cl">        <span class="n">output_file</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">opt</span><span class="p">,</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">options</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">opt</span> <span class="o">==</span> <span class="s1">&#39;-f&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">csv_file</span> <span class="o">=</span> <span class="n">arg</span>
</span></span><span class="line"><span class="cl">            <span class="k">elif</span> <span class="n">opt</span> <span class="o">==</span> <span class="s1">&#39;-o&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">output_file</span> <span class="o">=</span> <span class="n">arg</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">bits</span> <span class="o">=</span> <span class="n">parse_csv</span><span class="p">(</span><span class="n">csv_file</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">remainder</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">bits</span><span class="p">)</span> <span class="o">%</span> <span class="mi">8</span>
</span></span><span class="line"><span class="cl">        <span class="n">bits</span> <span class="o">=</span> <span class="n">bits</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">bits</span><span class="p">)</span> <span class="o">-</span> <span class="n">remainder</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">keys_list</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">        <span class="n">crc_data</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">        <span class="n">keys_len</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># å»æ‰Dataçš„ç¬¬ä¸€ä½æ ‡å¿—ä½</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">bits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;0&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">bits</span> <span class="o">=</span> <span class="n">bits</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">bits</span><span class="p">),</span> <span class="mi">8</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="n">byte</span> <span class="o">=</span> <span class="n">bits</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">bits</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">bits</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">bits</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> \
</span></span><span class="line"><span class="cl">                    <span class="n">bits</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">4</span><span class="p">]</span> <span class="o">+</span> <span class="n">bits</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">5</span><span class="p">]</span> <span class="o">+</span> <span class="n">bits</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">6</span><span class="p">]</span> <span class="o">+</span> <span class="n">bits</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">7</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">                <span class="n">n</span> <span class="o">=</span> <span class="n">i</span><span class="o">/</span><span class="mi">8</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">byte</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                        <span class="n">keys_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">byte</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                    <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;CMD42 data block parameters error.&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                        <span class="n">exit</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                <span class="k">elif</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">keys_len</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">byte</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="n">keys_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">keys_len</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;Keys length: &#34;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">keys_len</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&#34;-bytes&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">elif</span> <span class="n">n</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">n</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="n">keys_len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                    <span class="n">keys_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">byte</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                <span class="k">elif</span> <span class="p">(</span><span class="n">keys_len</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">n</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="n">keys_len</span> <span class="o">+</span> <span class="mi">3</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                    <span class="n">crc_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">byte</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="p">(</span><span class="n">crc_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mi">16</span><span class="o">*</span><span class="mi">16</span> <span class="o">+</span> <span class="n">crc_data</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">==</span> <span class="n">crc16_calc</span><span class="p">(</span><span class="n">keys_list</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                        <span class="n">x</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="n">keys_list</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="n">keys_len</span><span class="o">+</span><span class="mi">2</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">                        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;Key:&#34;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">binascii</span><span class="o">.</span><span class="n">b2a_hex</span><span class="p">(</span><span class="n">x</span><span class="p">))[</span><span class="mi">2</span><span class="p">:(</span><span class="n">keys_len</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">                        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;CRC:&#34;</span><span class="p">,</span> <span class="nb">hex</span><span class="p">(</span><span class="n">crc16_calc</span><span class="p">(</span><span class="n">keys_list</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">                        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">Analyse compeleted!&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;CRC error!&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="n">exit</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;Data Error&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">usage</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">usage</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;Usage:python kinstvis_sdio_parser.py -f test.csv&#34;</span><span class="p">)</span>
</span></span></code></pre></div><p>å»æ‰ç¬¬ä¸€ä½èµ·å§‹ä½ï¼Œè§£æCMD42 Dataç»“æ„ï¼Œå†è¿›è¡ŒCRCæ ¡éªŒï¼Œæ ¡éªŒæˆåŠŸã€‚</p>
<p><img loading="lazy"  src="./parse_key.png"
        alt="parse_key"/></p>
<p>å¯†ç å¦‚ä¸‹</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">5ffca19ffcdb5899a82c4e265f99c76b
</span></span></code></pre></div><h2 id="mmc-utils">MMC Utils</h2>
<p>ä¸‹ä¸€æ­¥æ˜¯å†™SDè§£é”å·¥å…·ï¼Œé•å…‰çš„å®˜æ–¹æ–‡æ¡£æä¾›äº†æ·»åŠ ä¸Šé”è§£é”åŠŸèƒ½çš„Demoï¼Œé€šè¿‡ä¿®æ”¹mmc-utilså¯ä»¥å®ç°è§£é”ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">git clone git://git.kernel.org/pub/scm/linux/kernel/git/cjb/mmc-utils.git
</span></span></code></pre></div><p>mmc-utils/mmc.h</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#define MMC_SET_BLOCKLEN        16 </span><span class="cm">/* ac [31:0] block len R1 */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define MMC_LOCK_UNLOCK         42 </span><span class="cm">/* adtc R1b */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define MMC_CMD42_UNLOCK        0x0 </span><span class="cm">/* UNLOCK */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define MMC_CMD42_SET_PWD       0x1 </span><span class="cm">/* SET_PWD */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define MMC_CMD42_CLR_PWD       0x2 </span><span class="cm">/* CLR_PWD */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define MMC_CMD42_LOCK          0x4 </span><span class="cm">/* LOCK */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define MMC_CMD42_SET_LOCK      0x5 </span><span class="cm">/* SET_PWD &amp; LOCK */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define MMC_CMD42_ERASE         0x8 </span><span class="cm">/* ERASE */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define MAX_PWD_LENGTH          32 </span><span class="cm">/* max PWDS_LEN: old+new */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define MMC_BLOCK_SIZE          512 </span><span class="cm">/* data blk size for cmd42 */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define MMC_R1_ERROR            (1 &lt;&lt; 19) </span><span class="cm">/* R1 bit19 */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define MMC_R1_LOCK_ULOCK_FAIL  (1 &lt;&lt; 24) </span><span class="cm">/* R1 bit24 */</span><span class="cp">
</span></span></span></code></pre></div><p>mmc-utils/mmc.c</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="p">{</span><span class="n">do_lock_unlock</span><span class="p">,</span> <span class="o">-</span><span class="mi">3</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s">&#34;cmd42&#34;</span><span class="p">,</span> <span class="s">&#34;&lt;password&gt; &lt;s|c|l|u|e&gt; &lt;device&gt;</span><span class="se">\n</span><span class="s">&#34;</span>
</span></span><span class="line"><span class="cl">                <span class="s">&#34;s</span><span class="se">\t</span><span class="s">set password</span><span class="se">\n</span><span class="s">&#34;</span>
</span></span><span class="line"><span class="cl">                <span class="s">&#34;c</span><span class="se">\t</span><span class="s">clear password</span><span class="se">\n</span><span class="s">&#34;</span>
</span></span><span class="line"><span class="cl">                <span class="s">&#34;l</span><span class="se">\t</span><span class="s">lock</span><span class="se">\n</span><span class="s">&#34;</span>
</span></span><span class="line"><span class="cl">                <span class="s">&#34;sl</span><span class="se">\t</span><span class="s">set password and lock</span><span class="se">\n</span><span class="s">&#34;</span>
</span></span><span class="line"><span class="cl">                <span class="s">&#34;u</span><span class="se">\t</span><span class="s">unlock</span><span class="se">\n</span><span class="s">&#34;</span>
</span></span><span class="line"><span class="cl">                <span class="s">&#34;e</span><span class="se">\t</span><span class="s">force erase</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nb">NULL</span><span class="p">},</span>
</span></span></code></pre></div><p>mmc-utils/mmc_cmds.h</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="c1">//lock/unlock feature implementation
</span></span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">do_lock_unlock</span><span class="p">(</span><span class="kt">int</span> <span class="n">nargs</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">char</span> <span class="o">*</span><span class="n">device</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">__u8</span> <span class="n">data_block</span><span class="p">[</span><span class="n">MMC_BLOCK_SIZE</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="n">__u8</span> <span class="n">data_block_onebyte</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">block_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">mmc_ioc_cmd</span> <span class="n">idata</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">cmd42_para</span><span class="p">;</span>               <span class="c1">//parameter of cmd42
</span></span></span><span class="line"><span class="cl">    <span class="kt">char</span> <span class="n">pwd</span><span class="p">[</span><span class="n">MAX_PWD_LENGTH</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span> <span class="c1">//password
</span></span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">pwd_len</span><span class="p">;</span>                  <span class="c1">//password length
</span></span></span><span class="line"><span class="cl">    <span class="n">__u32</span> <span class="n">r1_response</span><span class="p">;</span>            <span class="c1">//R1 response token
</span></span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">nargs</span> <span class="o">!=</span> <span class="mi">4</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&#34;Usage: mmc cmd42 &lt;password&gt; &lt;s|c|l|u|e&gt; &lt;device&gt; </span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nf">strcpy</span><span class="p">(</span><span class="n">pwd</span><span class="p">,</span> <span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">    <span class="n">pwd_len</span> <span class="o">=</span> <span class="nf">strlen</span><span class="p">(</span><span class="n">pwd</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nf">strcmp</span><span class="p">(</span><span class="s">&#34;s&#34;</span><span class="p">,</span> <span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">cmd42_para</span> <span class="o">=</span> <span class="n">MMC_CMD42_SET_PWD</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Set password: password=%s ...</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">pwd</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nf">strcmp</span><span class="p">(</span><span class="s">&#34;c&#34;</span><span class="p">,</span> <span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">cmd42_para</span> <span class="o">=</span> <span class="n">MMC_CMD42_CLR_PWD</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Clear password: password=%s ...</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">pwd</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nf">strcmp</span><span class="p">(</span><span class="s">&#34;l&#34;</span><span class="p">,</span> <span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">cmd42_para</span> <span class="o">=</span> <span class="n">MMC_CMD42_LOCK</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Lock the card: password=%s ...</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">pwd</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nf">strcmp</span><span class="p">(</span><span class="s">&#34;sl&#34;</span><span class="p">,</span> <span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">cmd42_para</span> <span class="o">=</span> <span class="n">MMC_CMD42_SET_LOCK</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Set password and lock the card: password - %s ...</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">pwd</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nf">strcmp</span><span class="p">(</span><span class="s">&#34;u&#34;</span><span class="p">,</span> <span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">cmd42_para</span> <span class="o">=</span> <span class="n">MMC_CMD42_UNLOCK</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Unlock the card: password=%s ...</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">pwd</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nf">strcmp</span><span class="p">(</span><span class="s">&#34;e&#34;</span><span class="p">,</span> <span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">cmd42_para</span> <span class="o">=</span> <span class="n">MMC_CMD42_ERASE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Force erase ... (Warning: all card data will be erased together with PWD!)</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Invalid parameter:</span><span class="se">\n</span><span class="s">&#34;</span>
</span></span><span class="line"><span class="cl">               <span class="s">&#34;s</span><span class="se">\t</span><span class="s">set password</span><span class="se">\n</span><span class="s">&#34;</span>
</span></span><span class="line"><span class="cl">               <span class="s">&#34;c</span><span class="se">\t</span><span class="s">clear password</span><span class="se">\n</span><span class="s">&#34;</span>
</span></span><span class="line"><span class="cl">               <span class="s">&#34;l</span><span class="se">\t</span><span class="s">lock</span><span class="se">\n</span><span class="s">&#34;</span>
</span></span><span class="line"><span class="cl">               <span class="s">&#34;sl</span><span class="se">\t</span><span class="s">set password and lock</span><span class="se">\n</span><span class="s">&#34;</span>
</span></span><span class="line"><span class="cl">               <span class="s">&#34;u</span><span class="se">\t</span><span class="s">unlock</span><span class="se">\n</span><span class="s">&#34;</span>
</span></span><span class="line"><span class="cl">               <span class="s">&#34;e</span><span class="se">\t</span><span class="s">force erase</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">device</span> <span class="o">=</span> <span class="n">argv</span><span class="p">[</span><span class="n">nargs</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="n">fd</span> <span class="o">=</span> <span class="nf">open</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">O_RDWR</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">fd</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">perror</span><span class="p">(</span><span class="s">&#34;open&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">cmd42_para</span> <span class="o">==</span> <span class="n">MMC_CMD42_ERASE</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">block_size</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="c1">//set blk size to 2-byte for Force Erase @DDR50 compability
</span></span></span><span class="line"><span class="cl">    <span class="k">else</span> <span class="n">block_size</span> <span class="o">=</span> <span class="n">MMC_BLOCK_SIZE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">ret</span> <span class="o">=</span> <span class="nf">set_block_len</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">block_size</span><span class="p">);</span> <span class="c1">//set data block size prior to cmd42
</span></span></span><span class="line"><span class="cl">        <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Set to data block length = %d byte(s).</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">block_size</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">cmd42_para</span> <span class="o">==</span> <span class="n">MMC_CMD42_ERASE</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">data_block_onebyte</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cmd42_para</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">data_block</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cmd42_para</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">data_block</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">pwd_len</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nf">memcpy</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">data_block</span> <span class="o">+</span> <span class="mi">2</span><span class="p">),</span> <span class="n">pwd</span><span class="p">,</span> <span class="n">pwd_len</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nf">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">idata</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">idata</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="n">idata</span><span class="p">.</span><span class="n">write_flag</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">idata</span><span class="p">.</span><span class="n">opcode</span> <span class="o">=</span> <span class="n">MMC_LOCK_UNLOCK</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">idata</span><span class="p">.</span><span class="n">arg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="c1">//set all 0 for cmd42 arg
</span></span></span><span class="line"><span class="cl">    <span class="n">idata</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">MMC_RSP_R1</span> <span class="o">|</span> <span class="n">MMC_CMD_AC</span> <span class="o">|</span> <span class="n">MMC_CMD_ADTC</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">idata</span><span class="p">.</span><span class="n">blksz</span> <span class="o">=</span> <span class="n">block_size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">idata</span><span class="p">.</span><span class="n">blocks</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">cmd42_para</span> <span class="o">==</span> <span class="n">MMC_CMD42_ERASE</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nf">mmc_ioc_cmd_set_data</span><span class="p">(</span><span class="n">idata</span><span class="p">,</span> <span class="n">data_block_onebyte</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span>
</span></span><span class="line"><span class="cl">        <span class="nf">mmc_ioc_cmd_set_data</span><span class="p">(</span><span class="n">idata</span><span class="p">,</span> <span class="n">data_block</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">ret</span> <span class="o">=</span> <span class="nf">ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">MMC_IOC_CMD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">idata</span><span class="p">);</span> <span class="c1">//Issue CMD42
</span></span></span><span class="line"><span class="cl">    <span class="n">r1_response</span> <span class="o">=</span> <span class="n">idata</span><span class="p">.</span><span class="n">response</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;cmd42 response: 0x%08x</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">r1_response</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">r1_response</span> <span class="o">&amp;</span> <span class="n">MMC_R1_ERROR</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span> <span class="c1">//check CMD42 error
</span></span></span><span class="line"><span class="cl">        <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;cmd42 error! Error code: 0x%08x</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">r1_response</span> <span class="o">&amp;</span> <span class="n">MMC_R1_ERROR</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">r1_response</span> <span class="o">&amp;</span> <span class="n">MMC_R1_LOCK_ULOCK_FAIL</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//check lock/unlock error
</span></span></span><span class="line"><span class="cl">        <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Card lock/unlock fail! Error code: 0x%08x</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">r1_response</span> <span class="o">&amp;</span> <span class="n">MMC_R1_LOCK_ULOCK_FAIL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nf">close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//change data block length
</span></span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">set_block_len</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">blk_len</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">mmc_ioc_cmd</span> <span class="n">idata</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">idata</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">idata</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="n">idata</span><span class="p">.</span><span class="n">opcode</span> <span class="o">=</span> <span class="n">MMC_SET_BLOCKLEN</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">idata</span><span class="p">.</span><span class="n">arg</span> <span class="o">=</span> <span class="n">blk_len</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">idata</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">MMC_RSP_R1</span> <span class="o">|</span> <span class="n">MMC_CMD_AC</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">ret</span> <span class="o">=</span> <span class="nf">ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">MMC_IOC_CMD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">idata</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>å®é™…ä¸Šæ˜¯é€šè¿‡ioctlæ§åˆ¶çš„ï¼Œç¼–è¯‘ä¹‹åï¼Œå¯ä»¥ä¸Šé”ï¼Œä½†æ˜¯å†ä¹Ÿæ— æ³•è§£é”æˆåŠŸï¼Œåªèƒ½æ¢ä¸€ç§æ–¹å¼ã€‚</p>
<p><a href="https://github.com/torvalds/linux/blob/master/include/uapi/linux/mmc/ioctl.h"target="_blank" rel="noopener noreferrer">https://github.com/torvalds/linux/blob/master/include/uapi/linux/mmc/ioctl.h</a></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo ./mmc scr <span class="nb">read</span> /sys/bus/mmc/devices/mmc0:aaaa/
</span></span><span class="line"><span class="cl">type: <span class="s1">&#39;SD&#39;</span>
</span></span><span class="line"><span class="cl">version: SD 3.0x
</span></span><span class="line"><span class="cl">bus widths: 4bit, 1bit,
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">sudo ./mmc cmd42 <span class="m">123456</span> s /sys/bus/mmc/devices/mmc0:aaaa/
</span></span><span class="line"><span class="cl">Set password: <span class="nv">password</span><span class="o">=</span><span class="m">123456</span> ...
</span></span></code></pre></div><h2 id="modify-the-kernel-module">Modify the kernel module</h2>
<p>å› ä¸ºç¬¬ä¸‰æ–¹å·¥å…·æ— æ³•å®ç°ï¼Œç°åœ¨åªèƒ½ä¿®æ”¹å†…æ ¸æ¨¡å—äº†ã€‚æœ¬äººçš„æ“ä½œç³»ç»Ÿæ˜¯Arch Linuxï¼ŒMMCé©±åŠ¨å±äºå†…æ ¸æ¨¡å—ï¼Œæ‰€ä»¥ä¸éœ€è¦é‡æ–°ç¼–è¯‘æ•´ä¸ªå†…æ ¸ã€‚è€Œä¸æ˜¯åƒUbuntuç›´æ¥builtinã€‚</p>
<p>Arch Linuxçš„å†…æ ¸æ¨¡å—ç›®å½•å¦‚ä¸‹ï¼Œæˆ‘çš„ç”µè„‘æ˜¯HP 840G3ï¼ŒSDå¡ä½¿ç”¨PCIé€šé“ï¼Œä¸»è¦ä¼šæ¶‰åŠä¸‹é¢ä¸‰ä¸ªé©±åŠ¨ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">/lib/modules/$(uname -r)/kernel/drivers/mmc/core/mmc_core.ko.xz
</span></span><span class="line"><span class="cl">/lib/modules/$(uname -r)/kernel/drivers/mmc/core/mmc_block.ko.xz
</span></span><span class="line"><span class="cl">/lib/modules/$(uname -r)/kernel/drivers/mmc/host/rtsx_pci_sdmmc.ko.xz
</span></span><span class="line"><span class="cl">/lib/modules/$(uname -r)/kernel/drivers/misc/cardreader/rtsx_pci.ko.xz
</span></span></code></pre></div><p>å¦‚æœé‡æ–°ä¸‹è½½å®˜æ–¹æºç ç¼–è¯‘å†…æ ¸æ¨¡å—ï¼Œä¼šå‡ºç°å¥‡æ€ªçš„é”™è¯¯ã€‚é¦–å…ˆæ˜¯vermagicåŒ¹é…é—®é¢˜ï¼Œå†…æ ¸ç‰ˆæœ¬ï¼Œå¤„ç†å™¨ç‰¹æ€§ä¸åŒ¹é…åˆ™ä¸å…è®¸æŒ‚è½½ã€‚å› ä¸ºLinux 3.7ååŠ å…¥äº†æ¨¡å—ç­¾åæœºåˆ¶ï¼Œå¯ä»¥é€šè¿‡modinfoæŸ¥çœ‹ç³»ç»Ÿè‡ªå¸¦çš„å†…æ ¸æ¨¡å—ï¼Œæ²¡æœ‰ç­¾åä¼šå¯¼è‡´æ— æ³•æŒ‚è½½ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ modinfo mmc_core
</span></span><span class="line"><span class="cl">filename:       /lib/modules/4.18.10-arch1-1-ARCH/kernel/drivers/mmc/core/mmc_core.ko.xz
</span></span><span class="line"><span class="cl">license:        GPL
</span></span><span class="line"><span class="cl">srcversion:     72D2DBEB18AB4B898BE5331
</span></span><span class="line"><span class="cl">depends:
</span></span><span class="line"><span class="cl">retpoline:      Y
</span></span><span class="line"><span class="cl">intree:         Y
</span></span><span class="line"><span class="cl">name:           mmc_core
</span></span><span class="line"><span class="cl">vermagic:       4.18.10-arch1-1-ARCH SMP preempt mod_unload modversions
</span></span><span class="line"><span class="cl">sig_id:         PKCS#7
</span></span><span class="line"><span class="cl">signer:
</span></span><span class="line"><span class="cl">sig_key:
</span></span><span class="line"><span class="cl">sig_hashalgo:   md4
</span></span><span class="line"><span class="cl">signature:      30:82:02:A5:06:09:2A:86:48:86:F7:0D:01:07:02:A0:82:02:96:30
</span></span><span class="line"><span class="cl">                ä»¥ä¸‹çœç•¥
</span></span><span class="line"><span class="cl">parm:           use_spi_crc:bool
</span></span></code></pre></div><p>æˆ‘ä»¬å¯ä»¥åœ¨/usr/lib/modules/$(uname -r)/build/ç›®å½•è¿›è¡Œç¼–è¯‘ï¼Œæ— éœ€å¦å¤–é…ç½®ã€‚åªéœ€è¦æŠŠMMCçš„coreä»£ç æ‹·è´åˆ°ç›®æ ‡ç›®å½•ä¸‹ã€‚å°±å¯ä»¥ç›´æ¥makeï¼Œç„¶åé‡æ–°æŒ‚è½½MMCå†…æ ¸æ¨¡å—é©±åŠ¨ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">cp ./core/* /usr/lib/modules/<span class="k">$(</span>uname -r<span class="k">)</span>/build/drivers/mmc/core/
</span></span><span class="line"><span class="cl">make modules <span class="nv">SUBDIRS</span><span class="o">=</span>drivers/mmc/core
</span></span><span class="line"><span class="cl">  Building modules, stage 2.
</span></span><span class="line"><span class="cl">  MODPOST <span class="m">7</span> modules
</span></span><span class="line"><span class="cl">rmmod rtsx_pci_sdmmc <span class="o">&amp;&amp;</span> rmmod mmc_core
</span></span><span class="line"><span class="cl">insmod /usr/lib/modules/<span class="k">$(</span>uname -r<span class="k">)</span>/build/drivers/mmc/core/mmc_core.ko
</span></span><span class="line"><span class="cl">insmod /lib/modules/<span class="k">$(</span>uname -r<span class="k">)</span>/kernel/drivers/mmc/host/rtsx_pci_sdmmc.ko.xz
</span></span></code></pre></div><h3 id="add-unlock-function">Add Unlock Function</h3>
<p>åœ¨mmc_ops.håŠ å…¥unlock_mmcå£°æ˜</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">unlock_mmc</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="n">u8</span><span class="o">*</span> <span class="n">key_buf</span><span class="p">,</span><span class="kt">int</span> <span class="n">key_len</span><span class="p">);</span>
</span></span></code></pre></div><p>éšåç¼–å†™å…·ä½“å®ç°ï¼Œé¦–å…ˆè®¾å®šå—é•¿åº¦ï¼Œéšåå‘é€CMD42 ADTCå‘½ä»¤ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">unlock_mmc</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="n">u8</span><span class="o">*</span> <span class="n">key_buf</span><span class="p">,</span><span class="kt">int</span> <span class="n">key_len</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">block_size</span> <span class="o">=</span> <span class="n">key_len</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">mmc_request</span> <span class="n">mrq</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">mmc_command</span> <span class="n">cmd_sbl</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">mmc_command</span> <span class="n">cmd</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">mmc_data</span> <span class="n">data</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">scatterlist</span> <span class="n">sg</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">u8</span> <span class="o">*</span><span class="n">data_buf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/*------------CMD 16----------------*/</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 1 byteflag + 1 byte password length + 16 bytes password
</span></span></span><span class="line"><span class="cl">    <span class="nf">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd_sbl</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_command</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">cmd_sbl</span><span class="p">.</span><span class="n">opcode</span> <span class="o">=</span> <span class="n">MMC_SET_BLOCKLEN</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">cmd_sbl</span><span class="p">.</span><span class="n">arg</span> <span class="o">=</span> <span class="n">block_size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">cmd_sbl</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">MMC_RSP_R1</span> <span class="o">|</span> <span class="n">MMC_CMD_AC</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">err</span> <span class="o">=</span> <span class="nf">mmc_wait_for_cmd</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd_sbl</span><span class="p">,</span> <span class="n">MMC_CMD_RETRIES</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">printk</span><span class="p">(</span><span class="s">&#34;%s failed block_size=%d </span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span><span class="n">__func__</span><span class="p">,</span><span class="n">block_size</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/*-----------CMD 42-----------------*/</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// CMD
</span></span></span><span class="line"><span class="cl">    <span class="nf">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_command</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="n">cmd</span><span class="p">.</span><span class="n">opcode</span> <span class="o">=</span> <span class="n">MMC_LOCK_UNLOCK</span><span class="p">;</span> <span class="c1">// CMD 42
</span></span></span><span class="line"><span class="cl">    <span class="n">cmd</span><span class="p">.</span><span class="n">arg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>   <span class="c1">// set all 0 for cmd42 arg
</span></span></span><span class="line"><span class="cl">    <span class="n">cmd</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">MMC_RSP_R1</span> <span class="o">|</span> <span class="n">MMC_CMD_ADTC</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Data
</span></span></span><span class="line"><span class="cl">    <span class="nf">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_data</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="n">data</span><span class="p">.</span><span class="n">timeout_ns</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="mi">1000</span><span class="o">*</span><span class="mi">1000</span><span class="o">*</span><span class="mi">1000</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">data</span><span class="p">.</span><span class="n">blksz</span> <span class="o">=</span> <span class="n">block_size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">data</span><span class="p">.</span><span class="n">blocks</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">data</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">MMC_DATA_WRITE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">data</span><span class="p">.</span><span class="n">sg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sg</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">data</span><span class="p">.</span><span class="n">sg_len</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">mmc_set_data_timeout</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="p">,</span> <span class="n">card</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mrq</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_request</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="n">mrq</span><span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">mrq</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Set Data for DMA
</span></span></span><span class="line"><span class="cl">    <span class="n">data_buf</span> <span class="o">=</span> <span class="nf">kzalloc</span><span class="p">(</span><span class="n">block_size</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data_buf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">printk</span><span class="p">(</span><span class="s">&#34;%s kzalloc failed</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span><span class="n">__func__</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nf">memset</span><span class="p">(</span><span class="n">data_buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">block_size</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">data_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">data_buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">key_len</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">memcpy</span><span class="p">(</span><span class="n">data_buf</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">key_buf</span><span class="p">,</span> <span class="n">key_len</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">sg_init_one</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sg</span><span class="p">,</span> <span class="n">data_buf</span><span class="p">,</span> <span class="n">block_size</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// request
</span></span></span><span class="line"><span class="cl">    <span class="nf">mmc_wait_for_req</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mrq</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">err</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">.</span><span class="n">error</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nf">printk</span><span class="p">(</span><span class="s">&#34;%s: unlock cmd error %d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">cmd</span><span class="p">.</span><span class="n">error</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span>
</span></span><span class="line"><span class="cl">        <span class="n">err</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="n">error</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">printk</span><span class="p">(</span><span class="s">&#34;[SDLOCK] %s MMC_LOCK_UNLOCK </span><span class="se">\r\n</span><span class="s">&#34;</span><span class="p">,</span><span class="n">__func__</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nl">out</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="nf">kfree</span><span class="p">(</span><span class="n">data_buf</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">err</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>åœ¨sd.cçš„mmc_sd_setup_cardä¹‹å‰ï¼ŒåŠ å…¥è§£é”åŠŸèƒ½ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">// æ£€æŸ¥æ˜¯å¦ä¸Šé”
</span></span><span class="line"><span class="cl">u32 <span class="nv">status</span> <span class="o">=</span> 0<span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="nv">err</span> <span class="o">=</span> mmc_send_status<span class="o">(</span>card, <span class="p">&amp;</span>status<span class="o">)</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="o">(</span>err<span class="o">)</span>
</span></span><span class="line"><span class="cl">    goto free_card<span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="o">(</span>status <span class="p">&amp;</span> R1_CARD_IS_LOCKED<span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="o">{</span>
</span></span><span class="line"><span class="cl">    mmc_card_set_encrypted<span class="o">(</span>card<span class="o">)</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    mmc_card_set_locked<span class="o">(</span>card<span class="o">)</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">//æ–¹ä¾¿è°ƒè¯•
</span></span><span class="line"><span class="cl">bool <span class="nv">auto_unlock</span> <span class="o">=</span> true<span class="p">;</span>
</span></span><span class="line"><span class="cl">char unlock_pwd<span class="o">[</span>16<span class="o">]</span> <span class="o">=</span> <span class="o">{</span>0x5f,0xfc,0xa1,0x9f,0xfc,0xdb,0x58,0x99,0xa8,0x2c,0x4e,0x26,0x5f,0x99,0xc7,0x6b<span class="o">}</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="o">(</span>status <span class="p">&amp;</span> R1_CARD_IS_LOCKED<span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="o">(</span>auto_unlock<span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">{</span>
</span></span><span class="line"><span class="cl">        //unlock sd card
</span></span><span class="line"><span class="cl">        <span class="nv">err</span> <span class="o">=</span> unlock_mmc<span class="o">(</span>card, unlock_pwd, 16<span class="o">)</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="o">(</span>err<span class="o">)</span>
</span></span><span class="line"><span class="cl">        <span class="o">{</span>
</span></span><span class="line"><span class="cl">            printk<span class="o">(</span><span class="s2">&#34;[SDLOCK] %s unlock failed \n&#34;</span>,__func__<span class="o">)</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span>
</span></span><span class="line"><span class="cl">        <span class="o">{</span>
</span></span><span class="line"><span class="cl">            printk<span class="o">(</span><span class="s2">&#34;[SDLOCK] %s unlock success \n&#34;</span>,__func__<span class="o">)</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="k">if</span><span class="o">(</span>!mmc_card_locked<span class="o">(</span>card<span class="o">))</span>
</span></span><span class="line"><span class="cl">            <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="nv">auto_unlock</span> <span class="o">=</span> false<span class="p">;</span>
</span></span><span class="line"><span class="cl">                printk<span class="o">(</span><span class="s2">&#34;[SDLOCK] %s unlock success and sdcard status is unlocked.\n&#34;</span>,__func__<span class="o">)</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">else</span>
</span></span><span class="line"><span class="cl">            <span class="o">{</span>
</span></span><span class="line"><span class="cl">                printk<span class="o">(</span><span class="s2">&#34;[SDLOCK] %s unlock success but sdcard status is locked, abnormal status.\n&#34;</span>,__func__<span class="o">)</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        //Check <span class="k">if</span> card is locked
</span></span><span class="line"><span class="cl">        <span class="nv">err</span> <span class="o">=</span> mmc_send_status<span class="o">(</span>card, <span class="p">&amp;</span>status<span class="o">)</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span>err<span class="o">)</span>
</span></span><span class="line"><span class="cl">        <span class="o">{</span>
</span></span><span class="line"><span class="cl">            printk<span class="o">(</span><span class="s2">&#34;[SDLOCK] %s resume sd card exception /n&#34;</span>,__func__<span class="o">)</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            goto free_card<span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span>status <span class="p">&amp;</span> R1_CARD_IS_LOCKED<span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">{</span>
</span></span><span class="line"><span class="cl">        printk<span class="o">(</span>KERN_WARNING <span class="s2">&#34;[SDLOCK] sdcard is locked\n&#34;</span><span class="o">)</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        goto <span class="k">done</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span>
</span></span><span class="line"><span class="cl">    <span class="o">{</span>
</span></span><span class="line"><span class="cl">        printk<span class="o">(</span>KERN_WARNING <span class="s2">&#34;[SDLOCK] sdcard resume to unlocked\n&#34;</span><span class="o">)</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="k">else</span>
</span></span><span class="line"><span class="cl"><span class="o">{</span>
</span></span><span class="line"><span class="cl">    printk<span class="o">(</span>KERN_WARNING <span class="s2">&#34;[SDLOCK] sdcard is unlocked\n&#34;</span><span class="o">)</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>åœ¨card.håŠ å…¥å®å®šä¹‰</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#define mmc_card_mmc(c)     ((c)-&gt;type == MMC_TYPE_MMC)
</span></span></span><span class="line"><span class="cl"><span class="cp">#define mmc_card_sd(c)      ((c)-&gt;type == MMC_TYPE_SD)
</span></span></span><span class="line"><span class="cl"><span class="cp">#define mmc_card_sdio(c)    ((c)-&gt;type == MMC_TYPE_SDIO)
</span></span></span><span class="line"><span class="cl"><span class="cp">#define mmc_card_locked(c)  ((c)-&gt;state &amp; MMC_STATE_LOCKED)
</span></span></span><span class="line"><span class="cl"><span class="cp">#define mmc_card_encrypt(c) ((c)-&gt;state &amp; MMC_STATE_ENCRYPT)
</span></span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp">#define MMC_STATE_PRESENT        (1&lt;&lt;0)       </span><span class="cm">/* present in sysfs */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define MMC_STATE_READONLY       (1&lt;&lt;1)       </span><span class="cm">/* card is read-only */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define MMC_STATE_BLOCKADDR      (1&lt;&lt;2)       </span><span class="cm">/* card uses block-addressing */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define MMC_CARD_SDXC            (1&lt;&lt;3)       </span><span class="cm">/* card is SDXC */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define MMC_CARD_REMOVED         (1&lt;&lt;4)       </span><span class="cm">/* card has been removed */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define MMC_STATE_DOING_BKOPS    (1&lt;&lt;5)       </span><span class="cm">/* card is doing BKOPS */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define MMC_STATE_LOCKED         (1&lt;&lt;12)      </span><span class="cm">/* card is currently locked */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define MMC_STATE_ENCRYPT        (1&lt;&lt;13)      </span><span class="cm">/* card is currently encrypt */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define MMC_STATE_ULTRAHIGHSPEED (1&lt;&lt;14)      </span><span class="cm">/* card is in ultra high speed mode */</span><span class="cp">
</span></span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp">#define MMC_STATE_SUSPENDED      (1&lt;&lt;6)       </span><span class="cm">/* card is suspended */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define MMC_STATE_CMDQ           (1&lt;&lt;7)       </span><span class="cm">/* card is in cmd queue mode */</span><span class="cp">
</span></span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp">#define MMC_LOCK_MODE_ERASE      (1&lt;&lt;3)
</span></span></span><span class="line"><span class="cl"><span class="cp">#define MMC_LOCK_MODE_LOCK       (1&lt;&lt;2)
</span></span></span><span class="line"><span class="cl"><span class="cp">#define MMC_LOCK_MODE_CLR_PWD    (1&lt;&lt;1)
</span></span></span><span class="line"><span class="cl"><span class="cp">#define MMC_LOCK_MODE_SET_PWD    (1&lt;&lt;0)
</span></span></span><span class="line"><span class="cl"><span class="cp">#define MMC_LOCK_MODE_UNLOCK     0
</span></span></span></code></pre></div><p>åœ¨core.cçš„mmc_wait_for_req_doneæ’æ¡©è°ƒè¯•ï¼Œéšåé€šè¿‡dmesgæŸ¥çœ‹è®°å½•</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="nf">printk</span><span class="p">(</span><span class="s">&#34;[mmc] CMD %d err number: %d&#34;</span><span class="p">,</span> <span class="n">mrq</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">opcode</span><span class="p">,</span> <span class="n">mrq</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">error</span><span class="p">);</span>
</span></span></code></pre></div><h2 id="uhs-i">UHS-I</h2>
<p>UHS-I(Ultra High Speed Phase Iï¼Œè¶…é«˜é€Ÿ)æ˜¯å®ç° SDHC å’Œ SDXC å¡é«˜é€Ÿæ•°æ®ä¼ è¾“çš„çš„æ€»çº¿æ¥å£ã€‚æ”¯æŒLVSï¼Œæœ‰ä¸ƒç§æ“ä½œæ¨¡å¼ã€‚</p>
<ul>
<li>DS - Default Speed up to 25MHz 3.3V signaling</li>
<li>HS - High Speed up to 50MHz 3.3V signaling</li>
<li>SDR12 - SDR up to 25MHz 1.8V signaling</li>
<li>SDR25 - SDR up to 50MHz 1.8V signaling</li>
<li>SDR50 - SDR up to 100MHz 1.8V signaling</li>
<li>SDR104 - SDR up to 208MHz 1.8V signaling</li>
<li>DDR - DDR up to 50MHz 1.8V signaling</li>
</ul>
<p>é¦–å…ˆç”¨CMD0é€‰æ‹©æ€»çº¿æ¨¡å¼ï¼šSPIæ¨¡å¼å’ŒSDæ¨¡å¼ã€‚1.8Vçš„ä¿¡å·æ¨¡å¼åªèƒ½è¿›å…¥SDæ¨¡å¼ã€‚</p>
<p><img loading="lazy"  src="./uhs_command_sequence.png"
        alt="uhs_command_sequence"/></p>
<p>å¯ä»¥çœ‹åˆ°å¹¶æ²¡æœ‰è§£é”æˆåŠŸï¼Œåœ¨CMD42å‡ºç°äº†-22çš„é”™è¯¯ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ dmesg -l 0,1,2,3,4,5,6,7
</span></span><span class="line"><span class="cl"><span class="o">[</span>62696.072102<span class="o">]</span> <span class="o">[</span>mmc<span class="o">]</span> CMD <span class="m">52</span> err number: -110
</span></span><span class="line"><span class="cl"><span class="o">[</span>62696.175620<span class="o">]</span> <span class="o">[</span>mmc<span class="o">]</span> CMD <span class="m">52</span> err number: -110
</span></span><span class="line"><span class="cl"><span class="o">[</span>62696.177592<span class="o">]</span> <span class="o">[</span>mmc<span class="o">]</span> CMD <span class="m">0</span> err number: <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>62696.181590<span class="o">]</span> <span class="o">[</span>mmc<span class="o">]</span> CMD <span class="m">8</span> err number: <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>62696.282033<span class="o">]</span> <span class="o">[</span>mmc<span class="o">]</span> CMD <span class="m">5</span> err number: -110
</span></span><span class="line"><span class="cl"><span class="o">[</span>62696.385534<span class="o">]</span> <span class="o">[</span>mmc<span class="o">]</span> CMD <span class="m">5</span> err number: -110
</span></span><span class="line"><span class="cl"><span class="o">[</span>62696.492060<span class="o">]</span> <span class="o">[</span>mmc<span class="o">]</span> CMD <span class="m">5</span> err number: -110
</span></span><span class="line"><span class="cl"><span class="o">[</span>62696.595641<span class="o">]</span> <span class="o">[</span>mmc<span class="o">]</span> CMD <span class="m">5</span> err number: -110
</span></span><span class="line"><span class="cl"><span class="o">[</span>62696.596514<span class="o">]</span> <span class="o">[</span>mmc<span class="o">]</span> CMD <span class="m">55</span> err number: <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>62696.597226<span class="o">]</span> <span class="o">[</span>mmc<span class="o">]</span> CMD <span class="m">41</span> err number: <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>62696.626822<span class="o">]</span> <span class="o">[</span>mmc<span class="o">]</span> CMD <span class="m">0</span> err number: <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>62696.630372<span class="o">]</span> <span class="o">[</span>mmc<span class="o">]</span> CMD <span class="m">8</span> err number: <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>62696.631051<span class="o">]</span> <span class="o">[</span>mmc<span class="o">]</span> CMD <span class="m">55</span> err number: <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>62696.631758<span class="o">]</span> <span class="o">[</span>mmc<span class="o">]</span> CMD <span class="m">41</span> err number: <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>62696.642862<span class="o">]</span> <span class="o">[</span>mmc<span class="o">]</span> CMD <span class="m">55</span> err number: <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>62696.643590<span class="o">]</span> <span class="o">[</span>mmc<span class="o">]</span> CMD <span class="m">41</span> err number: <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>62696.656036<span class="o">]</span> <span class="o">[</span>mmc<span class="o">]</span> CMD <span class="m">55</span> err number: <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>62696.656752<span class="o">]</span> <span class="o">[</span>mmc<span class="o">]</span> CMD <span class="m">41</span> err number: <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>62696.669827<span class="o">]</span> <span class="o">[</span>mmc<span class="o">]</span> CMD <span class="m">55</span> err number: <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>62696.670711<span class="o">]</span> <span class="o">[</span>mmc<span class="o">]</span> CMD <span class="m">41</span> err number: <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>62696.683086<span class="o">]</span> <span class="o">[</span>mmc<span class="o">]</span> CMD <span class="m">55</span> err number: <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>62696.683976<span class="o">]</span> <span class="o">[</span>mmc<span class="o">]</span> CMD <span class="m">41</span> err number: <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>62696.685084<span class="o">]</span> <span class="o">[</span>mmc<span class="o">]</span> CMD <span class="m">2</span> err number: <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>62696.685781<span class="o">]</span> <span class="o">[</span>mmc<span class="o">]</span> CMD <span class="m">3</span> err number: <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>62696.686493<span class="o">]</span> <span class="o">[</span>mmc<span class="o">]</span> CMD <span class="m">13</span> err number: <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>62696.687827<span class="o">]</span> <span class="o">[</span>mmc<span class="o">]</span> CMD <span class="m">9</span> err number: <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>62696.688551<span class="o">]</span> <span class="o">[</span>mmc<span class="o">]</span> CMD <span class="m">7</span> err number: <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>62696.689227<span class="o">]</span> <span class="o">[</span>mmc<span class="o">]</span> CMD <span class="m">16</span> err number: <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>62696.690033<span class="o">]</span> <span class="o">[</span>mmc<span class="o">]</span> CMD <span class="m">42</span> err number: -22
</span></span><span class="line"><span class="cl"><span class="o">[</span>62696.690041<span class="o">]</span> unlock_mmc: unlock cmd error -22
</span></span><span class="line"><span class="cl"><span class="o">[</span>62696.690045<span class="o">]</span> <span class="o">[</span>SDLOCK<span class="o">]</span> mmc_sd_init_card unlock failed
</span></span><span class="line"><span class="cl"><span class="o">[</span>62696.690749<span class="o">]</span> <span class="o">[</span>mmc<span class="o">]</span> CMD <span class="m">13</span> err number: <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>62696.690755<span class="o">]</span> <span class="o">[</span>SDLOCK<span class="o">]</span> sdcard is locked
</span></span><span class="line"><span class="cl"><span class="o">[</span>62696.690773<span class="o">]</span> mmc0: new SD card at address f317
</span></span><span class="line"><span class="cl"><span class="o">[</span>62696.691709<span class="o">]</span> mmcblk0: mmc0:f317 MF02B 1.88 GiB
</span></span></code></pre></div><p>Linuxç³»ç»Ÿé”™è¯¯å·-22å³EINVALã€‚æœ€åè·Ÿåˆ°äº†drivers/mmc/host/sdhci.cé‡Œ</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">filename: drivers/mmc/core/core.c
</span></span><span class="line"><span class="cl">functions:
</span></span><span class="line"><span class="cl">mmc_wait_for_req -&gt; __mmc_start_request -&gt; host-&gt;ops-&gt;request
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">filename: drivers/mmc/host/rtsx_pci_sdmmc.c
</span></span><span class="line"><span class="cl">functions:
</span></span><span class="line"><span class="cl">sdmmc_request -&gt; schedule_work -&gt; sd_request -&gt; sd_send_cmd_get_rsp -&gt; sd_normal_rw -&gt; sd_write_data -&gt; rtsx_pci_write_ppbuf -&gt; rtsx_pci_send_cmd
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">filename: drivers/misc/cardreader/rtsx_pcr.c
</span></span><span class="line"><span class="cl">rtsx_pci_write_ppbuf
</span></span><span class="line"><span class="cl">rtsx_pci_add_cmd
</span></span><span class="line"><span class="cl">rtsx_pci_send_cmd
</span></span></code></pre></div><p>å› ä¸ºæ˜¯ç¬”è®°æœ¬ç”µè„‘ï¼Œæ‰€ä»¥ç›¸å…³å‘½ä»¤åœ¨Realtekçš„SDè¯»å¡å™¨é©±åŠ¨é‡Œï¼Œè€Œåœ¨æ‰‹æœºä¸­æ˜¯drivers/mfd/rtsx_pcr.cã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">rtsx_pci_send_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_pcr</span> <span class="o">*</span><span class="n">pcr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">timeout</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="p">...</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">pcr</span><span class="o">-&gt;</span><span class="n">trans_result</span> <span class="o">==</span> <span class="n">TRANS_RESULT_FAIL</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">...</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">cp ./drivers/misc/cardreader/* /usr/lib/modules/<span class="k">$(</span>uname -r<span class="k">)</span>/build/drivers/misc/cardreader/
</span></span><span class="line"><span class="cl">make modules <span class="nv">SUBDIRS</span><span class="o">=</span>drivers/misc/cardreader
</span></span></code></pre></div><p>é€šè¿‡æ‰“å°rtsx_pci_add_cmdçš„å‚æ•°ï¼Œå¯ä»¥ç¡®å®šä¼ å…¥çš„keyæ²¡æœ‰é”™è¯¯</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">sd_cmd_set_sd_cmd
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">[75754.016095] [rtsx] cmd_type:1, reg_addr:fda9, ptr:0x50, val:2108292944 SD_CMD0 16
</span></span><span class="line"><span class="cl">[75754.016100] [rtsx] cmd_type:1, reg_addr:fdaa, ptr:0x0, val:2108358400  SD_CMD1
</span></span><span class="line"><span class="cl">[75754.016104] [rtsx] cmd_type:1, reg_addr:fdab, ptr:0x0, val:2108423936  SD_CMD2
</span></span><span class="line"><span class="cl">[75754.016111] [rtsx] cmd_type:1, reg_addr:fdac, ptr:0x0, val:2108489472  SD_CMD3
</span></span><span class="line"><span class="cl">[75754.016115] [rtsx] cmd_type:1, reg_addr:fdad, ptr:0x12, val:2108555026 SD_CMD4 0x12
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">sd_send_cmd_get_rsp
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">[75754.016119] [rtsx] cmd_type:1, reg_addr:fda1, ptr:0x1, val:2107768577  WRITE_REG_CMD SD_CFG2
</span></span><span class="line"><span class="cl">[75754.016122] [rtsx] cmd_type:1, reg_addr:fd5b, ptr:0x1, val:2103116033  CARD_DATA_SOURCE
</span></span><span class="line"><span class="cl">[75754.016126] [rtsx] cmd_type:1, reg_addr:fdb3, ptr:0x88, val:2108948360  WRITE_REG_CMD SD_TRANSFER
</span></span><span class="line"><span class="cl">[75754.016130] [rtsx] cmd_type:2, reg_addr:fdb3, ptr:0x60, val:-1112317856 CHECK_REG_CMD SD_TRANSFER
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">[75754.016134] [rtsx] cmd_type:0, reg_addr:fda9, ptr:0x0, val:1034485760  sd_cmd_set_sd_cmd 0
</span></span><span class="line"><span class="cl">[75754.016138] [rtsx] cmd_type:0, reg_addr:fdaa, ptr:0x0, val:1034551296  SD_CMD1
</span></span><span class="line"><span class="cl">[75754.016142] [rtsx] cmd_type:0, reg_addr:fdab, ptr:0x0, val:1034616832  SD_CMD1
</span></span><span class="line"><span class="cl">[75754.016146] [rtsx] cmd_type:0, reg_addr:fdac, ptr:0x0, val:1034682368  SD_CMD2
</span></span><span class="line"><span class="cl">[75754.016150] [rtsx] cmd_type:0, reg_addr:fdad, ptr:0x0, val:1034747904  SD_CMD3
</span></span><span class="line"><span class="cl">[75754.016153] [rtsx] cmd_type:0, reg_addr:fda3, ptr:0x0, val:1034092544  SD_STAT1
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">sd_cmd_set_sd_cmd
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">[75754.016787] [SDLOCK] unlock_mmc MMC_SET_BLOCKLEN 18
</span></span><span class="line"><span class="cl">[75754.016820] [rtsx] cmd_type:1, reg_addr:fda9, ptr:0x6a, val:2108292970 SD_CMD0 42
</span></span><span class="line"><span class="cl">[75754.016823] [rtsx] cmd_type:1, reg_addr:fdaa, ptr:0x0, val:2108358400  SD_CMD1
</span></span><span class="line"><span class="cl">[75754.016826] [rtsx] cmd_type:1, reg_addr:fdab, ptr:0x0, val:2108423936  SD_CMD2
</span></span><span class="line"><span class="cl">[75754.016829] [rtsx] cmd_type:1, reg_addr:fdac, ptr:0x0, val:2108489472  SD_CMD3
</span></span><span class="line"><span class="cl">[75754.016831] [rtsx] cmd_type:1, reg_addr:fdad, ptr:0x0, val:2108555008  SD_CMD4
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">[75754.016834] [rtsx] cmd_type:1, reg_addr:fda1, ptr:0x1, val:2107768577  WRITE_REG_CMD SD_CFG2
</span></span><span class="line"><span class="cl">[75754.016837] [rtsx] cmd_type:1, reg_addr:fd5b, ptr:0x1, val:2103116033  CARD_DATA_SOURCE
</span></span><span class="line"><span class="cl">[75754.016839] [rtsx] cmd_type:1, reg_addr:fdb3, ptr:0x88, val:2108948360 WRITE_REG_CMD SD_TRANSFER
</span></span><span class="line"><span class="cl">[75754.016842] [rtsx] cmd_type:2, reg_addr:fdb3, ptr:0x60, val:-1112317856 CHECK_REG_CMD SD_TRANSFER
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">[75754.016845] [rtsx] cmd_type:0, reg_addr:fda9, ptr:0x0, val:1034485760  sd_cmd_set_sd_cmd 0
</span></span><span class="line"><span class="cl">[75754.016848] [rtsx] cmd_type:0, reg_addr:fdaa, ptr:0x0, val:1034551296  SD_CMD1
</span></span><span class="line"><span class="cl">[75754.016851] [rtsx] cmd_type:0, reg_addr:fdab, ptr:0x0, val:1034616832  SD_CMD2
</span></span><span class="line"><span class="cl">[75754.016854] [rtsx] cmd_type:0, reg_addr:fdac, ptr:0x0, val:1034682368  SD_CMD3
</span></span><span class="line"><span class="cl">[75754.016856] [rtsx] cmd_type:0, reg_addr:fdad, ptr:0x0, val:1034747904  SD_CMD4
</span></span><span class="line"><span class="cl">[75754.016862] [rtsx] cmd_type:0, reg_addr:fda3, ptr:0x0, val:1034092544  SD_STAT1
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">write data
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">[75754.017492] [rtsx] cmd_type:1, reg_addr:fa00, ptr:0x0, val:2046885632
</span></span><span class="line"><span class="cl">[75754.017496] [rtsx] cmd_type:1, reg_addr:fa01, ptr:0x10, val:2046951184
</span></span><span class="line"><span class="cl">[75754.017499] [rtsx] cmd_type:1, reg_addr:fa02, ptr:0x5f, val:2047016799
</span></span><span class="line"><span class="cl">[75754.017502] [rtsx] cmd_type:1, reg_addr:fa03, ptr:0xfc, val:2047082492
</span></span><span class="line"><span class="cl">[75754.017505] [rtsx] cmd_type:1, reg_addr:fa04, ptr:0xa1, val:2047147937
</span></span><span class="line"><span class="cl">[75754.017508] [rtsx] cmd_type:1, reg_addr:fa05, ptr:0x9f, val:2047213471
</span></span><span class="line"><span class="cl">[75754.017511] [rtsx] cmd_type:1, reg_addr:fa06, ptr:0xfc, val:2047279100
</span></span><span class="line"><span class="cl">[75754.017513] [rtsx] cmd_type:1, reg_addr:fa07, ptr:0xdb, val:2047344573
</span></span><span class="line"><span class="cl">[75754.017518] [rtsx] cmd_type:1, reg_addr:fa08, ptr:0x58, val:2047410008
</span></span><span class="line"><span class="cl">[75754.017521] [rtsx] cmd_type:1, reg_addr:fa09, ptr:0x99, val:2047475609
</span></span><span class="line"><span class="cl">[75754.017524] [rtsx] cmd_type:1, reg_addr:fa0a, ptr:0xa8, val:2047541160
</span></span><span class="line"><span class="cl">[75754.017526] [rtsx] cmd_type:1, reg_addr:fa0b, ptr:0x2c, val:2047606572
</span></span><span class="line"><span class="cl">[75754.017529] [rtsx] cmd_type:1, reg_addr:fa0c, ptr:0x4e, val:2047672142
</span></span><span class="line"><span class="cl">[75754.017531] [rtsx] cmd_type:1, reg_addr:fa0d, ptr:0x26, val:2047737638
</span></span><span class="line"><span class="cl">[75754.017534] [rtsx] cmd_type:1, reg_addr:fa0e, ptr:0x5f, val:2047803231
</span></span><span class="line"><span class="cl">[75754.017537] [rtsx] cmd_type:1, reg_addr:fa0f, ptr:0x99, val:2047868825
</span></span><span class="line"><span class="cl">[75754.017539] [rtsx] cmd_type:1, reg_addr:fa10, ptr:0xc7, val:2047934407
</span></span><span class="line"><span class="cl">[75754.017542] [rtsx] cmd_type:1, reg_addr:fa11, ptr:0x6b, val:2047999851
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">sd_cmd_set_block_len
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">[75754.017569] [rtsx] cmd_type:1, reg_addr:fdb1, ptr:0x1, val:2108817153  SD_BLOCK_CNT_L 1
</span></span><span class="line"><span class="cl">[75754.017572] [rtsx] cmd_type:1, reg_addr:fdb2, ptr:0x0, val:2108882688  SD_BLOCK_CNT_H
</span></span><span class="line"><span class="cl">[75754.017575] [rtsx] cmd_type:1, reg_addr:fdaf, ptr:0x12, val:2108686098 SD_BYTE_CNT_L  18
</span></span><span class="line"><span class="cl">[75754.017577] [rtsx] cmd_type:1, reg_addr:fdb0, ptr:0x0, val:2108751616  SD_BYTE_CNT_H
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">[75754.017580] [rtsx] cmd_type:1, reg_addr:fda1, ptr:0x0, val:2107768576  WRITE_REG_CMD SD_CFG2
</span></span><span class="line"><span class="cl">[75754.017583] [rtsx] cmd_type:1, reg_addr:fdb3, ptr:0x81, val:2108948353 WRITE_REG_CMD SD_TRANSFER
</span></span><span class="line"><span class="cl">[75754.017585] [rtsx] cmd_type:2, reg_addr:fdb3, ptr:0x40, val:-1112326080 CHECK_REG_CMD SD_TRANSFER
</span></span></code></pre></div><h2 id="unlocking-sd-card-by-raspberry-pi">Unlocking SD Card by Raspberry Pi</h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo dd <span class="nv">bs</span><span class="o">=</span>4M <span class="k">if</span><span class="o">=</span>/home/cygnus/IMG/2018-06-27-raspbian-stretch-lite/2018-06-27-raspbian-stretch-lite.img <span class="nv">of</span><span class="o">=</span>/dev/mmcblk0 <span class="nv">status</span><span class="o">=</span>progress <span class="nv">conv</span><span class="o">=</span>fsync
</span></span></code></pre></div><p>ä¸‹è½½å¯¹åº”ç‰ˆæœ¬çš„æ ‘è“æ´¾æºä»£ç ï¼Œå¹¶æŠŠå·¥å…·é“¾åŠ å…¥ç¯å¢ƒå˜é‡</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">git clone --depth<span class="o">=</span><span class="m">1</span> --branch rpi-4.14.y https://github.com/raspberrypi/linux
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">PATH</span><span class="o">=</span><span class="nv">$PATH</span>:/home/cygnus/git/rapi-tools/arm-bcm2708/gcc-linaro-arm-linux-gnueabihf-raspbian-x64/bin
</span></span></code></pre></div><p>ä½¿ç”¨BCM2709é…ç½®ï¼Œå¹¶åœ¨MENU CONFIGé‡ŒæŠŠSDå¡é©±åŠ¨å’ŒMMCé©±åŠ¨å˜ä¸ºå†…æ ¸æ¨¡å—å½¢å¼ã€‚æœ€åç¼–è¯‘zImageï¼Œæ¨¡å—ï¼Œè®¾å¤‡æ ‘ï¼Œç„¶åæ›´æ–°SDå¡é‡Œçš„æ–‡ä»¶ã€‚
kernel.img is used by RPi 1B, 1A, A+, B+, 2B (first version) Z, Z (with camera), ZW, CM1
kernel7.img is used by the RPi2B2, RPi3B, CM3 and CM3L.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="nv">KERNEL</span><span class="o">=</span>kernel7
</span></span><span class="line"><span class="cl">make <span class="nv">ARCH</span><span class="o">=</span>arm <span class="nv">CROSS_COMPILE</span><span class="o">=</span>arm-linux-gnueabihf- bcm2709_defconfig
</span></span><span class="line"><span class="cl">make <span class="nv">ARCH</span><span class="o">=</span>arm <span class="nv">CROSS_COMPILE</span><span class="o">=</span>arm-linux-gnueabihf- menuconfig
</span></span><span class="line"><span class="cl">make <span class="nv">ARCH</span><span class="o">=</span>arm <span class="nv">CROSS_COMPILE</span><span class="o">=</span>arm-linux-gnueabihf- -j16 zImage modules dtbs
</span></span><span class="line"><span class="cl">sudo make <span class="nv">ARCH</span><span class="o">=</span>arm <span class="nv">CROSS_COMPILE</span><span class="o">=</span>arm-linux-gnueabihf- <span class="nv">INSTALL_MOD_PATH</span><span class="o">=</span>/run/media/cygnus/rootfs modules_install
</span></span></code></pre></div><p>æ›´æ–°å†…æ ¸</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo cp /run/media/cygnus/boot/<span class="nv">$KERNEL</span>.img /run/media/cygnus/boot/<span class="nv">$KERNEL</span>-backup.img
</span></span><span class="line"><span class="cl">sudo cp arch/arm/boot/zImage /run/media/cygnus/boot/<span class="nv">$KERNEL</span>.img
</span></span></code></pre></div><p>æ›´æ–°è®¾å¤‡æ ‘</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo cp arch/arm/boot/dts/*.dtb /run/media/cygnus/boot/
</span></span><span class="line"><span class="cl">sudo cp arch/arm/boot/dts/overlays/*.dtb* /run/media/cygnus/boot/overlays/
</span></span></code></pre></div><p>åœ¨boot configåŠ å…¥ä¸‹é¢é…ç½®</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="nv">dtoverlay</span><span class="o">=</span>sdio,poll_once<span class="o">=</span>off
</span></span></code></pre></div><table>
  <thead>
      <tr>
          <th>Name</th>
          <th>SD Card</th>
          <th>Raspberry Pi Pin Num</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>VCC</td>
          <td>4</td>
          <td>17</td>
      </tr>
      <tr>
          <td>GND</td>
          <td>6</td>
          <td>20</td>
      </tr>
      <tr>
          <td>CLK/SCLK</td>
          <td>5</td>
          <td>15</td>
      </tr>
      <tr>
          <td>CMD/MOSI</td>
          <td>2</td>
          <td>16</td>
      </tr>
      <tr>
          <td>DAT0/MISO</td>
          <td>7</td>
          <td>18</td>
      </tr>
      <tr>
          <td>DAT1</td>
          <td>8</td>
          <td>22</td>
      </tr>
      <tr>
          <td>DAT2</td>
          <td>9</td>
          <td>37</td>
      </tr>
      <tr>
          <td>DAT3/CS</td>
          <td>1</td>
          <td>13</td>
      </tr>
  </tbody>
</table>
<h2 id="reference">Reference</h2>
<p><a href="https://www.sdcard.org/downloads/pls/index.html"target="_blank" rel="noopener noreferrer">SD Simplified Specifications</a></p>
<p><a href="https://en.wikipedia.org/wiki/Secure_Digital"target="_blank" rel="noopener noreferrer">Wiki - Secure_Digital</a></p>
<p><a href="https://www.sdcard.org/developers/overview/index.html"target="_blank" rel="noopener noreferrer">SD Standard Overview</a></p>
</article><section class="article labels"><a class="category" href=/zh/categories/%E5%9B%BA%E4%BB%B6%E6%8F%90%E5%8F%96%E7%B3%BB%E5%88%97/>å›ºä»¶æå–ç³»åˆ—</a><a class="tag" href=/zh/tags/sd%E5%8D%A1/>SDå¡</a><a class="tag" href=/zh/tags/sd%E8%A7%84%E8%8C%83/>SDè§„èŒƒ</a><a class="tag" href=/zh/tags/sdio/>SDIO</a></section>
</div>
<div class="article bottom"><section class="article navigation"><p><a class="link" href="/zh/posts/tinyscheme-file-io/"><span class="iconfont icon-article"></span>TinySchemeè¯»å†™æ–‡ä»¶</a></p><p><a class="link" href="/zh/posts/huawei-e5885l-4g-router-tinkering-notes/"><span class="iconfont icon-article"></span>åä¸º E5885L 4Gè·¯ç”±å™¨æŠ˜è…¾ç¬”è®°</a></p></section></div></section><section id="footer"><div class="footer-wrap">
    <p class="copyright">2015 - 2026 Gorgias' Blog. </p><p class="license">
        <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noopener noreferrer">
            <img alt="CC BY-NC-SA" loading="lazy" src="/images/by-nc.svg" style="vertical-align: middle; height: 1.2em; margin: 0 0.2em;" />
            CC BY-NC-SA 4.0
        </a>
        (ç½²å-éå•†ä¸šæ€§ä½¿ç”¨-ç›¸åŒæ–¹å¼å…±äº«).
    </p><p class="powerby"><span>Powered&nbsp;by&nbsp;</span><a href="https://gohugo.io" 
        target="_blank" rel="noopener noreferrer">Hugo</a><span>&nbsp;&amp;&nbsp;</span><a href="https://themes.gohugo.io/hugo-notepadium/" 
        target="_blank" rel="noopener noreferrer">Notepadium</a></p></div></section></body>

</html>