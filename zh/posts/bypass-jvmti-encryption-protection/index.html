<!DOCTYPE html>
<html lang="zh"><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset="utf-8"><meta name="generator" content="Hugo 0.154.5"><meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<meta name="color-scheme" content="light dark">
<meta name="supported-color-schemes" content="light dark"><meta name="description" content="ç ”ç©¶è¿‡ç¨‹
æœ€è¿‘ç ”ç©¶æŸæ±½è½¦ï¼Œé‡åˆ°ä¸€ä¸ªWinä¸‹çš„è½¯ä»¶ï¼Œç”¨äºè¿æ¥ç»é”€å•†å†…ç½‘ã€‚"><title>JVMTIåŠ å¯†ä¿æŠ¤ç»•è¿‡&nbsp;&ndash;&nbsp;Gorgias&#39; Blog</title><link rel="stylesheet" href="/css/core.min.363cdd0e3e6340dd0e88b1f21887fb7e53e3129ed31d7f3cf62686d06069621ece79dc5ffb48a77ebba54468e667212f.css" integrity="sha384-NjzdDj5jQN0OiLHyGIf7flPjEp7THX889iaG0GBpYh7Oedxf&#43;0infrulRGjmZyEv"><meta name="twitter:card" content="summary" />
<meta name="twitter:title" content="JVMTIåŠ å¯†ä¿æŠ¤ç»•è¿‡" /><body><section id="header">
    <div class="header wrap"><span class="header left-side"><a class="site home" href="/zh/"><span class="site name">Gorgias' Blog</span></a></span>
        <span class="header right-side"><div class="nav wrap"><nav class="nav"><a class="nav item" href="/zh/categories/">åˆ†ç±»</a><a class="nav item" href="/zh/tags/">æ ‡ç­¾</a><a class="nav item" href="/zh/about/">å…³äº</a><a class="nav item" href="/zh/links/">å‹é“¾</a></nav></div></span></div></section><section id="content"><div class="article-container"><section class="article header">
    <h1 class="article title">JVMTIåŠ å¯†ä¿æŠ¤ç»•è¿‡</h1><p class="article date">2021-06-28<span class="langs"><span class="lang">
                    <a href="/en/posts/bypass-jvmti-encryption-protection/" title="English">
                        <span class="lang-icon">ğŸŒ</span>English</a>
                </span></span></p></section><article class="article markdown-body"><h2 id="ç ”ç©¶è¿‡ç¨‹">ç ”ç©¶è¿‡ç¨‹</h2>
<p>æœ€è¿‘ç ”ç©¶æŸæ±½è½¦ï¼Œé‡åˆ°ä¸€ä¸ªWinä¸‹çš„è½¯ä»¶ï¼Œç”¨äºè¿æ¥ç»é”€å•†å†…ç½‘ã€‚</p>
<p>å®‰è£…å®Œæˆï¼Œç›®å½•æœ‰jaræ–‡ä»¶åˆæœ‰exeæ–‡ä»¶ã€‚</p>
<p><img loading="lazy"  src="./files.png"
        alt="files"/></p>
<p>æ‰§è¡Œstart.exeä¹‹åå¯ä»¥çœ‹åˆ°å¯åŠ¨äº†ä¸¤ä¸ªJavaè¿›ç¨‹</p>
<p><img loading="lazy"  src="./winpe.png"
        alt="winpe"/></p>
<pre tabindex="0"><code>C:\LC\Elsapro\lib\jre\bin\java.exe -agentlib:C:\LC\Elsapro\lib\jna\jvmprotect -Djava.library.path=C:\LC\Elsapro\lib\jna -Dfile.encoding=utf-8 -classpath C:\LC\Elsapro -cp C:\LC\Elsapro\ElsaPro.jar com.qqw.lcst.softp.superc.v5.app.epweb.gui.OptGui 
</code></pre><p>çŒœæµ‹ç¬¬äºŒä¸ªè¿›ç¨‹å¯èƒ½æ˜¯å†…ç½®æµè§ˆå™¨ï¼Œç¬¬ä¸€ä¸ªè¿›ç¨‹æ˜¯å…³é”®è¿›ç¨‹</p>
<p>ä½¿ç”¨jdguiæ‰“å¼€ï¼Œå‘ç°éƒ¨åˆ†ç±»æ˜¾ç¤ºInternel Errorï¼Œå¹¶ä¸”å…³é”®ç±»æ²¡æœ‰æ˜¾ç¤ºã€‚ä½¿ç”¨å…¶ä»–javaåç¼–è¯‘å·¥å…·ä¹Ÿä¸€æ ·ã€‚</p>
<p><img loading="lazy"  src="./jdgui.png"
        alt="jdgui"/></p>
<p>ç®€å•é€†å‘start.exeæ–‡ä»¶ï¼Œå‘ç°åªæ˜¯ç”¨ä½œClassLoaderï¼Œå¯èƒ½ç”¨äºåœ¨çº¿æ›´æ–°ã€‚</p>
<p>åœ¨å¯åŠ¨å‚æ•°çœ‹åˆ°äº†agentlibæŒ‡å‘jvmprotectï¼Œä½¿ç”¨IDA Proæ‰“å¼€jvmprotectï¼Œå‘ç°ä½¿ç”¨äº†JVMTIä½œä¸ºagentï¼ŒçŒœæµ‹å¯èƒ½ä½œä¸ºè§£å¯†æ¨¡å—ã€‚</p>
<p>JVMTIæ”¯æŒåŒ…æ‹¬ä½†ä¸é™äºå–è¯ï¼Œè°ƒè¯•ï¼Œç›‘æ§ï¼Œçº¿ç¨‹åˆ†æï¼Œè¦†ç›–ç‡åˆ†æç­‰å·¥å…·ã€‚</p>
<p>ç®€å•æŸ¥é˜…JVMTIæ–‡æ¡£ï¼Œå¾—çŸ¥å¦‚ä¸‹ä¸‰ä¸ªä¸»è¦æ–¹æ³•ï¼Œå¯ä»¥ä½œä¸ºé€†å‘åˆ‡å…¥ç‚¹</p>
<ul>
<li>Agent_OnLoad   å¯åŠ¨æ—¶è°ƒç”¨</li>
<li>Agent_OnAttach é™„åŠ æ—¶è°ƒç”¨</li>
<li>Agent_OnUnload å¸è½½æ—¶è°ƒç”¨</li>
</ul>
<p>ä½¿ç”¨IDA Proæ‰“å¼€è¿™ä¸ªagentã€‚å¾—çŸ¥<code>Agent_OnLoad</code>æ˜¯å¯åŠ¨å‡½æ•°ï¼Œç”±äºä»£ç åŸºäºJNIå’ŒJVMTIï¼Œæ‰“å¼€é˜…è¯»ä¸å¤ªæ–¹ä¾¿ã€‚æˆ‘æ•´åˆäº†ä¸€ä¸ªjvmti_all.hå¤´æ–‡ä»¶ï¼Œæ–¹ä¾¿é€†å‘ã€‚ï¼ˆç”±äºè¿™ä¸ªå›è°ƒå‡½æ•°å¤ªç®€å•ï¼Œå¹¶ä¸”æ²¡æœ‰ç”¨åˆ°å…¶ä»–åŠŸèƒ½ï¼Œæ‰€ä»¥æ²¡æœ‰æ´¾ä¸Šä»€ä¹ˆç”¨åœºï¼‰ã€‚</p>
<p><img loading="lazy"  src="./onload.png"
        alt="onload"/></p>
<p>å¯åŠ¨æ—¶è®¾ç½®<code>SetEventCallbacks</code>ï¼Œæ­¤æ—¶ä¼šæŠŠjaråŒ…çš„classæ–‡ä»¶é€ä¸ªä¼ å…¥è¿™ä¸ªå›è°ƒå‡½æ•°ã€‚ç„¶åæŠŠæ¯ä¸ªç±»è§£å¯†ï¼Œå¹¶ä¸”è¾“å‡ºæ—¥å¿—ã€‚</p>
<p><img loading="lazy"  src="./eventcallback.png"
        alt="eventcallback"/></p>
<p>æˆ‘å¾ˆæ‡’ï¼Œä¸æƒ³è¿˜åŸç®—æ³•ï¼Œæ‰“ç®—ç”¨fridaæˆ–è€…unicorn engineå»è§£å¯†ã€‚</p>
<p>é˜…è¯»å®Œè¿™ç¯‡æ–‡ç«  <a href="http://www.fanyilun.me/2017/07/18/%E8%B0%88%E8%B0%88Java%20Intrumentation%E5%92%8C%E7%9B%B8%E5%85%B3%E5%BA%94%E7%94%A8/"target="_blank" rel="noopener noreferrer">Yilun Fan - è°ˆè°ˆJava Intrumentationå’Œç›¸å…³åº”ç”¨</a>ï¼Œå‘ç°Instrumentation APIåŸºäºJVMTIï¼Œå› æ­¤å¯ä»¥ä½¿ç”¨Java Agentæ¥å¯¼å‡ºclassæ–‡ä»¶</p>
<p><img loading="lazy"  src="./agent_related_tools.jpg"
        alt="agent_related_tools"/></p>
<p>å‚è€ƒ<a href="https://www.cnblogs.com/yougewe/p/9651555.html"target="_blank" rel="noopener noreferrer">ç­‰ä½ å½’å»æ¥ - å¦‚ä½•è·å–javaè¿è¡Œæ—¶åŠ¨æ€ç”Ÿæˆçš„classæ–‡ä»¶ï¼Ÿ</a>ï¼Œæˆ‘æ‰“åŒ…äº†åä¸ºClazzDumpAgent.jarçš„Agentã€‚då‚æ•°ä»£è¡¨dumpè·¯å¾„ï¼Œ-få‚æ•°æ˜¯åŒ¹é…æå–çš„å‰ç¼€ï¼Œ-ræ–‡ä»¶ä»£è¡¨åŒ…åã€‚</p>
<p>agentlibå’Œjavaagentå­˜åœ¨å…ˆåé¡ºåºï¼Œä¸€å®šè¦å…ˆè§£å¯†å®Œå†å¯¼å‡ºã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cmd" data-lang="cmd"><span class="line"><span class="cl">C<span class="p">:</span><span class="nl">\LC\Elsapro\lib\jre\bin\java.exe</span><span class="c1"> -Xms256m -Xmx512m -XX:MetaspaceSize=256m -XX:MaxMetaspaceSize=512m -agentlib:C:\LC\Elsapro\lib\jna\JvmtiCry -Djava.library.path=C:\LC\Elsapro\lib\jna -javaagent:C:\LC\Elsapro\ClazzDumpAgent.jar=-d=C:\LC\Elsapro\clazzDump\;-f=com/qqw/lcst;-r=lcst -Dfile.encoding=utf-8 -classpath C:\LC\Elsapro -cp C:\LC\Elsapro\ElsaPro.jar com.qqw.lcst.softp.superc.v5.app.epweb.gui.OptGui</span>
</span></span></code></pre></div><p>æ‰§è¡Œè¿™æ®µè„šæœ¬ï¼Œå¯ä»¥çœ‹åˆ°è§£å¯†å®Œæ¯ä¸ªclassä¹‹åï¼Œéƒ½ä¼šå¯¼å‡ºè¿™ä¸ªclassã€‚</p>
<p><img loading="lazy"  src="./decryption_cmd.png"
        alt="decryption_cmd.png"/></p>
<p>éšåå°†è·¯å¾„æ‰“åŒ…æˆzipæ–‡ä»¶ï¼Œç”¨ Java åç¼–è¯‘è½¯ä»¶æ‰“å¼€ï¼Œç›¸æ¯”è¾ƒç¬¬ä¸€å¼ å›¾ï¼Œå¯ä»¥çœ‹åˆ°ä¹‹å‰æ˜¾ç¤ºä¸ºnullçš„classå·²ç»å‡ºç°ç‡ï¼Œä½†æ˜¯æœ‰äº›æ˜¾ç¤ºInternal Errorçš„ç±»æ²¡æœ‰å‡ºç°ã€‚è¿™æ˜¯å› ä¸ºæ²¡æœ‰æ‰§è¡Œçš„classä¸ä¼šè¢«è§£å¯†ï¼Œè¿™æ—¶å€™ä¸»åŠ¨è§¦å‘è¿™ä¸ªåŠŸèƒ½ï¼Œåœ¨å‘½ä»¤è¡Œå¯ä»¥çœ‹åˆ°ç›¸å…³çš„ç±»è¢«å®æ—¶è§£å¯†ã€‚</p>
<p><img loading="lazy"  src="./jdgui2.png"
        alt="jdgui2"/></p>
<p>å»ºè®®ç”¨CFRå»åç¼–è¯‘ï¼ŒæŠ¥é”™æ›´å°‘ã€‚</p>
<pre tabindex="0"><code>cfrd -jar ./decypted.zip ./out
</code></pre><h2 id="å½©è›‹">å½©è›‹</h2>
<p><img loading="lazy"  src="./intranet.png"
        alt="intranet.png"/></p>
<h2 id="å‚è€ƒ">å‚è€ƒ</h2>
<p><a href="https://docs.oracle.com/javase/7/docs/technotes/guides/jpda/architecture.html"target="_blank" rel="noopener noreferrer">JDPA</a></p>
<p><a href="https://docs.oracle.com/javase/8/docs/platform/jvmti/jvmti.html"target="_blank" rel="noopener noreferrer">JVMTI Documentation</a></p>
<p><a href="http://www.fanyilun.me/2017/07/18/%E8%B0%88%E8%B0%88Java%20Intrumentation%E5%92%8C%E7%9B%B8%E5%85%B3%E5%BA%94%E7%94%A8/"target="_blank" rel="noopener noreferrer">è°ˆè°ˆJava Intrumentationå’Œç›¸å…³åº”ç”¨</a></p>
<p><a href="https://www.cnblogs.com/yougewe/p/9651555.html"target="_blank" rel="noopener noreferrer">ç­‰ä½ å½’å»æ¥ å¦‚ä½•è·å–javaè¿è¡Œæ—¶åŠ¨æ€ç”Ÿæˆçš„classæ–‡ä»¶</a></p>
<p><a href="http://www.fanyilun.me/2017/07/18/%E8%B0%88%E8%B0%88Java%20Intrumentation%E5%92%8C%E7%9B%B8%E5%85%B3%E5%BA%94%E7%94%A8/"target="_blank" rel="noopener noreferrer">Yilun Fan - è°ˆè°ˆJava Intrumentationå’Œç›¸å…³åº”ç”¨</a></p>
<p><a href="https://mega.nz/folder/C9oEFBDJ#KVpF5qunEq_e44R7VglDgg"target="_blank" rel="noopener noreferrer">JVMTI.h and ClazzDumpAgent</a></p>
</article><section class="article labels"><a class="category" href=/zh/categories/%E9%80%86%E5%90%91%E5%B7%A5%E7%A8%8B/>é€†å‘å·¥ç¨‹</a><a class="tag" href=/zh/tags/jvmti/>JVMTI</a><a class="tag" href=/zh/tags/%E8%A7%A3%E5%AF%86/>è§£å¯†</a><a class="tag" href=/zh/tags/java/>java</a></section>
</div>
<div class="article bottom"><section class="article navigation"><p><a class="link" href="/zh/posts/general-firmware-reversing-tips/"><span class="iconfont icon-article"></span>å›ºä»¶é€†å‘çš„é€šç”¨æŠ€å·§</a></p><p><a class="link" href="/zh/posts/firmware-extraction-series-ubi-extract-and-repack/"><span class="iconfont icon-article"></span>å›ºä»¶æå–ç³»åˆ— UBIæ–‡ä»¶ç³»ç»Ÿæå–ä»¥åŠé‡æ‰“åŒ…</a></p></section></div></section><section id="footer"><div class="footer-wrap">
    <p class="copyright">2015 - 2026 Gorgias' Blog. </p><p class="license">
        <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noopener noreferrer">
            <img alt="CC BY-NC-SA" loading="lazy" src="/images/by-nc.svg" style="vertical-align: middle; height: 1.2em; margin: 0 0.2em;" />
            CC BY-NC-SA 4.0
        </a>
        (ç½²å-éå•†ä¸šæ€§ä½¿ç”¨-ç›¸åŒæ–¹å¼å…±äº«).
    </p><p class="powerby"><span>Powered&nbsp;by&nbsp;</span><a href="https://gohugo.io" 
        target="_blank" rel="noopener noreferrer">Hugo</a><span>&nbsp;&amp;&nbsp;</span><a href="https://themes.gohugo.io/hugo-notepadium/" 
        target="_blank" rel="noopener noreferrer">Notepadium</a></p></div></section></body>

</html>