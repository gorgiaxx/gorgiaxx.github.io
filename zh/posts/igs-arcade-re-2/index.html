<!DOCTYPE html>
<html lang="zh"><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset="utf-8"><meta name="generator" content="Hugo 0.154.5"><meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<meta name="color-scheme" content="light dark">
<meta name="supported-color-schemes" content="light dark"><meta name="description" content="ä¸Šä¸€ç¯‡æ–‡ç« å†™åˆ°æ¸¸æˆæœ‰ä¸ªç ´ååˆ†åŒºçš„ä¿æŠ¤æœºåˆ¶ï¼Œæœ¬ç¯‡å°†æ·±å…¥åˆ†æã€‚
ä½œä¸º2007å¹´å‘å¸ƒçš„æ¸¸æˆï¼Œæ­¤æ¸¸æˆåŠ å›ºæœºåˆ¶è¿˜æ˜¯æ¯”è¾ƒè½åçš„ï¼Œä¸»è¦æ˜¯é ä¸€äº›æ‹¼æ¥ï¼Œä¿®æ”¹ç‰¹å¾çš„æ–¹æ³•æ¥åŠ å›ºã€‚å¹¶æ²¡æœ‰ç°ä»£APPåŠ å›ºçš„é‚£ä¹ˆå·çš„ç‰¹æ€§ã€‚ä¸»è¦æ˜¯åŠ å›ºçš„ç¯èŠ‚æœ‰ç‚¹å¤šï¼Œå¹¶ä¸”æ¯ä¸ªæ¸¸æˆéƒ½ä¸ä¸€æ ·ã€‚ç„¶åç”±äºå¼€å‘ä¸Šçš„ç‰¹æ€§ï¼Œï¼ˆç¼–è¯‘ä¼˜åŒ–ï¼Œä»£ç é£æ ¼ï¼‰ï¼Œä½¿å¾—é€†å‘åˆ†æå˜éº»çƒ¦äº†ã€‚"><title>IGS Arcade é€†å‘ç³»åˆ—ï¼ˆäºŒï¼‰- æ¸¸æˆæ–‡ä»¶æ¢å¤&nbsp;&ndash;&nbsp;Gorgias&#39; Blog</title><link rel="stylesheet" href="/css/core.min.363cdd0e3e6340dd0e88b1f21887fb7e53e3129ed31d7f3cf62686d06069621ece79dc5ffb48a77ebba54468e667212f.css" integrity="sha384-NjzdDj5jQN0OiLHyGIf7flPjEp7THX889iaG0GBpYh7Oedxf&#43;0infrulRGjmZyEv"><meta name="twitter:card" content="summary" />
<meta name="twitter:title" content="IGS Arcade é€†å‘ç³»åˆ—ï¼ˆäºŒï¼‰- æ¸¸æˆæ–‡ä»¶æ¢å¤" /><body><section id="header">
    <div class="header wrap"><span class="header left-side"><a class="site home" href="/zh/"><span class="site name">Gorgias' Blog</span></a></span>
        <span class="header right-side"><div class="nav wrap"><nav class="nav"><a class="nav item" href="/zh/categories/">åˆ†ç±»</a><a class="nav item" href="/zh/tags/">æ ‡ç­¾</a><a class="nav item" href="/zh/about/">å…³äº</a><a class="nav item" href="/zh/links/">å‹é“¾</a></nav></div></span></div></section><section id="content"><div class="article-container"><section class="article header">
    <h1 class="article title">IGS Arcade é€†å‘ç³»åˆ—ï¼ˆäºŒï¼‰- æ¸¸æˆæ–‡ä»¶æ¢å¤</h1><p class="article date">2025-05-25<span class="langs"><span class="lang">
                    <a href="/en/posts/igs-arcade-re-2/" title="English">
                        <span class="lang-icon">ğŸŒ</span>English</a>
                </span></span></p></section><article class="article markdown-body"><p>ä¸Šä¸€ç¯‡æ–‡ç« å†™åˆ°æ¸¸æˆæœ‰ä¸ªç ´ååˆ†åŒºçš„ä¿æŠ¤æœºåˆ¶ï¼Œæœ¬ç¯‡å°†æ·±å…¥åˆ†æã€‚</p>
<p>ä½œä¸º2007å¹´å‘å¸ƒçš„æ¸¸æˆï¼Œæ­¤æ¸¸æˆåŠ å›ºæœºåˆ¶è¿˜æ˜¯æ¯”è¾ƒè½åçš„ï¼Œä¸»è¦æ˜¯é ä¸€äº›æ‹¼æ¥ï¼Œä¿®æ”¹ç‰¹å¾çš„æ–¹æ³•æ¥åŠ å›ºã€‚å¹¶æ²¡æœ‰ç°ä»£APPåŠ å›ºçš„é‚£ä¹ˆå·çš„ç‰¹æ€§ã€‚ä¸»è¦æ˜¯åŠ å›ºçš„ç¯èŠ‚æœ‰ç‚¹å¤šï¼Œå¹¶ä¸”æ¯ä¸ªæ¸¸æˆéƒ½ä¸ä¸€æ ·ã€‚ç„¶åç”±äºå¼€å‘ä¸Šçš„ç‰¹æ€§ï¼Œï¼ˆç¼–è¯‘ä¼˜åŒ–ï¼Œä»£ç é£æ ¼ï¼‰ï¼Œä½¿å¾—é€†å‘åˆ†æå˜éº»çƒ¦äº†ã€‚</p>
<p>è¦æå–æ¸¸æˆå…¶å®æ¯”è¾ƒç®€å•ï¼Œç­‰æ¸¸æˆè¿è¡Œæ—¶é€šè¿‡shellä»å†…å­˜æˆ–è€…ä»æ–‡ä»¶ç³»ç»Ÿï¼ˆå¦‚æœæ–‡ä»¶è½åœ°ï¼‰dumpå°±è¡Œäº†ã€‚ä½†æ˜¯å¦‚æœè¦æå–ä¸åŒæ¸¸æˆï¼Œè¿™æ ·å°±å¤ªéº»çƒ¦äº†ï¼Œè¿˜æ˜¯å…ˆé™æ€åˆ†æå§ã€‚</p>
<p>æ€»ä¹‹ï¼Œè¿™ä¸ªé€†å‘è¿‡ç¨‹åƒæ˜¯åœ¨åšMISCé¢˜ä¸€æ ·ï¼Œéœ€è¦ä¸€äº›é€»è¾‘æ¨ç†ã€‚</p>
<h2 id="é€†å‘é™·é˜±">é€†å‘é™·é˜±</h2>
<p>ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œåˆ†ææ–‡ä»¶ç³»ç»Ÿçš„å†…å®¹ï¼Œå¾ˆå°‘ä¼šå…ˆä»å†…æ ¸å…¥æ‰‹ï¼Œä¸€èˆ¬å…ˆçœ‹initç›¸å…³æ–‡ä»¶ã€‚
ç¬¬ä¸€æ­¥ä¸€èˆ¬éƒ½æ˜¯çœ‹ /etc/inittabï¼Œè„šæœ¬é¦–å…ˆå¯åŠ¨rcï¼Œç„¶åå¯åŠ¨å›¾å½¢ç•Œé¢</p>
<pre tabindex="0"><code># Begin /etc/inittab
id:4:initdefault:
si::sysinit:/etc/rc.d/init.d/rc
x:4:respawn:/etc/X11/IGS &amp;&gt; /dev/null
# End /etc/inittab
</code></pre><h3 id="etcrcdinitdrc">/etc/rc.d/init.d/rc</h3>
<pre tabindex="0"><code>#!/bin/bash

PATH=/bin:/sbin:/usr/bin:/usr/sbin
export PATH

mount -n -o remount,rw /
mount -n -t ramfs tmp /tmp
mount -n -t proc proc /proc
mount -n -t usbdevfs usbdevfs /proc/bus/usb

#echo &#34;copy for etc&#34;
cp -a /etc/* /tmp
mount -n -t ramfs etc /etc
cp -a /tmp/* /etc
rm -rf /tmp/*

#echo &#34;copy for dev&#34;
cp -a /dev/* /tmp
mount -n -t ramfs dev /dev
cp -a /tmp/* /dev
rm -rf /tmp/*
mount -n -t devpts pts /dev/pts
mount -n -t tmpfs shm /dev/shm

#echo &#34;copy for var&#34;
cp -a /var/* /tmp
mount -n -t ramfs var /var
cp -a /tmp/* /var
rm -rf /tmp/*

#echo &#34;copy for root&#34;
cp -a /root/.b* /tmp
mount -n -t ramfs root /root
cp -a /tmp/.b* /root
rm -rf /tmp/.b*

/sbin/hdparm  -c1 -d1 -k1 -Xudma4 /dev/hdc &amp;&gt; /dev/null
</code></pre><h3 id="etcx11igs">/etc/X11/IGS</h3>
<p>é…ç½®ç¯å¢ƒå˜é‡ï¼Œå¯åŠ¨Xï¼Œç„¶åå¯åŠ¨è¯»å¡å™¨ï¼Œæœ€åå¯åŠ¨æ¸¸æˆï¼Œé™¤äº†è¿™ä¸ªå¾ªç¯æœ‰ä¸€ç‚¹åå¸¸ï¼Œå…¶ä»–éƒ½éå¸¸æ­£å¸¸ã€‚åˆ°è¿™ä¸ªæ—¶å€™è‚¯å®šå°±è®¤ä¸º/PM2008v2/PM2008v2æ˜¯æ¸¸æˆæœ¬ä½“äº†</p>
<pre tabindex="0"><code>#!/bin/sh

TZ=&#34;UCT&#34;
TERM=&#34;xterm&#34;
TempFile=&#34;/tmp/XTemp&#34;
HZ=&#34;100&#34;
PATH=/sbin:/usr/sbin:/bin:/usr/bin:/usr/X11R6/bin
LD_LIBRARY_PATH=/usr/X11R6/lib:/usr/X11R6/lib/modules/extensions
DISPLAY=:0

export PATH LD_LIBRARY_PATH DISPLAY TERM HZ TZ

ps -A | grep XFree86 | ( while read pid tty time command; do kill -9 $pid; done )
XFree86 &amp;&gt; /dev/null&amp;
mwm &amp;&gt; /dev/null &amp;

/usr/X11R6/bin/xsetroot -cursor /usr/X11R6/bitmaps/empty_ptr /usr/X11R6/bitmaps/empty_ptr

if [ -f $TempFile ];then
        rm -rf $TempFile
        sleep 10
        exit 0
else
        touch $TempFile
fi


/etc/rc.d/init.d/cardreader &amp;&gt; /dev/null&amp;
export TZ=&#34;CST&#34;

#Run Game
cd /PM2008v2

while [ 1 ]
do
	./PM2008v2 &amp;&gt; /dev/null
	sleep 5
done
</code></pre><p>æ¥ä¸‹æ¥åˆ†æ PM2008v2ï¼Œç¬¬ä¸€çœ¼çœ‹ä¸Šå»ï¼Œé‡Œé¢æœ‰å¾ˆå¤šç¨‹åºè£…è½½çš„ä»£ç ã€‚è”æƒ³åˆ°ä¹‹å‰æœ‰å¾ˆå¤šæ–‡ä»¶æ²¡æœ‰magicï¼ŒçŒœæµ‹å¯èƒ½æ˜¯æ‹¿æ¥åŠ¨æ€åŠ è½½ä»£ç æ–‡ä»¶è¿˜åŸæˆelfçš„ã€‚ä½†æ˜¯åæ¥ Nova å’Œæˆ‘è¯´è¿™ä¸œè¥¿ä¸æ˜¯æ¸¸æˆï¼Œæˆ‘æ‰çŸ¥é“äº†å®ƒçš„å¼‚å¸¸ã€‚è¿™ä¸ªæ–‡ä»¶æœ‰å¾ˆå¤šglibcç‰¹å¾ï¼Œæ„Ÿè§‰å°±æ˜¯ä¸€ä¸ªé™æ€é“¾æ¥glibcçš„ç¨‹åºã€‚</p>
<p>ä¸ºäº†æ–¹ä¾¿é€†å‘å’ŒåæœŸçš„æ¸¸æˆç§»æ¤ï¼Œæˆ‘éœ€è¦ç¡®è®¤GCCå’ŒGLibcç‰ˆæœ¬ï¼ŒPM2008v2: GCC: (GNU) 3.3.1ï¼Œä½†æ˜¯æ²¡æœ‰GLibcçš„ç‰ˆæœ¬ä¿¡æ¯ã€‚
å› æ­¤æˆ‘ç›´æ¥æ‰¾åˆ°ç³»ç»Ÿçš„libc.soï¼Œç‰ˆæœ¬æš‚å®šä¸ºglibc 2.3.2ã€‚åœ¨æœ€æ–°çš„linuxä¸‹ä¸å¥½ç¼–è¯‘ï¼Œdockerä¸‹ä¹Ÿå‡ºäº†é—®é¢˜ã€‚</p>
<h2 id="åˆ†æä¼ªæ¸¸æˆç¨‹åº">åˆ†æä¼ªæ¸¸æˆç¨‹åº</h2>
<h3 id="ç¼–è¯‘-gcc-331">ç¼–è¯‘ GCC 3.3.1</h3>
<p>ç”±äºç›®æ ‡ç‰ˆæœ¬å†…æ ¸æ˜¯i686çš„ï¼Œæˆ‘ä½¿ç”¨CentOS4ç¼–è¯‘ï¼Œè¿è¡Œåœ¨VMwareï¼Œä¸ºäº†ä¿è¯ä¼˜åŒ–ä¹‹åçš„æ±‡ç¼–ä»£ç ä¸€è‡´ï¼Œæˆ‘è¦ä½¿ç”¨ç›¸åŒGCCçš„ç‰ˆæœ¬ï¼Œç„¶åç¼–è¯‘ã€‚å¹¶ä¸”æ­å»ºè¿™ä¸ªç¯å¢ƒï¼Œä¹Ÿèƒ½æ–¹ä¾¿ä»¥åå¯¹è¾…åŠ©åˆ†æè¯¥å¹³å°å…¶ä»–æ¸¸æˆï¼Œä¹Ÿæœ‰ä¸€äº›å¸®åŠ©ã€‚å‰æœŸå‡†å¤‡å·¥ä½œå¤šä¸€ç‚¹ï¼ŒåæœŸå°±å¯ä»¥å°‘èµ°ä¸€äº›å¼¯è·¯ã€‚</p>
<pre tabindex="0"><code>wget http://mirrors.aliyun.com/gnu/gcc/gcc-3.3.1/gcc-3.3.1.tar.gz
</code></pre><p>ä½¿ç”¨é˜¿é‡Œäº‘çš„<a href="https://mirrors.aliyun.com/centos-vault/"target="_blank" rel="noopener noreferrer">vaultæº</a>ï¼Œå…ˆå®‰è£…å¼€å‘ç¯å¢ƒä¾èµ–ã€‚</p>
<pre tabindex="0"><code>yum groupinstall &#34;Development Tools&#34;
</code></pre><p>ä½¿ç”¨ä¸‹åˆ—é…ç½®ï¼ŒæŒ‡å®šç‰ˆæœ¬ä¸ºi686ï¼Œæ—§ç‰ˆçš„gccï¼Œæœ€å¥½ä¸è¦å¹¶å‘ç¼–è¯‘ï¼Œå¯èƒ½ä¼šå‡ºé—®é¢˜ï¼ˆ3.3.1æ²¡æœ‰é‡åˆ°ï¼Œ3.2.2é‡åˆ°äº†ï¼‰ï¼Œç„¶ååˆ é™¤ç³»ç»Ÿè‡ªå¸¦çš„gccï¼Œå†å®‰è£…ã€‚</p>
<pre tabindex="0"><code>../gcc-3.3.1/configure --prefix=/opt/gcc_3.3.1 --infodir=/usr/share/info --enable-shared --enable-threads=posix --disable-checking --with-system-zlib --enable-__cxa_atexit --disable-libunwind-exceptions --host=i686-pc-gnu-linux --build=i686-pc-linux-gnu --target=i686-pc-linux-gnu
make -j8
yum remove gcc
make install
</code></pre><h3 id="ç¼–è¯‘-glibc-232">ç¼–è¯‘ Glibc 2.3.2</h3>
<pre tabindex="0"><code>wget http://mirrors.aliyun.com/gnu/glibc/glibc-2.3.2.tar.gz
wget http://mirrors.aliyun.com/gnu/glibc/glibc-linuxthreads-2.3.2.tar.gz
</code></pre><p>linuxthreadsè¦è§£å‹åˆ°glibcç›®å½•</p>
<pre tabindex="0"><code>tar -zxvf glibc-2.3.2.tar.gz
cd glibc-2.3.2
tar -zxvf ../glibc-linuxthreads-2.3.2.tar.gz
</code></pre><p>GCC 2.3.2ç¼–è¯‘å¯èƒ½ä¼šé‡åˆ°ä¸€äº›bugï¼Œéœ€è¦æ‰“patchï¼Œåˆšå¥½E2000å¹³å°çš„Linuxä¹Ÿæ˜¯LFSç‰ˆæœ¬ï¼Œå¯ä»¥å»è¿™é‡Œä¸‹è½½ <a href="https://www.linuxfromscratch.org/patches/downloads/glibc/"target="_blank" rel="noopener noreferrer">LFS Glibc patches</a></p>
<pre tabindex="0"><code>patch -p1 &lt; ../patches/glibc-2.3.2-sscanf-1.patch
patch -p1 &lt; ../patches/glibc-2.3.2-inlining_fixes-2.patchÂ 
patch -p1 &lt; ../patches/glibc-2.3.2-test_lfs-1.patch
</code></pre><p>æ¥ä¸‹æ¥é…ç½®ç¼–è¯‘é€‰é¡¹ï¼Œå…ˆæš‚æ—¶è¿™ä¹ˆç”¨å§ï¼Œå› ä¸ºå³ä½¿è®¾ç½®ç»†åˆ†çš„ä¼˜åŒ–é€‰é¡¹ï¼Œæœ€åçš„æ±‡ç¼–å†…å®¹éƒ½å’Œç›®æ ‡æ–‡ä»¶å·®å¼‚å¾ˆå¤§ã€‚</p>
<pre tabindex="0"><code>CC=/opt/gcc_3.3.1/bin/gcc CFLAGS=&#34;-march=pentium4 -O2&#34; ../glibc-2.3.2/configure --prefix=/lib --disable-profile --enable-add-ons --libexecdir=/usr/lib --with-headers=/usr/include
</code></pre><p>å·®å¼‚é¡¹ï¼š</p>
<ol>
<li>æ ˆå¸§ï¼šç›®æ ‡ç¨‹åºå¤§éƒ¨åˆ†çš„å‡½æ•°è¿”å›éƒ½æ˜¯ <code>0xC9 leave</code>ï¼Œè€Œæˆ‘ç¼–è¯‘çš„éƒ½æ˜¯å…ˆmove esp, ebpï¼Œç„¶åpop ebpã€‚</li>
<li>å†…é“¾å‡½æ•°ï¼šç›®æ ‡ç¨‹åºå‡½æ•°å†…éƒ¨çš„callï¼Œä¸€äº›ä¸­ç­‰é•¿åº¦çš„å‡½æ•°ï¼Œä¼šè¢«ä¼˜åŒ–æˆå†…è”å‡½æ•°ã€‚</li>
</ol>
<p>ä¸Šè¿°å†…å®¹ï¼Œå³ä½¿æˆ‘å°†ç¼–è¯‘ä¼˜åŒ–çº§åˆ«è®¾ä¸ºO3ï¼Œä¹Ÿå‡ ä¹æ²¡æœ‰å˜åŒ–ã€‚æ‰‹åŠ¨é…ç½®fomit-frame-pointerã€-finline-limit=nç­‰ä¿¡æ¯ï¼Œä¹Ÿæ²¡ç”¨ã€‚ä¹Ÿè®¸éœ€è¦æ‰‹åŠ¨è®¾ç½®__inline__å§ï¼Œæˆ‘æ²¡æ—¶é—´å»éªŒè¯ã€‚
è¿™ä¸ªæƒ…å†µï¼Œç”¨flareç”Ÿæˆsignatureï¼Œå‡ ä¹è¿˜åŸä¸äº†é‚£ç§å‡½æ•°å†…éƒ¨å¸¦æœ‰callçš„ç¬¦å·ã€‚</p>
<p>ç»è¿‡åˆ†æï¼ŒPM2008v2è¿™ä¸ªç¨‹åºï¼Œå°±æ˜¯ä¸€ä¸ªkilldiskå‡½æ•°ï¼Œé™æ€ç¼–è¯‘äº†glibcã€‚</p>
<p><img loading="lazy"  src="killdisk.png"
        alt="killdisk.png"/></p>
<p>å› æ­¤ï¼Œå¦‚æœæ‰§è¡Œinittabï¼Œæ˜¯ä¸å¯èƒ½å¯åŠ¨æ¸¸æˆçš„ã€‚</p>
<h2 id="ç³»ç»Ÿåˆå§‹åŒ–åˆ†æ">ç³»ç»Ÿåˆå§‹åŒ–åˆ†æ</h2>
<h3 id="ç½‘å‹çš„é€†å‘æˆæœ">ç½‘å‹çš„é€†å‘æˆæœ</h3>
<p>Novaä¹‹å‰å‘Šè¯‰äº†æˆ‘ä¸€äº›ä¿¡æ¯ï¼Œå®é™…ä¸Šï¼Œä»…ä»è¿™ä¸ªç¬”è®°ï¼Œæˆ‘çœ‹ä¸å‡ºå…·ä½“çš„åŠ è½½æµç¨‹ï¼Œåªèƒ½çœ‹å‡ºæ–‡ä»¶å¤´éœ€è¦è¿˜åŸï¼Œç„¶årc.0å®é™…ä¸Šæ˜¯elfæ–‡ä»¶ï¼Œå¯åŠ¨æ—¶ä¼šæ‰§è¡Œã€‚è€Œä¸”Submarine Crisisæ¸¸æˆæ–‡ä»¶å’Œæˆ‘çš„PM2008æ¸¸æˆæ–‡ä»¶åˆä¸€äº›å·®å¼‚ã€‚</p>
<p><img loading="lazy"  src="notes_for_hwtest.png"
        alt="notes_for_hwtest.png"/></p>
<p><a href="https://github.com/batteryshark/igstools/blob/main/scripts/igs_rofsv1_dumpexec.py"target="_blank" rel="noopener noreferrer">https://github.com/batteryshark/igstools/blob/main/scripts/igs_rofsv1_dumpexec.py</a></p>
<p>è¿™ä¸ªè„šæœ¬æ˜¯ç”¨äºè¿˜åŸæ¸¸æˆæ–‡ä»¶çš„ï¼Œæˆ‘å°è¯•äº†ä¸€ä¸‹ï¼Œå¯ä»¥ç”Ÿæˆä¸€ä¸ªELFï¼Œä½†æ˜¯æ”¾åˆ°IDAåˆ†æä¼šå‡ºé”™ã€‚æˆ‘å¹¶ä¸çŸ¥é“ç”Ÿæˆçš„æ–‡ä»¶è¦å¦‚ä½•è¿è¡Œã€‚å› æ­¤è¿˜æ˜¯éœ€è¦è‡ªå·±åˆ†æä¸€éã€‚</p>
<h3 id="åˆ†æå†…æ ¸å¯åŠ¨è¿‡ç¨‹">åˆ†æå†…æ ¸å¯åŠ¨è¿‡ç¨‹</h3>
<p>é€šè¿‡åˆ†æä¾èµ–å’Œå…¶ä»–ç¯å¢ƒå˜é‡ï¼Œå¹¶æ²¡æœ‰æ‰¾åˆ°ä»»ä½•èƒ½å¯åŠ¨æ¸¸æˆçš„è·¯å¾„ã€‚åœ¨ä¸Šä¸€ç¯‡æ–‡ç« ï¼Œåˆ†æäº†æ–‡ä»¶ç³»ç»ŸæŒ‚è½½ï¼Œåœ¨æŒ‚è½½ä¹‹åï¼Œè¿˜æœ‰ä¸€ç³»åˆ—æ“ä½œã€‚IDAé‡åˆ°é•¿åº¦è¿‡å¤§çš„å‡½æ•°ï¼Œå¯èƒ½å°±ä¼šå‡ºé”™ï¼Œæ— æ³•åç¼–è¯‘ã€‚ä½†æ˜¯é—®é¢˜ä¸å¤§ï¼Œéº»çƒ¦çš„ä¸åœ¨è¿™é‡Œã€‚</p>
<p><img loading="lazy"  src="call_usermodehelper.png"
        alt="call_usermodehelper.png"/></p>
<p>ä¸Šä¸€ç¯‡æ–‡ç« ç”±äºæ˜¯åˆ†æåŸºäºå¼€æºä»£ç é­”æ”¹çš„filesystemï¼Œå¯ä»¥ç›´æ¥å¯¹ç…§é€†å‘ï¼Œå› æ­¤ä¸è¿˜åŸå…¶ä»–ç¬¦å·ï¼Œé—®é¢˜ä¹Ÿä¸å¤§ã€‚è¯¥å†…æ ¸ç‰ˆæœ¬æ˜¯2.4ï¼ŒbzImageæ²¡æœ‰æºå¸¦ç¬¦å·è¡¨ã€‚è¿™é‡Œçš„ä»£ç å¾ˆå¤šæ˜¯IGSè‡ªå·±å¼€å‘çš„ï¼Œæœ‰äº›ç³»ç»Ÿè°ƒç”¨ä¸æ˜¯é€šè¿‡intæ¥è°ƒç”¨çš„ã€‚å¦‚æœæœ‰ç”¨åˆ°syscallï¼Œåœ¨ç¬¦å·æ²¡è¿˜åŸçš„æƒ…å†µä¸‹åˆ†æï¼Œè¿˜æ˜¯æœ‰ä¸€äº›éº»çƒ¦ï¼Œå¦‚æœç”¨bindiffï¼Œå°±éœ€è¦åœ¨ida 8ä¸‹ç”¨ã€‚æˆ‘æ²¡æœ‰æ—¶é—´å»ç§»æ¤åˆ°Macä¸Šã€‚Linux Kernelæœ‰ä¸€ä¸ªsyscall tableï¼Œå¦‚æœIGSæ²¡æœ‰è‡ªå®šä¹‰è¿‡syscallï¼Œé‚£ä¹ˆå¯ä»¥ç›´æ¥å°†è‡ªå·±ç¼–è¯‘çš„kernelçš„syscall ç¬¦å·ç…§æ¬è¿‡æ¥ã€‚</p>
<p>å¦å¤–ï¼ŒIDA9å¯¹è¿™ä¸ªè€çš„Linux 2.4å†…æ ¸è§£æä¸å¤ªå¥½ï¼Œå¾ˆå¤šäº¤å‰å¼•ç”¨å’Œæ±‡ç¼–æŒ‡ä»¤éƒ½æ²¡æœ‰è¯†åˆ«å‡ºæ¥ï¼Œéœ€è¦æ‰‹åŠ¨ä¿®å¤ã€‚</p>
<h3 id="ä¿®å¤ç«‹å³æ•°äº¤å‰å¼•ç”¨">ä¿®å¤ç«‹å³æ•°äº¤å‰å¼•ç”¨</h3>
<pre tabindex="0"><code>import ida_ida
import ida_bytes
import ida_ua
import idautils

def find_immediate_values_and_convert_to_offset(start_range, end_range):
    converted_count = 0
    checked_count = 0
    min_ea = ida_ida.inf_get_min_ea()
    max_ea = ida_ida.inf_get_max_ea()
    print(f&#34;EA range: 0x{start_range:X} - 0x{end_range:X}&#34;)
    print(f&#34;Immediate Value Rangeï¼š0x{min_ea:X} - 0x{max_ea:X}&#34;)

    for ea in idautils.Heads():
        if not ida_bytes.is_code(ida_bytes.get_flags(ea)):
            continue

        insn = ida_ua.insn_t()
        if ida_ua.decode_insn(insn, ea) == 0:
            continue

        if  start_range &lt;= ea and ea &lt;= end_range:
            for op_num in range(ida_ida.UA_MAXOP):
                op = insn.ops[op_num]
                if op.type == ida_ua.o_void:
                    break
                if op.type == ida_ua.o_imm:
                    imm_value = op.value
                    if op.value &gt; 0xFFFFFFFF:
                        imm_value = (0xFFFFFFFF &amp; op.value)
                    checked_count += 1
                    if min_ea &lt;= imm_value and imm_value &lt;= max_ea:
                        if idc.op_offset(ea, op_num, REF_OFF32):
                            converted_count += 1
                        else:
                            print(f&#34;  -&gt; Convert Failed: 0x{ea:X}[{op_num}]&#34;)

    print(f&#34;Immediate Value: {checked_count}, Converted: {converted_count}&#34;)
</code></pre><h3 id="ä¿®å¤å­—ç¬¦ä¸²æ•°æ®">ä¿®å¤å­—ç¬¦ä¸²æ•°æ®</h3>
<p>å¯èƒ½æ˜¯å› ä¸ºäº¤å‰å¼•ç”¨æ²¡æœ‰è¯†åˆ«å®Œå…¨ï¼Œå­—ç¬¦ä¸²è¯†åˆ«æ€»æ˜¯ä¼šé”™å¤±å‰é¢å‡ ä¸ªbytesï¼Œéœ€è¦æ‰‹åŠ¨ä¿®å¤å­—ç¬¦ä¸²ã€‚</p>
<pre tabindex="0"><code>def get_the_firsstr_ea(ea):
    addr = ea - 1
    last_byte = ida_bytes.get_byte(addr)
    if 32 &lt; last_byte and last_byte &lt; 127:
        ea = get_the_firsstr_ea(addr)
    return ea

def find_str_address(start_ea, end_ea):
    current_ea = start_ea
    found_count = 0
    while current_ea &lt; end_ea:
        if current_ea == ida_idaapi.BADADDR:
            break
        address_flags = ida_bytes.get_flags(current_ea)
        if ida_bytes.is_strlit(address_flags):
            str_size = ida_bytes.get_item_size(current_ea)
            the_first_str_addr = get_the_firsstr_ea(current_ea)
            if the_first_str_addr != current_ea:
                len = current_ea - the_first_str_addr + str_size
                ida_bytes.create_strlit(the_first_str_addr, len, 0)
                print(f&#34;Fix str at 0x{current_ea:X}, before: {str_size}, after: {len}&#34;)
        current_ea += ida_bytes.get_item_size(current_ea)
        continue
</code></pre><h3 id="kernel-thread">Kernel Thread</h3>
<p><img loading="lazy"  src="call_usermodehelper1.png"
        alt="call_usermodehelper1.png"/></p>
<p>æ ¹æ®ä¸Šå›¾ä»£ç ï¼Œå¯ä»¥å¾—çŸ¥æ¸¸æˆåˆå§‹åŒ–çš„ç¬¬ä¸€æ­¥æ˜¯å…ˆè¿è¡Œ/bin/zshï¼Œå¹¶ä¸”æºå¸¦è¿™äº›å‚æ•°ã€‚</p>
<pre tabindex="0"><code>export HOME=/
export TERM=linux
export PATH=/bin:/usr/bin:/sbin:/usr/sbin
/bin/zsh /etc/rc.d/rc0.d __KERNEL__ -no-print -PM2008v2
</code></pre><p>ä¸‹ä¸€æ­¥å°±æ˜¯è¿è¡Œ/mnt/GECAæ–‡ä»¶</p>
<pre tabindex="0"><code>export HOME=/
export TERM=linux
export PATH=/bin:/usr/bin:/sbin:/usr/sbin
/mnt/GECA /etc/rc.d/rc0.d __KERNEL__ -no-print -PM2008v2
</code></pre><p>æœ€åè¿è¡Œè¿™äº›</p>
<pre tabindex="0"><code>if ( execute_command )
      run_init_process((const char *)execute_command);
run_init_process(&#34;/sbin/init&#34;); // å­˜åœ¨
run_init_process(&#34;/etc/init&#34;);  // ä¸å­˜åœ¨
run_init_process(&#34;/bin/init&#34;);  // ä¸å­˜åœ¨
run_init_process(&#34;/bin/sh&#34;);    // æŒ‡å‘bash
</code></pre><p>Kernel Cmdlineå¯ä»¥åœ¨parse_cmdline_earlyæ‰¾åˆ°ï¼Œå¹¶éLILOæ§åˆ¶ã€‚</p>
<p>å¦‚æœä»å¤–éƒ¨è®¾ç½®äº†bootcmdlineï¼Œå…¶ä¸­æœ‰ä¸€ä¸ªæš—æ¡©ï¼Œä¼šæ£€æµ‹bootloaderå‚æ•°æ˜¯å¦ç­‰äºâ€JBootâ€œï¼Œå¦‚æœä¸ç­‰äºï¼Œå°±è¿›å…¥æ­»å¾ªç¯ã€‚</p>
<p><img loading="lazy"  src="jboot.png"
        alt="jboot.png"/></p>
<p>è¿™ä¸ªJBootæ˜¯ä¸æ˜¯ä»£è¡¨Jameså†™çš„Bootloaderï¼ŸğŸ‘€</p>
<pre tabindex="0"><code>bootloader=JBoot
</code></pre><p>å†…æ ¸è‡ªå¸¦çš„å¯åŠ¨å‘½ä»¤</p>
<pre tabindex="0"><code>root=/dev/hdc2 ro console=ttyS1,115200 BOOT_IMAGE=PM2008v2
</code></pre><p>å¹¶æ²¡æœ‰è®¾ç½®init=ï¼Œå› æ­¤è‚¯å®šä¼šæ‰§è¡Œ/sbin/initï¼Œç„¶åæ‰§è¡Œ/etc/inittab</p>
<h3 id="æ¢å¤zshç¬¦å·å—é˜»">æ¢å¤ZSHç¬¦å·å—é˜»</h3>
<p>çº¿ç´¢åˆ°äº†/bin/zshï¼Œè¿™ä¸ªç¨‹åºå…¥å£å’ŒPM2008v2ä¸€æ ·ï¼Œæˆ‘åˆ¤æ–­ä¹Ÿæ˜¯åŸºäºglibcæ”¹çš„ï¼Œä½†æ˜¯æˆ‘å¯¼å…¥FLIRT Signatureï¼Œåªèƒ½è¯†åˆ«å‡ºæœ€é‡Œå±‚çš„å‡½æ•°ï¼Œè¿˜æ˜¯é‚£ä¸ªç¼–è¯‘ä¼˜åŒ–çš„åŸå› ã€‚</p>
<pre tabindex="0"><code>/Applications/IDA\ Professional\ 9.1.app/Contents/MacOS/tools/flair/sigmake ~/RE/igs/libc.pat ~/RE/igs/libc2.3.2.o2.sig
/Applications/IDA\ Professional\ 9.1.app/Contents/MacOS/tools/flair/pelf ~/RE/igs/libc.a ~/RE/igs/libc.pat
</code></pre><p><img loading="lazy"  src="zsh.png"
        alt="zsh.png"/></p>
<p>ç›®å‰ä¸çŸ¥é“åˆ°åº•æ˜¯åŸºäºä»€ä¹ˆGCCå’ŒGLibcæ”¹çš„ï¼Œè€ƒè™‘åˆ°åé¢å¯èƒ½æœ‰å¾ˆå¤šç¨‹åºä¹Ÿä¼šç”¨åˆ°glibcï¼Œæ‰€ä»¥éœ€è¦ç¡®å®šæ˜¯ä»€ä¹ˆç‰ˆæœ¬ï¼Œçœ‹çœ‹æœ‰æ²¡æœ‰å¿«é€Ÿæ¢å¤ç¬¦å·çš„åŠæ³•ã€‚</p>
<h4 id="ä¾èµ–å…³ç³»åˆ†æ">ä¾èµ–å…³ç³»åˆ†æ</h4>
<p>ä½¿ç”¨æˆ‘äº”å¹´å‰å¼€å‘çš„YAFAFï¼Œå¯ä»¥å¾ˆå¿«æ‰¾åˆ°ç›¸å…³çš„ä¾èµ–å…³ç³»ã€‚rc*.dåº”è¯¥æ˜¯æ¸¸æˆçš„ä»£ç ã€‚</p>
<p><img loading="lazy"  src="gcc_glibc.png"
        alt="gcc_glibc.png"/>
rc0.d</p>
<pre tabindex="0"><code>GLIBC_2.1
GLIBC_2.0
GCC: (GNU) 3.2.2 20030222 (Red Hat Linux 3.2.2-5)
</code></pre><p>rc2.d</p>
<pre tabindex="0"><code>GCC_3.0
GLIBC_2.0
GLIBC_2.1
GLIBC_2.2.3
GLIBC_2.1.3
GLIBC_2.3
GLIBC_2.2
GLIBC_2.3.2
GLIBC_2.0
GLIBC_2.1
GLIBCPP_3.2
GLIBC_2.2
GLIBC_2.1.3
GLIBC_2.3
GLIBC_2.3.2
</code></pre><p>rc9</p>
<pre tabindex="0"><code>GCC: (GNU) 3.3.1
GCC: (GNU) 3.2.1 20021207 (Red Hat Linux 8.0 3.2.1-2)
GCC: (GNU) 3.2.1 20030202 (Red Hat Linux 8.0 3.2.1-7)
GCC: (GNU) 3.2.2 20030222 (Red Hat Linux 3.2.2-4)
GCC: (GNU) 3.2.2 20030222 (Red Hat Linux 3.2.2-5)
</code></pre><p>ä»è¿™äº›ç‰¹å¾æ¥çœ‹ï¼Œè¿™å‡ ä¸ªæ–‡ä»¶ï¼Œåº”è¯¥æ˜¯å¤šä¸ªä¸åŒç¯å¢ƒç¼–è¯‘çš„elfæ–‡ä»¶çš„ç¢ç‰‡æ„æˆã€‚</p>
<p>å¹¶ä¸”/sbin/initä¹Ÿæ˜¯åŸºäºglibc2.3.Xï¼Œæ‰€ä»¥ç”¨gcc3.2.2ç¼–è¯‘glibc2.3.2å§ï¼ŒåŸºäºcentos3ï¼Œç¼–è¯‘è¿™ä¸€ç‰ˆGCCï¼Œä¸èƒ½ç”¨å¹¶å‘ï¼Œå¦åˆ™ä¼šå‡ºé”™ã€‚è¿˜å¥½æˆ‘ä»¥å‰ç¼–è¯‘openwrté‡åˆ°è¿‡ç±»ä¼¼é”™è¯¯ï¼Œä¸ç„¶åˆè¦å¡å¾ˆä¹…ï¼Œæœéƒ½æœä¸åˆ°æ˜¯å•¥åŸå› ã€‚</p>
<pre tabindex="0"><code>../gcc-3.2.2/configure --prefix=/opt/gcc_3.2.2 --infodir=/usr/share/info --enable-shared --enable-threads=posix --disable-checking --with-system-zlib --enable-__cxa_atexit

make
make install
</code></pre><p>ç¼–è¯‘GLibcï¼Œä¸ç®¡æ˜¯ç”¨O2è¿˜æ˜¯O3ï¼Œæœ€åå‡ ä¹éƒ½æ²¡æœ‰å†…è”å‡½æ•°ä¼˜åŒ–ã€‚ç›®å‰è¿˜æä¸æ˜ç™½æ˜¯ä»€ä¹ˆåŸå› ï¼Œä¹Ÿæœä¸åˆ°ï¼Œé—®AIä¹Ÿæ²¡ç”¨ã€‚</p>
<pre tabindex="0"><code>CC=/opt/gcc_3.2.2/bin/gcc CFLAGS=&#34;-march=pentium4 -O2&#34; ../glibc-2.3.2/configure --prefix=/lib --disable-profile --enable-add-ons --libexecdir=/usr/lib --with-headers=/usr/include
CC=/opt/gcc_3.2.2/bin/gcc CFLAGS=&#34;-O3&#34; ../glibc-2.3.2/configure --prefix=/lib --disable-profile --enable-add-ons --libexecdir=/usr/lib --with-headers=/usr/include
</code></pre><h3 id="æ¢å¤åˆ†æ-zsh-ç¬¦å·">æ¢å¤åˆ†æ ZSH ç¬¦å·</h3>
<p>æˆ‘ä¸å–œæ¬¢åšæœºæ¢°è€Œé‡å¤çš„å·¥ä½œï¼Œå¦‚æœè¦æˆ‘ç›´æ¥é€†å‘zshï¼Œæˆ‘ä¼šè§‰å¾—éå¸¸æ— èŠã€‚
è¿™ä¸ªç‰ˆæœ¬idaå¯¹è¯†åˆ«instrumentsä¸æ˜¯å¤ªå¥½ï¼Œå¾ˆå¤šåœ°æ–¹éœ€è¦æ‰‹åŠ¨æ¢å¤ã€‚ç”¨ä¸‹å›¾è„šæœ¬æ¢å¤å®Œåï¼Œä¸‹ä¸€æ­¥å°±æ˜¯æ¢å¤function entryï¼Œåœ¨æˆ‘ä¸Šä¸€ç¯‡æ–‡ç« æœ‰ç±»ä¼¼çš„è„šæœ¬ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">find_and_make_instrument</span><span class="p">(</span><span class="n">start_ea</span><span class="p">,</span> <span class="n">end_ea</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">image_base</span> <span class="o">=</span> <span class="n">idaapi</span><span class="o">.</span><span class="n">get_imagebase</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">current_ea</span> <span class="o">=</span> <span class="n">start_ea</span>
</span></span><span class="line"><span class="cl">    <span class="n">found_count</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="n">current_ea</span> <span class="o">&lt;</span> <span class="n">end_ea</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">current_ea</span> <span class="o">==</span> <span class="n">ida_idaapi</span><span class="o">.</span><span class="n">BADADDR</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span>
</span></span><span class="line"><span class="cl">        <span class="n">address_flags</span> <span class="o">=</span> <span class="n">ida_bytes</span><span class="o">.</span><span class="n">get_flags</span><span class="p">(</span><span class="n">current_ea</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">ida_bytes</span><span class="o">.</span><span class="n">is_code</span><span class="p">(</span><span class="n">address_flags</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">current_ea</span> <span class="o">+=</span> <span class="n">ida_bytes</span><span class="o">.</span><span class="n">get_item_size</span><span class="p">(</span><span class="n">current_ea</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">continue</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">ida_bytes</span><span class="o">.</span><span class="n">del_items</span><span class="p">(</span><span class="mh">0x8052606</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">ida_ua</span><span class="o">.</span><span class="n">can_decode</span><span class="p">(</span><span class="n">current_ea</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;Decode instruments at 0x</span><span class="si">{:X}</span><span class="s2">&#34;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">current_ea</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                <span class="n">insn_size</span> <span class="o">=</span> <span class="n">ida_ua</span><span class="o">.</span><span class="n">decode_insn</span><span class="p">(</span><span class="n">ida_ua</span><span class="o">.</span><span class="n">insn_t</span><span class="p">(),</span> <span class="n">current_ea</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">ida_bytes</span><span class="o">.</span><span class="n">del_items</span><span class="p">(</span><span class="n">current_ea</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">insn_size</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">offset</span> <span class="o">=</span> <span class="n">ida_ua</span><span class="o">.</span><span class="n">create_insn</span><span class="p">(</span><span class="n">current_ea</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">offset</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">found_count</span> <span class="o">+=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="n">idc</span><span class="o">.</span><span class="n">get_func_flags</span><span class="p">(</span><span class="n">current_ea</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                        <span class="n">current_ea</span> <span class="o">+=</span> <span class="n">offset</span>
</span></span><span class="line"><span class="cl">                        <span class="k">continue</span>
</span></span><span class="line"><span class="cl">                <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;Decode instruments failed at 0x</span><span class="si">{:X}</span><span class="s2">&#34;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">current_ea</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                    <span class="k">return</span>
</span></span><span class="line"><span class="cl">            <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;Create instruments failed at 0x</span><span class="si">{:X}</span><span class="s2">&#34;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">current_ea</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                <span class="n">current_ea</span> <span class="o">+=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">                <span class="k">continue</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;Search finished, </span><span class="si">{}</span><span class="s2"> instruments created&#34;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">found_count</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">find_and_make_instrument</span><span class="p">(</span><span class="mh">0x080480B4</span><span class="p">,</span> <span class="mh">0x0808F000</span><span class="p">)</span>
</span></span></code></pre></div><p>å› ä¸ºæ²¡æœ‰åŠæ³•ç”¨glibcçš„signatureï¼Œæˆ‘æƒ³äº†ä¸€ä¸ªæ¯”è¾ƒå‚»çš„åŠæ³•ï¼Œä½†æ˜¯é€Ÿåº¦æ¯”è°ƒç”¨MCPåˆ†æè¦å¿«ã€‚</p>
<p>å…ˆæŠŠæ–‡ä»¶Aï¼ˆè‡ªå·±ç¼–è¯‘çš„ï¼‰çš„glibcå­—ç¬¦ä¸²å®Œå…¨æ¢å¤ï¼Œæ¢å¤å‡½æ•°å…¥å£ã€‚
åœ¨æ–‡ä»¶Bï¼Œå…ˆä¿®å¤å‡½æ•°å…¥å£ï¼Œä¿®å¤ç«‹å³æ•°åç§»ï¼Œä¿®å¤å­—ç¬¦ä¸²ï¼Œå»é‡ï¼Œå»é™¤è¿‡çŸ­å­—ç¬¦ä¸²ï¼Œç„¶åé€ä¸ªåŒ¹é…æ–‡ä»¶Açš„å­—ç¬¦ä¸²ï¼Œå¹¶ç­›é€‰ã€‚
ä»ç­›é€‰ç»“æœéå†äº¤å‰å¼•ç”¨ï¼Œå°†ä¸é‡å¤ä¸”ä¸ºå‡½æ•°çš„ç­›é€‰å‡ºæ¥ã€‚</p>
<ol>
<li>å¦‚æœæ–‡ä»¶Açš„è¿™äº›å‡½æ•°æœ‰ç¬¦å·ï¼Œå°±æ¢å¤åˆ°æ–‡ä»¶Bï¼›</li>
<li>å­—ç¬¦ä¸²ä½œä¸ºå‚æ•°å…¥æ ˆçš„å‡½æ•°ï¼Œæ‰¾åˆ°å½“å‰å‡½æ•°ç©ºé—´çš„æ‰€æœ‰callï¼Œå¦‚æœç›®æ ‡åœ°å€æ²¡æœ‰ç¬¦å·ï¼Œä¹Ÿç”¨è¿™ä¸ªåŠæ³•å»è¿˜åŸå…¥æ ˆçš„å‡½æ•°ç¬¦å·ã€‚</li>
<li>é€’å½’è®¾ç½®ç¬¦å·ï¼Œæ¯”å¦‚æ¢å¤äº†è¿™ä¸ªcallçš„å‡½æ•°ï¼Œç„¶åå†å»callå‡½æ•°å†…éƒ¨å¯»æ‰¾å…¶ä»–çš„å‡½æ•°ã€‚è¿™ä¸ªæ„Ÿè§‰æ²¡ä»€ä¹ˆå¿…è¦ï¼Œå› ä¸ºä¼šé‡åˆ°å¾ˆå¤šæƒ…å†µã€‚</li>
</ol>
<h4 id="ida-pro-è„šæœ¬ä»ç›®æ ‡aæå–å­—ç¬¦ä¸²å’Œå‡½æ•°äº¤å‰å¼•ç”¨">IDA Pro è„šæœ¬ï¼Œä»ç›®æ ‡Aæå–å­—ç¬¦ä¸²å’Œå‡½æ•°äº¤å‰å¼•ç”¨</h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="ch">#!/usr/bin/env python3</span>
</span></span><span class="line"><span class="cl"><span class="c1"># -*- coding: utf-8 -*-</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">json</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">ida_funcs</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">ida_name</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">ida_bytes</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">ida_xref</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">ida_idaapi</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">ida_ua</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">ida_segment</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">idautils</span>
</span></span><span class="line"><span class="cl"><span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="kn">import</span> <span class="nn">ida_allins</span>
</span></span><span class="line"><span class="cl">    <span class="n">HAS_ALLINS</span> <span class="o">=</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl"><span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">HAS_ALLINS</span> <span class="o">=</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">find_target_function</span><span class="p">(</span><span class="n">xref_ea</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">insn</span> <span class="o">=</span> <span class="n">ida_ua</span><span class="o">.</span><span class="n">insn_t</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="ow">not</span> <span class="n">ida_ua</span><span class="o">.</span><span class="n">decode_insn</span><span class="p">(</span><span class="n">insn</span><span class="p">,</span> <span class="n">xref_ea</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">    <span class="n">current_func</span> <span class="o">=</span> <span class="n">ida_funcs</span><span class="o">.</span><span class="n">get_func</span><span class="p">(</span><span class="n">xref_ea</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">search_ea</span> <span class="o">=</span> <span class="n">xref_ea</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="n">search_ea</span> <span class="o">&lt;</span> <span class="n">current_func</span><span class="o">.</span><span class="n">end_ea</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">search_ea</span> <span class="o">=</span> <span class="n">ida_bytes</span><span class="o">.</span><span class="n">next_head</span><span class="p">(</span><span class="n">search_ea</span><span class="p">,</span> <span class="n">ida_idaapi</span><span class="o">.</span><span class="n">BADADDR</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">search_ea</span> <span class="o">==</span> <span class="n">ida_idaapi</span><span class="o">.</span><span class="n">BADADDR</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="n">ida_ua</span><span class="o">.</span><span class="n">decode_insn</span><span class="p">(</span><span class="n">insn</span><span class="p">,</span> <span class="n">search_ea</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="k">continue</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">insn</span><span class="o">.</span><span class="n">itype</span> <span class="ow">in</span> <span class="p">[</span><span class="n">ida_allins</span><span class="o">.</span><span class="n">NN_call</span><span class="p">,</span> <span class="n">ida_allins</span><span class="o">.</span><span class="n">NN_callfi</span><span class="p">,</span> <span class="n">ida_allins</span><span class="o">.</span><span class="n">NN_callni</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">            <span class="n">target_ea</span> <span class="o">=</span> <span class="n">insn</span><span class="o">.</span><span class="n">ops</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">addr</span> <span class="k">if</span> <span class="n">insn</span><span class="o">.</span><span class="n">ops</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">ida_ua</span><span class="o">.</span><span class="n">o_near</span> <span class="k">else</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">target_ea</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">target_func_name</span> <span class="o">=</span> <span class="n">ida_name</span><span class="o">.</span><span class="n">get_name</span><span class="p">(</span><span class="n">target_ea</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">target_func_name</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="k">return</span> <span class="n">target_func_name</span>
</span></span><span class="line"><span class="cl">                <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">func</span> <span class="o">=</span> <span class="n">ida_funcs</span><span class="o">.</span><span class="n">get_func</span><span class="p">(</span><span class="n">target_ea</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="n">func</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                        <span class="k">return</span> <span class="n">ida_funcs</span><span class="o">.</span><span class="n">get_func_name</span><span class="p">(</span><span class="n">func</span><span class="o">.</span><span class="n">start_ea</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">get_string_xrefs_with_functions</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">    è·å–IDAProä¸­æ‰€æœ‰å­—ç¬¦ä¸²åŠå…¶äº¤å‰å¼•ç”¨ä¿¡æ¯
</span></span></span><span class="line"><span class="cl"><span class="s2">    è¿”å›JSONæ ¼å¼æ•°æ®ï¼ŒåŒ…å«å­—ç¬¦ä¸²åœ°å€ã€å†…å®¹ã€é•¿åº¦å’Œå¼•ç”¨å®ƒçš„å‡½æ•°å
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># åˆå§‹åŒ–å­—ç¬¦ä¸²åˆ—è¡¨</span>
</span></span><span class="line"><span class="cl">    <span class="n">strings</span> <span class="o">=</span> <span class="n">idautils</span><span class="o">.</span><span class="n">Strings</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">strings</span><span class="o">.</span><span class="n">setup</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;[+] å¼€å§‹æ‰«æå­—ç¬¦ä¸²...&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">string_item</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">strings</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># è·å–å­—ç¬¦ä¸²åŸºæœ¬ä¿¡æ¯</span>
</span></span><span class="line"><span class="cl">        <span class="n">str_ea</span> <span class="o">=</span> <span class="n">string_item</span><span class="o">.</span><span class="n">ea</span>
</span></span><span class="line"><span class="cl">        <span class="n">str_length</span> <span class="o">=</span> <span class="n">string_item</span><span class="o">.</span><span class="n">length</span>
</span></span><span class="line"><span class="cl">        <span class="n">str_type</span> <span class="o">=</span> <span class="n">string_item</span><span class="o">.</span><span class="n">strtype</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># è·å–å­—ç¬¦ä¸²å†…å®¹</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">str_content</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">string_item</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">except</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">str_content</span> <span class="o">=</span> <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># è·å–æ®µä¿¡æ¯</span>
</span></span><span class="line"><span class="cl">        <span class="n">seg</span> <span class="o">=</span> <span class="n">ida_segment</span><span class="o">.</span><span class="n">getseg</span><span class="p">(</span><span class="n">str_ea</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">seg</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">seg_start</span> <span class="o">=</span> <span class="n">seg</span><span class="o">.</span><span class="n">start_ea</span>
</span></span><span class="line"><span class="cl">            <span class="n">seg_name</span> <span class="o">=</span> <span class="n">ida_segment</span><span class="o">.</span><span class="n">get_segm_name</span><span class="p">(</span><span class="n">seg</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="ow">not</span> <span class="n">seg_name</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">seg_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&#34;seg_</span><span class="si">{</span><span class="n">seg_start</span><span class="si">:</span><span class="s2">08X</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">seg_start</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">            <span class="n">seg_name</span> <span class="o">=</span> <span class="s2">&#34;unknown&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># æ”¶é›†æ‰€æœ‰å¼•ç”¨è¯¥å­—ç¬¦ä¸²çš„åœ°å€</span>
</span></span><span class="line"><span class="cl">        <span class="n">xref_functions</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># è·å–æ®µä¿¡æ¯</span>
</span></span><span class="line"><span class="cl">        <span class="n">seg</span> <span class="o">=</span> <span class="n">ida_segment</span><span class="o">.</span><span class="n">getseg</span><span class="p">(</span><span class="n">str_ea</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">seg</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">seg_start</span> <span class="o">=</span> <span class="n">seg</span><span class="o">.</span><span class="n">start_ea</span>
</span></span><span class="line"><span class="cl">            <span class="n">seg_name</span> <span class="o">=</span> <span class="n">ida_segment</span><span class="o">.</span><span class="n">get_segm_name</span><span class="p">(</span><span class="n">seg</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="ow">not</span> <span class="n">seg_name</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">seg_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&#34;seg_</span><span class="si">{</span><span class="n">seg_start</span><span class="si">:</span><span class="s2">08X</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">seg_start</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">            <span class="n">seg_name</span> <span class="o">=</span> <span class="s2">&#34;unknown&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">target_functions</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># å­˜å‚¨ç›®æ ‡å‡½æ•°å</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># ä½¿ç”¨XrefsToè·å–æ‰€æœ‰å¼•ç”¨</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">xref</span> <span class="ow">in</span> <span class="n">idautils</span><span class="o">.</span><span class="n">XrefsTo</span><span class="p">(</span><span class="n">str_ea</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">xref_ea</span> <span class="o">=</span> <span class="n">xref</span><span class="o">.</span><span class="n">frm</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1"># è·å–å¼•ç”¨åœ°å€æ‰€åœ¨çš„å‡½æ•°</span>
</span></span><span class="line"><span class="cl">            <span class="n">func</span> <span class="o">=</span> <span class="n">ida_funcs</span><span class="o">.</span><span class="n">get_func</span><span class="p">(</span><span class="n">xref_ea</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">func</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="c1"># è·å–å‡½æ•°å</span>
</span></span><span class="line"><span class="cl">                <span class="n">func_name</span> <span class="o">=</span> <span class="n">ida_funcs</span><span class="o">.</span><span class="n">get_func_name</span><span class="p">(</span><span class="n">func</span><span class="o">.</span><span class="n">start_ea</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">func_name</span> <span class="ow">and</span> <span class="n">func_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">xref_functions</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">xref_functions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">func_name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                
</span></span><span class="line"><span class="cl">                <span class="c1"># åˆ†æç›®æ ‡å‡½æ•°</span>
</span></span><span class="line"><span class="cl">                <span class="n">target_func</span> <span class="o">=</span> <span class="n">find_target_function</span><span class="p">(</span><span class="n">xref_ea</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">target_func</span> <span class="ow">and</span> <span class="n">target_func</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">target_functions</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">target_functions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">target_func</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># else:</span>
</span></span><span class="line"><span class="cl">            <span class="c1">#     # å¦‚æœä¸åœ¨å‡½æ•°ä¸­ï¼Œå°è¯•è·å–è¯¥åœ°å€çš„åç§°</span>
</span></span><span class="line"><span class="cl">            <span class="c1">#     name = ida_name.get_name(xref_ea)</span>
</span></span><span class="line"><span class="cl">            <span class="c1">#     if name and name not in xref_functions:</span>
</span></span><span class="line"><span class="cl">            <span class="c1">#         xref_functions.append(f&#34;@{name}&#34;)</span>
</span></span><span class="line"><span class="cl">            <span class="c1">#     else:</span>
</span></span><span class="line"><span class="cl">            <span class="c1">#         # å¦‚æœæ²¡æœ‰åç§°ï¼Œä½¿ç”¨åœ°å€</span>
</span></span><span class="line"><span class="cl">            <span class="c1">#         addr_name = f&#34;addr_0x{xref_ea:X}&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="c1">#         if addr_name not in xref_functions:</span>
</span></span><span class="line"><span class="cl">            <span class="c1">#             xref_functions.append(addr_name)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># æ·»åŠ æ•°æ®å¼•ç”¨</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># for xref_ea in idautils.DataRefsTo(str_ea):</span>
</span></span><span class="line"><span class="cl">        <span class="c1">#     func = ida_funcs.get_func(xref_ea)</span>
</span></span><span class="line"><span class="cl">        <span class="c1">#     if func:</span>
</span></span><span class="line"><span class="cl">        <span class="c1">#         func_name = ida_funcs.get_func_name(func.start_ea)</span>
</span></span><span class="line"><span class="cl">        <span class="c1">#         if func_name and func_name not in xref_functions:</span>
</span></span><span class="line"><span class="cl">        <span class="c1">#             xref_functions.append(func_name)</span>
</span></span><span class="line"><span class="cl">                
</span></span><span class="line"><span class="cl">        <span class="c1">#         # åˆ†æç›®æ ‡å‡½æ•°</span>
</span></span><span class="line"><span class="cl">        <span class="c1">#         target_func = find_target_function(xref_ea)</span>
</span></span><span class="line"><span class="cl">        <span class="c1">#         if target_func and target_func not in target_functions:</span>
</span></span><span class="line"><span class="cl">        <span class="c1">#             target_functions.append(target_func)</span>
</span></span><span class="line"><span class="cl">        <span class="c1">#     else:</span>
</span></span><span class="line"><span class="cl">        <span class="c1">#         name = ida_name.get_name(xref_ea)</span>
</span></span><span class="line"><span class="cl">        <span class="c1">#         if name and name not in xref_functions:</span>
</span></span><span class="line"><span class="cl">        <span class="c1">#             xref_functions.append(f&#34;@{name}&#34;)</span>
</span></span><span class="line"><span class="cl">        <span class="c1">#         else:</span>
</span></span><span class="line"><span class="cl">        <span class="c1">#             addr_name = f&#34;addr_0x{xref_ea:X}&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="c1">#             if addr_name not in xref_functions:</span>
</span></span><span class="line"><span class="cl">        <span class="c1">#                 xref_functions.append(addr_name)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># åˆ›å»ºç»“æœæ¡ç›®</span>
</span></span><span class="line"><span class="cl">        <span class="n">string_info</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;ea&#34;</span><span class="p">:</span> <span class="n">str_ea</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;str&#34;</span><span class="p">:</span> <span class="n">str_content</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;len&#34;</span><span class="p">:</span> <span class="n">str_length</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;seg_addr&#34;</span><span class="p">:</span> <span class="n">seg_start</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;seg_name&#34;</span><span class="p">:</span> <span class="n">seg_name</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;xrefs&#34;</span><span class="p">:</span> <span class="n">xref_functions</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;target_func_name&#34;</span><span class="p">:</span> <span class="n">target_functions</span>  <span class="c1"># æ–°å¢å­—æ®µ</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">string_info</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="mi">100</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;[+] å·²å¤„ç† </span><span class="si">{</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="si">}</span><span class="s2"> ä¸ªå­—ç¬¦ä¸²...&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;[+] æ€»å…±æ‰¾åˆ° </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span><span class="si">}</span><span class="s2"> ä¸ªå­—ç¬¦ä¸²&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">results</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># è·å–å¹¶ä¿å­˜å­—ç¬¦ä¸²ä¿¡æ¯</span>
</span></span><span class="line"><span class="cl">    <span class="n">strings_data</span> <span class="o">=</span> <span class="n">get_string_xrefs_with_functions</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">unique_data</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">string_info</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">strings_data</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">duplicated</span> <span class="o">=</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">string_info</span><span class="p">[</span><span class="s1">&#39;str&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">10</span> <span class="ow">and</span> <span class="n">string_info</span><span class="p">[</span><span class="s1">&#39;seg_name&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;.rodata&#39;</span> <span class="ow">and</span> <span class="n">string_info</span><span class="p">[</span><span class="s1">&#39;xrefs&#39;</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">string_info1</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">strings_data</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">string_info1</span><span class="p">[</span><span class="s1">&#39;str&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">string_info</span><span class="p">[</span><span class="s1">&#39;str&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">string_info</span><span class="p">[</span><span class="s1">&#39;ea&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">string_info1</span><span class="p">[</span><span class="s1">&#39;ea&#39;</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;</span><span class="se">\n</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">. é‡å¤å†…å®¹åœ°å€: 0x</span><span class="si">{</span><span class="n">string_info</span><span class="p">[</span><span class="s1">&#39;ea&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">08X</span><span class="si">}</span><span class="s2"> 0x</span><span class="si">{</span><span class="n">string_info1</span><span class="p">[</span><span class="s1">&#39;ea&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">08X</span><span class="si">}</span><span class="s2">  å­—ç¬¦ä¸²: </span><span class="si">{</span><span class="nb">repr</span><span class="p">(</span><span class="n">string_info1</span><span class="p">[</span><span class="s1">&#39;str&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="n">duplicated</span> <span class="o">=</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">                    <span class="k">break</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="ow">not</span> <span class="n">duplicated</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">unique_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">string_info</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                
</span></span><span class="line"><span class="cl">    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&#34;strings_with_xrefs.json&#34;</span><span class="p">,</span> <span class="s2">&#34;w&#34;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">unique_data</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">[+] åˆ†æå®Œæˆ! æ€»å…±å‘ç° </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">unique_data</span><span class="p">)</span><span class="si">}</span><span class="s2"> ä¸ªå­—ç¬¦ä¸²&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&#34;__main__&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">main</span><span class="p">()</span>
</span></span></code></pre></div><h4 id="ida-pro-è„šæœ¬å°†aåˆ°äº¤å‰å¼•ç”¨ç¬¦å·åŠ è½½åˆ°b">IDA Pro è„šæœ¬ï¼Œå°†Aåˆ°äº¤å‰å¼•ç”¨ç¬¦å·åŠ è½½åˆ°B</h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="ch">#!/usr/bin/env python</span>
</span></span><span class="line"><span class="cl"><span class="c1"># -*- coding: utf-8 -*-</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">json</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">ida_bytes</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">ida_name</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">ida_funcs</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">ida_xref</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">ida_kernwin</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">ida_segment</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">idautils</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">ida_idaapi</span>
</span></span><span class="line"><span class="cl"><span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="kn">import</span> <span class="nn">ida_allins</span>
</span></span><span class="line"><span class="cl">    <span class="n">HAS_ALLINS</span> <span class="o">=</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl"><span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">HAS_ALLINS</span> <span class="o">=</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">find_target_function</span><span class="p">(</span><span class="n">xref_ea</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">insn</span> <span class="o">=</span> <span class="n">ida_ua</span><span class="o">.</span><span class="n">insn_t</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="ow">not</span> <span class="n">ida_ua</span><span class="o">.</span><span class="n">decode_insn</span><span class="p">(</span><span class="n">insn</span><span class="p">,</span> <span class="n">xref_ea</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">    <span class="n">current_func</span> <span class="o">=</span> <span class="n">ida_funcs</span><span class="o">.</span><span class="n">get_func</span><span class="p">(</span><span class="n">xref_ea</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">search_ea</span> <span class="o">=</span> <span class="n">xref_ea</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="n">search_ea</span> <span class="o">&lt;</span> <span class="n">current_func</span><span class="o">.</span><span class="n">end_ea</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">search_ea</span> <span class="o">=</span> <span class="n">ida_bytes</span><span class="o">.</span><span class="n">next_head</span><span class="p">(</span><span class="n">search_ea</span><span class="p">,</span> <span class="n">ida_idaapi</span><span class="o">.</span><span class="n">BADADDR</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">search_ea</span> <span class="o">==</span> <span class="n">ida_idaapi</span><span class="o">.</span><span class="n">BADADDR</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="n">ida_ua</span><span class="o">.</span><span class="n">decode_insn</span><span class="p">(</span><span class="n">insn</span><span class="p">,</span> <span class="n">search_ea</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="k">continue</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">insn</span><span class="o">.</span><span class="n">itype</span> <span class="ow">in</span> <span class="p">[</span><span class="n">ida_allins</span><span class="o">.</span><span class="n">NN_call</span><span class="p">,</span> <span class="n">ida_allins</span><span class="o">.</span><span class="n">NN_callfi</span><span class="p">,</span> <span class="n">ida_allins</span><span class="o">.</span><span class="n">NN_callni</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">            <span class="n">target_ea</span> <span class="o">=</span> <span class="n">insn</span><span class="o">.</span><span class="n">ops</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">addr</span> <span class="k">if</span> <span class="n">insn</span><span class="o">.</span><span class="n">ops</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">ida_ua</span><span class="o">.</span><span class="n">o_near</span> <span class="k">else</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">target_ea</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">target_func_name</span> <span class="o">=</span> <span class="n">ida_name</span><span class="o">.</span><span class="n">get_name</span><span class="p">(</span><span class="n">target_ea</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">target_func_name</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="k">return</span> <span class="n">target_func_name</span><span class="p">,</span> <span class="n">target_ea</span>
</span></span><span class="line"><span class="cl">                <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">func</span> <span class="o">=</span> <span class="n">ida_funcs</span><span class="o">.</span><span class="n">get_func</span><span class="p">(</span><span class="n">target_ea</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="n">func</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                        <span class="k">return</span> <span class="n">ida_funcs</span><span class="o">.</span><span class="n">get_func_name</span><span class="p">(</span><span class="n">func</span><span class="o">.</span><span class="n">start_ea</span><span class="p">),</span> <span class="n">func</span><span class="o">.</span><span class="n">start_ea</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">                    
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">process_string_data</span><span class="p">(</span><span class="n">json_file_path</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">    ä»JSONæ–‡ä»¶è¯»å–å­—ç¬¦ä¸²æ•°æ®ï¼Œåœ¨rodataæ®µæœç´¢å­—ç¬¦ä¸²ï¼Œ
</span></span></span><span class="line"><span class="cl"><span class="s2">    è·³è½¬åˆ°ç¬¬ä¸€ä¸ªäº¤å‰å¼•ç”¨çš„å‡½æ•°ï¼Œå¹¶æ ¹æ®éœ€è¦é‡å‘½åå‡½æ•°
</span></span></span><span class="line"><span class="cl"><span class="s2">    
</span></span></span><span class="line"><span class="cl"><span class="s2">    å‚æ•°:
</span></span></span><span class="line"><span class="cl"><span class="s2">        json_file_path: JSONæ–‡ä»¶è·¯å¾„
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># è¯»å–JSONæ–‡ä»¶</span>
</span></span><span class="line"><span class="cl">        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">json_file_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">string_data_list</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;æˆåŠŸè¯»å–JSONæ–‡ä»¶ï¼ŒåŒ…å« </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">string_data_list</span><span class="p">)</span><span class="si">}</span><span class="s2"> ä¸ªå­—ç¬¦ä¸²æ¡ç›®&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># è·å–.rodataæ®µ</span>
</span></span><span class="line"><span class="cl">        <span class="n">rodata_seg</span> <span class="o">=</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">seg</span> <span class="ow">in</span> <span class="n">idautils</span><span class="o">.</span><span class="n">Segments</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">            <span class="n">seg_name</span> <span class="o">=</span> <span class="n">ida_segment</span><span class="o">.</span><span class="n">get_segm_name</span><span class="p">(</span><span class="n">ida_segment</span><span class="o">.</span><span class="n">getseg</span><span class="p">(</span><span class="n">seg</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">seg_name</span> <span class="o">==</span> <span class="s2">&#34;.rodata&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">rodata_seg</span> <span class="o">=</span> <span class="n">ida_segment</span><span class="o">.</span><span class="n">getseg</span><span class="p">(</span><span class="n">seg</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">break</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="n">rodata_seg</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;é”™è¯¯ï¼šæ— æ³•æ‰¾åˆ°.rodataæ®µ&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;æ‰¾åˆ°.rodataæ®µ: 0x</span><span class="si">{</span><span class="n">rodata_seg</span><span class="o">.</span><span class="n">start_ea</span><span class="si">:</span><span class="s2">X</span><span class="si">}</span><span class="s2"> - 0x</span><span class="si">{</span><span class="n">rodata_seg</span><span class="o">.</span><span class="n">end_ea</span><span class="si">:</span><span class="s2">X</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># å¤„ç†æ¯ä¸ªå­—ç¬¦ä¸²æ¡ç›®</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">string_data_list</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># print(f&#34;\n[{idx + 1}/{len(string_data_list)}] å¤„ç†å­—ç¬¦ä¸²: &#39;{item[&#39;str&#39;]}&#39;&#34;)</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="c1"># åœ¨rodataæ®µæœç´¢å­—ç¬¦ä¸²</span>
</span></span><span class="line"><span class="cl">            <span class="n">string_to_search</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;str&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">            <span class="n">found_ea</span> <span class="o">=</span> <span class="n">search_string_in_segment</span><span class="p">(</span><span class="n">string_to_search</span><span class="p">,</span> <span class="n">rodata_seg</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">found_ea</span> <span class="o">==</span> <span class="n">ida_idaapi</span><span class="o">.</span><span class="n">BADADDR</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="c1"># print(f&#34;  æœªåœ¨.rodataæ®µæ‰¾åˆ°å­—ç¬¦ä¸² &#39;{string_to_search}&#39;&#34;)</span>
</span></span><span class="line"><span class="cl">                <span class="k">continue</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="c1"># è·å–å­—ç¬¦ä¸²çš„äº¤å‰å¼•ç”¨</span>
</span></span><span class="line"><span class="cl">            <span class="n">xrefs</span> <span class="o">=</span> <span class="n">get_xrefs_to_address</span><span class="p">(</span><span class="n">found_ea</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="ow">not</span> <span class="n">xrefs</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;  å­—ç¬¦ä¸²åœ¨ 0x</span><span class="si">{</span><span class="n">found_ea</span><span class="si">:</span><span class="s2">X</span><span class="si">}</span><span class="s2"> æ²¡æœ‰äº¤å‰å¼•ç”¨&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">continue</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;  æ‰¾åˆ° </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">xrefs</span><span class="p">)</span><span class="si">}</span><span class="s2"> ä¸ªäº¤å‰å¼•ç”¨&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="c1"># è·å–ç¬¬ä¸€ä¸ªäº¤å‰å¼•ç”¨</span>
</span></span><span class="line"><span class="cl">            <span class="n">first_xref</span> <span class="o">=</span> <span class="n">xrefs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="c1"># æ‰¾åˆ°åŒ…å«è¯¥äº¤å‰å¼•ç”¨çš„å‡½æ•°</span>
</span></span><span class="line"><span class="cl">            <span class="n">func</span> <span class="o">=</span> <span class="n">ida_funcs</span><span class="o">.</span><span class="n">get_func</span><span class="p">(</span><span class="n">first_xref</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="ow">not</span> <span class="n">func</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;  0x</span><span class="si">{</span><span class="n">first_xref</span><span class="si">:</span><span class="s2">X</span><span class="si">}</span><span class="s2"> ä¸åœ¨ä»»ä½•å‡½æ•°ä¸­&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">continue</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="n">target_func_name</span><span class="p">,</span> <span class="n">target_func_ea</span> <span class="o">=</span> <span class="n">find_target_function</span><span class="p">(</span><span class="n">first_xref</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">target_func_name</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">target_func_name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;sub_&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;target_func_name&#39;</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">rename_function</span><span class="p">(</span><span class="n">target_func_ea</span><span class="p">,</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;target_func_name&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">                
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="n">func_ea</span> <span class="o">=</span> <span class="n">func</span><span class="o">.</span><span class="n">start_ea</span>
</span></span><span class="line"><span class="cl">            <span class="n">current_func_name</span> <span class="o">=</span> <span class="n">ida_funcs</span><span class="o">.</span><span class="n">get_func_name</span><span class="p">(</span><span class="n">func_ea</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;  ç›®æ ‡å‡½æ•°åœ°å€: 0x</span><span class="si">{</span><span class="n">func_ea</span><span class="si">:</span><span class="s2">X</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;  å½“å‰å‡½æ•°å: </span><span class="si">{</span><span class="n">current_func_name</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="c1"># æ£€æŸ¥å‡½æ•°æ˜¯å¦æœ‰è‡ªå®šä¹‰åç§°</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">is_auto_generated_name</span><span class="p">(</span><span class="n">current_func_name</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="c1"># ä½¿ç”¨JSONä¸­æä¾›çš„xrefsç¬¬ä¸€é¡¹ä½œä¸ºæ–°çš„å‡½æ•°å</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="s1">&#39;xrefs&#39;</span> <span class="ow">in</span> <span class="n">item</span> <span class="ow">and</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;xrefs&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s1">&#39;xrefs&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">new_name</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;xrefs&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="n">rename_function</span><span class="p">(</span><span class="n">func_ea</span><span class="p">,</span> <span class="n">new_name</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;  âœ“ å‡½æ•°é‡å‘½åä¸º: </span><span class="si">{</span><span class="n">new_name</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;  âœ— å‡½æ•°é‡å‘½åå¤±è´¥&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;  æœªæä¾›xrefsä¿¡æ¯ï¼Œè·³è¿‡é‡å‘½å&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;  å‡½æ•°å·²æœ‰è‡ªå®šä¹‰åç§°ï¼Œè·³è¿‡é‡å‘½å&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="c1"># è·³è½¬åˆ°å‡½æ•°</span>
</span></span><span class="line"><span class="cl">            <span class="n">ida_kernwin</span><span class="o">.</span><span class="n">jumpto</span><span class="p">(</span><span class="n">func_ea</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;  å·²è·³è½¬åˆ°å‡½æ•° 0x</span><span class="si">{</span><span class="n">func_ea</span><span class="si">:</span><span class="s2">X</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">å¤„ç†å®Œæˆï¼å…±å¤„ç†äº† </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">string_data_list</span><span class="p">)</span><span class="si">}</span><span class="s2"> ä¸ªå­—ç¬¦ä¸²æ¡ç›®&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;é”™è¯¯ï¼šæ— æ³•æ‰¾åˆ°æ–‡ä»¶ </span><span class="si">{</span><span class="n">json_file_path</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">except</span> <span class="n">json</span><span class="o">.</span><span class="n">JSONDecodeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;é”™è¯¯ï¼šJSONæ–‡ä»¶æ ¼å¼é”™è¯¯ - </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;é”™è¯¯ï¼šå¤„ç†è¿‡ç¨‹ä¸­å‡ºç°å¼‚å¸¸ - </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">search_string_in_segment</span><span class="p">(</span><span class="n">target_string</span><span class="p">,</span> <span class="n">segment</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">    åœ¨æŒ‡å®šæ®µä¸­æœç´¢å­—ç¬¦ä¸²
</span></span></span><span class="line"><span class="cl"><span class="s2">    
</span></span></span><span class="line"><span class="cl"><span class="s2">    å‚æ•°:
</span></span></span><span class="line"><span class="cl"><span class="s2">        target_string: è¦æœç´¢çš„å­—ç¬¦ä¸²
</span></span></span><span class="line"><span class="cl"><span class="s2">        segment: ç›®æ ‡æ®µ
</span></span></span><span class="line"><span class="cl"><span class="s2">    
</span></span></span><span class="line"><span class="cl"><span class="s2">    è¿”å›:
</span></span></span><span class="line"><span class="cl"><span class="s2">        æ‰¾åˆ°çš„åœ°å€ï¼Œå¦‚æœæœªæ‰¾åˆ°åˆ™è¿”å›BADADDR
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">start_ea</span> <span class="o">=</span> <span class="n">segment</span><span class="o">.</span><span class="n">start_ea</span>
</span></span><span class="line"><span class="cl">    <span class="n">end_ea</span> <span class="o">=</span> <span class="n">segment</span><span class="o">.</span><span class="n">end_ea</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1"># å°è¯•æœç´¢å­—ç¬¦ä¸²</span>
</span></span><span class="line"><span class="cl">    <span class="n">found_ea</span> <span class="o">=</span> <span class="n">ida_bytes</span><span class="o">.</span><span class="n">find_string</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="n">target_string</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">start_ea</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">range_end</span><span class="o">=</span><span class="n">end_ea</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">flags</span><span class="o">=</span><span class="n">ida_bytes</span><span class="o">.</span><span class="n">BIN_SEARCH_FORWARD</span> <span class="o">|</span> <span class="n">ida_bytes</span><span class="o">.</span><span class="n">BIN_SEARCH_NOSHOW</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1"># å¦‚æœåœ¨æ®µèŒƒå›´å†…æ‰¾åˆ°ï¼Œè¿”å›åœ°å€</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">found_ea</span> <span class="o">!=</span> <span class="n">ida_idaapi</span><span class="o">.</span><span class="n">BADADDR</span> <span class="ow">and</span> <span class="n">start_ea</span> <span class="o">&lt;=</span> <span class="n">found_ea</span> <span class="o">&lt;</span> <span class="n">end_ea</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">found_ea</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">ida_idaapi</span><span class="o">.</span><span class="n">BADADDR</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">get_xrefs_to_address</span><span class="p">(</span><span class="n">ea</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">    è·å–æŒ‡å‘æŒ‡å®šåœ°å€çš„æ‰€æœ‰äº¤å‰å¼•ç”¨
</span></span></span><span class="line"><span class="cl"><span class="s2">    
</span></span></span><span class="line"><span class="cl"><span class="s2">    å‚æ•°:
</span></span></span><span class="line"><span class="cl"><span class="s2">        ea: ç›®æ ‡åœ°å€
</span></span></span><span class="line"><span class="cl"><span class="s2">    
</span></span></span><span class="line"><span class="cl"><span class="s2">    è¿”å›:
</span></span></span><span class="line"><span class="cl"><span class="s2">        äº¤å‰å¼•ç”¨åœ°å€åˆ—è¡¨
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">xrefs</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1"># è·å–æ•°æ®å¼•ç”¨</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">xref</span> <span class="ow">in</span> <span class="n">idautils</span><span class="o">.</span><span class="n">DataRefsTo</span><span class="p">(</span><span class="n">ea</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">xrefs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">xref</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1"># è·å–ä»£ç å¼•ç”¨</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">xref</span> <span class="ow">in</span> <span class="n">idautils</span><span class="o">.</span><span class="n">CodeRefsTo</span><span class="p">(</span><span class="n">ea</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">xrefs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">xref</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">xrefs</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">is_auto_generated_name</span><span class="p">(</span><span class="n">func_name</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">    æ£€æŸ¥å‡½æ•°åæ˜¯å¦ä¸ºè‡ªåŠ¨ç”Ÿæˆçš„åç§°
</span></span></span><span class="line"><span class="cl"><span class="s2">    
</span></span></span><span class="line"><span class="cl"><span class="s2">    å‚æ•°:
</span></span></span><span class="line"><span class="cl"><span class="s2">        func_name: å‡½æ•°å
</span></span></span><span class="line"><span class="cl"><span class="s2">    
</span></span></span><span class="line"><span class="cl"><span class="s2">    è¿”å›:
</span></span></span><span class="line"><span class="cl"><span class="s2">        True å¦‚æœæ˜¯è‡ªåŠ¨ç”Ÿæˆçš„åç§°ï¼ŒFalse å¦åˆ™
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># IDAè‡ªåŠ¨ç”Ÿæˆçš„å‡½æ•°åé€šå¸¸ä»¥sub_ã€loc_ã€unk_ç­‰å¼€å¤´</span>
</span></span><span class="line"><span class="cl">    <span class="n">auto_prefixes</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;sub_&#39;</span><span class="p">,</span> <span class="s1">&#39;loc_&#39;</span><span class="p">,</span> <span class="s1">&#39;unk_&#39;</span><span class="p">,</span> <span class="s1">&#39;nullsub_&#39;</span><span class="p">,</span> <span class="s1">&#39;j_&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">prefix</span> <span class="ow">in</span> <span class="n">auto_prefixes</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">func_name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">prefix</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">rename_function</span><span class="p">(</span><span class="n">func_ea</span><span class="p">,</span> <span class="n">new_name</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">    é‡å‘½åå‡½æ•°
</span></span></span><span class="line"><span class="cl"><span class="s2">    
</span></span></span><span class="line"><span class="cl"><span class="s2">    å‚æ•°:
</span></span></span><span class="line"><span class="cl"><span class="s2">        func_ea: å‡½æ•°åœ°å€
</span></span></span><span class="line"><span class="cl"><span class="s2">        new_name: æ–°å‡½æ•°å
</span></span></span><span class="line"><span class="cl"><span class="s2">    
</span></span></span><span class="line"><span class="cl"><span class="s2">    è¿”å›:
</span></span></span><span class="line"><span class="cl"><span class="s2">        True å¦‚æœé‡å‘½åæˆåŠŸï¼ŒFalse å¦åˆ™
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># ä½¿ç”¨ida_name.set_nameè®¾ç½®å‡½æ•°å</span>
</span></span><span class="line"><span class="cl">        <span class="n">result</span> <span class="o">=</span> <span class="n">ida_name</span><span class="o">.</span><span class="n">set_name</span><span class="p">(</span><span class="n">func_ea</span><span class="p">,</span> <span class="n">new_name</span><span class="p">,</span> <span class="n">ida_name</span><span class="o">.</span><span class="n">SN_CHECK</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">result</span>
</span></span><span class="line"><span class="cl">    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;é‡å‘½åå‡½æ•°æ—¶å‡ºé”™: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">    ä¸»å‡½æ•° - æç¤ºç”¨æˆ·é€‰æ‹©JSONæ–‡ä»¶å¹¶å¼€å§‹å¤„ç†
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># è·å–JSONæ–‡ä»¶è·¯å¾„</span>
</span></span><span class="line"><span class="cl">    <span class="n">json_file</span> <span class="o">=</span> <span class="n">ida_kernwin</span><span class="o">.</span><span class="n">ask_file</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s2">&#34;*.json&#34;</span><span class="p">,</span> <span class="s2">&#34;é€‰æ‹©åŒ…å«å­—ç¬¦ä¸²æ•°æ®çš„JSONæ–‡ä»¶&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">json_file</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;å¼€å§‹å¤„ç†æ–‡ä»¶: </span><span class="si">{</span><span class="n">json_file</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">process_string_data</span><span class="p">(</span><span class="n">json_file</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;æœªé€‰æ‹©æ–‡ä»¶ï¼Œæ“ä½œå–æ¶ˆ&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&#34;__main__&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">main</span><span class="p">()</span>
</span></span></code></pre></div><p>è¿™äº›è¿™å‡ ä¸ªè„šæœ¬æ¯”è¾ƒç³™ï¼Œè¿˜éœ€æ‰“ç£¨ï¼Œä¸»è¦æ˜¯ç°åœ¨å¤Ÿç”¨äº†ã€‚è€Œä¸”å¯èƒ½ä½œç”¨ä¸æ˜¯å¾ˆå¤§ï¼Œå› ä¸ºåšäº†è¿™å‡ é¡¹ä¼˜åŒ–åï¼Œå¾ˆå¿«å°±èƒ½çœ‹å‡ºè¿™å‡ ä¸ªELFï¼Œå®é™…ä¸Šæ²¡æœ‰é­”æ”¹Glibcï¼Œåªæ˜¯é™æ€é“¾æ¥äº†è€Œå·²ã€‚å¹¶ä¸”éƒ½æ˜¯ç”¨ libc_start_main æ¥å¯åŠ¨ä¸»å‡½æ•°ã€‚</p>
<h3 id="ä¿®å¤gecaå’Œrc0d">ä¿®å¤GECAå’Œrc0.d</h3>
<p>ä» /dev/hdc1 çš„ 0x1B44 * 512 ä½ç½®è¯»å– 0x400 å­—èŠ‚ï¼Œè¿™ä¸ªæ˜¯ä¸€ä¸ªELF Headerï¼Œå†™å…¥åˆ° /mnt/head é‡Œã€‚</p>
<p>IGSåº”è¯¥æ˜¯æŠŠè¿™ä¸ªELFå¤´è—åœ¨äº†FATåˆ†åŒºçš„ç©ºç™½å¤„ã€‚å› ä¸ºåˆ†åŒºæ˜¯è¿ç»­çš„ï¼Œæ— æ³•ç›´æ¥ä»åˆ†åŒºå¸ƒå±€çœ‹å‡ºè—äº†å†…å®¹ã€‚</p>
<p>ä» /bin/arch çš„æœ«å°¾çš„ä½ç½®è¯»å– 0x400 å­—èŠ‚ï¼Œå†™å…¥åˆ° /mnt/GECA é‡Œã€‚</p>
<p>ç„¶åå°† /etc/init.d/rc0.d è¿½åŠ åˆ° /mnt/GECA æœ«å°¾</p>
<h3 id="ä¿®å¤æ¸¸æˆæ–‡ä»¶">ä¿®å¤æ¸¸æˆæ–‡ä»¶</h3>
<p>åœ¨æˆ‘å¼€å§‹åˆ†æä¹‹å‰ï¼ŒNova æŠŠä»–å’Œ BatteryShark ç ”ç©¶çš„è¿›åº¦åˆ†äº«ç»™æˆ‘äº†ï¼Œä»–ä»¬å·²ç»å°† Speed Driver 2 çš„ELFè¿˜åŸï¼Œä½†æ˜¯è¿™ä¸ªELFè¿˜æ˜¯æœ‰é—®é¢˜çš„ï¼Œå¹¶ä¸”ä¸èƒ½ç”¨åœ¨å…¶ä»–æ¸¸æˆï¼Œæ¯”å¦‚Percussion Master 2008ã€‚
<a href="https://github.com/batteryshark/igstools/blob/main/scripts/igs_rofsv1_dumpexec.py"target="_blank" rel="noopener noreferrer">IGS Dump EXEC</a></p>
<p>å› æ­¤è¿˜æ˜¯è¦è‡ªå·±åŠ¨æ‰‹ï¼Œæ°å¥½æˆ‘ä¹Ÿè¦é€†å‘åˆ†æè¿˜åŸæ¸¸æˆæ–‡ä»¶çš„ä»£ç ã€‚</p>
<p>åœ¨å†…æ ¸å¯åŠ¨é˜¶æ®µï¼ŒGECA è¢« zsh ä¿®å¤åï¼Œç«‹åˆ»å°±ä¼šç”¨ç›¸åŒçš„ç¯å¢ƒå˜é‡å’Œå‚æ•°è¿è¡Œã€‚</p>
<p>rc* çš„æ‹¼æ¥é¡ºåºï¼Œæ˜¯é€šè¿‡ä¸€ä¸ªå­—ç¬¦ä¸²å˜é‡æ¥è®¾å®šçš„ï¼Œæ¯ä¸ªæ¸¸æˆéƒ½ä¸ä¸€æ ·ã€‚</p>
<p><img loading="lazy"  src="geca_params.png"
        alt="geca_params.png"/></p>
<p>è¿™ä¸ªæ•°å­—å­—ç¬¦ï¼Œåˆšå¥½å¯¹åº” /etc/rc.d çš„æ–‡ä»¶é¡ºåº</p>
<pre tabindex="0"><code>2 1 3 5 8 4 7 6 9
</code></pre><p>GECA ä»£ç è¿è¡Œè¿‡ç¨‹ï¼šå…ˆå°†/etc/rc.dçš„ç¢ç‰‡ï¼Œæ ¹æ®ä¸åŒé¡ºåºæ¥è®¾ç½®å‰ªåˆ‡å°ºå¯¸ï¼Œè¾“å‡ºåˆ°/mntç›®å½•</p>
<pre tabindex="0"><code>dd if=/etc/rc.d/rc2.d of=/mnt/rc2 bs=1K count=[file_size / 1024 - 400] &amp;&gt; /dev/null
dd if=/etc/rc.d/rc1.d of=/mnt/rc1 bs=1K count=[file_size / 1024 - 400 + 7] &amp;&gt; /dev/null
dd if=/etc/rc.d/rc3.d of=/mnt/rc3 bs=1K count=[file_size / 1024 - 400 + 14] &amp;&gt; /dev/null
dd if=/etc/rc.d/rc5.d of=/mnt/rc5 bs=1K count=[file_size / 1024 - 400 + 21] &amp;&gt; /dev/null
dd if=/etc/rc.d/rc8.d of=/mnt/rc8 bs=1K count=[file_size / 1024 - 400 + 28] &amp;&gt; /dev/null
dd if=/etc/rc.d/rc4.d of=/mnt/rc4 bs=1K count=[file_size / 1024 - 400 + 35] &amp;&gt; /dev/null
dd if=/etc/rc.d/rc7.d of=/mnt/rc7 bs=1K count=[file_size / 1024 - 400 + 42] &amp;&gt; /dev/null
dd if=/etc/rc.d/rc6.d of=/mnt/rc6 bs=1K count=[file_size / 1024 - 400 + 49] &amp;&gt; /dev/null
dd if=/etc/rc.d/rc9.d of=/mnt/rc9 bs=1 count=[file_size - 400 * 1024] &amp;&gt; /dev/null
</code></pre><p>ç„¶åæŒ‚è½½ramfsåœ¨/execï¼Œå°†è¿™äº›æ–‡ä»¶æ‹¼æ¥æˆçœŸæ­£çš„æ¸¸æˆæ–‡ä»¶ï¼Œæ›¿æ¢æ‰åŸæœ¬çš„ç¡¬ç›˜ç ´åç¨‹åºã€‚
æ¥ä¸‹æ¥çš„å¯åŠ¨è¿‡ç¨‹å°±ç¬¦åˆå‰é¢çš„ /etc/X11/IGS äº†ã€‚</p>
<pre tabindex="0"><code>mount -n -t ramfs GameExecution /exec &amp;&gt; /dev/null
cat /mnt/head /mnt/rc2 /mnt/rc1 /mnt/rc3 /mnt/rc5 /mnt/rc8 /mnt/rc4 /mnt/rc7 /mnt/rc6 /mnt/rc9 &gt; /exec/PM2008v2 &amp;&amp; chmod 777 /exec/PM2008v2 &amp;&gt; /dev/null

# åˆ é™¤ä¸´æ—¶æ–‡ä»¶
umount /mnt &amp;&gt;/dev/null
rm -rf /mnt &amp;&gt;/dev/null
</code></pre><p>å¯ä»¥ç¼–å†™ä¸€ä¸ªè„šæœ¬æ¥å®ç°è¿™ä¸ªè¿‡ç¨‹</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="ch">#!/usr/bin/env python3</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">os</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">argparse</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s1">&#39;Recover game from IGS E2000 platform&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;head_file&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;head file to read&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;rc_dir&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;game parts dir to read&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;game_file&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;game file to write&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">rc_order</span> <span class="o">=</span> <span class="s2">&#34;213584769&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">rc_order_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">rc_order</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">block_num</span> <span class="o">=</span> <span class="mi">400</span>
</span></span><span class="line"><span class="cl">    <span class="n">ignore_count</span> <span class="o">=</span> <span class="mi">7</span>
</span></span><span class="line"><span class="cl">    <span class="n">step_type</span> <span class="o">=</span> <span class="mi">2</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">head</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">head_file</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">game_file</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">game_fd</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">game_fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">head</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rc_order_len</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">rc_file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">rc_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&#34;rc</span><span class="si">{</span><span class="n">rc_order</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s2">.d&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">rc_data</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">rc_file_path</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="n">rc_data_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">rc_data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">write_size</span> <span class="o">=</span> <span class="n">rc_data_size</span> <span class="o">-</span> <span class="n">block_num</span> <span class="o">*</span> <span class="mi">1024</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;rc</span><span class="si">{</span><span class="n">rc_order</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s2">.d size: 0x</span><span class="si">{</span><span class="n">rc_data_size</span><span class="si">:</span><span class="s2">08X</span><span class="si">}</span><span class="s2">, write 0x</span><span class="si">{</span><span class="n">write_size</span><span class="si">:</span><span class="s2">08X</span><span class="si">}</span><span class="s2"> bytes to game file, write block </span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">write_size</span><span class="o">/</span><span class="mi">1024</span><span class="p">)</span><span class="si">}</span><span class="s2"> skip block_num: </span><span class="si">{</span><span class="n">block_num</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1"># head = head + rc_data[0:write_size]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">step_type</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">block_num</span> <span class="o">-=</span> <span class="n">ignore_count</span>
</span></span><span class="line"><span class="cl">            <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">block_num</span> <span class="o">+=</span> <span class="n">ignore_count</span>
</span></span><span class="line"><span class="cl">            <span class="n">game_fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">rc_data</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">write_size</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&#34;__main__&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">main</span><span class="p">()</span>
</span></span></code></pre></div><pre tabindex="0"><code>(base) âœ python ./recover_game.py ./head.img ./part2/etc/rc.d ./pm2008_game
rc2.d size: 0x00080000, write 0x0001C000 bytes to game file, write block 112 skip block_num: 400
rc1.d size: 0x00080000, write 0x0001DC00 bytes to game file, write block 119 skip block_num: 393
rc3.d size: 0x00080000, write 0x0001F800 bytes to game file, write block 126 skip block_num: 386
rc5.d size: 0x00080000, write 0x00021400 bytes to game file, write block 133 skip block_num: 379
rc8.d size: 0x00080000, write 0x00023000 bytes to game file, write block 140 skip block_num: 372
rc4.d size: 0x00080000, write 0x00024C00 bytes to game file, write block 147 skip block_num: 365
rc7.d size: 0x00080000, write 0x00026800 bytes to game file, write block 154 skip block_num: 358
rc6.d size: 0x00080000, write 0x00028400 bytes to game file, write block 161 skip block_num: 351
rc9.d size: 0x003CA6D8, write 0x003746D8 bytes to game file, write block 3537 skip block_num: 344
</code></pre><p>ä¿®å¤åï¼Œè™½ç„¶é¿å¼€äº†å¤šä¸ªç‰ˆæœ¬çš„glibcç‰¹å¾ï¼Œä½†ELFå¯èƒ½è¿˜æœ‰é—®é¢˜ï¼Œå› ä¸ºæ¯ä¸ªæ¸¸æˆçš„ä¸»ç¨‹åºæ¢å¤ç®—æ³•è¿˜æ˜¯æœ‰ç•¥å¾®å·®å¼‚ã€‚PM2008çš„æ¢å¤é€»è¾‘è¾“å…¥å°±æ¯”SD2å¤šä¸¤ä¸ªå‚æ•°ï¼Œå…ˆåˆ†æPM2008å§ã€‚</p>
<p>è¿˜éœ€è¦åŠ¨æ€åˆ†æä¸€ä¸‹å†…å­˜é‡Œçš„ELFæ–‡ä»¶æ˜¯æ€ä¹ˆè£…è½½çš„ï¼Œä½†æ˜¯ç°åœ¨å‘ç°ï¼Œåœ¨æ¸¸æˆæœºæ¥ç½‘çº¿æˆ–è€…é”®ç›˜ï¼Œå°±ä¼šè‡ªåŠ¨æ­»æœºï¼Œä¸çŸ¥é“æ˜¯ä¸æ˜¯å®‰å…¨æœºåˆ¶ã€‚ä¸‹ä¸€ç¯‡å°†åˆ†æå¦‚ä½•åœ¨è®¾å¤‡ä¸ŠåŠ¨æ€è°ƒè¯•ã€‚</p>
</article><section class="article labels"><a class="category" href=/zh/categories/%E9%80%86%E5%90%91%E5%B7%A5%E7%A8%8B/>é€†å‘å·¥ç¨‹</a><a class="tag" href=/zh/tags/igs/>IGS</a><a class="tag" href=/zh/tags/arcade/>Arcade</a><a class="tag" href=/zh/tags/crack/>Crack</a><a class="tag" href=/zh/tags/%E9%88%8A%E8%B1%A1%E7%94%B5%E5%AD%90/>éˆŠè±¡ç”µå­</a><a class="tag" href=/zh/tags/e2000/>E2000</a></section>
</div>
<div class="article bottom"><section class="article navigation"><p><a class="link" href="/zh/posts/igs-arcade-re-3/"><span class="iconfont icon-article"></span>IGS Arcade é€†å‘ç³»åˆ—ï¼ˆä¸‰ï¼‰- Getshell</a></p><p><a class="link" href="/zh/posts/igs-arcade-re-1/"><span class="iconfont icon-article"></span>IGS Arcade é€†å‘ç³»åˆ—ï¼ˆä¸€ï¼‰- E2000å¹³å°åˆ†æ</a></p></section></div></section><section id="footer"><div class="footer-wrap">
    <p class="copyright">2015 - 2026 Gorgias' Blog. </p><p class="license">
        <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noopener noreferrer">
            <img alt="CC BY-NC-SA" loading="lazy" src="/images/by-nc.svg" style="vertical-align: middle; height: 1.2em; margin: 0 0.2em;" />
            CC BY-NC-SA 4.0
        </a>
        (ç½²å-éå•†ä¸šæ€§ä½¿ç”¨-ç›¸åŒæ–¹å¼å…±äº«).
    </p><p class="powerby"><span>Powered&nbsp;by&nbsp;</span><a href="https://gohugo.io" 
        target="_blank" rel="noopener noreferrer">Hugo</a><span>&nbsp;&amp;&nbsp;</span><a href="https://themes.gohugo.io/hugo-notepadium/" 
        target="_blank" rel="noopener noreferrer">Notepadium</a></p></div></section></body>

</html>